<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MongoDBを触ってみよう | IIJ Bootcamp</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="MongoDBに対してクエリを投げながら、レプリカセットなど特徴的な機能について紹介します。">
    
    <link rel="preload" href="/bootcamp/assets/css/0.styles.095a7d7e.css" as="style"><link rel="preload" href="/bootcamp/assets/js/app.50837537.js" as="script"><link rel="preload" href="/bootcamp/assets/js/2.46b7ffd3.js" as="script"><link rel="preload" href="/bootcamp/assets/js/20.0acbd8cd.js" as="script"><link rel="preload" href="/bootcamp/assets/js/14.9babec04.js" as="script"><link rel="preload" href="/bootcamp/assets/js/13.b665defe.js" as="script"><link rel="prefetch" href="/bootcamp/assets/js/10.c157c9de.js"><link rel="prefetch" href="/bootcamp/assets/js/11.4f409002.js"><link rel="prefetch" href="/bootcamp/assets/js/12.f3a14d59.js"><link rel="prefetch" href="/bootcamp/assets/js/15.3da39eab.js"><link rel="prefetch" href="/bootcamp/assets/js/16.b8d3b920.js"><link rel="prefetch" href="/bootcamp/assets/js/17.06d2a4ac.js"><link rel="prefetch" href="/bootcamp/assets/js/18.4fb9eac4.js"><link rel="prefetch" href="/bootcamp/assets/js/19.b2e35193.js"><link rel="prefetch" href="/bootcamp/assets/js/21.902ccd5f.js"><link rel="prefetch" href="/bootcamp/assets/js/22.ba186817.js"><link rel="prefetch" href="/bootcamp/assets/js/23.1b53958b.js"><link rel="prefetch" href="/bootcamp/assets/js/24.3b063ec8.js"><link rel="prefetch" href="/bootcamp/assets/js/25.ee89fc16.js"><link rel="prefetch" href="/bootcamp/assets/js/26.cde6c13d.js"><link rel="prefetch" href="/bootcamp/assets/js/27.7c59e671.js"><link rel="prefetch" href="/bootcamp/assets/js/28.7de8a20d.js"><link rel="prefetch" href="/bootcamp/assets/js/29.67d58155.js"><link rel="prefetch" href="/bootcamp/assets/js/3.65ecb4b0.js"><link rel="prefetch" href="/bootcamp/assets/js/30.1113c3c3.js"><link rel="prefetch" href="/bootcamp/assets/js/31.f653877b.js"><link rel="prefetch" href="/bootcamp/assets/js/32.8ac1ae9f.js"><link rel="prefetch" href="/bootcamp/assets/js/33.d779463b.js"><link rel="prefetch" href="/bootcamp/assets/js/34.9f894566.js"><link rel="prefetch" href="/bootcamp/assets/js/35.95183d67.js"><link rel="prefetch" href="/bootcamp/assets/js/36.6f6931be.js"><link rel="prefetch" href="/bootcamp/assets/js/37.d5336fcb.js"><link rel="prefetch" href="/bootcamp/assets/js/38.60a6faee.js"><link rel="prefetch" href="/bootcamp/assets/js/39.a3bec209.js"><link rel="prefetch" href="/bootcamp/assets/js/4.7d8f730b.js"><link rel="prefetch" href="/bootcamp/assets/js/40.3dd53e01.js"><link rel="prefetch" href="/bootcamp/assets/js/41.0d7c9775.js"><link rel="prefetch" href="/bootcamp/assets/js/42.c5c1e25e.js"><link rel="prefetch" href="/bootcamp/assets/js/43.8ac99d4d.js"><link rel="prefetch" href="/bootcamp/assets/js/44.2e5d10e2.js"><link rel="prefetch" href="/bootcamp/assets/js/45.55abc2f2.js"><link rel="prefetch" href="/bootcamp/assets/js/46.c7d5a28d.js"><link rel="prefetch" href="/bootcamp/assets/js/47.d609f38f.js"><link rel="prefetch" href="/bootcamp/assets/js/48.adb4ac7d.js"><link rel="prefetch" href="/bootcamp/assets/js/49.0c429fdb.js"><link rel="prefetch" href="/bootcamp/assets/js/5.3bd3a0cb.js"><link rel="prefetch" href="/bootcamp/assets/js/50.5ff0c0fe.js"><link rel="prefetch" href="/bootcamp/assets/js/51.33e12c75.js"><link rel="prefetch" href="/bootcamp/assets/js/52.d217c282.js"><link rel="prefetch" href="/bootcamp/assets/js/53.0f8d9665.js"><link rel="prefetch" href="/bootcamp/assets/js/54.2078d78a.js"><link rel="prefetch" href="/bootcamp/assets/js/55.fa238973.js"><link rel="prefetch" href="/bootcamp/assets/js/56.f0c27cef.js"><link rel="prefetch" href="/bootcamp/assets/js/6.f1a94d8d.js"><link rel="prefetch" href="/bootcamp/assets/js/7.db5e66f9.js"><link rel="prefetch" href="/bootcamp/assets/js/8.6d753844.js"><link rel="prefetch" href="/bootcamp/assets/js/9.752e03b6.js">
    <link rel="stylesheet" href="/bootcamp/assets/css/0.styles.095a7d7e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/bootcamp/" class="home-link router-link-active"><!----> <span class="site-name">IIJ Bootcamp</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/iij/bootcamp" target="_blank" rel="noopener noreferrer" class="repo-link">
      GitHub
      <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/iij/bootcamp" target="_blank" rel="noopener noreferrer" class="repo-link">
      GitHub
      <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>MongoDBを触ってみよう</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/bootcamp/database/mongodb/#今日のサンプル環境" class="sidebar-link">今日のサンプル環境</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/bootcamp/database/mongodb/#mongodbの紹介" class="sidebar-link">MongoDBの紹介</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bootcamp/database/mongodb/#個人的な雑感" class="sidebar-link">個人的な雑感</a></li></ul></li><li><a href="/bootcamp/database/mongodb/#早速使ってみよう" class="sidebar-link">早速使ってみよう</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/bootcamp/database/mongodb/#検索と集計-aggregation" class="sidebar-link">検索と集計(Aggregation)</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/bootcamp/database/mongodb/#レプリカセット" class="sidebar-link">レプリカセット</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bootcamp/database/mongodb/#解説" class="sidebar-link">解説</a></li><li class="sidebar-sub-header"><a href="/bootcamp/database/mongodb/#ハンズオン" class="sidebar-link">ハンズオン</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><table><tr><td>このハンズオンでやること</td><td>MongoDBに対してクエリを投げながら、レプリカセットなど特徴的な機能について紹介します。</td></tr> <tr><td>想定時間</td><td>1h</td></tr> <tr><td>前提知識・用語</td><td>なし</td></tr></table> <h1 id="page-frontmatter-title"><a href="#page-frontmatter-title" class="header-anchor">#</a> MongoDBを触ってみよう</h1> <h2 id="今日のサンプル環境"><a href="#今日のサンプル環境" class="header-anchor">#</a> 今日のサンプル環境</h2> <p>以下のレポジトリを手元にクローンして、<code>docker compose up -d</code>を実行してください。</p> <p><a href="https://github.com/iij/bootcamp-mongodb-sample" target="_blank" rel="noopener noreferrer">iij/bootcamp-mongodb-sample<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-terminal extra-class"><pre class="language-text"><code>$ git clone git@github.com:iij/bootcamp-mongodb-sample.git
$ cd bootcamp-mongodb-sample/
$ docker compose up -d
[+] Running 3/3
 ⠿ Container bootcamp-mongodb-sample-mongo-secondary-1  Started                                                                                 7.3s
 ⠿ Container bootcamp-mongodb-sample-mongo-primary-1    Started                                                                                 7.1s
 ⠿ Container bootcamp-mongodb-sample-mongo-arbiter-1    Started                                                                                 8.0s
$ docker compose ps
NAME                                        COMMAND                  SERVICE             STATUS              PORTS
bootcamp-mongodb-sample-mongo-arbiter-1     &quot;docker-entrypoint.s…&quot;   mongo-arbiter       running             0.0.0.0:27019-&gt;27019/tcp, :::27019-&gt;27019/tcp
bootcamp-mongodb-sample-mongo-primary-1     &quot;docker-entrypoint.s…&quot;   mongo-primary       running             0.0.0.0:27017-&gt;27017/tcp, :::27017-&gt;27017/tcp
bootcamp-mongodb-sample-mongo-secondary-1   &quot;docker-entrypoint.s…&quot;   mongo-secondary     running             0.0.0.0:27018-&gt;27018/tcp, :::27018-&gt;27018/tcp                                                  ::27018-&gt;27018/tcp
</code></pre></div><h2 id="mongodbの紹介"><a href="#mongodbの紹介" class="header-anchor">#</a> MongoDBの紹介</h2> <p><a href="https://www.mongodb.com/" target="_blank" rel="noopener noreferrer">MongoDB<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>は2009年に初版がリリースされた、MongoDB社が開発しているドキュメント指向のデータベース。
MySQLなどのRDBが「行と列」からなるテーブル形式でデータを管理するのに対して、ドキュメント指向であるMongoDBには以下のjsonデータのようなオブジェクトをそのまま保存・検索ができるデータベースです。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;username&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;bob&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;address&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;street&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;123 Main Street&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;city&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Springfield&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;state&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;NY&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>いわゆる「NoSQL」としてRDBMSに比べて大量のデータを柔軟に保存し、複雑な検索クエリで比較的高速に検索・集計することができます。
さらにレプリケーションやインデックス、ドキュメント単位のロックなどRDBMSと同じような機能を持つため、スキーマレス（テーブル定義を事前に決めなくてもいい）でありながらRDBMSのような使い方ができます。</p> <p>他の特徴として、「レプリカセット」と呼ばれる仕組みで3台（奇数台）1セットの冗長構成を簡単に作れる他、「シャーディング」による負荷分散構成も簡単に構築することができます。</p> <h3 id="個人的な雑感"><a href="#個人的な雑感" class="header-anchor">#</a> 個人的な雑感</h3> <p>MongoDBはスキーマレスでありながらRDBMSのような使い方もできることから、サービス立ち上げ時に開発スピードが求められる段階において、データスキーマを含めて試行錯誤を高速に繰り返すような使われ方が話題になりました。
現在では上記のような開発手法で利用されることは少なく、主に以下のような場面で利用されます。</p> <ul><li>IoTのセンサーデータなど、insert manyなデータの格納・検索
<ul><li>データ間のリレーションや更新の一貫性があまり求められず、更新よりもデータの追加が頻発するケース</li> <li>書き込みが多く、write操作の負荷分散が必要になるケース</li></ul></li> <li>データのaggregation(集計)、地理情報などによる特殊な検索用途
<ul><li>スキーマレスを活かし、データを雑に投入して後からゴリゴリクエリを書いて集計するケース</li> <li>地理情報(geo location)検索など特殊な検索が必要になるケース</li></ul></li></ul> <p>もちろん上記のようなケースはRDBでも可能ですし、個々の機能について言えばもっと得意なDB製品は存在します。
一方でMongoDBは幅広いケースについて80点くらいを取れるような製品と言えます。</p> <h2 id="早速使ってみよう"><a href="#早速使ってみよう" class="header-anchor">#</a> 早速使ってみよう</h2> <p>何はともあれ使ってみましょう。<code>docker compose up -d</code>に成功していれば、以下のコマンドでMongoDBのコンソールが使えます。</p> <div class="language-terminal extra-class"><pre class="language-text"><code>$ docker compose exec mongo-arbiter mongo --port 27017 --host mongo-primary

MongoDB shell version v5.0.1
connecting to: mongodb://mongo-primary:27017/?compressors=disabled&amp;gssapiServiceName=mongodb
Implicit session: session { &quot;id&quot; : UUID(&quot;c90c0469-9eb0-4583-bb9d-5af4b7a3f907&quot;) }
MongoDB server version: 5.0.1

~~略~~

&gt; 
&gt; rs.initiate()
{
	&quot;info2&quot; : &quot;no configuration specified. Using a default configuration for the set&quot;,
	&quot;me&quot; : &quot;edd2f8708eef:27017&quot;,
	&quot;ok&quot; : 1
}
mongo-set:SECONDARY&gt;
mongo-set:PRIMARY&gt;
</code></pre></div><p>まずはおまじないとして<code>rs.initiate()</code>を実行しておいてください。あとで紹介します。</p> <p>とりあえず適当なデータを作成してみましょう。</p> <div class="language-terminal extra-class"><pre class="language-text"><code>mongo-set:PRIMARY&gt; use bootcamp-db
switched to db bootcamp-db
mongo-set:PRIMARY&gt; db.people.insert({name: &quot;tanaka-san&quot;, age: 22})
WriteResult({ &quot;nInserted&quot; : 1 })
mongo-set:PRIMARY&gt; db.people.insert({name: &quot;sato-san&quot;, age: 25})
WriteResult({ &quot;nInserted&quot; : 1 })

mongo-set:PRIMARY&gt; db.people.find()
{ &quot;_id&quot; : ObjectId(&quot;61065f590ea234e44f402acf&quot;), &quot;name&quot; : &quot;tanaka-san&quot;, &quot;age&quot; : 22 }
{ &quot;_id&quot; : ObjectId(&quot;61065f650ea234e44f402ad0&quot;), &quot;name&quot; : &quot;sato-san&quot;, &quot;age&quot; : 25 }
mongo-set:PRIMARY&gt;
</code></pre></div><p>RDBMSにおける「テーブル」は、MongoDBでは「collection」と呼ばれます。ここでは<code>people</code>がcollectionです。</p> <div class="language-terminal extra-class"><pre class="language-text"><code>mongo-set:PRIMARY&gt; show collections;
people
</code></pre></div><p>MySQLなどのように事前に<code>CREATE TABLE...</code>などでテーブルを作成しなくても、勝手にcollectionが作成されています。
MongoDBはスキーマレスなので、形式を問わずデータを保存できます。</p> <div class="language-terminal extra-class"><pre class="language-text"><code>mongo-set:PRIMARY&gt; db.people.insert({name: &quot;watanabe-san&quot;, age: 23, address: &quot;tokyo&quot;})
WriteResult({ &quot;nInserted&quot; : 1 })
mongo-set:PRIMARY&gt; db.people.insert({name: &quot;fujimoto-san&quot;, age: 23, address: {post: &quot;123-4567&quot;, city: &quot;tokyo&quot;}})
WriteResult({ &quot;nInserted&quot; : 1 })
mongo-set:PRIMARY&gt; db.people.insert({name: &quot;kawai-san&quot;, age: 30, address: {post: &quot;123-9876&quot;, city: &quot;tokyo&quot;}})
WriteResult({ &quot;nInserted&quot; : 1 })
</code></pre></div><p><code>db.people.find()</code> してみてください。<code>people</code> collectionの中にいろんな形式でデータが保存されています。</p> <h2 id="検索と集計-aggregation"><a href="#検索と集計-aggregation" class="header-anchor">#</a> 検索と集計(Aggregation)</h2> <p>単純な検索であれば<code>find()</code>で可能です。</p> <div class="language-terminal extra-class"><pre class="language-text"><code># 名前が`sato-san`なデータを検索
db.people.find({name: &quot;sato-san&quot;})

# ageが23以上なデータを検索
db.people.find({age: {$gte: 23}})
</code></pre></div><p><code>$gte</code>は<code>greater than or equal</code>の略で「以上」のデータを検索します。例えばageが23「未満」なデータを検索する場合は<code>$lt</code>(<code>lower than</code>)です。
詳しくはこちら =&gt; <a href="https://docs.mongodb.com/manual/reference/operator/query-comparison/" target="_blank" rel="noopener noreferrer">Comparison Query Operators<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>ネストされたデータも検索できます。</p> <div class="language-terminal extra-class"><pre class="language-text"><code>&gt; db.people.find({&quot;address.city&quot;: &quot;tokyo&quot;})
</code></pre></div><p>さらに詳しい検索や集計をする場合、強力な <a href="https://docs.mongodb.com/manual/core/aggregation-pipeline/" target="_blank" rel="noopener noreferrer">Aggregation<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 機能が使えます。</p> <p>まずは何も集計せずに検索してみましょう。</p> <div class="language-terminal extra-class"><pre class="language-text"><code>mongo-set:PRIMARY&gt; db.people.aggregate([   { $match: {&quot;address.city&quot;: &quot;tokyo&quot;} } ])
{ &quot;_id&quot; : ObjectId(&quot;62e5e5265beeb8a010811279&quot;), &quot;name&quot; : &quot;fujimoto-san&quot;, &quot;age&quot; : 23, &quot;address&quot; : { &quot;post&quot; : &quot;123-4567&quot;, &quot;city&quot; : &quot;tokyo&quot; } }
{ &quot;_id&quot; : ObjectId(&quot;62e5e52e5beeb8a01081127a&quot;), &quot;name&quot; : &quot;kawai-san&quot;, &quot;age&quot; : 30, &quot;address&quot; : { &quot;post&quot; : &quot;123-9876&quot;, &quot;city&quot; : &quot;tokyo&quot; } }
m
</code></pre></div><p>例えばここからMySQLの<code>group by</code>と同じことをするには以下のようにします。</p> <div class="language-terminal extra-class"><pre class="language-text"><code>db.people.aggregate([
  { $match: {&quot;address.city&quot;: &quot;tokyo&quot;} },
  { $group: {_id: &quot;$address.city&quot;, age_sum: {$sum: &quot;$age&quot;}} }
])
</code></pre></div><p>ここでは<code>address.city</code>が<code>tokyo</code>になってる人のデータを集計し、<code>age</code>を合計して表示しています。</p> <p>aggregationで使える機能はたくさんあるので、色々と試してみてください。=&gt; <a href="https://docs.mongodb.com/manual/reference/operator/aggregation-pipeline/" target="_blank" rel="noopener noreferrer">Aggregation Pipeline Stages<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>例えば<code>$replaceRoot</code>というpipelineを使うとどうなるか試してみてください。</p> <div class="language-terminal extra-class"><pre class="language-text"><code>db.people.aggregate([
  { $match: {&quot;address.city&quot;: &quot;tokyo&quot;} },
  { $replaceRoot: {newRoot: &quot;$address&quot;} }
])
</code></pre></div><p>他には <a href="https://docs.mongodb.com/manual/reference/operator/aggregation/unwind/" target="_blank" rel="noopener noreferrer">$unwind<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> も面白い機能です。</p> <h2 id="レプリカセット"><a href="#レプリカセット" class="header-anchor">#</a> レプリカセット</h2> <h3 id="解説"><a href="#解説" class="header-anchor">#</a> 解説</h3> <p>MongoDBでは <a href="https://docs.mongodb.com/manual/replication/" target="_blank" rel="noopener noreferrer">レプリカセット<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> と呼ばれる構成を奇数台（最小3台）で構成することができます。</p> <p>(以下画像は <a href="https://docs.mongodb.com/manual/replication/" target="_blank" rel="noopener noreferrer">https://docs.mongodb.com/manual/replication/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> より)</p> <p><img src="/bootcamp/assets/img/replica-set-primary-with-two-secondaries.bakedsvg.71ff1fec.svg" alt="replica-set-primary-with-two-secondaries"></p> <p>通常ではクライアントやアプリケーションは「Primary」になっているMongoDBに対してデータを更新します。すると更新されたデータは「Secondary」にもレプリケーションされます。
そしてレプリカセットを構成しているMongoDBはお互いに投票処理を行い、その結果によって自動的にPrimary役が決定されます。</p> <p>もしPrimaryが停止したりネットワーク的に分断された場合、残り2台のMongoDB同士で通信（画像のHeartbeat通信）を行い、2台による投票処理によって自動的に次のPrimaryが決定します。</p> <p><img src="/bootcamp/assets/img/replica-set-trigger-election.bakedsvg.a65dbacf.svg" alt="replica-set-trigger-election"></p> <p>この時元々Primaryだったホストは他2台との通信ができなくなったことで、自動的にSecondaryとなり更新クエリを受け付けなくなります。</p> <h3 id="ハンズオン"><a href="#ハンズオン" class="header-anchor">#</a> ハンズオン</h3> <p>実際にやってみましょう。今回用意したサンプルの<code>docker-compose.yml</code>では以下のホストを立ち上げています。</p> <ul><li>mongo-primary</li> <li>mongo-secondary</li> <li>mongo-arbiter</li></ul> <p>この3台でレプリカセットを構築してみましょう。</p> <div class="custom-block tip"><p class="custom-block-title">Aribiterとは？</p> <p>先ほどMongoDBのレプリカセットは最低3台の奇数台で構成されると説明しました。
これは投票処理におけるsplit brainを防ぐためですが、一方でreplicationによるデータコピーは1台で十分というケースは多々あります。
その場合3台目に1~2台目と同じスペックのサーバを用意するのは無駄です。そこで使われるのが「投票処理しか行わない」 <a href="https://www.mongodb.com/docs/manual/core/replica-set-arbiter/" target="_blank" rel="noopener noreferrer">Arbiter<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> というサーバです。</p> <p>Aribiterにはデータのreplicationが行われず、データの書き込みも読み込みもできません。レプリカセットに参加しPrimaryを選出するための投票処理しか行わないため、低スペックで安いサーバに構築することが可能です。</p> <p>このハンズオンではArbiterのホストをMongoDB clientを起動するためのホストとして利用しています。</p></div> <p>先ほどと同様に、mongo-arbiterホストから<code>mongo-primary</code>のコンソールに入り、レプリカセットの設定をします。</p> <div class="language-terminal extra-class"><pre class="language-text"><code>$ docker compose exec mongo-arbiter mongo --port 27017 --host mongo-primary
rs.reconfig( {
   _id : &quot;mongo-set&quot;,
   members: [
      { _id: 0, host: &quot;mongo-primary:27017&quot;, priority: 2 },
      { _id: 1, host: &quot;mongo-secondary:27018&quot;, priority: 1 },
      { _id: 2, host: &quot;mongo-arbiter:27019&quot;, priority: 0 }
   ]
})
</code></pre></div><p>以下のような結果が返ってくるはずです。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
	<span class="token property">&quot;ok&quot;</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
	<span class="token property">&quot;$clusterTime&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token property">&quot;clusterTime&quot;</span> <span class="token operator">:</span> Timestamp(<span class="token number">1659236394</span><span class="token punctuation">,</span> <span class="token number">2</span>)<span class="token punctuation">,</span>
		<span class="token property">&quot;signature&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
			<span class="token property">&quot;hash&quot;</span> <span class="token operator">:</span> BinData(<span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span>)<span class="token punctuation">,</span>
			<span class="token property">&quot;keyId&quot;</span> <span class="token operator">:</span> NumberLong(<span class="token number">0</span>)
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token property">&quot;operationTime&quot;</span> <span class="token operator">:</span> Timestamp(<span class="token number">1659236394</span><span class="token punctuation">,</span> <span class="token number">2</span>)
<span class="token punctuation">}</span>
</code></pre></div><p>すると残りの2台にも設定が反映され、レプリカセットが構築されます。mongo-secondaryのコンソールで<code>rs.status()</code>を実行し、設定状況を確認してみてください。</p> <div class="language-terminal extra-class"><pre class="language-text"><code>$ docker compose exec mongo-arbiter mongo --port 27018 --host mongo-secondary

mongo-set:SECONDARY&gt; rs.status() # 設定確認
</code></pre></div><p><code>&quot;ok&quot; : 1</code>などでレプリカセットの正常性を確認できます。</p> <p>以下のようにsecondaryにprimaryからデータがreplicateされていることが確認できます。</p> <div class="language-terminal extra-class"><pre class="language-text"><code>mongo-set:SECONDARY&gt; rs.secondaryOk()
mongo-set:SECONDARY&gt; use bootcamp-db
switched to db bootcamp-db
mongo-set:SECONDARY&gt; db.people.find()
{ &quot;_id&quot; : ObjectId(&quot;610674ca6c750f55ca8b580d&quot;), &quot;name&quot; : &quot;tanaka-san&quot;, &quot;age&quot; : 22 }
{ &quot;_id&quot; : ObjectId(&quot;610674ce6c750f55ca8b580e&quot;), &quot;name&quot; : &quot;sato-san&quot;, &quot;age&quot; : 25 }
{ &quot;_id&quot; : ObjectId(&quot;610674d46c750f55ca8b580f&quot;), &quot;name&quot; : &quot;watanabe-san&quot;, &quot;age&quot; : 23, &quot;address&quot; : &quot;tokyo&quot; }
{ &quot;_id&quot; : ObjectId(&quot;610674d86c750f55ca8b5810&quot;), &quot;name&quot; : &quot;fujimoto-san&quot;, &quot;age&quot; : 23, &quot;address&quot; : { &quot;post&quot; : &quot;123-4567&quot;, &quot;city&quot; : &quot;tokyo&quot; } }
{ &quot;_id&quot; : ObjectId(&quot;610674dc6c750f55ca8b5811&quot;), &quot;name&quot; : &quot;kawai-san&quot;, &quot;age&quot; : 30, &quot;address&quot; : { &quot;post&quot; : &quot;123-9876&quot;, &quot;city&quot; : &quot;tokyo&quot; } }
</code></pre></div><p>ここで例えばPrimaryのMongoDBを落としてみましょう</p> <div class="language-terminal extra-class"><pre class="language-text"><code>$ docker compose stop mongo-primary
[+] Running 1/1
 ⠿ Container bootcamp-mongodb-sample-mongo-primary-1  Stopped                                                                                  11.1s
$ docker compose ps
NAME                                        COMMAND                  SERVICE             STATUS              PORTS
bootcamp-mongodb-sample-mongo-arbiter-1     &quot;docker-entrypoint.s…&quot;   mongo-arbiter       running             0.0.0.0:27019-&gt;27019/tcp, :::27019-&gt;27019/tcp
bootcamp-mongodb-sample-mongo-primary-1     &quot;docker-entrypoint.s…&quot;   mongo-primary       exited (137)
bootcamp-mongodb-sample-mongo-secondary-1   &quot;docker-entrypoint.s…&quot;   mongo-secondary     running             0.0.0.0:27018-&gt;27018/tcp, :::27018-&gt;27018/tcp                                                                     :::27018-&gt;27018/tcp
</code></pre></div><p>するとSecondaryのプロンプトが<code>mongo-set:PRIMARY&gt;</code>に変わるのが確認できます。</p> <div class="language-terminal extra-class"><pre class="language-text"><code>mongo-set:SECONDARY&gt;
mongo-set:PRIMARY&gt;
mongo-set:PRIMARY&gt;
mongo-set:PRIMARY&gt;
</code></pre></div><p><code>rs.status()</code>をもう一度Secondaryで叩いてみてください。先ほどとどう変わったでしょうか。</p> <div><hr> <span>CC BY-SA Licensed | Copyright (c) 2022, Internet Initiative Japan Inc.</span></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/iij/bootcamp/edit/master/src/database/mongodb/README.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">8/1/2022, 2:53:47 AM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/bootcamp/assets/js/app.50837537.js" defer></script><script src="/bootcamp/assets/js/2.46b7ffd3.js" defer></script><script src="/bootcamp/assets/js/20.0acbd8cd.js" defer></script><script src="/bootcamp/assets/js/14.9babec04.js" defer></script><script src="/bootcamp/assets/js/13.b665defe.js" defer></script>
  </body>
</html>
