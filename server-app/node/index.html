<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Node.jsでWebアプリを作る | IIJ Bootcamp</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Node.jsを使ったアプリケーション開発のハンズオンです">
    
    <link rel="preload" href="/bootcamp/assets/css/0.styles.a3856d16.css" as="style"><link rel="preload" href="/bootcamp/assets/js/app.e62409ba.js" as="script"><link rel="preload" href="/bootcamp/assets/js/2.f4bad7c4.js" as="script"><link rel="preload" href="/bootcamp/assets/js/24.6fb96394.js" as="script"><link rel="preload" href="/bootcamp/assets/js/11.9b671749.js" as="script"><link rel="preload" href="/bootcamp/assets/js/10.d0e8d2eb.js" as="script"><link rel="prefetch" href="/bootcamp/assets/js/12.23918dce.js"><link rel="prefetch" href="/bootcamp/assets/js/13.d63900af.js"><link rel="prefetch" href="/bootcamp/assets/js/14.87c32f45.js"><link rel="prefetch" href="/bootcamp/assets/js/15.3fe368a4.js"><link rel="prefetch" href="/bootcamp/assets/js/16.370acae5.js"><link rel="prefetch" href="/bootcamp/assets/js/17.a914052f.js"><link rel="prefetch" href="/bootcamp/assets/js/18.b1b2c3c5.js"><link rel="prefetch" href="/bootcamp/assets/js/19.6af8b8d3.js"><link rel="prefetch" href="/bootcamp/assets/js/20.0d6e5578.js"><link rel="prefetch" href="/bootcamp/assets/js/21.3838ef41.js"><link rel="prefetch" href="/bootcamp/assets/js/22.43ed6a81.js"><link rel="prefetch" href="/bootcamp/assets/js/23.ee5c19d2.js"><link rel="prefetch" href="/bootcamp/assets/js/25.f5c88938.js"><link rel="prefetch" href="/bootcamp/assets/js/26.17e3fe7d.js"><link rel="prefetch" href="/bootcamp/assets/js/27.aa1aa3f4.js"><link rel="prefetch" href="/bootcamp/assets/js/28.85ffe65a.js"><link rel="prefetch" href="/bootcamp/assets/js/29.ed613e43.js"><link rel="prefetch" href="/bootcamp/assets/js/3.9d79fd9e.js"><link rel="prefetch" href="/bootcamp/assets/js/30.20aa12c0.js"><link rel="prefetch" href="/bootcamp/assets/js/31.7ff5984f.js"><link rel="prefetch" href="/bootcamp/assets/js/32.8b1ba981.js"><link rel="prefetch" href="/bootcamp/assets/js/33.f13650d1.js"><link rel="prefetch" href="/bootcamp/assets/js/34.2183668a.js"><link rel="prefetch" href="/bootcamp/assets/js/35.534f79ac.js"><link rel="prefetch" href="/bootcamp/assets/js/36.c0dca6c8.js"><link rel="prefetch" href="/bootcamp/assets/js/37.6dc23be4.js"><link rel="prefetch" href="/bootcamp/assets/js/38.e9712a0e.js"><link rel="prefetch" href="/bootcamp/assets/js/39.5ef3259f.js"><link rel="prefetch" href="/bootcamp/assets/js/4.58ad8900.js"><link rel="prefetch" href="/bootcamp/assets/js/40.0c5365a6.js"><link rel="prefetch" href="/bootcamp/assets/js/41.7e4d9022.js"><link rel="prefetch" href="/bootcamp/assets/js/42.a948d78b.js"><link rel="prefetch" href="/bootcamp/assets/js/43.3c496ced.js"><link rel="prefetch" href="/bootcamp/assets/js/5.ba2bbda6.js"><link rel="prefetch" href="/bootcamp/assets/js/6.8d49a5c0.js"><link rel="prefetch" href="/bootcamp/assets/js/7.270b3a08.js"><link rel="prefetch" href="/bootcamp/assets/js/8.51717c2f.js"><link rel="prefetch" href="/bootcamp/assets/js/9.0947e6ee.js">
    <link rel="stylesheet" href="/bootcamp/assets/css/0.styles.a3856d16.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/bootcamp/" class="home-link router-link-active"><!----> <span class="site-name">IIJ Bootcamp</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/iij/bootcamp" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/iij/bootcamp" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Node.jsでWebアプリを作る</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/bootcamp/server-app/node/#下準備" class="sidebar-link">下準備</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bootcamp/server-app/node/#dockerコンテナの立ち上げ方" class="sidebar-link">dockerコンテナの立ち上げ方</a></li></ul></li><li><a href="/bootcamp/server-app/node/#node-js-とは" class="sidebar-link">Node.js とは</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bootcamp/server-app/node/#c10k-問題" class="sidebar-link">C10K 問題</a></li><li class="sidebar-sub-header"><a href="/bootcamp/server-app/node/#イベント駆動" class="sidebar-link">イベント駆動</a></li></ul></li><li><a href="/bootcamp/server-app/node/#first-step" class="sidebar-link">first step</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bootcamp/server-app/node/#簡単な解説" class="sidebar-link">簡単な解説</a></li></ul></li><li><a href="/bootcamp/server-app/node/#npm" class="sidebar-link">NPM</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/bootcamp/server-app/node/#express-アプリケーションの作成" class="sidebar-link">express アプリケーションの作成</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/bootcamp/server-app/node/#データベースアクセス" class="sidebar-link">データベースアクセス</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/bootcamp/server-app/node/#最後に" class="sidebar-link">最後に</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><table><tr><td>このハンズオンでやること</td><td>Node.jsを使ったアプリケーション開発のハンズオンです</td></tr> <tr><td>想定時間</td><td>1h</td></tr> <tr><td>前提知識・用語</td><td>JavaScript</td></tr></table> <h1 id="page-frontmatter-title"><a href="#page-frontmatter-title" class="header-anchor">#</a> Node.jsでWebアプリを作る</h1> <h2 id="下準備"><a href="#下準備" class="header-anchor">#</a> 下準備</h2> <h3 id="dockerコンテナの立ち上げ方"><a href="#dockerコンテナの立ち上げ方" class="header-anchor">#</a> dockerコンテナの立ち上げ方</h3> <p>以下のコマンドでdockerコンテナを立ち上げてログインしてください。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ docker run --name bootcamp-node --rm -it regunorf/bootcamp-node <span class="token function">bash</span>
</code></pre></div><p>同じdockerコンテナに複数のターミナルを接続するには以下のようにします。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ docker <span class="token builtin class-name">exec</span> -it bootcamp-node <span class="token function">bash</span>
</code></pre></div><p>ハンズオンでは同じコンテナに複数ターミナルでログインしていることを前提に記述している部分があるので、上記のように複数ターミナルを開いておいてください。</p> <h2 id="node-js-とは"><a href="#node-js-とは" class="header-anchor">#</a> Node.js とは</h2> <p>Node.js はサーバサイドで動作するJavaScriptのエンジンです。従来ブラウザ上でWebページを動的に動かすために使われていたJavaScriptを、ブラウザ上だけでなくサーバ上でも動かすためNode.jsなどが生まれました。</p> <p>ブラウザ以外で動作するJavaScriptの実装としてはほかにもRhinoなどがあります。
最近ではTypeScriptがそのまま動作する <a href="https://github.com/denoland/deno" target="_blank" rel="noopener noreferrer">Deno<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> も登場しています。</p> <p>Node.jsの特徴としては、何よりもまず実装全体がイベント駆動で動作するという点です。これを説明するにはまずC10K問題から話をする必要があります。少し長くなりますが、Node.jsの立ち位置を知るためには必要なので簡単に解説します。</p> <h3 id="c10k-問題"><a href="#c10k-問題" class="header-anchor">#</a> C10K 問題</h3> <p>Webサーバーは当然の事ながらたくさんのユーザーからのアクセスに答えて、HTMLを返したりサーバーサイドのプログラム（C言語やJavaやRubyなどで書かれた）を動かしてレスポンスを返す必要があります。その際に１つ１つ順番に処理していたのではキリがないため、たくさんのアクセスを並列に処理する必要があります。</p> <p>プログラムを並列に動かすやり方はいくつかありますが、たとえばApacheではスレッド・プロセスベースの並列処理が主要でした。
1つのリクエストに対してOSのプロセスを立ち上げ、それぞれのプロセスで別々のプログラムを動かすことで大量のリクエストをさばくことができます。
しかし1つのサーバ上で起動できるプロセスの数には限度があります。そのためたとえば1万人の同時リクエストを1台のサーバで（処理能力に余裕があったとしても）さばけないのが問題となりました。
プロセスを起動すること自体のオーバーヘッドも無視できません。</p> <p>インターネットが普及して利用者が増えたことや、IoTなど大量の小さなデータを送信する機会が増えたことで、より効率の良い方法が求められました。</p> <h3 id="イベント駆動"><a href="#イベント駆動" class="header-anchor">#</a> イベント駆動</h3> <p>C10K 問題に対してNode.jsは「イベントループ」と「ノンブロッキングI/O」の２つの仕様で解決しています。下の図はイベントループとノンブロッキングI/Oを組み合わせたNode.jsにおける並行処理の概念図です。</p> <p><img src="/bootcamp/assets/img/event-loop.08b77931.png" alt="イベントループ" title="イベントループ"></p> <p>まずNode.jsは基本的にシングルスレッドで動作します。Node.jsは動作中常にイベントループと呼ばれる無限ループで「diskへの書き込みが終わった」「リクエストを受けとった」のようなイベントの発生を監視しています。そして検知したイベントに対して指定されたcallback関数を実行します。</p> <p>このようにイベントの発生に対して処理を行うプログラムを「イベント駆動型」と呼びます。</p> <p>またNode.jsにおいて、diskへの書き込みやネットワークアクセスなど時間のかかる処理は全て非同期に実行されます。つまりdiskへの書き込みを始めた時点でプログラムは他の処理を始め、書き込みが行われている間別の処理を実行します。
そして「書き込みが完了した」というイベントが発生すると続きの処理を行います。</p> <p>この非同期な処理はノンブロッキングIOと呼ばれます。</p> <p>このようにNode.jsは「イベントループ」と「ノンブロッキングI/O」の２つによってシングルスレッドで多くのリクエストを並行して処理することで、C10K問題におけるスレッドの割り当てコストを解決しています。</p> <p>ただし逆に気をつけないといけない点は、Node.jsはシングルスレッドで動作するため、CPUを多く使うような重たい処理を行うとアプリケーション全体が遅くなってしまうことです。
その点スレッドプログラミングでは、あるスレッドがどれだけ重くなっても他のスレッドには影響がないためアプリケーション全体のパフォーマンスが落ちることはありません。</p> <h2 id="first-step"><a href="#first-step" class="header-anchor">#</a> first step</h2> <p>まずは簡単なWebサーバを作ってみましょう。</p> <p>下準備で立ち上げたdockerに入り、<code>bootcamp-node</code>というディレクトリを作成してください。
そしてそのディレクトリ内に以下のファイルを<code>app.js</code>という名前で作成してください。</p> <div class="language- extra-class"><pre class="language-text"><code>mkdir bootcamp-node
cd bootcamp-node/
vi app.js
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> hostname <span class="token operator">=</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token number">3000</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/plain'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'Hello World\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> hostname<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Server running at http://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>hostname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>ファイルを作成したら以下のコマンドでサーバーを起動します。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ node app.js
</code></pre></div><p><code>Server running at http://127.0.0.1:3000/</code>というメッセージが表示されれば無事にサーバーが立ち上がっています。curlコマンドでリクエストを投げてみましょう。<code>Hello World</code> が表示されたはずです。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">curl</span> http://127.0.0.1:3000/
Hello World
</code></pre></div><h3 id="簡単な解説"><a href="#簡単な解説" class="header-anchor">#</a> 簡単な解説</h3> <p>この短いコードでもNode.jsの特徴が出ています。コード中の</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/plain'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'Hello World\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>の部分は<code>createServer</code>というメソッドにcallbackとして無名関数を渡すことで、リクエストが来た際の動作を定義します。今回は<code>Hello World</code>という文字列を返すようにしました。</p> <p>このようにNode.jsでは基本的にcallback関数を指定することでサーバーの挙動を定義して行きます。</p> <h2 id="npm"><a href="#npm" class="header-anchor">#</a> NPM</h2> <p>もう少し複雑なサーバーを作りたいところですが、素のNode.jsだと色々と機能が足りないので<code>express</code>という定番ライブラリを導入します。<code>express</code>はWebサーバーを作る際の基本的な機能を提供してくれる他、pluginとして様々な機能を組み合わせることができます。</p> <p>Node.jsで追加ライブラリを導入するには<code>NPM (node package manager)</code>と呼ばれるパッケージマネージャを使います。npmはNode.jsをインストールすると自動的に追加されます。</p> <p>まずは<code>bootcamp-node</code>ディレクトリ以下で<code>init</code>コマンドを実行し、npmで管理するアプリケーションの定義を作成しましょう。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">npm</span> init
</code></pre></div><p>色々聞かれますが全てenterで構いません。最後まで行くと<code>package.json</code>というファイルが作成されます。
npmはパッケージマネージャですが、このようにアプリケーションのメインファイルを指定したり<code>npm script</code>と呼ばれるコマンドを登録できるなど、Node.jsアプリケーション全体の管理もしてくれます。</p> <p>以下のコマンドでアプリケーションに<code>express</code>を追加してみましょう。</p> <p>必要であればプロキシを設定してください。</p> <div class="language- extra-class"><pre class="language-text"><code>npm -g config set proxy http://proxy.iiji.jp:8080
npm -g config set https-proxy http://proxy.iiji.jp:8080
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">npm</span> <span class="token function">install</span> express
</code></pre></div><p>すると<code>node_modules</code>というディレクトリ内に<code>express</code>と<code>express</code>が依存するライブラリの本体がダウンロードされ、アプリケーションから使えるようになります。</p> <p>また<code>package.json</code>を見ると<code>dependencies</code>に<code>express</code>が追加されているのが分かります。このように依存するライブラリが<code>package.json</code>で一元管理されるため、他の場所でアプリケーションを動かそうとする場合に依存ライブラリを簡単に導入することができます。</p> <p>npmの詳しい使い方は「npm 入門」などで検索したサイトなどを見てみてください（<a href="https://docs.npmjs.com/cli-documentation/" target="_blank" rel="noopener noreferrer">公式のドキュメント<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>は非常に分かりにくいです・・・）。</p> <h2 id="express-アプリケーションの作成"><a href="#express-アプリケーションの作成" class="header-anchor">#</a> express アプリケーションの作成</h2> <p>npmでexpressを導入できたので、簡単なアプリケーションを作成してみましょう。<code>express.js</code>という名前で以下のようなファイルを作成してください。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/bootcamp1'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'BOOTCAMP 1\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/bootcamp2'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'BOOTCAMP 2\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/create'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Create Bootcamp\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>修正したら先ほどと同じように<code>node express.js</code>で起動しましょう。今度はアクセスするパスやメソッドによって実行されるcallback関数が変わります。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token number">127.0</span>.0.1:3000/bootcamp1
BOOTCAMP <span class="token number">1</span>
$ <span class="token function">curl</span> <span class="token number">127.0</span>.0.1:3000/bootcamp2
BOOTCAMP <span class="token number">2</span>
$ <span class="token function">curl</span> -X POST <span class="token number">127.0</span>.0.1:3000/create
Create Bootcamp
</code></pre></div><p>さきほどよりも少ないコードで多くの機能が実現できました。expressは人気のフレームワークで様々なプラグインやラップしたフレームワークが作られています。
もし興味があれば調べてみてください。</p> <h2 id="データベースアクセス"><a href="#データベースアクセス" class="header-anchor">#</a> データベースアクセス</h2> <p>最後にデータベースへのアクセスを実現してみましょう。データベースにはMongoDBを使用してみます。
（最近はあまり言われませんが、かつてはMongoDB・Express・AngularJS・Node.jsを合わせて「MEANスタック」と呼ばれたりしていました。）</p> <p>事前準備で作られたvagrantやdockerコンテナにはmongodbが既にinstallされています。以下のコマンドでMongoDBを起動してください。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">service</span> mongodb start
</code></pre></div><p>node.jsからMongoDBにアクセスするために<code>mongoose</code>というライブラリを使います。
先ほどと同じようにnpmでインストールしましょう。ついでにjsonをパースするための<code>body-parser</code>も追加します。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">npm</span> <span class="token function">install</span> mongoose body-parser
</code></pre></div><p>今回は<code>peoples</code>というテーブルに<code>_id</code>と<code>name</code>属性をもつドキュメントを作成し、その一覧を取得するAPIを作ってみます。</p> <p>まずはmongooseを使うためにmodelの定義を行います。以下の内容を<code>model.js</code>として作成してください。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongoose'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Schema <span class="token operator">=</span> mongoose<span class="token punctuation">.</span>Schema<span class="token punctuation">;</span>

<span class="token comment">// Peopleの定義</span>
<span class="token keyword">const</span> People <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> String<span class="token punctuation">,</span> require<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// MongoDBへの接続</span>
mongoose<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">'mongodb://127.0.0.1:27017/bootcamp'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> useNewUrlParser<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// モデルをエクスポート</span>
exports<span class="token punctuation">.</span>People <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'People'</span><span class="token punctuation">,</span> People<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>次に<code>mongo.js</code>を以下のように作成してAPIを定義しましょう。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> bodyParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'body-parser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> model <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./model'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bodyParser<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{</span> extended<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bodyParser<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/peoples'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  model<span class="token punctuation">.</span>People<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> peoples</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>peoples<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/peoples'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> people <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">model<span class="token punctuation">.</span>People</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  people<span class="token punctuation">.</span>name <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>name<span class="token punctuation">;</span>

  people<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> message<span class="token operator">:</span> <span class="token string">'created!\n'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>node mongo.js</code>でサーバーを起動してください。そして別のウィンドウから以下のようにcurlでリクエストを投げることができます。</p> <p><code>name=Alice</code>なデータを作成</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">curl</span> -X POST -H <span class="token string">'Content-Type:application/json'</span> -d <span class="token string">'{&quot;name&quot;: &quot;Alice&quot;}'</span> <span class="token number">127.0</span>.0.1:3000/peoples

<span class="token punctuation">{</span><span class="token string">&quot;message&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;created!&quot;</span><span class="token punctuation">}</span>
</code></pre></div><p>一覧で取得</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token number">127.0</span>.0.1:3000/peoples

<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&quot;_id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;5cf3f435a47f5c0cdb9023a6&quot;</span>,<span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;Alice&quot;</span>,<span class="token string">&quot;__v&quot;</span>:0<span class="token punctuation">}</span><span class="token punctuation">]</span>
</code></pre></div><h2 id="最後に"><a href="#最後に" class="header-anchor">#</a> 最後に</h2> <p>ここまで簡単なNode.jsを使ったAPIサーバーの実装を行ってみました。なんとなくNode.jsのやり方が掴めたでしょうか。</p> <p>ただし実際のプロダクトで使用する場合は、TypeScriptを使って開発したりAPIのcallback関数を別ファイルにする、ロギングの仕組みを整えるなど様々なことを考える必要があります。</p> <p>今回の内容は本当に基礎的なものでしかないため、もし興味があれば様々なフレームワークや実装例を調べてみてください。</p> <div><hr> <span>CC BY-SA Licensed | Copyright (c) 2020, Internet Initiative Japan Inc.</span></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/iij/bootcamp/edit/master/src/server-app/node/README.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">8/3/2021, 1:23:34 AM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/bootcamp/assets/js/app.e62409ba.js" defer></script><script src="/bootcamp/assets/js/2.f4bad7c4.js" defer></script><script src="/bootcamp/assets/js/24.6fb96394.js" defer></script><script src="/bootcamp/assets/js/11.9b671749.js" defer></script><script src="/bootcamp/assets/js/10.d0e8d2eb.js" defer></script>
  </body>
</html>
