<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>並行・並列処理ハンズオン | IIJ Bootcamp</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="主にWebサービスにおける並行・並列処理の基本や注意点などを学びます">
    
    <link rel="preload" href="/bootcamp/assets/css/0.styles.095a7d7e.css" as="style"><link rel="preload" href="/bootcamp/assets/js/app.1abd0c46.js" as="script"><link rel="preload" href="/bootcamp/assets/js/2.ef45b232.js" as="script"><link rel="preload" href="/bootcamp/assets/js/25.f3205fa3.js" as="script"><link rel="preload" href="/bootcamp/assets/js/18.08feb914.js" as="script"><link rel="preload" href="/bootcamp/assets/js/17.cfaf8c29.js" as="script"><link rel="prefetch" href="/bootcamp/assets/js/10.4ee64958.js"><link rel="prefetch" href="/bootcamp/assets/js/11.8a1b9020.js"><link rel="prefetch" href="/bootcamp/assets/js/12.2a2dcb14.js"><link rel="prefetch" href="/bootcamp/assets/js/13.89775596.js"><link rel="prefetch" href="/bootcamp/assets/js/14.28557c7a.js"><link rel="prefetch" href="/bootcamp/assets/js/15.75a2eb60.js"><link rel="prefetch" href="/bootcamp/assets/js/16.52f38cb3.js"><link rel="prefetch" href="/bootcamp/assets/js/19.f4cabaa4.js"><link rel="prefetch" href="/bootcamp/assets/js/20.fb716ec8.js"><link rel="prefetch" href="/bootcamp/assets/js/21.5aee11d9.js"><link rel="prefetch" href="/bootcamp/assets/js/22.f77c86f6.js"><link rel="prefetch" href="/bootcamp/assets/js/23.708d876b.js"><link rel="prefetch" href="/bootcamp/assets/js/24.886f15ea.js"><link rel="prefetch" href="/bootcamp/assets/js/26.53d56b7b.js"><link rel="prefetch" href="/bootcamp/assets/js/27.f9e1e538.js"><link rel="prefetch" href="/bootcamp/assets/js/28.b240254e.js"><link rel="prefetch" href="/bootcamp/assets/js/29.f50d8ad3.js"><link rel="prefetch" href="/bootcamp/assets/js/3.dba2fe97.js"><link rel="prefetch" href="/bootcamp/assets/js/30.5c8e6cc2.js"><link rel="prefetch" href="/bootcamp/assets/js/31.4e0d7c83.js"><link rel="prefetch" href="/bootcamp/assets/js/32.f5519b1f.js"><link rel="prefetch" href="/bootcamp/assets/js/33.42033d00.js"><link rel="prefetch" href="/bootcamp/assets/js/34.cd9ad79c.js"><link rel="prefetch" href="/bootcamp/assets/js/35.c27d1ac9.js"><link rel="prefetch" href="/bootcamp/assets/js/36.a7d38a0b.js"><link rel="prefetch" href="/bootcamp/assets/js/37.3e3afdf3.js"><link rel="prefetch" href="/bootcamp/assets/js/38.b3990f84.js"><link rel="prefetch" href="/bootcamp/assets/js/39.68203f20.js"><link rel="prefetch" href="/bootcamp/assets/js/4.af3fd79f.js"><link rel="prefetch" href="/bootcamp/assets/js/40.dedbe1d3.js"><link rel="prefetch" href="/bootcamp/assets/js/41.edc244a4.js"><link rel="prefetch" href="/bootcamp/assets/js/42.feb19b44.js"><link rel="prefetch" href="/bootcamp/assets/js/43.dfd70171.js"><link rel="prefetch" href="/bootcamp/assets/js/44.be75dcef.js"><link rel="prefetch" href="/bootcamp/assets/js/45.58bc5cd7.js"><link rel="prefetch" href="/bootcamp/assets/js/46.4d1f3a96.js"><link rel="prefetch" href="/bootcamp/assets/js/47.64663700.js"><link rel="prefetch" href="/bootcamp/assets/js/48.a8993b69.js"><link rel="prefetch" href="/bootcamp/assets/js/49.3216ccd1.js"><link rel="prefetch" href="/bootcamp/assets/js/5.0f4bcd1c.js"><link rel="prefetch" href="/bootcamp/assets/js/50.d558535a.js"><link rel="prefetch" href="/bootcamp/assets/js/51.ebcc0c61.js"><link rel="prefetch" href="/bootcamp/assets/js/52.9232dfd3.js"><link rel="prefetch" href="/bootcamp/assets/js/53.9430d4af.js"><link rel="prefetch" href="/bootcamp/assets/js/54.cfc31c20.js"><link rel="prefetch" href="/bootcamp/assets/js/55.a57ee7d9.js"><link rel="prefetch" href="/bootcamp/assets/js/56.03ab3916.js"><link rel="prefetch" href="/bootcamp/assets/js/57.d7be5679.js"><link rel="prefetch" href="/bootcamp/assets/js/58.82cb18d4.js"><link rel="prefetch" href="/bootcamp/assets/js/59.d6774aca.js"><link rel="prefetch" href="/bootcamp/assets/js/6.efde655b.js"><link rel="prefetch" href="/bootcamp/assets/js/60.c2d03315.js"><link rel="prefetch" href="/bootcamp/assets/js/61.7c8fdf18.js"><link rel="prefetch" href="/bootcamp/assets/js/62.679d4ceb.js"><link rel="prefetch" href="/bootcamp/assets/js/63.4d5cb16e.js"><link rel="prefetch" href="/bootcamp/assets/js/7.a524cb00.js"><link rel="prefetch" href="/bootcamp/assets/js/8.e7fbf1be.js"><link rel="prefetch" href="/bootcamp/assets/js/9.09347b55.js">
    <link rel="stylesheet" href="/bootcamp/assets/css/0.styles.095a7d7e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/bootcamp/" class="home-link router-link-active"><!----> <span class="site-name">IIJ Bootcamp</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/iij/bootcamp" target="_blank" rel="noopener noreferrer" class="repo-link">
      GitHub
      <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/iij/bootcamp" target="_blank" rel="noopener noreferrer" class="repo-link">
      GitHub
      <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>並行・並列処理ハンズオン</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/bootcamp/server-app/concurrent/#環境準備" class="sidebar-link">環境準備</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/bootcamp/server-app/concurrent/#この資料の約束" class="sidebar-link">この資料の約束</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/bootcamp/server-app/concurrent/#このハンズオンの目的" class="sidebar-link">このハンズオンの目的</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/bootcamp/server-app/concurrent/#ハンズオン" class="sidebar-link">ハンズオン</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bootcamp/server-app/concurrent/#簡単な並行処理サンプル" class="sidebar-link">簡単な並行処理サンプル</a></li><li class="sidebar-sub-header"><a href="/bootcamp/server-app/concurrent/#メモリ空間の共有とレースコンディション" class="sidebar-link">メモリ空間の共有とレースコンディション</a></li><li class="sidebar-sub-header"><a href="/bootcamp/server-app/concurrent/#排他制御・アトミック処理" class="sidebar-link">排他制御・アトミック処理</a></li></ul></li><li><a href="/bootcamp/server-app/concurrent/#最後に" class="sidebar-link">最後に</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><table><tr><td>このハンズオンでやること</td><td>主にWebサービスにおける並行・並列処理の基本や注意点などを学びます</td></tr> <tr><td>想定時間</td><td>1.5h</td></tr> <tr><td>前提知識・用語</td><td></td></tr></table> <h1 id="page-frontmatter-title"><a href="#page-frontmatter-title" class="header-anchor">#</a> 並行・並列処理ハンズオン</h1> <h2 id="環境準備"><a href="#環境準備" class="header-anchor">#</a> 環境準備</h2> <p>以下のdockerコマンドでコンソールを取得してください。</p> <div class="language-terminal line-numbers-mode"><pre class="language-text"><code>$ docker pull iijrfujimoto/bootcamp_concurrent
$ mkdir bootcamp_work  # 作業用のディレクトリ。名前はなんでもいい
$ cd bootcamp_work
$ docker run --name bootcamp_concurrent -p 8000:8000 -v $PWD:/work --rm -it iijrfujimoto/bootcamp_concurrent /bin/bash
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="この資料の約束"><a href="#この資料の約束" class="header-anchor">#</a> この資料の約束</h2> <p>ターミナルでの実行例を示す際、以下のように<code>$</code>で始まっている場合はdockerを起動しているホスト側で実行するコマンドを示します。</p> <div class="language-terminal line-numbers-mode"><pre class="language-text"><code>$ curl localhost:8000
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>以下のように<code>root@40e566b8e23e</code>などで示されている場合はdockerコンテナ上で実行するコマンドであることを示します。</p> <div class="language-terminal line-numbers-mode"><pre class="language-text"><code>root@0dd4d9fad678:/work# python3 main.py
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="このハンズオンの目的"><a href="#このハンズオンの目的" class="header-anchor">#</a> このハンズオンの目的</h2> <p>このハンズオンでは、Webアプリケーションの実装に欠かせない「並行処理」について取り扱います。</p> <p>プログラミングにおいて、同時に複数の処理を行う「並行処理」は複雑で実装が難しいものです。
それは・・・（実装が難しい理由を本から引用）</p> <p>しかしユーザからの多数のリクエストに対応するため、Webアプリケーションに並行処理の実装は必須です。
昨今ではライブラリやフレームワークが発達し並行処理を意識しなくてもWebアプリケーションを作ることが可能ですが、
並行処理の勘所を理解せずに使うと思わぬバグや事故を起こす可能性があります。</p> <p>このハンズオンではWebアプリケーションにおける並行処理実装の初歩的な注意点を紹介し、不具合を起こさないための知識を得てもらう目的としています。</p> <div class="custom-block tip"><p class="custom-block-title">並行処理と並列処理</p> <p>並行処理(concurrent processing)と並列処理(parallel processing)は似た言葉ですが異なる動作を指す言葉です。</p> <ul><li>並行処理: ある時間内に複数のタスクを処理すること</li> <li>並列処理: 複数のタスクを「同時に」処理すること</li></ul> <p>「並行処理」と言う場合はある時間内に複数タスクを実行できればいいので、実行するタスクを小まめに切り替えながら処理する動作も含みます。
一方で「並列処理」の場合は複数のCPUコアによって全く同時に複数タスクを処理することを指します。</p> <p>（参考: <a href="https://go.dev/blog/waza-talk" target="_blank" rel="noopener noreferrer">Concurrency is not parallelism<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）</p></div> <h2 id="ハンズオン"><a href="#ハンズオン" class="header-anchor">#</a> ハンズオン</h2> <h3 id="簡単な並行処理サンプル"><a href="#簡単な並行処理サンプル" class="header-anchor">#</a> 簡単な並行処理サンプル</h3> <p>まずはPythonで簡単なWebサーバを書いてみましょう。</p> <p>vscode等を利用して作業用ディレクトリ(<code>bootcamp_work</code>)でPythonコードを書いていきましょう。</p> <div class="language-termianl line-numbers-mode"><pre class="language-text"><code>$ vim main.py
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> http<span class="token punctuation">.</span>server <span class="token keyword">import</span> BaseHTTPRequestHandler<span class="token punctuation">,</span> ThreadingHTTPServer
<span class="token keyword">import</span> time

PORT <span class="token operator">=</span> <span class="token number">8000</span>

<span class="token keyword">class</span> <span class="token class-name">SimpleHelloHandler</span><span class="token punctuation">(</span>BaseHTTPRequestHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">def</span> <span class="token function">do_GET</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'start processing path = {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>

    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token comment"># 何かの処理</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'end processing path = {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>

    self<span class="token punctuation">.</span>send_response<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>send_header<span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/plain; charset=utf-8'</span><span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>end_headers<span class="token punctuation">(</span><span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>wfile<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">b'Hello simple server!\n'</span><span class="token punctuation">)</span>

<span class="token keyword">with</span> ThreadingHTTPServer<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> PORT<span class="token punctuation">)</span><span class="token punctuation">,</span> SimpleHelloHandler<span class="token punctuation">)</span> <span class="token keyword">as</span> httpd<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;serving at port&quot;</span><span class="token punctuation">,</span> PORT<span class="token punctuation">)</span>
    httpd<span class="token punctuation">.</span>serve_forever<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>保存したら、dockerコンテナ内からサーバを起動してみます。</p> <div class="language-terminal line-numbers-mode"><pre class="language-text"><code>root@0dd4d9fad678:/work# python3 main.py
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>手元のホストから以下のようにcurlで叩いてみましょう。
「Hello simple server!」と返ってくれば成功です。</p> <div class="language-terminal line-numbers-mode"><pre class="language-text"><code>$ curl localhost:8000
Hello simple server!
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>リクエストした直後、サーバー側のログに<code>start processing path = /</code>と表示されたことを覚えておいてください。</p> <h3 id="メモリ空間の共有とレースコンディション"><a href="#メモリ空間の共有とレースコンディション" class="header-anchor">#</a> メモリ空間の共有とレースコンディション</h3> <h4 id="サンプルコード"><a href="#サンプルコード" class="header-anchor">#</a> サンプルコード</h4> <p>先ほどのプログラムを少し改造して、今までのアクセス数をカウントできるようにしてみましょう。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> http<span class="token punctuation">.</span>server <span class="token keyword">import</span> BaseHTTPRequestHandler<span class="token punctuation">,</span> ThreadingHTTPServer
<span class="token keyword">import</span> time

PORT <span class="token operator">=</span> <span class="token number">8000</span>

<span class="token keyword">class</span> <span class="token class-name">SimpleHelloHandler</span><span class="token punctuation">(</span>BaseHTTPRequestHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>
    request_total <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">def</span> <span class="token function">count_and_do_something</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        t <span class="token operator">=</span> SimpleHelloHandler<span class="token punctuation">.</span>request_total
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'start processing path = {}, before request count = {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">)</span>

        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>  <span class="token comment"># 何かの処理</span>

        t <span class="token operator">=</span> t <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'end processing path = {}, after request count = {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">)</span>

        SimpleHelloHandler<span class="token punctuation">.</span>request_total <span class="token operator">=</span> t

    <span class="token keyword">def</span> <span class="token function">do_GET</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>count_and_do_something<span class="token punctuation">(</span>self<span class="token punctuation">.</span>path<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>send_response<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>send_header<span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/plain; charset=utf-8'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>end_headers<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>wfile<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">b'Hello! request count=%a\n'</span> <span class="token operator">%</span> SimpleHelloHandler<span class="token punctuation">.</span>request_total<span class="token punctuation">)</span>

<span class="token keyword">with</span> ThreadingHTTPServer<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> PORT<span class="token punctuation">)</span><span class="token punctuation">,</span> SimpleHelloHandler<span class="token punctuation">)</span> <span class="token keyword">as</span> httpd<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;serving at port&quot;</span><span class="token punctuation">,</span> PORT<span class="token punctuation">)</span>
    httpd<span class="token punctuation">.</span>serve_forever<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>以下のようにcurlを複数叩いてみます。<code>&amp;</code>はコマンドをバックグラウンドで実行する書き方です。
先ほどはサーバ側が処理をする10秒間curlコマンドはずっと待っていましたが、<code>&amp;</code>をつけることですぐに次のコマンドを叩けます。</p> <div class="language-terminal line-numbers-mode"><pre class="language-text"><code>$ curl localhost:8000 &amp;
$ curl localhost:8000 &amp;
$ curl localhost:8000 &amp;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>さて結果はどうでしょうか。3回コマンドを実行しましたが、サーバのログは以下のようになったのではないでしょうか。</p> <div class="language-terminal line-numbers-mode"><pre class="language-text"><code>serving at port 8000
start processing path = /, before request count = 0
start processing path = /, before request count = 0
start processing path = /, before request count = 0
end processing path = /, after request count = 1
end processing path = /, after request count = 1
end processing path = /, after request count = 1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>きちんとリクエスト数をカウントできていない、重大な不具合があるようです。</p> <h4 id="コード解説"><a href="#コード解説" class="header-anchor">#</a> コード解説</h4> <h4 id="forkとthread"><a href="#forkとthread" class="header-anchor">#</a> forkとthread</h4> <p>このプログラムではユーザからのリクエストを同時に処理するために <a href="https://docs.python.org/ja/3/library/http.server.html#http.server.ThreadingHTTPServer" target="_blank" rel="noopener noreferrer">ThreadingHTTPServer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> を利用しています。
ThreadingHTTPServer の説明を見てみましょう。</p> <blockquote><p>This class is identical to HTTPServer but uses threads to handle requests by using the ThreadingMixIn.</p></blockquote> <p>どうやらリクエストを処理(handle)するために「スレッド」を利用するようです。
<a href="https://docs.python.org/ja/3.7/library/socketserver.html#socketserver.ThreadingMixIn" target="_blank" rel="noopener noreferrer">ThreadingMixIn<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> の説明も見てみましょう。</p> <blockquote><p>Forking and threading versions of each type of server can be created using these mix-in classes.</p></blockquote> <p><code>fork</code>もしくは<code>thread</code>いずれかの仕組みで渡したServerオブジェクトを並列に実行してくれるようです。<code>fork</code>と<code>thread</code>は両方とも並列処理のための方法ですが、大きな違いがあります。</p> <p><img src="/bootcamp/assets/img/fork.drawio.fb839165.png" alt="fork" title="fork"></p> <p><img src="/bootcamp/assets/img/thread.drawio.25427a90.png" alt="thread" title="thread"></p> <p>図の通り<code>fork</code>の場合forkで分かれたプロセス上で<code>SimpleHelloHandler</code>のインスタンスが実行されます。そのためリクエストを処理する各インスタンス間でメモリ空間を共有していません（できないとも言う）。
一方で<code>thread</code>の場合はメモリ空間を共有した同じプロセス内で<code>SimpleHelloHandler</code>インスタンスが実行されます。</p> <p>今回<code>request_total</code>はクラス変数として宣言されています。そのため各<code>SimpleHelloHandler</code>インスタンスから共有するメモリ上の変数としてアクセスが可能です。
Webサーバを実装する時に限りませんが、ライブラリやフレームワークを利用する際にはそれがどういう仕組みで動くのか把握しておく必要があります。</p> <h4 id="クリティカルセッション"><a href="#クリティカルセッション" class="header-anchor">#</a> クリティカルセッション</h4> <p><code>count_and_do_something</code>の以下の部分に注目してみましょう（といっても中身全てですが）。</p> <div class="language-python line-numbers-mode"><div class="highlight-lines"><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br></div><pre class="language-python"><code>    <span class="token keyword">def</span> <span class="token function">count_and_do_something</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        t <span class="token operator">=</span> SimpleHelloHandler<span class="token punctuation">.</span>request_total
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'start processing path = {}, before request count = {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">)</span>

        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>  <span class="token comment"># 何かの処理</span>

        t <span class="token operator">=</span> t <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'end processing path = {}, after request count = {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">)</span>

        SimpleHelloHandler<span class="token punctuation">.</span>request_total <span class="token operator">=</span> t
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>上記2-10行目は<code>SimpleHelloHandler.request_total</code>という共有資源にアクセスしており、複数のスレッドから同時にアクセスされると不具合が起きます。このような箇所を「<strong>クリティカルセクション</strong>」と呼びます。
また実際にクリティカルセクションに複数のスレッドが同時にアクセスしてしまい、不具合が起きている状態を「<strong>レースコンディション(競合状態)</strong>」と呼びます。</p> <p>スレッドなどを利用する並行処理プログラミングではこのクリティカルセクションを如何に減らし、そして保護するかが大切になります。</p> <h3 id="排他制御・アトミック処理"><a href="#排他制御・アトミック処理" class="header-anchor">#</a> 排他制御・アトミック処理</h3> <h4 id="排他制御"><a href="#排他制御" class="header-anchor">#</a> 排他制御</h4> <p>クリティカルセクションを保護する手法の一つが、ロックを取得する排他制御と呼ばれるものです。まずは素朴に実装してみましょう。
（説明用にすごく雑な実装なので間違っても仕事で以下のようなコードを書かないでください）</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> http<span class="token punctuation">.</span>server <span class="token keyword">import</span> BaseHTTPRequestHandler<span class="token punctuation">,</span> ThreadingHTTPServer
<span class="token keyword">import</span> time

PORT <span class="token operator">=</span> <span class="token number">8000</span>


<span class="token keyword">class</span> <span class="token class-name">SimpleHelloHandler</span><span class="token punctuation">(</span>BaseHTTPRequestHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>
    request_total <span class="token operator">=</span> <span class="token number">0</span>
    request_total_lock <span class="token operator">=</span> <span class="token boolean">False</span>

    <span class="token keyword">def</span> <span class="token function">count_and_do_something</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> SimpleHelloHandler<span class="token punctuation">.</span>request_total_lock<span class="token punctuation">:</span>  <span class="token comment"># request_total_lock がFalseになるまで無限ループする</span>
                SimpleHelloHandler<span class="token punctuation">.</span>request_total_lock <span class="token operator">=</span> <span class="token boolean">True</span>  <span class="token comment"># ロックの取得</span>
                <span class="token keyword">break</span>

        t <span class="token operator">=</span> SimpleHelloHandler<span class="token punctuation">.</span>request_total
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'start processing path = {}, before request count = {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">)</span>

        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>  <span class="token comment"># 何かの処理</span>

        t <span class="token operator">=</span> t <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'end processing path = {}, after request count = {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">)</span>

        SimpleHelloHandler<span class="token punctuation">.</span>request_total <span class="token operator">=</span> t
        SimpleHelloHandler<span class="token punctuation">.</span>request_total_lock <span class="token operator">=</span> <span class="token boolean">False</span>  <span class="token comment"># 処理が完了したらロックを解放する</span>

    <span class="token keyword">def</span> <span class="token function">do_GET</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>count_and_do_something<span class="token punctuation">(</span>self<span class="token punctuation">.</span>path<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>send_response<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>send_header<span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/plain; charset=utf-8'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>end_headers<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>wfile<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">b'Hello! request count=%a\n'</span> <span class="token operator">%</span> SimpleHelloHandler<span class="token punctuation">.</span>request_total<span class="token punctuation">)</span>


<span class="token keyword">with</span> ThreadingHTTPServer<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> PORT<span class="token punctuation">)</span><span class="token punctuation">,</span> SimpleHelloHandler<span class="token punctuation">)</span> <span class="token keyword">as</span> httpd<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;serving at port&quot;</span><span class="token punctuation">,</span> PORT<span class="token punctuation">)</span>
    httpd<span class="token punctuation">.</span>serve_forever<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>サーバを実行してみてください。先ほどと同じようにcurlを実行するとどうでしょうか。</p> <div class="language-terminal line-numbers-mode"><pre class="language-text"><code>$ curl localhost:8000 &amp;
$ curl localhost:8000 &amp;
$ curl localhost:8000 &amp;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>ここでは新しくクラス変数として<code>request_total_lock</code>を追加し、<code>count_and_do_something</code>の先頭でこの変数を検査しています。
<code>True</code>の場合は次のループに遷移し、無限に検査を繰り返します。<code>False</code>だった場合は<code>True</code>を代入しクリティカルセクションに入ります。
クリティカルセクションの終了後、<code>request_total_lock</code>に<code>False</code>を代入し、別のスレッドが実行できるようにします。</p> <p>少しややこしいですが、複数のスレッド間の動作を順番に書くと以下のようになります。</p> <ol><li>最初のリクエスト(thread1)が来て<code>count_and_do_something</code>が実行される</li> <li><code>request_total_lock</code>は<code>False</code>なのでthread1が<code>True</code>を代入してロックを取得する</li> <li>2個目のリクエスト(thread2)が来て<code>count_and_do_something</code>が実行される</li> <li><code>request_total_lock</code>は<code>True</code>なのでthread2は無限ループを続ける</li> <li>thread1でクリティカルセクションが完了し、<code>request_total_lock</code>に<code>False</code>が代入される</li> <li>thread2がロックを取得し、クリティカルセクションを開始する</li></ol> <p>このロック機構によりクリティカルセクションが保護され、<code>request_total</code>が正しくカウントされるようになりました。
このようにロックが取得できるまで無限ループで待ち続けるような実装を「スピンロック」と言います。</p> <p>このコードは一見うまくいっていますが、実はレースコンディションを引き起こすクリティカルセクションが隠れています。</p> <div class="language-python line-numbers-mode"><div class="highlight-lines"><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br></div><pre class="language-python"><code>    <span class="token keyword">def</span> <span class="token function">count_and_do_something</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> SimpleHelloHandler<span class="token punctuation">.</span>request_total_lock<span class="token punctuation">:</span>     <span class="token comment"># ここから</span>
                SimpleHelloHandler<span class="token punctuation">.</span>request_total_lock <span class="token operator">=</span> <span class="token boolean">True</span>  <span class="token comment"># ここまでが実はクリティカルセクション</span>
                <span class="token keyword">break</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>上記の3行目で<code>request_total_lock</code>を見た後<code>True</code>を代入するまでにわずかながらでもラグがあるため、運が悪いと3行目が複数のスレッドで同時に実行される可能性があります。
すると複数のスレッドが同時にロックを取得してしまい、クリティカルセクションが同時に実行されてしまいます。</p> <p>後でも記載しますが、これは<code>request_total_lock</code>の検査とロックの獲得が「アトミックでない」処理のためです。</p> <p>さて、このように並行処理に関わるスピンロックなどのコードを自前で実装するのはやめて、ライブラリを使いましょう。これはスレッドプログラミングにおける大原則です。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> http<span class="token punctuation">.</span>server <span class="token keyword">import</span> BaseHTTPRequestHandler<span class="token punctuation">,</span> ThreadingHTTPServer
<span class="token keyword">from</span> threading <span class="token keyword">import</span> Lock
<span class="token keyword">import</span> time

PORT <span class="token operator">=</span> <span class="token number">8000</span>


<span class="token keyword">class</span> <span class="token class-name">SimpleHelloHandler</span><span class="token punctuation">(</span>BaseHTTPRequestHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>
    request_total <span class="token operator">=</span> <span class="token number">0</span>
    request_total_lock <span class="token operator">=</span> Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">count_and_do_something</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        SimpleHelloHandler<span class="token punctuation">.</span>request_total_lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># ロックの取得。他のスレッドはアクセスできなくなる</span>

        t <span class="token operator">=</span> SimpleHelloHandler<span class="token punctuation">.</span>request_total
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'start processing path = {}, before request count = {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">)</span>

        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>  <span class="token comment"># 何かの処理</span>

        t <span class="token operator">=</span> t <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'end processing path = {}, after request count = {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">)</span>

        SimpleHelloHandler<span class="token punctuation">.</span>request_total <span class="token operator">=</span> t
        SimpleHelloHandler<span class="token punctuation">.</span>request_total_lock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># ロックの解放</span>

    <span class="token keyword">def</span> <span class="token function">do_GET</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>count_and_do_something<span class="token punctuation">(</span>self<span class="token punctuation">.</span>path<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>send_response<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>send_header<span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/plain; charset=utf-8'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>end_headers<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>wfile<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">b'Hello! request count=%a\n'</span> <span class="token operator">%</span> SimpleHelloHandler<span class="token punctuation">.</span>request_total<span class="token punctuation">)</span>

<span class="token keyword">with</span> ThreadingHTTPServer<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> PORT<span class="token punctuation">)</span><span class="token punctuation">,</span> SimpleHelloHandler<span class="token punctuation">)</span> <span class="token keyword">as</span> httpd<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;serving at port&quot;</span><span class="token punctuation">,</span> PORT<span class="token punctuation">)</span>
    httpd<span class="token punctuation">.</span>serve_forever<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>Pythonの <a href="https://docs.python.org/ja/3/library/threading.html" target="_blank" rel="noopener noreferrer">threadingパッケージ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> にはスレッドプログラミングに使えるツールが用意されています。今回は <a href="https://docs.python.org/ja/3/library/threading.html#lock-objects" target="_blank" rel="noopener noreferrer">Lock<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> を利用しました。
<code>acquire()</code>を実行するとロックを取得し、もし他のスレッドで既に取得済みの場合はブロック（コード実行をそこで停止する）します。</p> <p>この部分は以下のようにも書けます。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>    <span class="token keyword">def</span> <span class="token function">count_and_do_something</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> SimpleHelloHandler<span class="token punctuation">.</span>request_total_lock<span class="token punctuation">:</span>
            t <span class="token operator">=</span> SimpleHelloHandler<span class="token punctuation">.</span>request_total
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'start processing path = {}, before request count = {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">)</span>

            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>  <span class="token comment"># 何かの処理</span>

            t <span class="token operator">=</span> t <span class="token operator">+</span> <span class="token number">1</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'end processing path = {}, after request count = {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">)</span>

            SimpleHelloHandler<span class="token punctuation">.</span>request_total <span class="token operator">=</span> t
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>クリティカルセクションが分かりやすくロックの開放し忘れもないので、基本的には<code>with</code>を利用して書きましょう。</p> <h4 id="スレッドセーフ-アトミック-な処理"><a href="#スレッドセーフ-アトミック-な処理" class="header-anchor">#</a> スレッドセーフ（アトミック）な処理</h4> <p>ロックを取得することでクリティカルセクションを保護できることは分かりました。
しかし皆さんも薄々お気づきの通り、そもそもこのコードのクリティカルセクションをもっと小さくできるのではないでしょうか。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> http<span class="token punctuation">.</span>server <span class="token keyword">import</span> BaseHTTPRequestHandler<span class="token punctuation">,</span> ThreadingHTTPServer
<span class="token keyword">import</span> time

PORT <span class="token operator">=</span> <span class="token number">8000</span>


<span class="token keyword">class</span> <span class="token class-name">SimpleHelloHandler</span><span class="token punctuation">(</span>BaseHTTPRequestHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>
    request_total <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">def</span> <span class="token function">count_and_do_something</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'start processing path = {}, before request count = {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
            path<span class="token punctuation">,</span> SimpleHelloHandler<span class="token punctuation">.</span>request_total<span class="token punctuation">)</span><span class="token punctuation">)</span>

        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>  <span class="token comment"># 何かの処理</span>

        SimpleHelloHandler<span class="token punctuation">.</span>request_total <span class="token operator">+=</span> <span class="token number">1</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'end processing path = {}, after request count = {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
            path<span class="token punctuation">,</span> SimpleHelloHandler<span class="token punctuation">.</span>request_total<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">do_GET</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>count_and_do_something<span class="token punctuation">(</span>self<span class="token punctuation">.</span>path<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>send_response<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>send_header<span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/plain; charset=utf-8'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>end_headers<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>wfile<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">b'Hello! request count=%a\n'</span> <span class="token operator">%</span> SimpleHelloHandler<span class="token punctuation">.</span>request_total<span class="token punctuation">)</span>


<span class="token keyword">with</span> ThreadingHTTPServer<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> PORT<span class="token punctuation">)</span><span class="token punctuation">,</span> SimpleHelloHandler<span class="token punctuation">)</span> <span class="token keyword">as</span> httpd<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;serving at port&quot;</span><span class="token punctuation">,</span> PORT<span class="token punctuation">)</span>
    httpd<span class="token punctuation">.</span>serve_forever<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>どうでしょう。試しに同じようにcurlで叩いてみましょう。</p> <div class="language-terminal line-numbers-mode"><pre class="language-text"><code>$ curl localhost:8000 &amp;
$ curl localhost:8000 &amp;
$ curl localhost:8000 &amp;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-terminal line-numbers-mode"><pre class="language-text"><code>serving at port 8000
start processing path = /, before request count = 0
start processing path = /, before request count = 0
start processing path = /, before request count = 0
end processing path = /, after request count = 1
end processing path = /, after request count = 2
end processing path = /, after request count = 3
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><code>before request count</code> はともかくとして、「リクエスト数をカウントする」という要件は満たせているように見えます。
しかしここにもレースコンディションを引き起こすクリティカルセクションが隠れています。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'start processing path = {}, before request count = {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
            path<span class="token punctuation">,</span> SimpleHelloHandler<span class="token punctuation">.</span>request_total<span class="token punctuation">)</span><span class="token punctuation">)</span>

        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>  <span class="token comment"># 何かの処理</span>

        SimpleHelloHandler<span class="token punctuation">.</span>request_total <span class="token operator">+=</span> <span class="token number">1</span> <span class="token comment"># クリティカルセクション</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'end processing path = {}, after request count = {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
            path<span class="token punctuation">,</span> SimpleHelloHandler<span class="token punctuation">.</span>request_total<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>スレッドプログラミングにおいて、ある処理が複数スレッドから同時に実行されても問題ない実装であることを「スレッドセーフ(thread safe)である」と言います。
例えば先ほどの<code>acquire()</code>はスレッドセーフなメソッドであり、複数スレッドから同時にアクセスされてもレースコンディションを起こさないように実装されています。</p> <p>一方でPythonにおける<code>+= 1</code>とはスレッドセーフな処理なんでしょうか。結論から言うとそうではありません。
なぜこの短いコードでレースコンディションが発生するのでしょうか。</p> <p>Pythonで書かれたコードは最終的にバイトコードにコンパイルされて実行されます（CPythonの場合）。
<code>dis</code>を利用して実際に実行されるバイトコードを見てみましょう。</p> <div class="language-terminal line-numbers-mode"><pre class="language-text"><code>root@40e566b8e23e:/work# python3
Python 3.9.2 (default, Feb 28 2021, 17:03:44)
[GCC 10.2.1 20210110] on linux
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; import dis
&gt;&gt;&gt; a = 0
&gt;&gt;&gt; dis.dis(&quot;a += 1&quot;)
  1           0 LOAD_NAME                0 (a)
              2 LOAD_CONST               0 (1)
              4 INPLACE_ADD
              6 STORE_NAME               0 (a)
              8 LOAD_CONST               1 (None)
             10 RETURN_VALUE
&gt;&gt;&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><code>a += 1</code>というコードは上記の通り6行のバイトコードに変換されます。内容を見てみると以下のように動作することが分かります。</p> <ol><li>「a」というメモリ領域から値を読み込む(<code>LOAD_NAME</code>)</li> <li>加算する(<code>INPLACE_ADD</code>)</li> <li>「a」というメモリ領域に値を書き込む(<code>STORE_NAME</code>)</li></ol> <p>つまり<code>a += 1</code>という一見1ステップのコードでも、バイトコードやその先の機械語レベルでは複数のステップに分かれた処理である可能性があります。
（ここで「可能性」と言っているのは、あくまで言語やコンパイラの仕様や実装次第なためです。少なくともCPythonではアトミックな機械語は生成されないはずです。）</p> <p>仮に機械語レベルで複数ステップに分かれた処理であった場合、タイミングによってはthread1が1ステップ目を実行した後、
入れ替わりthread2が1ステップ目を実行してしまう可能性があります。
そのため<code>a += 1</code>のようなコードでも、レースコンディションを起こす可能性があります。</p> <p>スレッドプログラミングにおいては常に「その処理がスレッドセーフなのか」、仕様を確認しつつ進める必要があります。</p> <div class="custom-block tip"><p class="custom-block-title">アトミックな処理</p> <p>「アトム(atom)」とは「これ以上分割不可能な単位」という意味を持ち、「原子性」などとも呼ばれます。
同じように「アトミックな処理」とはその処理が「外部から途中経過が観測できず、失敗した場合は処理前の状態に復元される」ことを言います。
その意味でCPythonにおける<code>a += 1</code>はメモリからreadしてwriteする過程があるためアトミックな処理ではありません。</p> <p>例えばMySQLなどのRDBでトランザクションを張り、最後にCOMMITする操作はアトミックな処理です。
また最近のCPUには加算処理などをアトミックに行う処理が命令として用意されており、言語によってはそういった命令を利用してアトミックな加算処理などを利用することが可能です。</p> <p>例: gccなどのCコンパイラに実装されている<code>__sync_fetch_and_add</code>など</p></div> <div class="custom-block tip"><p class="custom-block-title">コンテキストスイッチ</p> <p>CPython(c言語で書かれたPython処理系)にはGILという仕組みがあり、Pythonプログラムは1個のCPUコアしか使うことができません。
1個のCPUコアでは同時に1個の仕事しかできないため、複数のスレッドを動かす際は1個のCPUコアの処理時間を分け合うことになります。
つまりあるCPUコアでthread1の仕事を進めつつあるタイミングでthread1を待機状態にし、thread2の仕事を始める・・・ということを行っていきます。
この仕事の割り振りを決めるのがLinuxカーネルにおける「スケジューラ」と呼ばれる機能であり、thread1-&gt;thread2など仕事内容が切り替わるのを「コンテキストスイッチ」と呼びます。</p></div> <p><code>a += 1</code> がスレッドセーフでないことが分かったので、きちんとロックを利用してスレッドセーフな実装にしましょう。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> http<span class="token punctuation">.</span>server <span class="token keyword">import</span> BaseHTTPRequestHandler<span class="token punctuation">,</span> ThreadingHTTPServer
<span class="token keyword">from</span> threading <span class="token keyword">import</span> Lock
<span class="token keyword">import</span> time

PORT <span class="token operator">=</span> <span class="token number">8000</span>


<span class="token keyword">class</span> <span class="token class-name">SimpleHelloHandler</span><span class="token punctuation">(</span>BaseHTTPRequestHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>
    request_total <span class="token operator">=</span> <span class="token number">0</span>
    request_total_lock <span class="token operator">=</span> Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">increment_request_total</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> SimpleHelloHandler<span class="token punctuation">.</span>request_total_lock<span class="token punctuation">:</span>
            SimpleHelloHandler<span class="token punctuation">.</span>request_total <span class="token operator">+=</span> <span class="token number">1</span>

    <span class="token keyword">def</span> <span class="token function">count_and_do_something</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'start processing path = {}, before request count = {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
            path<span class="token punctuation">,</span> SimpleHelloHandler<span class="token punctuation">.</span>request_total<span class="token punctuation">)</span><span class="token punctuation">)</span>

        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>  <span class="token comment"># 何かの処理</span>

        self<span class="token punctuation">.</span>increment_request_total<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'end processing path = {}, after request count = {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
            path<span class="token punctuation">,</span> SimpleHelloHandler<span class="token punctuation">.</span>request_total<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">do_GET</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>count_and_do_something<span class="token punctuation">(</span>self<span class="token punctuation">.</span>path<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>send_response<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>send_header<span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/plain; charset=utf-8'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>end_headers<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>wfile<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">b'Hello! request count=%a\n'</span> <span class="token operator">%</span> SimpleHelloHandler<span class="token punctuation">.</span>request_total<span class="token punctuation">)</span>


<span class="token keyword">with</span> ThreadingHTTPServer<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> PORT<span class="token punctuation">)</span><span class="token punctuation">,</span> SimpleHelloHandler<span class="token punctuation">)</span> <span class="token keyword">as</span> httpd<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;serving at port&quot;</span><span class="token punctuation">,</span> PORT<span class="token punctuation">)</span>
    httpd<span class="token punctuation">.</span>serve_forever<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><h2 id="最後に"><a href="#最後に" class="header-anchor">#</a> 最後に</h2> <p>この資料で伝えたいのは以下のことです。</p> <ul><li>ライブラリやフレームワークを利用する際はその仕組みをきちんと理解しましょう
<ul><li>webプログラミングにおいては特に並行・並列処理をどのように実装しているのか確認しましょう</li></ul></li> <li>スレッドプログラミングを書いているという認識を持ち、書こうとしている処理がスレッドセーフなのか常に確認しましょう
<ul><li>Webフレームワークが推奨する書き方に習うことで、トラブルを防ぐことができます</li></ul></li> <li>ロックなど排他制御の実装を行う際は自前で実装せず、必ずライブラリを利用しましょう</li></ul> <p>並行・並列処理、スレッドプログラミングは非常に複雑になります（これは実行するまで処理がどのような順番で実行されるか分からない非決定性から来ています）。</p> <p>Webフレームワークはこの並行・並列処理の複雑性を隠蔽するために発達しているという側面があり、推奨される書き方をすることで複雑性を意識しなくても実装が可能なようになっています。
しかし自分が今どのような仕組みの上で実装しているのかを意識していないと、思わぬ事故を起こす可能性があります。</p> <p>フレームワークが提供するレールに乗りながらも、自分がスレッドプログラミングをしていることを常に意識することが大切です。</p> <div><hr> <span>CC BY-SA Licensed | Copyright (c) 2022, Internet Initiative Japan Inc.</span></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/iij/bootcamp/edit/master/src/server-app/concurrent/README.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">7/30/2024, 7:03:42 AM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/bootcamp/assets/js/app.1abd0c46.js" defer></script><script src="/bootcamp/assets/js/2.ef45b232.js" defer></script><script src="/bootcamp/assets/js/25.f3205fa3.js" defer></script><script src="/bootcamp/assets/js/18.08feb914.js" defer></script><script src="/bootcamp/assets/js/17.cfaf8c29.js" defer></script>
  </body>
</html>
