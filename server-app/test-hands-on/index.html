<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>テストプログラミング ハンズオン | IIJ Bootcamp</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="開発を行う際に覚えておくと非常に便利なテストを伝授します。">
    
    <link rel="preload" href="/bootcamp/assets/css/0.styles.095a7d7e.css" as="style"><link rel="preload" href="/bootcamp/assets/js/app.5182695c.js" as="script"><link rel="preload" href="/bootcamp/assets/js/2.c14b973d.js" as="script"><link rel="preload" href="/bootcamp/assets/js/29.d3b71a87.js" as="script"><link rel="preload" href="/bootcamp/assets/js/16.b94b3d20.js" as="script"><link rel="preload" href="/bootcamp/assets/js/15.e36f630f.js" as="script"><link rel="prefetch" href="/bootcamp/assets/js/10.e61da88c.js"><link rel="prefetch" href="/bootcamp/assets/js/11.53c250a3.js"><link rel="prefetch" href="/bootcamp/assets/js/12.bfb68d09.js"><link rel="prefetch" href="/bootcamp/assets/js/13.e4cf165f.js"><link rel="prefetch" href="/bootcamp/assets/js/14.18526015.js"><link rel="prefetch" href="/bootcamp/assets/js/17.1de4c681.js"><link rel="prefetch" href="/bootcamp/assets/js/18.163ce037.js"><link rel="prefetch" href="/bootcamp/assets/js/19.4dd2cd97.js"><link rel="prefetch" href="/bootcamp/assets/js/20.3acd92f6.js"><link rel="prefetch" href="/bootcamp/assets/js/21.2d14ee2d.js"><link rel="prefetch" href="/bootcamp/assets/js/22.334e0ba4.js"><link rel="prefetch" href="/bootcamp/assets/js/23.c0b5a349.js"><link rel="prefetch" href="/bootcamp/assets/js/24.df98f01d.js"><link rel="prefetch" href="/bootcamp/assets/js/25.a3507266.js"><link rel="prefetch" href="/bootcamp/assets/js/26.3996daa2.js"><link rel="prefetch" href="/bootcamp/assets/js/27.c6d13cbf.js"><link rel="prefetch" href="/bootcamp/assets/js/28.6580104a.js"><link rel="prefetch" href="/bootcamp/assets/js/3.6d95f3b7.js"><link rel="prefetch" href="/bootcamp/assets/js/30.ee062891.js"><link rel="prefetch" href="/bootcamp/assets/js/31.72f203f6.js"><link rel="prefetch" href="/bootcamp/assets/js/32.f51f8e63.js"><link rel="prefetch" href="/bootcamp/assets/js/33.f5389f0d.js"><link rel="prefetch" href="/bootcamp/assets/js/34.f4e3608b.js"><link rel="prefetch" href="/bootcamp/assets/js/35.27511ed8.js"><link rel="prefetch" href="/bootcamp/assets/js/36.9a737932.js"><link rel="prefetch" href="/bootcamp/assets/js/37.893de9be.js"><link rel="prefetch" href="/bootcamp/assets/js/38.179cdfae.js"><link rel="prefetch" href="/bootcamp/assets/js/39.aa144f5a.js"><link rel="prefetch" href="/bootcamp/assets/js/4.87ed4c7b.js"><link rel="prefetch" href="/bootcamp/assets/js/40.7e5373ec.js"><link rel="prefetch" href="/bootcamp/assets/js/41.386915d0.js"><link rel="prefetch" href="/bootcamp/assets/js/42.d96528e5.js"><link rel="prefetch" href="/bootcamp/assets/js/43.53482be7.js"><link rel="prefetch" href="/bootcamp/assets/js/44.673483f9.js"><link rel="prefetch" href="/bootcamp/assets/js/45.5d8218da.js"><link rel="prefetch" href="/bootcamp/assets/js/46.a9331107.js"><link rel="prefetch" href="/bootcamp/assets/js/47.01efc76e.js"><link rel="prefetch" href="/bootcamp/assets/js/48.92988486.js"><link rel="prefetch" href="/bootcamp/assets/js/49.bbfb5426.js"><link rel="prefetch" href="/bootcamp/assets/js/5.96a94ac4.js"><link rel="prefetch" href="/bootcamp/assets/js/50.929d894d.js"><link rel="prefetch" href="/bootcamp/assets/js/51.2aaa35c3.js"><link rel="prefetch" href="/bootcamp/assets/js/52.6beb5f38.js"><link rel="prefetch" href="/bootcamp/assets/js/53.5f35f782.js"><link rel="prefetch" href="/bootcamp/assets/js/54.eca8ad87.js"><link rel="prefetch" href="/bootcamp/assets/js/55.471523dc.js"><link rel="prefetch" href="/bootcamp/assets/js/56.c9da3b91.js"><link rel="prefetch" href="/bootcamp/assets/js/57.f6bf7b9b.js"><link rel="prefetch" href="/bootcamp/assets/js/58.d34fa072.js"><link rel="prefetch" href="/bootcamp/assets/js/59.6e33e4c5.js"><link rel="prefetch" href="/bootcamp/assets/js/6.7a297d6f.js"><link rel="prefetch" href="/bootcamp/assets/js/7.e5b3d2f5.js"><link rel="prefetch" href="/bootcamp/assets/js/8.b1819698.js"><link rel="prefetch" href="/bootcamp/assets/js/9.62c9881e.js">
    <link rel="stylesheet" href="/bootcamp/assets/css/0.styles.095a7d7e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/bootcamp/" class="home-link router-link-active"><!----> <span class="site-name">IIJ Bootcamp</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/iij/bootcamp" target="_blank" rel="noopener noreferrer" class="repo-link">
      GitHub
      <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/iij/bootcamp" target="_blank" rel="noopener noreferrer" class="repo-link">
      GitHub
      <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>テストプログラミング ハンズオン</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/bootcamp/server-app/test-hands-on/#なぜテストを行うのか" class="sidebar-link">なぜテストを行うのか</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/bootcamp/server-app/test-hands-on/#効率的なテストとは" class="sidebar-link">効率的なテストとは</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/bootcamp/server-app/test-hands-on/#いつテストを作るのか" class="sidebar-link">いつテストを作るのか</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/bootcamp/server-app/test-hands-on/#dockerコンテナの立ち上げ方" class="sidebar-link">dockerコンテナの立ち上げ方</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/bootcamp/server-app/test-hands-on/#テストの実行方法" class="sidebar-link">テストの実行方法</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/bootcamp/server-app/test-hands-on/#関数・テストの修正方法" class="sidebar-link">関数・テストの修正方法</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/bootcamp/server-app/test-hands-on/#同値クラス・境界値テスト" class="sidebar-link">同値クラス・境界値テスト</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bootcamp/server-app/test-hands-on/#同値クラステストとは" class="sidebar-link">同値クラステストとは</a></li><li class="sidebar-sub-header"><a href="/bootcamp/server-app/test-hands-on/#境界値テストとは" class="sidebar-link">境界値テストとは</a></li><li class="sidebar-sub-header"><a href="/bootcamp/server-app/test-hands-on/#テスト実装例" class="sidebar-link">テスト実装例</a></li><li class="sidebar-sub-header"><a href="/bootcamp/server-app/test-hands-on/#問題にチャレンジしよう" class="sidebar-link">問題にチャレンジしよう</a></li></ul></li><li><a href="/bootcamp/server-app/test-hands-on/#apiと関数のモック" class="sidebar-link">APIと関数のモック</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bootcamp/server-app/test-hands-on/#モックとは" class="sidebar-link">モックとは</a></li><li class="sidebar-sub-header"><a href="/bootcamp/server-app/test-hands-on/#テスト実装例-2" class="sidebar-link">テスト実装例</a></li><li class="sidebar-sub-header"><a href="/bootcamp/server-app/test-hands-on/#fastapiについて" class="sidebar-link">FastAPIについて</a></li><li class="sidebar-sub-header"><a href="/bootcamp/server-app/test-hands-on/#テスト実装例-3" class="sidebar-link">テスト実装例</a></li><li class="sidebar-sub-header"><a href="/bootcamp/server-app/test-hands-on/#問題にチャレンジしよう-2" class="sidebar-link">問題にチャレンジしよう</a></li></ul></li><li><a href="/bootcamp/server-app/test-hands-on/#tddをやってみる" class="sidebar-link">TDDをやってみる</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bootcamp/server-app/test-hands-on/#tddのやり方" class="sidebar-link">TDDのやり方</a></li><li class="sidebar-sub-header"><a href="/bootcamp/server-app/test-hands-on/#テスト実装例-4" class="sidebar-link">テスト実装例</a></li><li class="sidebar-sub-header"><a href="/bootcamp/server-app/test-hands-on/#サイクル1-red" class="sidebar-link">サイクル1 Red</a></li><li class="sidebar-sub-header"><a href="/bootcamp/server-app/test-hands-on/#サイクル1-green" class="sidebar-link">サイクル1 Green</a></li><li class="sidebar-sub-header"><a href="/bootcamp/server-app/test-hands-on/#サイクル1-refactoring" class="sidebar-link">サイクル1 Refactoring</a></li><li class="sidebar-sub-header"><a href="/bootcamp/server-app/test-hands-on/#サイクル2-red" class="sidebar-link">サイクル2 Red</a></li><li class="sidebar-sub-header"><a href="/bootcamp/server-app/test-hands-on/#サイクル2-green" class="sidebar-link">サイクル2 Green</a></li><li class="sidebar-sub-header"><a href="/bootcamp/server-app/test-hands-on/#サイクル2-refactoring" class="sidebar-link">サイクル2 Refactoring</a></li><li class="sidebar-sub-header"><a href="/bootcamp/server-app/test-hands-on/#サイクル3-red" class="sidebar-link">サイクル3 Red</a></li><li class="sidebar-sub-header"><a href="/bootcamp/server-app/test-hands-on/#サイクル3-green" class="sidebar-link">サイクル3 Green</a></li><li class="sidebar-sub-header"><a href="/bootcamp/server-app/test-hands-on/#サイクル3-refactoring" class="sidebar-link">サイクル3 Refactoring</a></li><li class="sidebar-sub-header"><a href="/bootcamp/server-app/test-hands-on/#サイクル4-red" class="sidebar-link">サイクル4 Red</a></li><li class="sidebar-sub-header"><a href="/bootcamp/server-app/test-hands-on/#サイクル4-green" class="sidebar-link">サイクル4 Green</a></li><li class="sidebar-sub-header"><a href="/bootcamp/server-app/test-hands-on/#サイクル4-refactoring" class="sidebar-link">サイクル4 Refactoring</a></li><li class="sidebar-sub-header"><a href="/bootcamp/server-app/test-hands-on/#問題にチャレンジしよう-3" class="sidebar-link">問題にチャレンジしよう</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><table><tr><td>このハンズオンでやること</td><td>開発を行う際に覚えておくと非常に便利なテストを伝授します。</td></tr> <tr><td>想定時間</td><td>1h</td></tr> <tr><td>前提知識・用語</td><td>Python3</td></tr></table> <h1 id="page-frontmatter-title"><a href="#page-frontmatter-title" class="header-anchor">#</a> テストプログラミング ハンズオン</h1> <h1 id="目次"><a href="#目次" class="header-anchor">#</a> 目次</h1> <ul><li><a href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB">はじめに</a></li> <li><a href="#%E6%A6%82%E8%AB%96">概論</a> <ul><li><a href="#%E3%81%AA%E3%81%9C%E3%83%86%E3%82%B9%E3%83%88%E3%82%92%E8%A1%8C%E3%81%86%E3%81%AE%E3%81%8B">なぜテストを行うのか</a></li> <li><a href="#%E5%8A%B9%E7%8E%87%E7%9A%84%E3%81%AA%E3%83%86%E3%82%B9%E3%83%88%E3%81%A8%E3%81%AF">効率的なテストとは</a></li> <li><a href="#%E3%81%84%E3%81%A4%E3%83%86%E3%82%B9%E3%83%88%E3%82%92%E4%BD%9C%E3%82%8B%E3%81%AE%E3%81%8B">いつテストを作るのか</a></li></ul></li> <li><a href="#%E6%BA%96%E5%82%99">準備</a> <ul><li><a href="#docker%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E3%81%AE%E7%AB%8B%E3%81%A1%E4%B8%8A%E3%81%92%E6%96%B9">dockerコンテナの立ち上げ方</a></li> <li><a href="#%E3%83%86%E3%82%B9%E3%83%88%E3%81%AE%E5%AE%9F%E8%A1%8C%E6%96%B9%E6%B3%95">テストの実行</a></li> <li><a href="#%E9%96%A2%E6%95%B0%E3%83%BB%E3%83%86%E3%82%B9%E3%83%88%E3%81%AE%E4%BF%AE%E6%AD%A3%E6%96%B9%E6%B3%95">関数・テストの修正方法</a></li></ul></li> <li><a href="#%E3%83%86%E3%82%B9%E3%83%88%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B">テストを実行する</a> <ul><li><a href="#%E5%90%8C%E5%80%A4%E3%82%AF%E3%83%A9%E3%82%B9%E3%83%BB%E5%A2%83%E7%95%8C%E5%80%A4%E3%83%86%E3%82%B9%E3%83%88">同値クラス・境界値テスト</a></li> <li><a href="#api%E3%81%A8%E9%96%A2%E6%95%B0%E3%81%AE%E3%83%A2%E3%83%83%E3%82%AF">APIと関数のモック</a></li> <li><a href="#tdd%E3%82%92%E3%82%84%E3%81%A3%E3%81%A6%E3%81%BF%E3%82%8B">TDDをやってみる</a></li></ul></li> <li><a href="#%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB">おわりに</a></li></ul> <br> <h1 id="はじめに"><a href="#はじめに" class="header-anchor">#</a> はじめに</h1> <p>本講義はdockerを使用します。<br>
dockerコンテナのpullには時間を要するため、概論の聴講と並行して「準備 ⇒ dockerコンテナの立ち上げ方」を実施することを推奨します。</p> <br> <h1 id="概論"><a href="#概論" class="header-anchor">#</a> 概論</h1> <h2 id="なぜテストを行うのか"><a href="#なぜテストを行うのか" class="header-anchor">#</a> なぜテストを行うのか</h2> <p>昨今ではIT技術が普及し、炊飯器・電子レンジ・洗濯機といった身の回りのものから、航空機や車など、普段の生活に必須になるものにまで。ソフトウェアが使用されています。<br>
また、世の中に流通しているソフトウェアはテストが実施されており、その挙動で問題が起こらないことを保証されています。</p> <br> <p>例えばソフトウェアに対し、テストを行われていないと仮定して、個人的に運営しているブログなどで不具合が発生した場合はどうなるでしょうか。<br>
その不具合によってサーバがダウンしている間は、運営者に広告費が入らないなど、ある程度小規模で済みます。<br>
（ブログ収益で生計を立てている場合、致命的ですが。）</p> <br> <p>例えば自動車や医療機器などで不具合が発生してしまった場合、どうなるでしょうか。<br>
最悪の場合、ブレーキが効かない、医療機器のレーザーの出力が多すぎたなど、ソフトウェアの欠陥によって人命が失われてしまう可能性もあります。</p> <br> <p>上記2つの例を上げましたが、大なり小なり、ソフトウェアの不具合によって、どこかの誰かが被害を被ってしまいます。<br>
そのため、自身が作成するプログラムでは必ず動作のテストを行い、極力不具合を発生させないソフトウェアを作ることを目指す必要があります。</p> <br> <h2 id="効率的なテストとは"><a href="#効率的なテストとは" class="header-anchor">#</a> 効率的なテストとは</h2> <p>テストを作成する場合には、不具合をなくすことも重要ですが、テストにコストをかけないことも重要になります。</p> <br> <p>例えば、あるプロダクトに使用される、以下のような仕様の関数<code>f(x)</code>があるとします。</p> <ul><li>関数<code>f</code>は、任意の数字<code>x</code>の値を取ります。</li> <li>任意の数字<code>x</code>は、int型であり、 <em>-2,147,483,648</em> から <em>2,147,483,647</em> の範囲の値を格納できます。</li> <li>関数<code>f</code>は、与えられた数字が <em>0</em> から <em>100</em> の間であれば<code>True</code>、そうでなければ<code>False</code>を返却します。</li></ul> <p>上記の<code>f(x)</code>の挙動を100%確かめるためには、 <em>4,294,967,296</em> 件のテストを行わなければなりません。<br>
しかし、実際のプロダクトを作成する場合、1つの関数に対し40億回もテストを実施してしまうと、プロダクトの売上以上に人件費や計算機の運用コストがかかってしまい、会社は倒産の危機に瀕してしまいます。</p> <p>そのため、後述する「同値クラス・境界値テスト」などの手法によって、最低限かつ最適な回数でテストを行うことが求められます。</p> <br> <h2 id="いつテストを作るのか"><a href="#いつテストを作るのか" class="header-anchor">#</a> いつテストを作るのか</h2> <p>開発を行う際、ウォーターフォール型の開発では、下記の流れになるかと思います。<br>
右下向きの矢印が設計工程、中央が開発工程、右上向きの矢印がテスト工程になります。</p> <p><img src="/bootcamp/assets/img/figure1.959b588c.png" alt="figure1.png" title="figure1"></p> <p>設計における各要素は、テスト工程の各要素に対応することになります。<br>
例えば、まずは要求定義を行い、ソフトウェアに必要な要件を決めますが、この時点で明確な要件が定義できているのであれば、システムテストで実施するテスト項目を作成しておくことができます。</p> <br> <p>このように各設計段階でテスト項目を作成することで、要件に沿ったテストを作成することができます。<br>
（何年も開発を行っているとわかるのですが、ものを作ってからテストを作成すると、「今動くものを通すテスト」を無意識的に書いてしまい、要件も網羅できないテストを作ってしまう傾向が出てきます。）</p> <br> <p>また、後述するTDD（テスト駆動開発）のように、テストを作成して開発を進める手法もあります。</p> <br> <h1 id="準備"><a href="#準備" class="header-anchor">#</a> 準備</h1> <h2 id="dockerコンテナの立ち上げ方"><a href="#dockerコンテナの立ち上げ方" class="header-anchor">#</a> dockerコンテナの立ち上げ方</h2> <p>下記のコマンドでdockerコンテナを立ち上げます。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># リポジトリのクローン</span>
$ <span class="token function">git</span> clone git@github.com:iij/bootcamp.git
$ <span class="token builtin class-name">cd</span> bootcamp/src/server-app/test-hands-on

<span class="token comment"># コンテナの立ち上げ</span>
$ <span class="token function">docker-compose</span> up --build
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><br> <h2 id="テストの実行方法"><a href="#テストの実行方法" class="header-anchor">#</a> テストの実行方法</h2> <p>この項では、任意の「<a href="#%E3%83%86%E3%82%B9%E3%83%88%E3%82%92%E5%AE%9F%E8%A1%8C%E3%81%99%E3%82%8B">テストを実行する</a>」の項のテストを実行します。</p> <br> <p>「<a href="#docker%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E3%81%AE%E7%AB%8B%E3%81%A1%E4%B8%8A%E3%81%92%E6%96%B9">dockerコンテナの立ち上げ方</a>」で、起動中のコンソールとは別のコンソールを開き、実行中のコンテナにアクセスします。<br>
コマンドを実行すると、コンテナ内のbashが実行されます。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">cd</span> bootcamp/src/server-app/test-hands-on
$ <span class="token function">docker-compose</span> <span class="token builtin class-name">exec</span> bootcamp-test <span class="token function">bash</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><br> <p>下記のコマンドで、テストを実行してみましょう。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># ソースは全て&quot;/test-hands-on&quot;配下にあります。</span>
$ <span class="token builtin class-name">cd</span> /test-hands-on

<span class="token comment"># 任意のテストを実行します。</span>
$ python -m unittest -v exercises.exercise0.test_challenge
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><br> <h2 id="関数・テストの修正方法"><a href="#関数・テストの修正方法" class="header-anchor">#</a> 関数・テストの修正方法</h2> <p>「テストの実行方法」の項でテストを行うと、初回は下記のようにテストが失敗してしまいます。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ python -m unittest -v exercises.exercise0.test_challenge
test_success <span class="token punctuation">(</span>exercises.exercise0.test_challenge.HelloTestCase<span class="token punctuation">)</span> <span class="token punctuation">..</span>. FAIL

<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
FAIL: test_success <span class="token punctuation">(</span>exercises.exercise0.test_challenge.HelloTestCase<span class="token punctuation">)</span>
----------------------------------------------------------------------
Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span>:
  File <span class="token string">&quot;/test-hands-on/exercises/exercise0/test_challenge.py&quot;</span>, line <span class="token number">7</span>, <span class="token keyword">in</span> test_success
    self.assertEqual<span class="token punctuation">(</span>hello<span class="token punctuation">(</span><span class="token punctuation">)</span>, <span class="token string">&quot;goodbye world?&quot;</span><span class="token punctuation">)</span>
AssertionError: <span class="token string">&quot;hello world&quot;</span> <span class="token operator">!=</span> <span class="token string">&quot;goodbye world?&quot;</span>
- hello world
+ goodbye world?
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><br> <p>試しに、このテストを修正してみましょう。
テストソースである、 <code>/test-hands-on/exercises/exercise0/test_challenge.py</code> を開いてみます。</p> <p>内容は下記のようになっており、ソース内でimportしている <code>hello()</code> 関数に対し、文字列&quot;goodbye world?&quot;が来ることを期待してテストを行っているようです。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> unittest
<span class="token keyword">from</span> <span class="token punctuation">.</span>challenge <span class="token keyword">import</span> hello


<span class="token keyword">class</span> <span class="token class-name">HelloTestCase</span><span class="token punctuation">(</span>unittest<span class="token punctuation">.</span>TestCase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">test_success</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>hello<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;goodbye world?&quot;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><br> <p>では、テスト対象である <code>hello()</code> 関数を見てみましょう。<br>
どうやら、この関数は文字列&quot;hello world&quot;を返すようです。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">&quot;hello world&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><br> <p>しかし、これではテストソースで期待されている関数の返り値と、実際の関数の返り値が異なってしまっています。<br>
これがテストが失敗してしまう原因となるため、テストの期待する値を&quot;goodbye world?&quot;から&quot;hello world&quot;に変えてみましょう。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> unittest
<span class="token keyword">from</span> <span class="token punctuation">.</span>challenge <span class="token keyword">import</span> hello


<span class="token keyword">class</span> <span class="token class-name">HelloTestCase</span><span class="token punctuation">(</span>unittest<span class="token punctuation">.</span>TestCase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">test_success</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>hello<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;hello world&quot;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>このテストを実行してみると、先程まで失敗していたテストが成功しました。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>python -m unittest -v exercises.exercise0.test_challenge
test_success <span class="token punctuation">(</span>exercises.exercise0.test_challenge.HelloTestCase<span class="token punctuation">)</span> <span class="token punctuation">..</span>. ok

----------------------------------------------------------------------
Ran <span class="token number">1</span> <span class="token builtin class-name">test</span> <span class="token keyword">in</span> <span class="token number">0</span>.000s

OK
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><br> <p>このように、テストソースというものは、テストを実施したい関数に対して動作を確認するように作成・実行します。</p> <p>本講義では、テストを実施したい関数に対し、テストソースで期待する返り値を設定し、関数の動作確認を行っていきます。</p> <br> <p>ちなみに、ローカルのソースファイルの変更は、コンテナ内にも自動で同期されます。<br>
以降はローカルでファイルを変更し、コンテナ内でテストを実行してみましょう。</p> <br> <h1 id="テストを実行する"><a href="#テストを実行する" class="header-anchor">#</a> テストを実行する</h1> <h2 id="同値クラス・境界値テスト"><a href="#同値クラス・境界値テスト" class="header-anchor">#</a> 同値クラス・境界値テスト</h2> <p>この項では「同値クラステスト」と「境界値テスト」という手法のテストを実施し、効率的なテストについて学びます。</p> <br> <h3 id="同値クラステストとは"><a href="#同値クラステストとは" class="header-anchor">#</a> 同値クラステストとは</h3> <p>同値クラステストとは「任意の関数<code>g(x)</code>の引数<code>x</code>に対し、有効である値、無効である値のグループ（有効同値クラス、無効同値クラス）を定義してテストを実施する」ものになります。</p> <p>例えば、本書の冒頭で出てきた、関数<code>f(x)</code>では、<code>x</code>の値が <em>0</em> から <em>100</em> の間であれば有効同値クラス、そうでなければ無効同値クラス、と定義できます。<br>
仮に「有効同値クラス内の値が入力された場合は正常終了、無効同値クラス内の値が入力された場合は異常終了する」と見た場合、終了の仕方は「正常終了か異常終了か」の2択と見ることができます。</p> <p>すなわち、関数<code>f(x)</code>に対する同値クラステストとは、有効同値である <em>10</em> , <em>50</em> , <em>90</em> など、いくつかの値のグループと、無効同値である <em>-500</em> , <em>-10</em> , <em>110</em> , <em>500</em> などの値のグループのテストを実施すればよいことになります。</p> <br> <h3 id="境界値テストとは"><a href="#境界値テストとは" class="header-anchor">#</a> 境界値テストとは</h3> <p>同値クラステストでは「有効/無効と定義した値に対する処理が正しく動くか」を確認できました。</p> <p>しかし、これでは「有効/無効の範囲は正しいか」が確認できていません。<br>
こういった場合は境界値テストを実施し、有効値/無効値の境界が、正しく実行されるかのテストを行います。</p> <p>本書冒頭の関数<code>f(x)</code>を例にすると、下限の境界値は <em>-1</em> , <em>0</em> 、上限の境界値は <em>100</em> , <em>101</em> となります。</p> <br> <h3 id="テスト実装例"><a href="#テスト実装例" class="header-anchor">#</a> テスト実装例</h3> <p>本書冒頭で定義した、関数<code>f(x)</code>がPythonで以下のように定義されているとします。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">if</span> <span class="token number">0</span> <span class="token operator">&lt;=</span> x <span class="token operator">&lt;=</span> <span class="token number">100</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token boolean">True</span>
  <span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token boolean">False</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><br> <p>上記の関数に対し、同値クラスのテストを定義すると、下記のように書くことができます。<br>
下記のテストでは、関数<code>f(x)</code>に有効同値クラスの値を入力すると<code>True</code>、そうでない値を入力すると<code>False</code>が返却されることを確認しています。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> unittest

<span class="token keyword">class</span> <span class="token class-name">ExampleTestCase</span><span class="token punctuation">(</span>unittest<span class="token punctuation">.</span>TestCase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">test_equivalence_partitioning</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 有効同値のテスト</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>f<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>f<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>f<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>

        <span class="token comment"># 無効同値のテスト</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>f<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>f<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>f<span class="token punctuation">(</span><span class="token number">110</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>f<span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><br> <p>境界値テストを定義すると、下記のように書くことができます。<br>
下記のテストでは、関数<code>f(x)</code>に下限の境界値 <em>-1</em> , <em>0</em> 、上限の境界値 <em>100</em> , <em>101</em> を入力し、適宜<code>True</code>か<code>False</code>が返却されることを確認しています。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> unittest

<span class="token keyword">class</span> <span class="token class-name">ExampleTestCase</span><span class="token punctuation">(</span>unittest<span class="token punctuation">.</span>TestCase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">test_equivalence_partitioning</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 下限の境界値</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>f<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>f<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>

        <span class="token comment"># 上限の境界値</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>f<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>f<span class="token punctuation">(</span><span class="token number">101</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><br> <h3 id="問題にチャレンジしよう"><a href="#問題にチャレンジしよう" class="header-anchor">#</a> 問題にチャレンジしよう</h3> <p>dockerコンテナ内の<code>/test-hands-on/exercises/exercise1/challenge.py</code>に、商品の申し込みを行う関数<code>apply(quantity)</code>が定義されています。</p> <p>関数は以下の仕様になっています。</p> <ul><li>この関数は、int型の引数<code>quantity</code>を取ります。</li> <li>関数<code>apply()</code>は、10以上、100以下の値が入力されると、申し込みが成功し、文字列<code>&quot;accepted&quot;</code>が返却されます。</li> <li>申し込みに失敗した場合は、文字列<code>&quot;not accepted&quot;</code>が返却されます。</li> <li>int型以外のデータが入力された場合、例外<code>TypeError()</code>が発生し、プログラムが異常終了します。</li></ul> <p>dockerコンテナ内の<code>/test-hands-on/exercises/exercise1/test_challenge.py</code>に、作成途中のテストクラス<code>ApplyTestCase</code>が定義されているため、関数<code>apply(quantity)</code>に対するテストを作成してみましょう。</p> <br> <h2 id="apiと関数のモック"><a href="#apiと関数のモック" class="header-anchor">#</a> APIと関数のモック</h2> <p>この項では、Pythonで実行できるAPI（FastAPI）のフレームワークを使用し、APIに対するテストや、関数のモックに触れてみましょう。</p> <br> <h3 id="モックとは"><a href="#モックとは" class="header-anchor">#</a> モックとは</h3> <p>「モックアップ」の略称であり、工業製品などの試作や、店頭展示などのためにつくられる実物大模型のことを指します。<br>
「<a href="https://dictionary.goo.ne.jp/word/%e3%83%a2%e3%83%83%e3%82%af%e3%82%a2%e3%83%83%e3%83%97/" target="_blank" rel="noopener noreferrer">goo辞書 モックアップ（mock-up）<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>」より</p> <p>テストにおけるモックとは、主にクラスや関数の動作をシミュレートするためのオブジェクトになります。</p> <br> <p>例えば、以下のような仕様の関数<code>rock_paper_scissors(shoot)</code>があるとします。</p> <ul><li>関数<code>rock_paper_scissors(shoot)</code>は、じゃんけんを行う関数で、引数<code>shoot</code>は文字列&quot;rock&quot;, &quot;paper&quot;, &quot;scissors&quot;の、いずれかを取ります。</li> <li>関数<code>rock_paper_scissors()</code>は、内部で引数に対してじゃんけんの手を出す関数<code>my_shoot()</code>が実行されます。</li> <li>関数<code>my_shoot()</code>は、それぞれ <em>1/3</em> の確率で&quot;rock&quot;, &quot;paper&quot;, &quot;scissors&quot;のいずれかを取得します。</li> <li>関数<code>rock_paper_scissors()</code>は、入力された引数<code>shoot</code>が、関数<code>my_shoot()</code>の返り値に勝利できる場合 <em>1</em> 、引き分けであれば <em>0</em> 、敗北であれば <em>-1</em> を返します。</li></ul> <p>上記の関数<code>rock_paper_scissors()</code>をテストする場合、内部の関数の返り値が乱数で決定されてしまうため、通常であればテストが実行できません。<br>
（例えば、1回目の<code>my_shoot()</code>を実行した時に&quot;rock&quot;が返却されたとしても、2回目も&quot;rock&quot;が返却されるとは限らないですよね）</p> <p>こういった場合、関数のモックを使用して、テスト対象の関数内で使用されているクラスや関数をモックし、返り値を固定してシミュレーションを行う必要があります。</p> <br> <h3 id="テスト実装例-2"><a href="#テスト実装例-2" class="header-anchor">#</a> テスト実装例</h3> <p>関数<code>rock_paper_scissors(shoot)</code>が、Pythonで以下のように定義されているとします。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">rock_paper_scissors</span><span class="token punctuation">(</span>shoot<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token comment"># 1/3で&quot;rock&quot;, &quot;paper&quot;, &quot;scissors&quot;が格納される</span>
  my_shoot_result <span class="token operator">=</span> my_shoot<span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment"># あいこ</span>
  <span class="token keyword">if</span> shoot <span class="token operator">==</span> my_shoot_result<span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token number">0</span>
  
  <span class="token comment"># 勝利</span>
  <span class="token keyword">if</span> shoot <span class="token operator">==</span> <span class="token string">&quot;rock&quot;</span> <span class="token keyword">and</span> my_shoot_result <span class="token operator">==</span> <span class="token string">&quot;scissors&quot;</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token number">1</span>
  <span class="token keyword">if</span> shoot <span class="token operator">==</span> <span class="token string">&quot;paper&quot;</span> <span class="token keyword">and</span> my_shoot_result <span class="token operator">==</span> <span class="token string">&quot;rock&quot;</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token number">1</span>
  <span class="token keyword">if</span> shoot <span class="token operator">==</span> <span class="token string">&quot;scissors&quot;</span> <span class="token keyword">and</span> my_shoot_result <span class="token operator">==</span> <span class="token string">&quot;paper&quot;</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token number">1</span>
  
  <span class="token comment"># 敗北</span>
  <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><br> <p>上記の関数に対し、モックを使用したテストを定義すると、下記のように書くことができます。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> unittest
<span class="token keyword">from</span> unittest <span class="token keyword">import</span> mock
<span class="token comment"># 関数rock_paper_scissors(), my_shoot()は、exampleパッケージに含まれているとする</span>
<span class="token keyword">from</span> <span class="token punctuation">.</span> <span class="token keyword">import</span> example

rock_paper_scissors <span class="token operator">=</span> example<span class="token punctuation">.</span>rock_paper_scissors

<span class="token keyword">class</span> <span class="token class-name">ExampleTestCase</span><span class="token punctuation">(</span>unittest<span class="token punctuation">.</span>TestCase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">test_rock_paper_scissors</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># あいこのテスト</span>
        <span class="token keyword">with</span> mock<span class="token punctuation">.</span>patch<span class="token punctuation">.</span><span class="token builtin">object</span><span class="token punctuation">(</span>example<span class="token punctuation">,</span> <span class="token string">'my_shoot'</span><span class="token punctuation">,</span> return_value<span class="token operator">=</span><span class="token string">&quot;rock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>rock_paper_scissors<span class="token punctuation">(</span><span class="token string">&quot;rock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 勝利のテスト</span>
        <span class="token keyword">with</span> mock<span class="token punctuation">.</span>patch<span class="token punctuation">.</span><span class="token builtin">object</span><span class="token punctuation">(</span>example<span class="token punctuation">,</span> <span class="token string">'my_shoot'</span><span class="token punctuation">,</span> return_value<span class="token operator">=</span><span class="token string">&quot;scissors&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>rock_paper_scissors<span class="token punctuation">(</span><span class="token string">&quot;rock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

        <span class="token comment"># 敗北のテスト</span>
        <span class="token keyword">with</span> mock<span class="token punctuation">.</span>patch<span class="token punctuation">.</span><span class="token builtin">object</span><span class="token punctuation">(</span>example<span class="token punctuation">,</span> <span class="token string">'my_shoot'</span><span class="token punctuation">,</span> return_value<span class="token operator">=</span><span class="token string">&quot;paper&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>rock_paper_scissors<span class="token punctuation">(</span><span class="token string">&quot;rock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><br> <h3 id="fastapiについて"><a href="#fastapiについて" class="header-anchor">#</a> FastAPIについて</h3> <p>IIJ Bootcamp「FastAPI でwebアプリを作る」にて紹介されているため、詳細の説明は省きます。</p> <p>下記「テスト実装例」にサンプルを記載するように、簡単にAPIを実装できるフレームワークになっています。</p> <br> <h3 id="テスト実装例-3"><a href="#テスト実装例-3" class="header-anchor">#</a> テスト実装例</h3> <p>FastAPIは、下記のようにAPIを実装できます。<br>
下記は、ブラウザで<code>http://localhost:8000/hello</code>にアクセスすると、データ<code>{&quot;response&quot;: &quot;hello&quot;}</code>を返却します。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI

app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">&quot;/hello&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">&quot;response&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><br> <p>上記のAPIに対し、HTTPステータスやレスポンスを検証するテストは、下記のように書くことができます。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> unittest


<span class="token keyword">class</span> <span class="token class-name">ExampleTestCase</span><span class="token punctuation">(</span>unittest<span class="token punctuation">.</span>TestCase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">test_api</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># パス&quot;/hello&quot;に接続する</span>
        res <span class="token operator">=</span> client<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;/hello&quot;</span><span class="token punctuation">)</span>

        <span class="token comment"># HTTPステータスと、レスポンスの取得</span>
        status <span class="token operator">=</span> res<span class="token punctuation">.</span>status_code
        data <span class="token operator">=</span> res<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># HTTPステータスと、レスポンスの検証</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>status<span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">&quot;response&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><br> <h3 id="問題にチャレンジしよう-2"><a href="#問題にチャレンジしよう-2" class="header-anchor">#</a> 問題にチャレンジしよう</h3> <p>dockerコンテナ内の<code>/test-hands-on/exercises/exercise2/challenge.py</code>に、FastAPIと、いくつかのエンドポイントが定義されています。</p> <p>上記のAPIは、コンテナから下記のコマンドで実行することができます。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ python3 -m uvicorn exercises.exercise2.challenge:app --reload --host <span class="token string">&quot;0.0.0.0&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><br> <p>API実行後は、ブラウザに下記のURLを入力すると、APIにアクセスできます。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>http://localhost:8000/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><br> <p>また、APIは下記のエンドポイントがあります。</p> <table><thead><tr><th>パス</th> <th>詳細</th></tr></thead> <tbody><tr><td>/</td> <td><code>{&quot;message&quot;: &quot;hello world&quot;}</code>が返却されます。</td></tr> <tr><td>/echo/{data}</td> <td><code>{&quot;message&quot;: &quot;got the message: {data}&quot;}</code>が返却されます。<br>※<code>{data}</code>は、任意の値が代入されます。</td></tr> <tr><td>/gacha</td> <td><code>{&quot;message&quot;: &quot;{result}&quot;</code>が返却されます。<br>※<code>{result}</code>は、 <em>1/100</em> で文字列&quot;you win&quot;、それ以外で文字列&quot;you lose&quot;が代入されます。</td></tr></tbody></table> <p>dockerコンテナ内の<code>/test-hands-on/exercises/exercise2/test_challenge.py</code>に、作成途中のテストクラス<code>ApiTestCase</code>が定義されているため、上記の仕様のAPIに対するテストを作成してみましょう。</p> <br> <h2 id="tddをやってみる"><a href="#tddをやってみる" class="header-anchor">#</a> TDDをやってみる</h2> <p>TDDとは、「テスト駆動開発( <em>Test-Driven</em> )」のことを指し「テストファースト（テスト優先）」を掲げて開発を行う、 <strong>開発手法</strong> のことになります。</p> <p>テスト手法じゃないよ !!!!</p> <br> <h3 id="tddのやり方"><a href="#tddのやり方" class="header-anchor">#</a> TDDのやり方</h3> <p>TDDは、任意の開発を行う設計があるうえで、下記のサイクルで開発を行っていきます。</p> <ol><li>Red
<ul><li>動作をしないテストを書く。</li></ul></li> <li>Green
<ul><li>迅速に、テストを実行できるコードを書いてテストを通すようにする。<br>
※コードが汚くても良い。</li></ul></li> <li>Refactoring
<ul><li>リファクタリングを行い、コード内から重複を削除する。</li></ul></li></ol> <p>上記 <em>1~3</em> のサイクルを実行し、動きつつコードとリファクタリングによって最適化されたコードを、着実に作っていく手法になります。</p> <br> <h3 id="テスト実装例-4"><a href="#テスト実装例-4" class="header-anchor">#</a> テスト実装例</h3> <p>この項で実際に、TDDのサイクルを見てみましょう。</p> <p>例えば、以下の仕様のソースを作りたいとします。</p> <ul><li>クラス内の<code>do()</code>関数の、実行回数が3の倍数なら&quot;Fizz&quot;、5の倍数なら&quot;Buzz&quot;を返す、クラス<code>FizzBuzz</code>を実装します。</li> <li>このクラスは<code>do()</code>の実行回数を、内部でカウントします。</li> <li>3でも5の倍数でもないカウントに対しては、そのカウントを返します。</li></ul> <p>上記のコードをTDDで作成していきましょう。</p> <br> <h3 id="サイクル1-red"><a href="#サイクル1-red" class="header-anchor">#</a> サイクル1 Red</h3> <p>まずは、クラス<code>FizzBuzz</code>の関数を作成します。<br>
下記のコードは、<code>example.py</code>のようなパッケージにあると考えてください。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">FizzBuzz</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">do</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><br> <p>次に、動作をしないテストを書きましょう。<br> <code>do()</code>が最初に実行する時は、下記の仕様が適用されます。</p> <blockquote><p>3でも5の倍数でもないカウントに対しては、そのカウントを返します。</p></blockquote> <br> <p>とりあえず1回目の実行では「1」が返ってくるはずなので、テストでは「1」を期待してみます。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> unittest
<span class="token keyword">from</span> <span class="token punctuation">.</span>fizzbuzz <span class="token keyword">import</span> FizzBuzz


<span class="token keyword">class</span> <span class="token class-name">ExampleTestCase</span><span class="token punctuation">(</span>unittest<span class="token punctuation">.</span>TestCase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">test_success</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        fb <span class="token operator">=</span> FizzBuzz<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>fb<span class="token punctuation">.</span>do<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><br> <p>これを実行すると、当然のようにコケますね。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ python -m unittest -v example.test_fizzbuzz
test_success <span class="token punctuation">(</span>example.test_fizzbuzz.ExampleTestCase<span class="token punctuation">)</span> <span class="token punctuation">..</span>. FAIL
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><br> <h3 id="サイクル1-green"><a href="#サイクル1-green" class="header-anchor">#</a> サイクル1 Green</h3> <p>次は「とりあえず動くコードを書く」ことをします。<br>
テストでは1が返却されることを期待しているので、1を返しましょう。<br>
TDDって簡単ですね。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">FizzBuzz</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">do</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><br> <p>動いたよ！！！！やったね！！！！！！！！！</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ python -m unittest -v example.test_fizzbuzz
test_success <span class="token punctuation">(</span>example.test_fizzbuzz.ExampleTestCase<span class="token punctuation">)</span> <span class="token punctuation">..</span>. ok
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><br> <h3 id="サイクル1-refactoring"><a href="#サイクル1-refactoring" class="header-anchor">#</a> サイクル1 Refactoring</h3> <p>現在の<code>FizzBuzz</code>は、この世界に存在するどんなものよりも洗練されているため、リファクタリングは必要ないですね。<br>
素晴らしい。</p> <br> <h3 id="サイクル2-red"><a href="#サイクル2-red" class="header-anchor">#</a> サイクル2 Red</h3> <p>2サイクル目に来ました。<br>
Redでは、あえてテストを失敗させなければならないため、泣く泣く完成されたテストコードに手を加えましょう。</p> <p>サイクル1 Redでも確認した通り、どうやら<code>do()</code>を実行するごとに実行回数を返してくれるそうです。<br>
実行回数毎に、期待する値を増加させてみましょう。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> unittest
<span class="token keyword">from</span> <span class="token punctuation">.</span>fizzbuzz <span class="token keyword">import</span> FizzBuzz


<span class="token keyword">class</span> <span class="token class-name">ExampleTestCase</span><span class="token punctuation">(</span>unittest<span class="token punctuation">.</span>TestCase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">test_success</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        fb <span class="token operator">=</span> FizzBuzz<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>fb<span class="token punctuation">.</span>do<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>fb<span class="token punctuation">.</span>do<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>fb<span class="token punctuation">.</span>do<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>fb<span class="token punctuation">.</span>do<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>fb<span class="token punctuation">.</span>do<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>fb<span class="token punctuation">.</span>do<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>fb<span class="token punctuation">.</span>do<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>fb<span class="token punctuation">.</span>do<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>fb<span class="token punctuation">.</span>do<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>fb<span class="token punctuation">.</span>do<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>fb<span class="token punctuation">.</span>do<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>fb<span class="token punctuation">.</span>do<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>fb<span class="token punctuation">.</span>do<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>fb<span class="token punctuation">.</span>do<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>fb<span class="token punctuation">.</span>do<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><br> <p><code>FizzBuzz</code>は既に完成されているため、テストをいくら加えようが失敗するはずがないのですが、試してみましょう。<br>
まあ、やる意味はないと思うのですが（笑）</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ python -m unittest -v example.test_fizzbuzz
test_success <span class="token punctuation">(</span>example.test_fizzbuzz.ExampleTestCase<span class="token punctuation">)</span> <span class="token punctuation">..</span>. FAIL
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><br> <h3 id="サイクル2-green"><a href="#サイクル2-green" class="header-anchor">#</a> サイクル2 Green</h3> <p>なんということでしょうか。<br>
完成されていたと思われた<code>do()</code>は、何回実行しても「1」しか返してくれないではないですか。</p> <p>誰ですか、こんな実装にしたのは（怒）</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>count <span class="token operator">=</span> <span class="token number">0</span>

<span class="token keyword">class</span> <span class="token class-name">FizzBuzz</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">do</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">global</span> count
        count <span class="token operator">+=</span> <span class="token number">1</span>
        <span class="token keyword">return</span> count
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><br> <p>だいぶ雑なコードですが、たぶん動くと思うからテストしましょう。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ python -m unittest -v example.test_fizzbuzz
test_success <span class="token punctuation">(</span>example.test_fizzbuzz.ExampleTestCase<span class="token punctuation">)</span> <span class="token punctuation">..</span>. ok
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><br> <h3 id="サイクル2-refactoring"><a href="#サイクル2-refactoring" class="header-anchor">#</a> サイクル2 Refactoring</h3> <p>現在の<code>FizzBuzz</code>はグローバル変数が使用されているなど、あまり美しくありません。<br>
クラスで値を持たせて、インスタンス毎に値を共有させないようにしましょう。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">FizzBuzz</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">def</span> <span class="token function">do</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>count <span class="token operator">+=</span> <span class="token number">1</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>count
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><br> <p>コードを変更しましたが、テストの結果が成功のままであることを確認します。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ python -m unittest -v example.test_fizzbuzz
test_success <span class="token punctuation">(</span>example.test_fizzbuzz.ExampleTestCase<span class="token punctuation">)</span> <span class="token punctuation">..</span>. ok
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><br> <h3 id="サイクル3-red"><a href="#サイクル3-red" class="header-anchor">#</a> サイクル3 Red</h3> <p>さて、ここまでで以下の仕様を実装することができました。</p> <ul><li>内部でカウントを保持する。</li> <li>3でも5でもないカウントは、その値を返す。</li></ul> <br> <p>次は「3の倍数なら&quot;Fizz&quot;を返す」を実装してみましょう。</p> <p>失敗するテストを書きます。
テスト全体を書くと文字量が多くなりますので、以降は差分で表記します。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>-        self.assertEqual(fb.do(), 3)
+        self.assertEqual(fb.do(), &quot;Fizz&quot;)

-        self.assertEqual(fb.do(), 6)
+        self.assertEqual(fb.do(), &quot;Fizz&quot;)

-        self.assertEqual(fb.do(), 9)
+        self.assertEqual(fb.do(), &quot;Fizz&quot;)

-        self.assertEqual(fb.do(), 12)
+        self.assertEqual(fb.do(), &quot;Fizz&quot;)

-        self.assertEqual(fb.do(), 15)
+        self.assertEqual(fb.do(), &quot;Fizz&quot;)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><br> <p>テストは失敗しますね。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ python -m unittest -v example.test_fizzbuzz
test_success <span class="token punctuation">(</span>example.test_fizzbuzz.ExampleTestCase<span class="token punctuation">)</span> <span class="token punctuation">..</span>. FAIL
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><br> <h3 id="サイクル3-green"><a href="#サイクル3-green" class="header-anchor">#</a> サイクル3 Green</h3> <p>さて、&quot;Fizz&quot;を返せるように<code>FizzBuzz</code>を修正しましょう。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">FizzBuzz</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">def</span> <span class="token function">do</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>count <span class="token operator">+=</span> <span class="token number">1</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>count <span class="token operator">%</span> <span class="token number">3</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">&quot;Fizz&quot;</span>

        <span class="token keyword">return</span> self<span class="token punctuation">.</span>count
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><br> <p>テストはオールグリーンです。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ python -m unittest -v example.test_fizzbuzz
test_success <span class="token punctuation">(</span>example.test_fizzbuzz.ExampleTestCase<span class="token punctuation">)</span> <span class="token punctuation">..</span>. ok
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><br> <h3 id="サイクル3-refactoring"><a href="#サイクル3-refactoring" class="header-anchor">#</a> サイクル3 Refactoring</h3> <p>特にリファクタリング箇所がないので省きます。</p> <br> <h3 id="サイクル4-red"><a href="#サイクル4-red" class="header-anchor">#</a> サイクル4 Red</h3> <p>最後の仕様になります。<br>
最後は「5の倍数なら&quot;Buzz&quot;を返す」を実装します。</p> <p>ただし、3かつ5の倍数であれば&quot;FizzBuzz&quot;が返ることに注意してください。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>-        self.assertEqual(fb.do(), 5)
+        self.assertEqual(fb.do(), &quot;Buzz&quot;)

-        self.assertEqual(fb.do(), 10)
+        self.assertEqual(fb.do(), &quot;Buzz&quot;)

-        self.assertEqual(fb.do(), 15)
+        self.assertEqual(fb.do(), &quot;FizzBuzz&quot;)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><br> <p>「手がかかる子ほど可愛い」というのは、このことを言うのでしょうか。<br>
だんだんコンソールに出力される「FAIL」が愛おしく思えてきました。</p> <p>きっと「失敗の後は必ず成功する」ということが約束されているからでしょう。</p> <p>みなさんも、そう思いませんか？</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ python -m unittest -v example.test_fizzbuzz
test_success <span class="token punctuation">(</span>example.test_fizzbuzz.ExampleTestCase<span class="token punctuation">)</span> <span class="token punctuation">..</span>. FAIL
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><br> <h3 id="サイクル4-green"><a href="#サイクル4-green" class="header-anchor">#</a> サイクル4 Green</h3> <p>&quot;Buzz&quot;および&quot;FizzBuzz&quot;を返せるようにしましょう。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">FizzBuzz</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">def</span> <span class="token function">do</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>count <span class="token operator">+=</span> <span class="token number">1</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>count <span class="token operator">%</span> <span class="token number">15</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">&quot;FizzBuzz&quot;</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>count <span class="token operator">%</span> <span class="token number">3</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">&quot;Fizz&quot;</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>count <span class="token operator">%</span> <span class="token number">5</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">&quot;Buzz&quot;</span>

        <span class="token keyword">return</span> self<span class="token punctuation">.</span>count
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><br> <p>テストも通ります。<br>
やったか！？（まだ終わりじゃないです。）</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ python -m unittest -v example.test_fizzbuzz
test_success <span class="token punctuation">(</span>example.test_fizzbuzz.ExampleTestCase<span class="token punctuation">)</span> <span class="token punctuation">..</span>. ok
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><br> <h3 id="サイクル4-refactoring"><a href="#サイクル4-refactoring" class="header-anchor">#</a> サイクル4 Refactoring</h3> <p>最後のリファクタリングになります。<br>
これで全てを終わらせて、あなたは次のステージへ進むことになるでしょう。</p> <p>先程書いた<code>FizzBuzz</code>では、まだ手続きを共通化し、最適にできる部分があります。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment">#####################################</span>
<span class="token comment"># このコードは一例です。</span>
<span class="token comment"># みんなが読みやすいコードを書こうね！</span>
<span class="token comment">#####################################</span>
<span class="token keyword">class</span> <span class="token class-name">FizzBuzz</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">def</span> <span class="token function">_divided</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> count<span class="token punctuation">,</span> div<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token keyword">not</span><span class="token punctuation">(</span>count <span class="token operator">%</span> div<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">do</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>count <span class="token operator">+=</span> <span class="token number">1</span>
        result <span class="token operator">=</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>count<span class="token punctuation">,</span> <span class="token string">&quot;Fizz&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Buzz&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;FizzBuzz&quot;</span><span class="token punctuation">]</span>
        index <span class="token operator">=</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>_divided<span class="token punctuation">(</span>self<span class="token punctuation">.</span>count<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> \
            <span class="token operator">+</span> self<span class="token punctuation">.</span>_divided<span class="token punctuation">(</span>self<span class="token punctuation">.</span>count<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> result<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><br> <p>多分これが一番美しいと思います。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ python -m unittest -v example.test_fizzbuzz
test_success <span class="token punctuation">(</span>example.test_fizzbuzz.ExampleTestCase<span class="token punctuation">)</span> <span class="token punctuation">..</span>. ok
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><br> <h3 id="問題にチャレンジしよう-3"><a href="#問題にチャレンジしよう-3" class="header-anchor">#</a> 問題にチャレンジしよう</h3> <p>dockerコンテナ内の<code>/test-hands-on/exercises/exercise3/challenge.py</code>には、FastAPIで書かれた作りかけのAPIがあります。</p> <p>上記のAPIは、コンテナから下記のコマンドで実行することができます。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ python3 -m uvicorn exercises.exercise3.challenge:app --reload --host <span class="token string">&quot;0.0.0.0&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><br> <p>API実行後は、ブラウザに下記のURLを入力すると、APIにアクセスできます。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>http://localhost:8000/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><br> <p>みなさんには、TDDを使って上記のAPIを完成させてもらいます。<br>
作ってもらいたいAPIの仕様は、下記のものになります。</p> <ul><li>このAPIは、<code>/, /add, /sub, /mul, /div</code>の5つのエンドポイントがあります。</li> <li>このAPIはサーバ内部でint型の値を保持し、現在設定されている値を<code>/</code>にアクセスすることで、確認することができます。
また、値は0始まりになります。</li> <li><code>/add, /sub, /mul, /div</code>にパスパラメータを与えると、保持されている値に対し、四則演算を行います（後述）。</li> <li>本APIでは、全てint型で計算を行います。</li></ul> <br> <p>以下、APIのパスについて</p> <table><thead><tr><th>パス</th> <th>詳細</th></tr></thead> <tbody><tr><td>/</td> <td><code>{&quot;current_number&quot;: {数値}}</code>が返却されます。<br>{数値}には、サーバで保持されている値が入ります。</td></tr> <tr><td>/add/{data}</td> <td><code>{&quot;current_number&quot;: {数値}}</code>が返却されます。<br>{data}に渡された値をサーバで保持している値に加算します。</td></tr> <tr><td>/sub/{data}</td> <td><code>{&quot;current_number&quot;: {数値}}</code>が返却されます。<br>{data}に渡された値をサーバで保持している値から減算します。</td></tr> <tr><td>/mul/{data}</td> <td><code>{&quot;current_number&quot;: {数値}}</code>が返却されます。<br>{data}に渡された値をサーバで保持している値に乗算します。</td></tr> <tr><td>/div/{data}</td> <td><code>{&quot;current_number&quot;: {数値}}</code>が返却されます。<br>{data}に渡された値をサーバで保持している値から除算します。</td></tr></tbody></table> <br> <p>サーバでの値の保持・取得関数は、ソース内に定義されています。<br>
以下に、使い方の例を記載します。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># サーバ内に保持されている値を記録します。</span>
set_current_number<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token comment"># サーバ内に保持されている値を取得します</span>
got_data <span class="token operator">=</span> get_current_number<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># got_data = 1</span>

set_current_number<span class="token punctuation">(</span><span class="token number">123</span> <span class="token operator">+</span> <span class="token number">456</span><span class="token punctuation">)</span>
got_data <span class="token operator">=</span> get_current_number<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># got_data = 579</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>dockerコンテナ内の<code>/test-hands-on/exercises/exercise3/test_challenge.py</code>には、本APIが完成すると通るようになる、テスト<code>test_success()</code>が定義されています。</p> <p>上記のテストがOKになるよう、各種APIをTDDを使って作成してみましょう。</p> <br> <h1 id="おわりに"><a href="#おわりに" class="header-anchor">#</a> おわりに</h1> <p>一般的にソフトウェアテストというと、専門のテスト部隊があって「Excelにスクショをペタペタ貼るだけでしょ？」というようなイメージを持ち、敬遠される方も少なくはないと思います。</p> <p>開発者がテストについて知識を持ち、単体テストで可能な限りの不具合をなくしておくと、後の工程で不具合が少なく済ますことができたり、メリットがあります。<br>
また、後の工程で発生した不具合の内容を聞いた・見ただけで、どのモジュール同士で問題が起こっているのか目星がつくなど、効率的なトラブルシュートやソフトウェアの理解にも繋がります。</p> <p>冒頭でも述べましたが、ソフトウェアにも品質というものがあり、この品質次第で会社の売上に影響が出たり、企業のセキュリティや人命に影響を及ぼしてしまう懸念もあります。</p> <p>そのため。開発を行う際には是非テストにも注力をしていただき、ユーザーの満足できるソフトウェアを作れるよう、目指してみてください。</p> <p>良いエンジニアライフを！👍</p> <div><hr> <span>CC BY-SA Licensed | Copyright (c) 2022, Internet Initiative Japan Inc.</span></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/iij/bootcamp/edit/master/src/server-app/test-hands-on/README.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">7/26/2023, 3:06:35 AM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/bootcamp/assets/js/app.5182695c.js" defer></script><script src="/bootcamp/assets/js/2.c14b973d.js" defer></script><script src="/bootcamp/assets/js/29.d3b71a87.js" defer></script><script src="/bootcamp/assets/js/16.b94b3d20.js" defer></script><script src="/bootcamp/assets/js/15.e36f630f.js" defer></script>
  </body>
</html>
