<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>5. リバースプロキシの導入/運用 | IIJ Bootcamp</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="IIJ で実施している新人向けのハンズオン資料集です。">
    
    <link rel="preload" href="/bootcamp/assets/css/0.styles.095a7d7e.css" as="style"><link rel="preload" href="/bootcamp/assets/js/app.50a11bbb.js" as="script"><link rel="preload" href="/bootcamp/assets/js/2.7bf70406.js" as="script"><link rel="preload" href="/bootcamp/assets/js/44.caef96e9.js" as="script"><link rel="preload" href="/bootcamp/assets/js/17.95c1ddf5.js" as="script"><link rel="prefetch" href="/bootcamp/assets/js/10.2adcf103.js"><link rel="prefetch" href="/bootcamp/assets/js/11.29ffe81b.js"><link rel="prefetch" href="/bootcamp/assets/js/12.d3a13d48.js"><link rel="prefetch" href="/bootcamp/assets/js/13.46565697.js"><link rel="prefetch" href="/bootcamp/assets/js/14.fb818678.js"><link rel="prefetch" href="/bootcamp/assets/js/15.81c3f4c8.js"><link rel="prefetch" href="/bootcamp/assets/js/16.c0d3a21b.js"><link rel="prefetch" href="/bootcamp/assets/js/18.c2ba277f.js"><link rel="prefetch" href="/bootcamp/assets/js/19.b881042d.js"><link rel="prefetch" href="/bootcamp/assets/js/20.456639e5.js"><link rel="prefetch" href="/bootcamp/assets/js/21.1db40e20.js"><link rel="prefetch" href="/bootcamp/assets/js/22.beeadf8d.js"><link rel="prefetch" href="/bootcamp/assets/js/23.5b5ddd07.js"><link rel="prefetch" href="/bootcamp/assets/js/24.c83bf162.js"><link rel="prefetch" href="/bootcamp/assets/js/25.63ffde0a.js"><link rel="prefetch" href="/bootcamp/assets/js/26.f2cb1d3f.js"><link rel="prefetch" href="/bootcamp/assets/js/27.3681c24a.js"><link rel="prefetch" href="/bootcamp/assets/js/28.1d58b053.js"><link rel="prefetch" href="/bootcamp/assets/js/29.b31fa967.js"><link rel="prefetch" href="/bootcamp/assets/js/3.b083bf8e.js"><link rel="prefetch" href="/bootcamp/assets/js/30.7d00f498.js"><link rel="prefetch" href="/bootcamp/assets/js/31.ea90f202.js"><link rel="prefetch" href="/bootcamp/assets/js/32.8496634b.js"><link rel="prefetch" href="/bootcamp/assets/js/33.fc3bebe9.js"><link rel="prefetch" href="/bootcamp/assets/js/34.1a9e662a.js"><link rel="prefetch" href="/bootcamp/assets/js/35.daa30ce1.js"><link rel="prefetch" href="/bootcamp/assets/js/36.8a788618.js"><link rel="prefetch" href="/bootcamp/assets/js/37.7515b893.js"><link rel="prefetch" href="/bootcamp/assets/js/38.89f585e7.js"><link rel="prefetch" href="/bootcamp/assets/js/39.30b2df34.js"><link rel="prefetch" href="/bootcamp/assets/js/4.a0928ec2.js"><link rel="prefetch" href="/bootcamp/assets/js/40.520e4a6c.js"><link rel="prefetch" href="/bootcamp/assets/js/41.b21e3ebe.js"><link rel="prefetch" href="/bootcamp/assets/js/42.963e4410.js"><link rel="prefetch" href="/bootcamp/assets/js/43.9fcce5c7.js"><link rel="prefetch" href="/bootcamp/assets/js/45.3b1f9311.js"><link rel="prefetch" href="/bootcamp/assets/js/46.e7cfa70d.js"><link rel="prefetch" href="/bootcamp/assets/js/47.593c8737.js"><link rel="prefetch" href="/bootcamp/assets/js/48.317b414b.js"><link rel="prefetch" href="/bootcamp/assets/js/49.0c631dbf.js"><link rel="prefetch" href="/bootcamp/assets/js/5.91e30bde.js"><link rel="prefetch" href="/bootcamp/assets/js/50.9d7ea09f.js"><link rel="prefetch" href="/bootcamp/assets/js/51.a0ff6d1e.js"><link rel="prefetch" href="/bootcamp/assets/js/52.6f63cff0.js"><link rel="prefetch" href="/bootcamp/assets/js/53.c37b1fe4.js"><link rel="prefetch" href="/bootcamp/assets/js/54.e871e378.js"><link rel="prefetch" href="/bootcamp/assets/js/55.f6b006bf.js"><link rel="prefetch" href="/bootcamp/assets/js/56.a62c8c31.js"><link rel="prefetch" href="/bootcamp/assets/js/57.a04f3ad1.js"><link rel="prefetch" href="/bootcamp/assets/js/58.aefc0314.js"><link rel="prefetch" href="/bootcamp/assets/js/59.24791641.js"><link rel="prefetch" href="/bootcamp/assets/js/6.2440bc90.js"><link rel="prefetch" href="/bootcamp/assets/js/60.9e03105d.js"><link rel="prefetch" href="/bootcamp/assets/js/61.f35cd630.js"><link rel="prefetch" href="/bootcamp/assets/js/62.e67bf903.js"><link rel="prefetch" href="/bootcamp/assets/js/63.861dc213.js"><link rel="prefetch" href="/bootcamp/assets/js/64.860bec87.js"><link rel="prefetch" href="/bootcamp/assets/js/65.48e87058.js"><link rel="prefetch" href="/bootcamp/assets/js/7.d1ac5f77.js"><link rel="prefetch" href="/bootcamp/assets/js/8.fa0960a5.js"><link rel="prefetch" href="/bootcamp/assets/js/9.22c8c25f.js">
    <link rel="stylesheet" href="/bootcamp/assets/css/0.styles.095a7d7e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/bootcamp/" class="home-link router-link-active"><!----> <span class="site-name">IIJ Bootcamp</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/iij/bootcamp" target="_blank" rel="noopener noreferrer" class="repo-link">
      GitHub
      <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/iij/bootcamp" target="_blank" rel="noopener noreferrer" class="repo-link">
      GitHub
      <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>5. リバースプロキシの導入/運用</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/bootcamp/cicd_infra/ansible/REVERSE_PROXY.html#_5-リバースプロキシの導入-運用" class="sidebar-link">5. リバースプロキシの導入/運用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bootcamp/cicd_infra/ansible/REVERSE_PROXY.html#ansible-playbook-ディレクトリ構造" class="sidebar-link">Ansible playbook ディレクトリ構造</a></li><li class="sidebar-sub-header"><a href="/bootcamp/cicd_infra/ansible/REVERSE_PROXY.html#ファイル編集" class="sidebar-link">ファイル編集</a></li><li class="sidebar-sub-header"><a href="/bootcamp/cicd_infra/ansible/REVERSE_PROXY.html#実行" class="sidebar-link">実行</a></li></ul></li><li><a href="/bootcamp/cicd_infra/ansible/REVERSE_PROXY.html#_3-ケース-2-バージョンアップ-スケーリング" class="sidebar-link">3. [ケース 2] バージョンアップ &amp; スケーリング</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bootcamp/cicd_infra/ansible/REVERSE_PROXY.html#バージョンアップ" class="sidebar-link">バージョンアップ</a></li><li class="sidebar-sub-header"><a href="/bootcamp/cicd_infra/ansible/REVERSE_PROXY.html#スケールアップ" class="sidebar-link">スケールアップ</a></li><li class="sidebar-sub-header"><a href="/bootcamp/cicd_infra/ansible/REVERSE_PROXY.html#解答例" class="sidebar-link">解答例</a></li><li class="sidebar-sub-header"><a href="/bootcamp/cicd_infra/ansible/REVERSE_PROXY.html#コラム-特定の-playbook-のみ実行する" class="sidebar-link">コラム 特定の playbook のみ実行する</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="_5-リバースプロキシの導入-運用"><a href="#_5-リバースプロキシの導入-運用" class="header-anchor">#</a> 5. リバースプロキシの導入/運用</h2> <p>それではいよいよ本格的に Ansible を活用してみます。
さきほどのセクションで構築したデータベースとアプリケーションを流用し変更を加えてみます。</p> <p>現在の状態は、ブラウザから直接アプリケーションに<code>HTTP</code>でアクセスしている状態です。
nginx を導入し、<code>HTTPS</code>でアクセスしてみましょう。</p> <p>今回、新たに Reverse proxy サーバを構築するにあたっては
既存の<code>site.yml</code>への追記が必要となります。</p> <p>前回までで記述ルールのいくつかはご説明致しましたが
本格的に作業に取り組む前に一つ確認をしておきます。</p> <h3 id="ansible-playbook-ディレクトリ構造"><a href="#ansible-playbook-ディレクトリ構造" class="header-anchor">#</a> Ansible playbook ディレクトリ構造</h3> <p>作業に取りかかる前にまず、ディレクトリ構造を確認してみましょう。
下記は教材のディレクトリ構造から Ansible に関わるファイルやディレクトリのみを抜粋しています。</p> <p>それぞれのファイル・ディレクトリに役割説明を記載しています。</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>├── ansible.cfg  <span class="token comment"># Ansibleの設定ファイル</span>
├── inventories  <span class="token comment"># 管理対象サーバの情報を格納するディレクトリ</span>
│   ├── group_vars  <span class="token comment"># グループごとの変数ファイルを格納するファイル</span>
│   │   └── all.yml  <span class="token comment"># すべてのグループに適用される変数ファイル</span>
│   └── hosts  <span class="token comment"># サーバのIPやSSHのユーザやグループなどを記述するファイル</span>
├── playbooks  <span class="token comment"># 実行用ファイルを格納するディレクトリ。各ファイルはsite.ymlからインポートします。</span>
│   ├── acl.yml
│   ├── app.yml
│   ├── db.yml
│   └── rp.yml
├── roles  <span class="token comment"># ロールを格納するディレクトリ。Ansibleの実行はロールと呼ばれるまとまりで管理されます。</span>
│   └── webapp
│       ├── defaults
│       │   └── main.yml  <span class="token comment"># ロール内で使用される変数のデフォルト値を定義するファイル</span>
│       ├── files  <span class="token comment"># サーバへ配布したいファイルを格納するディレクトリ</span>
│       ├── handlers
│       │   └── main.yml  <span class="token comment"># ハンドラタスクを定義するファイル</span>
│       ├── tasks
│       │   └── main.yml  <span class="token comment"># Ansibleの具体的な処理内容を記述するファイル</span>
│       └── templates  <span class="token comment"># サーバへ配布したいJinja2テンプレートを使ったファイルを格納するディレクトリ</span>
├── site.yml  <span class="token comment"># playbookファイル</span>
└── vars
    └── proxy.yml  <span class="token comment"># Proxy配下でハンズオンを実施するためのファイル</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>なぜ、このような構成にしているかと言うと、
Ansible ではより多くの人たちが正しく仕えるように推奨の記述方式を定めています。</p> <p>ディレクトリ構成もその一部であり、Inventory や Role 等は Ansible を実行する上で
それぞれのファイルを探すデフォルトパスになっていますので、よほどの理由が無い限り
ベストプラクティスに沿って作成する事が推奨されます。</p> <p>詳しく知りたい人は Ansible の<a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_best_practices.html" target="_blank" rel="noopener noreferrer">ベストプラクティス<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>をご覧ください。</p> <h3 id="ファイル編集"><a href="#ファイル編集" class="header-anchor">#</a> ファイル編集</h3> <p>それではファイルを作成してみましょう。
TLS の証明書に加え、いくつかの設定ファイルはすでに用意してあります。
皆さんには下記 4 つのファイルを編集してもらいます。</p> <h4 id="roles-nginx-tasks-main-yml"><a href="#roles-nginx-tasks-main-yml" class="header-anchor">#</a> roles/nginx/tasks/main.yml</h4> <p>nginx を構築するためのタスクファイルです。
<a href="http://nginx.org/en/linux_packages.html#RHEL-CentOS" target="_blank" rel="noopener noreferrer">公式ドキュメント<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>のインストール手順に加え、設定ファイルや証明書の配布を行っています。</p> <p>Ansible はモジュールと呼ばれるものを使って、さまざまな処理を行います。
Ansible に組込み済みのモジュールは<a href="https://docs.ansible.com/ansible/latest/modules/list_of_all_modules.html" target="_blank" rel="noopener noreferrer">公式ドキュメント<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>にリストアップされており、各モジュールごとの書き方が載っています。
モジュールを自作して使うこともできますが、基本的には上記のサイトから行いたい処理に合ったモジュールを探し、タスクファイルを作ります。</p> <p>下記の内容を教材の<code>roles/nginx/tasks/main.yml</code>にコピーしましょう。</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install yum<span class="token punctuation">-</span>utils
  <span class="token key atrule">yum</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> yum<span class="token punctuation">-</span>utils
    <span class="token key atrule">state</span><span class="token punctuation">:</span> present
  <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token string">&quot;{{ proxy_env | default({}) }}&quot;</span>

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> add Nginx repository
  <span class="token key atrule">copy</span><span class="token punctuation">:</span>
    <span class="token key atrule">src</span><span class="token punctuation">:</span> <span class="token string">&quot;etc/yum.repos.d/nginx.repo&quot;</span>
    <span class="token key atrule">dest</span><span class="token punctuation">:</span> <span class="token string">&quot;/etc/yum.repos.d/nginx.repo&quot;</span>
    <span class="token key atrule">mode</span><span class="token punctuation">:</span> <span class="token number">0644</span>

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install Nginx
  <span class="token key atrule">yum</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">&quot;nginx&quot;</span>
    <span class="token key atrule">state</span><span class="token punctuation">:</span> present
  <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token string">&quot;{{ proxy_env | default({}) }}&quot;</span>
  <span class="token key atrule">ignore_errors</span><span class="token punctuation">:</span> <span class="token string">&quot;{{ ansible_check_mode }}&quot;</span>

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create ssl directory
  <span class="token key atrule">file</span><span class="token punctuation">:</span>
    <span class="token key atrule">state</span><span class="token punctuation">:</span> directory
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/nginx/ssl
    <span class="token key atrule">owner</span><span class="token punctuation">:</span> root
    <span class="token key atrule">group</span><span class="token punctuation">:</span> root
    <span class="token key atrule">mode</span><span class="token punctuation">:</span> <span class="token number">0600</span>

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> deploy ssl files
  <span class="token key atrule">copy</span><span class="token punctuation">:</span>
    <span class="token key atrule">src</span><span class="token punctuation">:</span> <span class="token string">&quot;etc/nginx/ssl/{{ item }}&quot;</span>
    <span class="token key atrule">dest</span><span class="token punctuation">:</span> <span class="token string">&quot;/etc/nginx/ssl/{{ item }}&quot;</span>
    <span class="token key atrule">mode</span><span class="token punctuation">:</span> <span class="token number">0400</span>
  <span class="token key atrule">with_items</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> server.crt
    <span class="token punctuation">-</span> server.key
    <span class="token punctuation">-</span> dhparam.pem

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> remove default config file
  <span class="token key atrule">file</span><span class="token punctuation">:</span>
    <span class="token key atrule">state</span><span class="token punctuation">:</span> absent
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/nginx/conf.d/default.conf
  <span class="token key atrule">notify</span><span class="token punctuation">:</span> reload nginx

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> deploy config file
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">src</span><span class="token punctuation">:</span> etc/nginx/conf.d/app.conf.j2
    <span class="token key atrule">dest</span><span class="token punctuation">:</span> /etc/nginx/conf.d/app.conf
    <span class="token key atrule">owner</span><span class="token punctuation">:</span> root
    <span class="token key atrule">group</span><span class="token punctuation">:</span> root
    <span class="token key atrule">mode</span><span class="token punctuation">:</span> <span class="token number">0644</span>
  <span class="token key atrule">notify</span><span class="token punctuation">:</span> reload nginx

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> start nginx
  <span class="token key atrule">systemd</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">state</span><span class="token punctuation">:</span> started
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> yes
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><p>nginx の構築に使用したモジュールの一覧は以下になります。</p> <table><thead><tr><th style="text-align:center;">モジュール名</th> <th style="text-align:left;">説明</th></tr></thead> <tbody><tr><td style="text-align:center;"><a href="https://docs.ansible.com/ansible/latest/modules/yum_module.html#yum-module" target="_blank" rel="noopener noreferrer">yum<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">yum コマンドを使って RPM パッケージを操作できるモジュールです。</td></tr> <tr><td style="text-align:center;"><a href="https://docs.ansible.com/ansible/latest/modules/file_module.html#file-module" target="_blank" rel="noopener noreferrer">file<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">対象サーバのファイルシステムを操作できるモジュールです。<br>ディレクトリやファイルを作成/削除したり、ファイルのオーナーやパーミッションを変更できたりします。</td></tr> <tr><td style="text-align:center;"><a href="https://docs.ansible.com/ansible/latest/modules/copy_module.html#copy-module" target="_blank" rel="noopener noreferrer">copy<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">対象サーバへファイルをコピーできるモジュールです。</td></tr> <tr><td style="text-align:center;"><a href="https://docs.ansible.com/ansible/latest/modules/template_module.html#template-module" target="_blank" rel="noopener noreferrer">template<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;">対象サーバへファイルをコピーできるモジュールです。<code>copy</code>との違いはファイル内に<code>Jinja2</code>テンプレートが使える点です。<br>ファイル内で変数を使いたい場合はこちらを使います。</td></tr> <tr><td style="text-align:center;"><a href="https://docs.ansible.com/ansible/latest/modules/systemd_module.html#systemd-module" target="_blank" rel="noopener noreferrer">systemd<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:left;"><a href="https://wiki.archlinux.jp/index.php/Systemd" target="_blank" rel="noopener noreferrer">systmed<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>によって管理されるプロセスを操作できるモジュールです。<br>基本的には Linux 環境でプロセスを常駐させる場合はこれを使います。</td></tr></tbody></table> <h4 id="roles-nginx-templates-etc-nginx-conf-d-app-conf-j2"><a href="#roles-nginx-templates-etc-nginx-conf-d-app-conf-j2" class="header-anchor">#</a> roles/nginx/templates/etc/nginx/conf.d/app.conf.j2</h4> <p>nginx の設定ファイルです。
ファイル内で変数を使用しているので<code>templates</code>下に配置しています。</p> <p>分かりやすさのために、配置するディレクトリをコピー先のパスと同じにしています。
Ansible やサーバの構築/運用に慣れないうちは、こうしておくことをお勧めします。</p> <p>下記の内容を教材の<code>roles/nginx/templates/etc/nginx/conf.d/app.conf.j2</code>にコピーしましょう。</p> <div class="language-jinja line-numbers-mode"><pre class="language-text"><code>upstream app_backend {
    {% for app in nginx_backends %}
    server {{ app.host }}:{{ app.port }} max_fails=1 fail_timeout=3s;
    {% endfor %}
}

server {
  listen {{ nginx_https_port }} ssl;

  ssl_protocols TLSv1.2 TLSv1.3;
  ssl_certificate /etc/nginx/ssl/server.crt;
  ssl_certificate_key /etc/nginx/ssl/server.key;
  ssl_dhparam /etc/nginx/ssl/dhparam.pem;

  location / {
    proxy_set_header  Host  $http_host;
    proxy_set_header  X-Real-IP  $remote_addr;
    proxy_set_header  X-Forwarded-Host  $server_name;
    proxy_set_header  X-Forwarded-Server  $host;
    proxy_set_header  X-Forwarded-Proto  $scheme;
    proxy_set_header  X-Forwarded-Port {{ nginx_https_port }};
    proxy_set_header  X-Forwarded-For  $proxy_add_x_forwarded_for;
    proxy_pass  http://app_backend;
  }

  error_page 404 /404.html;

  error_page 500 502 503 504 /50x.html;
  location = /50x.html {
    root  /usr/share/nginx/html;
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>nginx の設定について説明することは主題から外れるので、この講義では行いません。
興味のある人は nginx の<a href="http://nginx.org/en/docs/http/configuring_https_servers.html" target="_blank" rel="noopener noreferrer">公式ドキュメント<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>をご覧ください。</p> <h4 id="playbooks-rp-yml"><a href="#playbooks-rp-yml" class="header-anchor">#</a> playbooks/rp.yml</h4> <p>nginx を構築するための実行ファイルです。
対象サーバとロールを指定することで、指定したサーバに nginx を構築できます。</p> <p>下記の内容を教材の<code>playbooks/rp.yml</code>にコピーしましょう。</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> set up the reverse proxy server
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> rp
  <span class="token key atrule">become</span><span class="token punctuation">:</span> no
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> no
  <span class="token key atrule">vars_files</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ../vars/proxy.yml
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> roles/nginx
      <span class="token key atrule">tags</span><span class="token punctuation">:</span> nginx
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="site-yml"><a href="#site-yml" class="header-anchor">#</a> site.yml</h4> <p>最後に、さきほど作った<code>playbooks/rp.yml</code>をインポートする様に教材の<code>site.yml</code>に下記を追記します。</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token punctuation">-</span> <span class="token key atrule">import_playbook</span><span class="token punctuation">:</span> playbooks/rp.yml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="実行"><a href="#実行" class="header-anchor">#</a> 実行</h3> <p>さて、ファイルがすべて準備できたらいよいよ Ansible を実行します。</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>ansible-playbook <span class="token parameter variable">-i</span> inventories/hosts site.yml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>failed=0</code>と表示されれば実行は成功です。</p> <p>ブラウザで<a href="https://localhost:8443" target="_blank" rel="noopener noreferrer">https://localhost:8443<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>にアクセスして確認します。
自己署名証明書を使っているためブラウザから注意文言が表示されますが、スキップしてください。
すると、さきほどと同じ画面が表示されます。</p> <p>ここで、もう一つ注目してほしい部分があります。
Ansible の実行ログを眺めると、データベースや Java アプリケーションの構築用のタスクもステータスが<code>ok</code>の状態で、実行されているのが分かると思います。
またさきほど実行した<code>ansible-playbook site.yml</code>をもう一度実行すると、nginx の構築タスクも含め、すべてのタスクのステータスが<code>ok</code>になります。</p> <p>ある操作を何回行っても等価であるとき、その操作を<code>冪等</code>であると言います。
<strong>Ansible の良さの 1 つがこの<code>冪等</code>性です。</strong>
基本的に Ansible は同じタスクを何回実行しても、差分のないタスクは実行されません。
すなわち、ファイルを変更しない限りホストに対して余計な変更が加わらず、安全です。</p> <p>しかしこの<code>冪等</code>性は意識していないと壊れてしまう場合があります。
Ansible を使うときは<code>冪等</code>性に注意を払いましょう。</p> <h2 id="_3-ケース-2-バージョンアップ-スケーリング"><a href="#_3-ケース-2-バージョンアップ-スケーリング" class="header-anchor">#</a> 3. [ケース 2] バージョンアップ &amp; スケーリング</h2> <p>さて、nginx を導入して初期構築タスクを自動化できました。
次は変数やホスト情報を編集して、運用タスクを自動化してみましょう。</p> <h3 id="バージョンアップ"><a href="#バージョンアップ" class="header-anchor">#</a> バージョンアップ</h3> <p>まずは nginx のバージョンアップをしてみましょう。</p> <p>さきほどインストールされた nginx のバージョンは少し古めの<code>1.20.0</code>です。
このバージョンは<code>roles/nginx/defaults/main.yml</code>に<code>nginx_version</code>という変数として定義されています。
また、下記のコマンドを実行することで、確認することもできます。</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>ansible rp1 <span class="token parameter variable">-m</span> <span class="token builtin class-name">command</span> <span class="token parameter variable">-a</span> <span class="token string">'nginx -V'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>これを<code>1.22.0</code>にアップデートしてみたいと思います。
教材の<code>inventories/group_vars/all.yml</code>に下記を追記しましょう。</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">nginx_version</span><span class="token punctuation">:</span> 1.22.0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Ansible には変数の優先度が設定されており、同じ名前の変数は優先度の高いほうが有効になります。
これを利用することでロールの完全性を担保しつつ、タスクの内容を編集できます。</p> <p>具体的な優先度は<a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html#variable-precedence-where-should-i-put-a-variable" target="_blank" rel="noopener noreferrer">公式ドキュメント<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>をご覧ください。</p> <p>ファイルの準備ができたら Ansible を実行します。</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>ansible-playbook <span class="token parameter variable">-i</span> inventories/hosts site.yml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>本実行が完了したら、さきほどの確認コマンドを実行してバージョンが上がったことを確認してみましょう。</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>ansible rp1 <span class="token parameter variable">-m</span> <span class="token builtin class-name">command</span> <span class="token parameter variable">-a</span> <span class="token string">'nginx -V'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="スケールアップ"><a href="#スケールアップ" class="header-anchor">#</a> スケールアップ</h3> <p>次はアプリケーションサーバをスケールアップ（増設）してみましょう。
と言っても増設用のサーバはすでにコンテナとして起動してあるので、皆さんがすべきことは下記 2 つのファイルの編集です。</p> <h4 id="inventories-hosts"><a href="#inventories-hosts" class="header-anchor">#</a> inventories/hosts</h4> <p>まずは Ansible の管理対象にアプリケーション増設用のサーバ（app2）を追加します。
教材の<code>inventories/hosts</code>を下記のように追記してください。</p> <div class="language-diff line-numbers-mode"><pre class="language-diff"><code>[app]
app1
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> app2
</span></span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>これで<code>app</code>グループの中に<code>app2</code>サーバを追加できました。</p> <p>Ansible には管理対象のホストをグルーピングし、設定したグループ単位で Ansible を実行したり、変数を設定できたりします。
こうすることで、柔軟かつ効率的にサーバを管理できます。
この講義ではそれぞれ 1 台しかありませんが、データベースサーバやリバースプロキシサーバもグループに分けられています。</p> <p>Ansible のグループやホストについての詳細は<a href="/bootcamp/cicd_infra/ansible/hhttps:/docs.ansible.com/ansible/latest/user_guide/intro_inventory.html#inventory-basics-formats-hosts-and-groups">公式ドキュメント</a>をご覧ください。</p> <h4 id="inventories-group-vars-all-yml"><a href="#inventories-group-vars-all-yml" class="header-anchor">#</a> inventories/group_vars/all.yml</h4> <p>次に変数ファイルを編集します。
さきほども編集した<code>inventories/group_vars/all.yml</code>に下記のように追記します。</p> <div class="language-diff line-numbers-mode"><pre class="language-diff"><code>nginx_backends:
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> - host: 192.0.2.12
</span><span class="token prefix unchanged"> </span><span class="token line">   port: &quot;{{ server_port }}&quot;
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> - host: 192.0.2.13
</span><span class="token prefix inserted">+</span><span class="token line">   port: &quot;{{ server_port }}&quot;
</span></span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>これは nginx が通信を経由させるサーバのリストを格納している変数です。
ここに新しく<code>app2</code>サーバの情報を追記することで、nginx が<code>app2</code>サーバにも通信を流してくれます。</p> <p>nginx はロードバランサ（負荷分散装置）としての機能も備えているので、
こうすることで今まで<code>app1</code>サーバにしかいかなかった通信が<code>app2</code>にも行くようになり、負荷を分散できます。</p> <p>nginx の機能について詳しく説明することは主題から外れてしまいますので、この講義では行いません。
さらに詳しく知りたい人は nginx の<a href="http://nginx.org/en/docs/http/load_balancing.html" target="_blank" rel="noopener noreferrer">公式ドキュメント<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>をご覧ください。</p> <h4 id="実行-2"><a href="#実行-2" class="header-anchor">#</a> 実行</h4> <p>さて、ファイルの準備ができたら Ansible を実行します。
今回は事前にチェックを行ってみましょう。</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>ansible-playbook <span class="token parameter variable">-C</span> site.yml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>dryrun</code>で結果を確認すると、新たに<code>app2</code>サーバが増えていることが確認できます。
また、nginx の設定ファイルの差分も確認できるはずです。</p> <p><code>failed=0</code>と表示されていれば問題ありません。
<code>-C（--check）</code>のオプションを外し、本実行を行いましょう。</p> <p>コマンドが終了したら、ブラウザで<a href="https://localhost:8443" target="_blank" rel="noopener noreferrer">https://localhost:8443<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>にアクセスして確認してみましょう。</p> <p>この Web アプリケーションは動作しているサーバのホスト名を画面に表示しています。
新しくブラウザを開き<a href="https://localhost:8443" target="_blank" rel="noopener noreferrer">https://localhost:8443<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>にアクセスすると、ホスト名の表記が変わっているはずです。</p> <p>これにより、nginx が正常に負荷を分散してくれていることが確認できます。</p> <p>ここで、もう一つ注目していただきたいところがあります。
Ansible の実行ログの中に、<code>RUNNING HANDLER</code>という表記が確認できると思います。
さきほどと同じ様に<code>ansible-playbook site.yml</code>と実行した場合、この表記がなくなると思います。</p> <p>これは Ansible のハンドラという機能になります。
これは、ハンドラを設定したタスクが<code>changed</code>のときにのみ実行されるタスクを設定できる機能です。
実際に実行されるタスクは各ロールの<code>handlers/main.yml</code>に書かれています。</p> <p>これにより設定ファイルが変更された場合のみ、アプリケーションやデータベースなどのプロセスを再起動できます。
影響範囲を限定できるため、安全にホストに対して変更を加えることができます。</p> <p>詳細は<a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_intro.html#handlers-running-operations-on-change" target="_blank" rel="noopener noreferrer">公式ドキュメント<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>をご覧ください。</p> <h3 id="解答例"><a href="#解答例" class="header-anchor">#</a> 解答例</h3> <p><a href="https://github.com/iij/ansible-exercise/tree/solution" target="_blank" rel="noopener noreferrer">教材の solution ブランチ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>が解答例になっています。
この解答例以外にも多くの実現方法がありますが、参考にしてもらえればと思います。</p> <p>他のファイルについても、この講義を受けた後の最終的なファイルの内容になっています。
ハンズオンを進める中でつまずくことがあれば、参考にしてもらえればと思います。</p> <h3 id="コラム-特定の-playbook-のみ実行する"><a href="#コラム-特定の-playbook-のみ実行する" class="header-anchor">#</a> コラム 特定の playbook のみ実行する</h3> <p>Ansible には冪等性を担保する為の仕組みが備わっているというのは記述したとおりです。
しかしながら、実行する前から不要と分かっている作業まで読み込ませ、Ansible に実行判断を任せるというのは
万が一を気にする運用の場では不安を感じたり、処理時間が惜しいと感じることもあるでしょう。</p> <p>Ansible ではそのような際に、実行タスクを分けて実行する事も可能になっています。
今回のケースでは以下のように実行する事で nginx のみのタスクだけ実行する、といった事が可能になります。</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>ansible-playbook <span class="token parameter variable">-C</span> site.yml <span class="token parameter variable">-t</span> nginx
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>これはどのように実行しているのでしょうか。
実は Ansible には<code>タグ</code>という機能があり、タスクやロールなどに任意の値（タグ）を付けることができます。
これを利用することで、Ansible 実行時に任意のタスクのみを実行する/しないことができます。
実はさきほどの<code>playbooks/rp.yml</code>にタグが設定してありました。</p> <p>タグは増やしすぎても管理がたいへんになるので、ある程度のまとまりやよく使うタスクにのみ付与するのが良いでしょう。
タグの詳細については<a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_tags.html" target="_blank" rel="noopener noreferrer">公式ドキュメント<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>をご覧ください。</p> <div><hr> <span>CC BY-SA Licensed | Copyright (c) 2023, Internet Initiative Japan Inc.</span></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/iij/bootcamp/edit/master/src/cicd_infra/ansible/REVERSE_PROXY.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">7/29/2025, 10:08:37 AM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/bootcamp/assets/js/app.50a11bbb.js" defer></script><script src="/bootcamp/assets/js/2.7bf70406.js" defer></script><script src="/bootcamp/assets/js/44.caef96e9.js" defer></script><script src="/bootcamp/assets/js/17.95c1ddf5.js" defer></script>
  </body>
</html>
