<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>drone でCIテスト・デプロイを回す | IIJ Bootcamp</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="IIJ で実施している新人向けのハンズオン資料集です。">
    
    <link rel="preload" href="/bootcamp/assets/css/0.styles.095a7d7e.css" as="style"><link rel="preload" href="/bootcamp/assets/js/app.7ad561c0.js" as="script"><link rel="preload" href="/bootcamp/assets/js/2.f42780dc.js" as="script"><link rel="preload" href="/bootcamp/assets/js/12.b5ed6a6b.js" as="script"><link rel="prefetch" href="/bootcamp/assets/js/10.4954f9c4.js"><link rel="prefetch" href="/bootcamp/assets/js/11.6174e313.js"><link rel="prefetch" href="/bootcamp/assets/js/13.1a1190ad.js"><link rel="prefetch" href="/bootcamp/assets/js/14.f3e7f559.js"><link rel="prefetch" href="/bootcamp/assets/js/15.cefe1fcc.js"><link rel="prefetch" href="/bootcamp/assets/js/16.4d0bf39d.js"><link rel="prefetch" href="/bootcamp/assets/js/17.2509d33d.js"><link rel="prefetch" href="/bootcamp/assets/js/18.a532029f.js"><link rel="prefetch" href="/bootcamp/assets/js/19.1d8ac687.js"><link rel="prefetch" href="/bootcamp/assets/js/20.63355336.js"><link rel="prefetch" href="/bootcamp/assets/js/21.5539b33d.js"><link rel="prefetch" href="/bootcamp/assets/js/22.9ed7bd24.js"><link rel="prefetch" href="/bootcamp/assets/js/23.f0609113.js"><link rel="prefetch" href="/bootcamp/assets/js/24.419d4b03.js"><link rel="prefetch" href="/bootcamp/assets/js/25.72faa4c4.js"><link rel="prefetch" href="/bootcamp/assets/js/26.53d0321f.js"><link rel="prefetch" href="/bootcamp/assets/js/27.e9563c80.js"><link rel="prefetch" href="/bootcamp/assets/js/28.87e1f1e1.js"><link rel="prefetch" href="/bootcamp/assets/js/29.eae8513f.js"><link rel="prefetch" href="/bootcamp/assets/js/3.7eca3ff7.js"><link rel="prefetch" href="/bootcamp/assets/js/30.e35fcba1.js"><link rel="prefetch" href="/bootcamp/assets/js/31.6b59acbe.js"><link rel="prefetch" href="/bootcamp/assets/js/32.ab5aaa6d.js"><link rel="prefetch" href="/bootcamp/assets/js/33.888933a9.js"><link rel="prefetch" href="/bootcamp/assets/js/34.dcb88ba2.js"><link rel="prefetch" href="/bootcamp/assets/js/35.faba5c7b.js"><link rel="prefetch" href="/bootcamp/assets/js/36.0618250e.js"><link rel="prefetch" href="/bootcamp/assets/js/37.bf473902.js"><link rel="prefetch" href="/bootcamp/assets/js/38.d5343427.js"><link rel="prefetch" href="/bootcamp/assets/js/39.eb453bc1.js"><link rel="prefetch" href="/bootcamp/assets/js/4.0ffa71d3.js"><link rel="prefetch" href="/bootcamp/assets/js/40.9027c5f5.js"><link rel="prefetch" href="/bootcamp/assets/js/41.ba41db43.js"><link rel="prefetch" href="/bootcamp/assets/js/42.5b557b73.js"><link rel="prefetch" href="/bootcamp/assets/js/43.cc3eae88.js"><link rel="prefetch" href="/bootcamp/assets/js/44.2197fd33.js"><link rel="prefetch" href="/bootcamp/assets/js/45.006f5c62.js"><link rel="prefetch" href="/bootcamp/assets/js/46.04b5c45f.js"><link rel="prefetch" href="/bootcamp/assets/js/47.7ed92c65.js"><link rel="prefetch" href="/bootcamp/assets/js/48.dd6450f9.js"><link rel="prefetch" href="/bootcamp/assets/js/49.b2f6d1e6.js"><link rel="prefetch" href="/bootcamp/assets/js/5.de947382.js"><link rel="prefetch" href="/bootcamp/assets/js/50.f34a9a4b.js"><link rel="prefetch" href="/bootcamp/assets/js/51.bd2c7664.js"><link rel="prefetch" href="/bootcamp/assets/js/52.1f123cc8.js"><link rel="prefetch" href="/bootcamp/assets/js/53.90aa3d87.js"><link rel="prefetch" href="/bootcamp/assets/js/54.f0f112af.js"><link rel="prefetch" href="/bootcamp/assets/js/55.034cfb32.js"><link rel="prefetch" href="/bootcamp/assets/js/56.1f2a2a08.js"><link rel="prefetch" href="/bootcamp/assets/js/57.9765b11e.js"><link rel="prefetch" href="/bootcamp/assets/js/58.75a0b3bd.js"><link rel="prefetch" href="/bootcamp/assets/js/59.c3345303.js"><link rel="prefetch" href="/bootcamp/assets/js/6.fa4cc718.js"><link rel="prefetch" href="/bootcamp/assets/js/7.a1b225e3.js"><link rel="prefetch" href="/bootcamp/assets/js/8.a24b827c.js"><link rel="prefetch" href="/bootcamp/assets/js/9.c673f9c9.js">
    <link rel="stylesheet" href="/bootcamp/assets/css/0.styles.095a7d7e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/bootcamp/" class="home-link router-link-active"><!----> <span class="site-name">IIJ Bootcamp</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/iij/bootcamp" target="_blank" rel="noopener noreferrer" class="repo-link">
      GitHub
      <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/iij/bootcamp" target="_blank" rel="noopener noreferrer" class="repo-link">
      GitHub
      <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>drone でCIテスト・デプロイを回す</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/bootcamp/cicd_infra/drone/#_0-この講義について" class="sidebar-link">0. この講義について</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bootcamp/cicd_infra/drone/#_0-1-この講義の目的" class="sidebar-link">0.1 この講義の目的</a></li><li class="sidebar-sub-header"><a href="/bootcamp/cicd_infra/drone/#_0-2-ハンズオンの対象者" class="sidebar-link">0.2 ハンズオンの対象者</a></li><li class="sidebar-sub-header"><a href="/bootcamp/cicd_infra/drone/#_0-3-下準備" class="sidebar-link">0.3 下準備</a></li><li class="sidebar-sub-header"><a href="/bootcamp/cicd_infra/drone/#_0-4-この資料のお約束" class="sidebar-link">0.4. この資料のお約束</a></li></ul></li><li><a href="/bootcamp/cicd_infra/drone/#_1-継続的インテグレーション、継続的デリバリとは" class="sidebar-link">1. 継続的インテグレーション、継続的デリバリとは</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/bootcamp/cicd_infra/drone/#_2-droneとは" class="sidebar-link">2. droneとは</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bootcamp/cicd_infra/drone/#_2-1-とりあえず初めてみる" class="sidebar-link">2.1. とりあえず初めてみる</a></li></ul></li><li><a href="/bootcamp/cicd_infra/drone/#_3-droneの基本的な設定" class="sidebar-link">3. droneの基本的な設定</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bootcamp/cicd_infra/drone/#_3-1-pipeline" class="sidebar-link">3.1. Pipeline</a></li><li class="sidebar-sub-header"><a href="/bootcamp/cicd_infra/drone/#_3-2-steps" class="sidebar-link">3.2. Steps</a></li></ul></li><li><a href="/bootcamp/cicd_infra/drone/#_4-pull-requestと組み合わせる" class="sidebar-link">4. Pull Requestと組み合わせる</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bootcamp/cicd_infra/drone/#_4-1-テストが失敗したらマージできないようにしたい" class="sidebar-link">4.1. テストが失敗したらマージできないようにしたい</a></li></ul></li><li><a href="/bootcamp/cicd_infra/drone/#_5-さまざまなプラグイン" class="sidebar-link">5. さまざまなプラグイン</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bootcamp/cicd_infra/drone/#_5-1-キャッシュプラグイン" class="sidebar-link">5.1. キャッシュプラグイン</a></li></ul></li><li><a href="/bootcamp/cicd_infra/drone/#_6-さまざまな応用" class="sidebar-link">6. さまざまな応用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bootcamp/cicd_infra/drone/#_6-1-text-lintを使った日本語チェックの例" class="sidebar-link">6.1. Text Lintを使った日本語チェックの例</a></li><li class="sidebar-sub-header"><a href="/bootcamp/cicd_infra/drone/#_6-2-services" class="sidebar-link">6.2 Services</a></li></ul></li><li><a href="/bootcamp/cicd_infra/drone/#_8-参考情報" class="sidebar-link">8. 参考情報</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/bootcamp/cicd_infra/drone/#続き" class="sidebar-link">続き</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="drone-でciテスト・デプロイを回す"><a href="#drone-でciテスト・デプロイを回す" class="header-anchor">#</a> drone でCIテスト・デプロイを回す</h1> <h2 id="_0-この講義について"><a href="#_0-この講義について" class="header-anchor">#</a> 0. この講義について</h2> <h3 id="_0-1-この講義の目的"><a href="#_0-1-この講義の目的" class="header-anchor">#</a> 0.1 この講義の目的</h3> <p>継続的インテグレーション(Continuous Integration)、継続的デリバリ(Continuous Delivery)について理解する。
drone を利用したCI/CDを体験し、自分のプロジェクトにCI/CDを自ら導入できるようにする。</p> <h3 id="_0-2-ハンズオンの対象者"><a href="#_0-2-ハンズオンの対象者" class="header-anchor">#</a> 0.2 ハンズオンの対象者</h3> <p>これからプログラムを書く、またはテキストファイルによる設定ファイル、マニュアル、仕様書などを記述する可能性のある技術者を対象としています。</p> <p>講義にあたって事前に以下の要件を満たすようにしてください。</p> <ul><li>YAMLの読み書きができること
<ul><li>知らない場合は<a href="https://www.codeproject.com/Articles/1214409/Learn-YAML-in-five-minutes" target="_blank" rel="noopener noreferrer">Learn YAML in five minutes!<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>をご覧ください。</li></ul></li> <li>「Gitの使い方＋GitHubを使った開発手法」を受講しておくこと
<ul><li>この講義の中では Git の操作に加え GitHub 上での操作も必要になります。アカウントがない場合は事前に用意してください。</li></ul></li></ul> <div class="custom-block tip"><p class="custom-block-title">チェックポイント1 🏁</p> <p>Gitの使い方＋GitHubを使った開発手法を受講しましたか？<br>
git clone, checkout, add, commit, push などを利用します。</p></div> <h3 id="_0-3-下準備"><a href="#_0-3-下準備" class="header-anchor">#</a> 0.3 下準備</h3> <ul><li>Gitを利用できる環境を準備してください。</li> <li>お好みのテキストエディタを準備してください。
<ul><li>この講義では<a href="https://azure.microsoft.com/ja-jp/products/visual-studio-code/" target="_blank" rel="noopener noreferrer">VSCode<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>を推奨します。
<a href="https://atom.io/" target="_blank" rel="noopener noreferrer">Atom<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>や<a href="https://www.sublimetext.com/3" target="_blank" rel="noopener noreferrer">Sublime Text<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://notepad-plus-plus.org/" target="_blank" rel="noopener noreferrer">Nodepad++<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>を使ってもかまいません。Vimに慣れている人はVimを使ってもよいです。
メモ帳、サクラエディタ、TeraPadは非推奨です。</li></ul></li></ul> <h3 id="_0-4-この資料のお約束"><a href="#_0-4-この資料のお約束" class="header-anchor">#</a> 0.4. この資料のお約束</h3> <p>💻 は自分で操作する箇所を示しています。</p> <p>&lt;ほげほげ&gt; で囲まれている部分は自分の設定値で置き換えてください。たとえば</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>git clone &lt;リモートリポジトリのアドレス&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>と記載されている箇所は</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>git clone git@github.com:iij/bootcamp.git
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>というように置き換えてください。</p> <h2 id="_1-継続的インテグレーション、継続的デリバリとは"><a href="#_1-継続的インテグレーション、継続的デリバリとは" class="header-anchor">#</a> 1. 継続的インテグレーション、継続的デリバリとは</h2> <p>継続的インテグレーション(Continuous Integration、以下CI)とは、
アプリケーションのリリースサイクルにおいてビルドやテストなどを自動化し、
継続的に実行することで品質改善や納期短縮を実現するための方法です。</p> <p>もしかしたら自分のプロジェクトがそうかもれませんが、プログラミングは意外と手作業の多い分野でした。
しかしながら手作業でビルド、テストをしていると不具合が含まれていても発覚するのが遅くなり、手戻りが大きくなってしまいます。
そこでビルドやテストを自動化し、コードがpushされたらすぐに実行することで早期に不具合を見つけようというのがCIです。
また世の中にはビルドが難しいプロダクトというのも多数存在しますので、自動化されているということは開発メンバーを追加するのも楽になります。</p> <p>継続的デリバリ(Continuous Delivery、以下CD)とはCIをさらに進めてユーザーに製品を届けるまでのリリースプロセス全体を自動化し、
<strong>継続的に顧客に価値を届ける</strong>ことを目的とした手法です。</p> <p>CI/CDを導入した場合、コードをコミットするとビルドが走り、ユニットテストを通して、コードがテスト環境にデプロイされます。その後結合テスト、
システムテストを行い、必要であれば承認後、本番環境にデプロイされます。</p> <h2 id="_2-droneとは"><a href="#_2-droneとは" class="header-anchor">#</a> 2. droneとは</h2> <p><a href="https://drone.io/" target="_blank" rel="noopener noreferrer">drone<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> とはdockerをベースとしたCI/CDのためのプラットフォームです。
IIJ社内ではdrone v1.0を提供しています。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>社内のプライベートな環境で使えるdroneが用意されていることがあります。
講師の指示がある場合はそちらの環境を利用しましょう。</p></div> <ul><li>サイト: <a href="https://cloud.drone.io/" target="_blank" rel="noopener noreferrer">https://cloud.drone.io/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>ドキュメント: <a href="https://docs.drone.io/" target="_blank" rel="noopener noreferrer">https://docs.drone.io/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>GitHubと連携して簡単に設定を行うことができ、設定もyamlに記載するシンプルなもので、dockerベースのため環境構築も簡単に行うことができます。</p> <h3 id="_2-1-とりあえず初めてみる"><a href="#_2-1-とりあえず初めてみる" class="header-anchor">#</a> 2.1. とりあえず初めてみる</h3> <h4 id="_2-1-1-droneの設定を有効化する"><a href="#_2-1-1-droneの設定を有効化する" class="header-anchor">#</a> 2.1.1. droneの設定を有効化する</h4> <p>このハンズオンのためにCI/CDを行うためのサンプルリポジトリを <a href="https://github.com/iij/drone-exercise" target="_blank" rel="noopener noreferrer">https://github.com/iij/drone-exercise<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> に用意しています。</p> <p>💻 GitHub上で操作し、作業用リポジトリを作成してください。</p> <p><img src="/bootcamp/assets/img/fork-repo.e0dbd328.jpg" alt="droneで最初のテスト"></p> <p>上記リポジトリを開いて「Use this template」を押してください。<br>
リポジトリ名は「<code>drone-exercise-&lt;user名&gt;</code>」にしましょう。<br>
ほかの設定値はデフォルトで良いです。</p> <p>ここで作成したリポジトリに対して操作をしていきます。</p> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>Use this template が表示されていない場合は正しくログインできているか確認してください。<br>
講師から repository を作成する organization が指示されていれば、それに従ってください。</p></div> <p>droneはGitHub上のコミットやpushといったイベントが発生するとそれに応じて自動的に処理が走るようになっています。
これはWebhookというしくみを用いて実現されていますが、droneを使う前にこの設定が必要です。</p> <p>💻 droneにリポジトリを登録する。</p> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p><a href="https://cloud.drone.io/" target="_blank" rel="noopener noreferrer">https://cloud.drone.io/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> では 新規のユーザー登録を行っていません。<br>
そのため、以下の手順を実施するためには <a href="http://drone.io" target="_blank" rel="noopener noreferrer">drone.io<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> の 構築が必要です。<br>
講師は接続先を案内してください。</p></div> <p><a href="http://xn--drone-f83dqcwesos420avc3aymzhv8g.io" target="_blank" rel="noopener noreferrer">講師に案内されたdrone.io<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> にログインしてください。</p> <p>初回のログインでは OAuth の連携の許可が必要になるかもしれません。</p> <p>Repositories の リストから「自分のアカウント名/<code>drone-exercise-&lt;user名&gt;</code>」を探してリポジトリ名をクリックし詳細ページを開きましょう。</p> <p>見つからない場合は「SYNC」ボタンを押してから探してください。</p> <p>「SETTINGS」タブから「ACTIVATE REPOSITORY」をクリックすると自動で設定が行われ、設定画面が表示されます。</p> <p>これでdroneを利用する準備が整いました。</p> <h4 id="_2-1-2-droneでテストを実行する"><a href="#_2-1-2-droneでテストを実行する" class="header-anchor">#</a> 2.1.2. droneでテストを実行する</h4> <p>💻 作成した作業用リポジトリ(自分のアカウント名/<code>drone-exercise-&lt;user名&gt;</code>)をローカルにgit cloneしてください。</p> <p>このリポジトリにはすでにdroneの設定ファイルが置かれています。
適当に<code>README.md</code>を編集してコミット、pushしてみましょう。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>おさらいです。 編集したあとは git add でステージング したのち commit &amp;&amp; push となります。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>date &gt;&gt; README.md
git add README.md
git commit -m &quot;update README.md&quot;
git push origin master
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></div> <p>GitHub に push してしばらくすると drone で テストが実行されます。</p> <p>先程開いた droneの「自分のアカウント名/<code>drone-exercise-&lt;user名&gt;</code>」の 詳細ページから「ACTIVITY FEED」タブを開くとテストの実行ログが表示されます。</p> <p>クリックして 実行ログを読むとどのようにテストが実行されているかが分かります。</p> <p>このリポジトリにはRubyで書かれたプログラムと、Ruby用のテストフレームワークである<a href="https://rspec.info/" target="_blank" rel="noopener noreferrer">RSpec<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>で
書かれたテストが置かれています。</p> <p><img src="/bootcamp/assets/img/drone_first_test.31192e41.png" alt="droneで最初のテスト"></p> <p>図を見ると、 clone と test の step からなるとわかります。</p> <p>それぞれクリックすると各 step の詳細が表示されます。</p> <div class="custom-block tip"><p class="custom-block-title">チェックポイント2 🏁</p> <p>「test」ではどういうメッセージが出力されたでしょうか？</p></div> <h4 id="_2-1-3-webhookの設定確認"><a href="#_2-1-3-webhookの設定確認" class="header-anchor">#</a> 2.1.3 Webhookの設定確認</h4> <p>drone と GitHub の連携には Webhook を利用しています。</p> <p>デフォルトでは<code>pr</code>と<code>push</code>の2つが登録されています。</p> <p><code>pr</code>を指定すると、Pull Requestをオープンしたとき、または既存のPRへpushしたときにテストが実行されます。
<code>push</code> を指定すると、<code>git push</code> したときにテストが実行されます。</p> <p>この設定は 「Settings」-&gt;「Hooks」-&gt;「Webhooks」-&gt; droneのエントリ -&gt; Edit で確認でき、</p> <p>設定画面最下部の「Recent Deliveries」では実際に発行されたWebhookを確認 &amp; 再送信できます。</p> <h2 id="_3-droneの基本的な設定"><a href="#_3-droneの基本的な設定" class="header-anchor">#</a> 3. droneの基本的な設定</h2> <p>drone設定の基本は、どういった環境で、どのようなコマンドを実行するかということを記述することです。</p> <p>設定はKubernetesライクな書き方になっていますので、Kubernetesの知識があれば読みやすいです。</p> <p>droneはバージョンによって設定ファイルの書き方が異なりますので、
既存のプロジェクトを編集するときは気を付けてください。</p> <p>droneの設定はデフォルトでリポジトリの一番上の階層に<code>.drone.yml</code>という名前で置きます。</p> <p>2.1.2 でcloneしたリポジトリの<code>.drone.yml</code>を見てみましょう。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">kind</span><span class="token punctuation">:</span> pipeline
<span class="token key atrule">name</span><span class="token punctuation">:</span> default

<span class="token key atrule">steps</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> test
    <span class="token key atrule">image</span><span class="token punctuation">:</span> ruby<span class="token punctuation">:</span>2.6.2
    <span class="token key atrule">commands</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> bundle install
      <span class="token punctuation">-</span> rspec
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>各項目について解説していきます。</p> <h3 id="_3-1-pipeline"><a href="#_3-1-pipeline" class="header-anchor">#</a> 3.1. Pipeline</h3> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">kind</span><span class="token punctuation">:</span> pipeline
<span class="token key atrule">name</span><span class="token punctuation">:</span> default
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>一連のテスト実行の流れを<code>Pipeline</code>と呼びます。</p> <p>まずyamlの先頭で<code>kind: pipeline</code>と記載し、この下に書かれる設定値がPipelineのものであることを宣言します。
ただIIJの環境では<code>Pipeline</code>以外の設定は利用できませんのでこの<code>kind</code>と<code>name</code>は固定になります。</p> <p><code>Pipeline</code>は複数の<code>Step</code>で構成されます。</p> <h3 id="_3-2-steps"><a href="#_3-2-steps" class="header-anchor">#</a> 3.2. Steps</h3> <p>ひとつのPipelineで複数のテスト(<code>Step</code>)を実行できます。</p> <p>各<code>Step</code>は別々のdockerコンテナで実行され、各テストは独立した環境でテストできます。</p> <p>UI上では各<code>Step</code>ごとに結果が分けて表示され、<code>name</code>で名前を付けることができ、これはUI上に表示されます。</p> <p><img src="/bootcamp/assets/img/drone_steps.6a94640c.png" alt="Stepの表示"></p> <p><code>image</code> はテストに利用するdockerイメージを指定します。</p> <p><code>image: ruby</code> と指定した場合はDocker Hubの<a href="https://hub.docker.com/_/ruby" target="_blank" rel="noopener noreferrer">Ruby Official Image<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>が利用されます。
素性のわからないイメージを利用することはやめましょう。</p> <p>また、<code>image: ruby:3.1.2</code> のようにタグを指定して、特定のバージョンを利用できるイメージもありますが意図せず更新される場合があります。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>プライベートなDockerイメージ置き場を自分で作成することもできます。</p></div> <p><code>commands</code> にはコンテナ内で実行するコマンドを記述します。</p> <p><code>bundle install</code> ではテスト実行に必要なライブラリをインストールしていて、<code>rspec</code>でテストを実行しています。</p> <p>各テストが成功したかどうかは各コマンドのExit Codeを見ていて、Code 0以外ではテストは中断され失敗となります。
テストが失敗すると以下のような表示になります。</p> <p><img src="/bootcamp/assets/img/drone_test_failed.3ffdd2f3.png" alt="テスト失敗時の表示"></p> <h2 id="_4-pull-requestと組み合わせる"><a href="#_4-pull-requestと組み合わせる" class="header-anchor">#</a> 4. Pull Requestと組み合わせる</h2> <p>droneを設定した状態でPull Requestを作成するとどうなるでしょうか。</p> <p>💻 意図的にテストが失敗するようにコードを修正し、Pull Requestを作成してみましょう。</p> <ol><li>まず、別の branch へ checkout します</li></ol> <div class="language- line-numbers-mode"><pre class="language-text"><code>git checkout -b feature/text-error
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="2"><li>実装である<code>hello_world.rb</code>を以下のように書き換えてみます。</li></ol> <div class="language-diff line-numbers-mode"><pre class="language-diff"><code><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> def world
</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">    'Hello World'
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    'Goodby World'
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> end
</span></span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ol start="3"><li>編集した内容を commit し push します。</li></ol> <div class="language- line-numbers-mode"><pre class="language-text"><code>git add hello_world.rb
git commit -m &quot;goodby&quot;
git push origin feature/text-error
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>💻 GitHub を開いてPull Requestを作成しましょう。</p> <p>別のbranch に push した内容を develop branch などへ取り込んでもらうためのリクエストを Pull Request(PR) と呼びます。</p> <p><img src="/bootcamp/assets/img/drone_pull_request_button.39571d74.png" alt="Pull Requestを作成しましょう"></p> <p>もし、作業リポジトリを fork して作成した場合 PR の送り先が fork 元 repository になっています。</p> <p>その時は 自分のrepository に PR を送るように base repository (左側) の 表記を見直してください。</p> <p>無事PRを作成できた場合 PRのページへ遷移します。</p> <p>ページ下部にdroneのテスト結果が表示されています。</p> <p>一目でテストが失敗していることがわかるでしょう。</p> <p><img src="/bootcamp/assets/img/drone_pull_request_result.6e4f0582.png" alt="Pull Requestに表示されたdroneの結果"></p> <div class="custom-block tip"><p class="custom-block-title">チェックポイント3 🏁</p> <p>Pull Request は作成できましたか？<br> <a href="http://drone.io" target="_blank" rel="noopener noreferrer">drone.io<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> は動作しましたか?<br>
テストが失敗しましたか？</p></div> <h3 id="_4-1-テストが失敗したらマージできないようにしたい"><a href="#_4-1-テストが失敗したらマージできないようにしたい" class="header-anchor">#</a> 4.1. テストが失敗したらマージできないようにしたい</h3> <p>さて、 先程のPRではテストに失敗してしまいました。</p> <p>この状態でもMergeボタンを押すことは可能ですが、普通は押されたくないはずです。
この挙動はGitHubの設定画面から変更できます。</p> <p>💻 テストが通ったときだけマージできるように設定する</p> <ol><li>「Settings」-&gt;「Branches」-&gt;「Branch protection rules」-&gt;「Add rule」を押し、</li> <li>「Branch name pattern」に「master」と記入し、</li> <li>「Include administrators」にチェックを入れます。</li> <li>「Require status checks to pass before merging」にチェックを入れて</li> <li>「Status checks found in the last week for this repository」に出ている
「continuous-integration/drone/pr」と
「continuous-integration/drone/push」にチェックを入れます。</li> <li>「Create」します。</li></ol> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>もし、continuous-integration/drone/pr が見つからない場合<br>
先ほど作成したPRによる drone のテストがうまく動いていないかもしれません。<br>
fork した場合は PR の作成先を確認する必要があります。<br>
PR の作成先が間違っているかもしれません。見直してください。</p></div> <p><img src="/bootcamp/assets/img/drone_branch_protection.6e9707f7.png" alt="Branch protection rules"></p> <p>先程作成したPull Requestのページに戻るとマージボタンが押せなくなっています。</p> <p><img src="/bootcamp/assets/img/drone_reject_merge.260c0651.png" alt="マージできない状態"></p> <p>これは複数人で開発するときには便利な機能です。</p> <p>このあとmasterブランチを利用しますのでBranch protection rulesは削除しておきましょう。</p> <p>💻 Branch protection rules の一覧ページで<code>master</code>と名前がついたルールの<code>delete</code>ボタンを押す</p> <p>💻 この後項目のためにmasterブランチに戻っておきましょう。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ git checkout master
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">チェックポイント4 🏁</p> <p>マージボタンが押せなくなったのはなぜですか？</p></div> <h2 id="_5-さまざまなプラグイン"><a href="#_5-さまざまなプラグイン" class="header-anchor">#</a> 5. さまざまなプラグイン</h2> <p><a href="http://plugins.drone.io/" target="_blank" rel="noopener noreferrer">droneには様々なプラグインが用意されています。<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>主に外部と連携する機能が用意されています。
後述する利用のしかたからも分かるとおり plugin は 単なる docker コンテナであるため、自分で開発することもできます。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Plugins are just Docker containers which means you can write plugins in any programming language that runs inside a container. You can even create plugins using simple bash scripting.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p><a href="https://docs.drone.io/plugins/overview/" target="_blank" rel="noopener noreferrer">https://docs.drone.io/plugins/overview/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> より引用</p></blockquote> <h3 id="_5-1-キャッシュプラグイン"><a href="#_5-1-キャッシュプラグイン" class="header-anchor">#</a> 5.1. キャッシュプラグイン</h3> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>この項目はS3互換のオブジェクトストレージが必要です。
講師は接続先を案内してください。</p></div> <p>これまでの例ではテストを実行するときに必要なライブラリを<code>bundle install</code>で事前にダウンロードしてから実行していました。
しかし毎回ダウンロードしていたのではテスト実行に時間がかかりますし、ネットワークの無駄です。</p> <p><a href="http://plugins.drone.io/drone-plugins/drone-s3-cache/" target="_blank" rel="noopener noreferrer">s3-cache<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>プラグインを使うと特定のディレクトリを
<a href="https://aws.amazon.com/jp/s3/" target="_blank" rel="noopener noreferrer">S3<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>に保存し、テストのたびに復元してくれる機能を提供します。</p> <h4 id="_5-1-1-ライブラリの保存場所を変更する"><a href="#_5-1-1-ライブラリの保存場所を変更する" class="header-anchor">#</a> 5.1.1. ライブラリの保存場所を変更する</h4> <p>パッケージマネージャーによってはリポジトリの中ではなく、システムの特別な場所に配置するものがあります。
s3-cacheプラグインはリポジトリ内にあるファイルしかキャッシュできません。</p> <p>nodejsのパッケージマネージャーであるnpmはデフォルトでリポジトリ直下にライブラリを配置しますが、
Rubyのパッケージマネージャーであるbundlerはシステム領域にライブラリを保存するため、
そのままではキャッシュさせることができません。
ほとんどの場合、パッケージマネージャーのオプションで保存場所を変更できますので、
Rubyを例に設定してみましょう。</p> <p>Rubyのパッケージマネージャーであるbundlerは<code>--path</code>オプションで保存場所を指定できます。</p> <p><code>drone.yaml</code> で 実行している <code>bundle install</code> にオプションを渡し 一般的によく使われる<code>vendor/bundle</code>に保存するように変更してください。</p> <p>💻 パッケージの保存先を変更する</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>  - name: test
    image: ruby:2.6.2
    commands:
      - bundle install --path vendor/bundle
      - bundle exec rspec
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="_5-1-2-ライブラリをキャッシュさせてみる"><a href="#_5-1-2-ライブラリをキャッシュさせてみる" class="header-anchor">#</a> 5.1.2. ライブラリをキャッシュさせてみる</h4> <p>さっそくキャッシュさせてみましょう。</p> <p>このプラグインはキャッシュしたデータを戻す<code>restore</code>と、キャッシュを行う<code>rebuild</code>の機能があります。</p> <p><code>.drone.yml</code>を編集してキャッシュを組み込んでみましょう。
<code>rebuild</code>ステップで<code>vendor/bundle</code>ディレクトリをキャッシュし、
<code>restore</code>ステップでキャッシュされたものを戻します。</p> <p><code>test</code>Stepの前後に、<code>restore</code>と<code>rebuild</code>を追加します。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>以下の設定は各環境で用意された接続先へ値を変更してください。</p> <p>&lt;変数名&gt;で書かれた場所を適切な値で置き換えてください。</p></div> <p>💻 パッケージをキャッシュするように変更する</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">steps</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> restore
    <span class="token key atrule">image</span><span class="token punctuation">:</span> plugins/s3<span class="token punctuation">-</span>cache
    <span class="token key atrule">settings</span><span class="token punctuation">:</span>
      <span class="token key atrule">pull</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> &lt;ENDPOINT<span class="token punctuation">&gt;</span>
      <span class="token key atrule">access_key</span><span class="token punctuation">:</span> &lt;ACCESS_KEY<span class="token punctuation">&gt;</span>
      <span class="token key atrule">secret_key</span><span class="token punctuation">:</span> &lt;SECRET_KEY<span class="token punctuation">&gt;</span>
      <span class="token key atrule">restore</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> test
    <span class="token key atrule">image</span><span class="token punctuation">:</span> ruby<span class="token punctuation">:</span>2.6.2
    <span class="token key atrule">commands</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> bundle install <span class="token punctuation">-</span><span class="token punctuation">-</span>path vendor/bundle
      <span class="token punctuation">-</span> bundle exec rspec

  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> rebuild
    <span class="token key atrule">image</span><span class="token punctuation">:</span> plugins/s3<span class="token punctuation">-</span>cache
    <span class="token key atrule">settings</span><span class="token punctuation">:</span>
      <span class="token key atrule">pull</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> &lt;ENDPOINT<span class="token punctuation">&gt;</span>
      <span class="token key atrule">access_key</span><span class="token punctuation">:</span> &lt;ACCESS_KEY<span class="token punctuation">&gt;</span>
      <span class="token key atrule">secret_key</span><span class="token punctuation">:</span> &lt;SECRET_KEY<span class="token punctuation">&gt;</span>
      <span class="token key atrule">rebuild</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">mount</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> vendor/bundle
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>💻 コミットして実行してみましょう。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>git add .drone.yml
git commit -m &quot;Cache導入&quot;
git push origin master
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>droneのUI上で最新の実行ログを開いて見ましょう。
<code>restore</code>と<code>rebuild</code>のステップが増えていることを確認してください。</p> <p>1回目はキャッシュされてないので何も起きませんが、2回目からはキャッシュが使われるので実行が早くなります。
1回目の実行時間を確認してから、以下のように2回目のテストを実行してみてください。</p> <p><code>--allow-empty</code> はファイルを変更していなくてもコミットを作ることができるオプションです。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>git commit --allow-empty -m &quot;Cacheの効果を確認する&quot;
git push origin master
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>このキャッシュを利用する操作は drone で完結しない処理です。<br>
もしオブジェクトストレージ側にトラブルがあれば 処理が長時間に及ぶ可能性があります。</p> <p>また、drone 上の ジョブの同時実行数には限りがある場合があります。<br>
処理が長時間に渡る場合は drone 上のジョブ実行結果の確認画面から キャンセルができます</p></div> <p>💻 テスト実行が早くなっていることを確認しましょう。</p> <div class="custom-block tip"><p class="custom-block-title">チェックポイント5 🏁</p> <p>テストが速くなったのはなぜですか？</p></div> <h2 id="_6-さまざまな応用"><a href="#_6-さまざまな応用" class="header-anchor">#</a> 6. さまざまな応用</h2> <h3 id="_6-1-text-lintを使った日本語チェックの例"><a href="#_6-1-text-lintを使った日本語チェックの例" class="header-anchor">#</a> 6.1. Text Lintを使った日本語チェックの例</h3> <p>droneはプログラムにしか使えないものでしょうか。そうではありません。
droneは何でも動かすことができますから、テストをすることだけが仕事ではありません。</p> <p>ここでは自然言語のチェックを行う <a href="https://textlint.github.io/" target="_blank" rel="noopener noreferrer">textlint<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> を使った例を紹介します。</p> <p>💻 stepsに以下の項目を追加してみましょう。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> textlint
    <span class="token key atrule">image</span><span class="token punctuation">:</span> node
    <span class="token key atrule">commands</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> npm install textlint
      <span class="token punctuation">-</span> npm install textlint<span class="token punctuation">-</span>rule<span class="token punctuation">-</span>preset<span class="token punctuation">-</span>ja<span class="token punctuation">-</span>technical<span class="token punctuation">-</span>writing
      <span class="token punctuation">-</span> $(npm bin)/textlint <span class="token punctuation">-</span><span class="token punctuation">-</span>format pretty<span class="token punctuation">-</span>error <span class="token punctuation">-</span><span class="token punctuation">-</span>preset ja<span class="token punctuation">-</span>technical<span class="token punctuation">-</span>writing README.md
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>textlintはnodejsで動作しますので、イメージにnodeを指定します。
textlintはフレームワークのみでこれ単体で動かすことはできません。どういったものをチェックするかというルールは別に定義しなければいけません。
ここでは日本語の技術文書を書くうえで必要ないくつかのルールをまとめた
<a href="https://github.com/textlint-ja/textlint-rule-preset-ja-technical-writing" target="_blank" rel="noopener noreferrer">textlint-rule-preset-ja-technical-writing<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
を利用します。試しに <code>README.md</code>をチェックしてみましょう。</p> <p>💻 README.mdをTextlintでチェックする。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>git add .drone.yml
git commit -m &quot;textlintによるチェック&quot;
git push origin master
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><img src="/bootcamp/assets/img/drone_textlint_error.9c7cad75.png" alt="textlintのエラー"></p> <p>このようにチェックする対象はプログラムに限りませんので、マニュアルなどのドキュメントのチェックなどにも活用できます。</p> <div class="custom-block tip"><p class="custom-block-title">チェックポイント6 🏁</p> <p>droneが利用できる事例としてふさわしいものはどれですか？</p></div> <h3 id="_6-2-services"><a href="#_6-2-services" class="header-anchor">#</a> 6.2 Services</h3> <p>単純なスクリプトやライブラリのテストはこれだけでも十分にdroneでテストできます。</p> <p>ではデータベース使ったテストはできるでしょうか。</p> <p>データベースのテストをするならデータベースのプロセスが上がっている必要があります。<br>
でも1つのコンテナでアプリケーションと一緒にデータベースも一緒に立ち上げたくないですよね。</p> <p>そのために<code>Service</code>というしくみがあります。<br>
同時に複数のコンテナを立ち上げて待機させておき、テスト中利用できます。</p> <p>サンプルとしてRuby on Rails＋MySQLで構成されたアプリケーションを用意しました。</p> <p>💻 <a href="https://github.com/iij/drone-exercise-rails" target="_blank" rel="noopener noreferrer">https://github.com/iij/drone-exercise-rails<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> から 作業用リポジトリを作成し、git cloneしてください。</p> <p><img src="/bootcamp/assets/img/fork-repo.e0dbd328.jpg" alt="rails テスト"></p> <p>上記リポジトリを開いて「Use this template」を押してください。</p> <p>リポジトリ名は「<code>drone-exercise-rails-&lt;user名&gt;</code>」にしましょう。<br>
ほかの設定値はデフォルトで良いです。</p> <p>ここで作成したリポジトリに対して操作をしていきます。</p> <p>Ruby on RailsはWebアプリケーションを作るためのRuby製フレームワークです。
データの保存にMySQLなどのデータベースを利用できます。</p> <p>標準的なWebアプリケーションではデータベースなどの外部サービスにデータを保存し、それを読み取って加工して表示するという動作が多く、
テストするときもデータベースが動いている必要があります。</p> <p>上記リポジトリにはテストを行うだけの <code>.drone.yml</code> が含まれています。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">kind</span><span class="token punctuation">:</span> pipeline
<span class="token key atrule">name</span><span class="token punctuation">:</span> default

<span class="token key atrule">steps</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> test
    <span class="token key atrule">image</span><span class="token punctuation">:</span> ruby<span class="token punctuation">:</span>2.6.2
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">RAILS_ENV</span><span class="token punctuation">:</span> test
    <span class="token key atrule">commands</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> bundle <span class="token comment"># 実行に必要なライブラリをインストールする</span>
      <span class="token punctuation">-</span> bundle exec rails db<span class="token punctuation">:</span>reset <span class="token comment"># テスト用のデータベース、テーブルを作成する</span>
      <span class="token punctuation">-</span> bundle exec rails test <span class="token comment"># テストを実行する</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>💻 まずはこの状態でテストを実行し、結果を見てみましょう。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>新しいrepository への drone の 有効のしかた<br>
内容の変更を伴わないcommit をする方法を思い出してください。</p></div> <p>ちなみにテストは <code>test/models/user_test.rb</code> に書いてあります。</p> <p>この状態ではデータベースが動いていないのでテストが成功しません。</p> <p>テストしている間横で何か動かしておきたいという場合には <code>Service</code> を使います。
今回はMySQLを使いますが、<a href="https://hub.docker.com/_/mysql" target="_blank" rel="noopener noreferrer">MySQLは公式でdockerイメージが提供されています<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>のでこれを利用します。</p> <p>💻 以下の項目を<code>.drone.yml</code>に追加してください。</p> <p>kind, name, steps と同じ高さでよいです(services の左側にスペースはいりません)</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> db
    <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql<span class="token punctuation">:</span>8.0.16
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">&quot;--default-authentication-plugin=mysql_native_password&quot;</span> <span class="token punctuation">]</span> <span class="token comment"># MySQL8.0のデフォルト認証方式にRailsが対応していないため変更</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">MYSQL_ALLOW_EMPTY_PASSWORD</span><span class="token punctuation">:</span> <span class="token string">'yes'</span> <span class="token comment"># テスト用にパスワードなしで接続できるようにする</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><code>name</code> で名前をつけて <code>image</code> で使用するdockerイメージを指定します。</p> <p>Railsではデータベースの設定を<code>config/database.yml</code>から読み込みます。<br>
droneで設定したデータベースへ接続するための設定値を見てみましょう。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">test</span><span class="token punctuation">:</span>
  <span class="token key atrule">&lt;&lt;</span><span class="token punctuation">:</span> <span class="token important">*default</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> db
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3306</span>
  <span class="token key atrule">socket</span><span class="token punctuation">:</span> <span class="token null important">null</span>
  <span class="token key atrule">database</span><span class="token punctuation">:</span> drone<span class="token punctuation">-</span>exercise<span class="token punctuation">-</span>rails_test
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>このファイルで接続先MySQLサーバのホストを指定しているのですが、<br>
ここでは<code>.drone.yml</code>で指定した<code>db</code>がホスト名になっていて、この名前で接続できます。</p> <div class="custom-block tip"><p class="custom-block-title">チェックポイント7 🏁</p> <p>テスト実行中にデータベースはどこで実行されているでしょうか？</p></div> <h2 id="_8-参考情報"><a href="#_8-参考情報" class="header-anchor">#</a> 8. 参考情報</h2> <ul><li><a href="https://docs.drone.io/" target="_blank" rel="noopener noreferrer">drone Documentation<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h2 id="続き"><a href="#続き" class="header-anchor">#</a> 続き</h2> <ul><li><a href="/bootcamp/cicd_infra/github_actions/">GitHub Actions でCIテスト・デプロイを回す</a></li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/iij/bootcamp/edit/master/src/cicd_infra/drone/README.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">8/7/2023, 10:09:59 AM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/bootcamp/assets/js/app.7ad561c0.js" defer></script><script src="/bootcamp/assets/js/2.f42780dc.js" defer></script><script src="/bootcamp/assets/js/12.b5ed6a6b.js" defer></script>
  </body>
</html>
