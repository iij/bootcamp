<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>IIJ Bootcamp</title>
    <meta name="description" content="jenkinsを手元で動かしてプロダクトの理解や使い所を考えます">
    
    
    <link rel="preload" href="/bootcamp/assets/css/0.styles.2b6a07f9.css" as="style"><link rel="preload" href="/bootcamp/assets/js/app.d2f1aa0e.js" as="script"><link rel="preload" href="/bootcamp/assets/js/2.acfdd0a4.js" as="script"><link rel="preload" href="/bootcamp/assets/js/3.8871fbf6.js" as="script"><link rel="preload" href="/bootcamp/assets/js/5.d20398c4.js" as="script"><link rel="preload" href="/bootcamp/assets/js/4.a9d4f0c2.js" as="script"><link rel="prefetch" href="/bootcamp/assets/js/10.5f8a5456.js"><link rel="prefetch" href="/bootcamp/assets/js/11.543ef737.js"><link rel="prefetch" href="/bootcamp/assets/js/12.4ddb5c1e.js"><link rel="prefetch" href="/bootcamp/assets/js/13.c5c411d4.js"><link rel="prefetch" href="/bootcamp/assets/js/14.42aafd44.js"><link rel="prefetch" href="/bootcamp/assets/js/15.69d56ee8.js"><link rel="prefetch" href="/bootcamp/assets/js/16.2d760d44.js"><link rel="prefetch" href="/bootcamp/assets/js/17.f362e4a8.js"><link rel="prefetch" href="/bootcamp/assets/js/18.37605e11.js"><link rel="prefetch" href="/bootcamp/assets/js/19.97637d7d.js"><link rel="prefetch" href="/bootcamp/assets/js/20.8abaa144.js"><link rel="prefetch" href="/bootcamp/assets/js/21.13750af6.js"><link rel="prefetch" href="/bootcamp/assets/js/22.910c6441.js"><link rel="prefetch" href="/bootcamp/assets/js/23.acf9765f.js"><link rel="prefetch" href="/bootcamp/assets/js/24.c37c1784.js"><link rel="prefetch" href="/bootcamp/assets/js/25.1f2988ad.js"><link rel="prefetch" href="/bootcamp/assets/js/26.80262ad6.js"><link rel="prefetch" href="/bootcamp/assets/js/27.ebb5f83a.js"><link rel="prefetch" href="/bootcamp/assets/js/28.1a6e8768.js"><link rel="prefetch" href="/bootcamp/assets/js/6.6afd3d90.js"><link rel="prefetch" href="/bootcamp/assets/js/7.b81cb9d1.js"><link rel="prefetch" href="/bootcamp/assets/js/8.0797b3c3.js"><link rel="prefetch" href="/bootcamp/assets/js/9.76124e4d.js">
    <link rel="stylesheet" href="/bootcamp/assets/css/0.styles.2b6a07f9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/bootcamp/" class="home-link router-link-active"><!----> <span class="site-name">IIJ Bootcamp</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/iij/bootcamp" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/iij/bootcamp" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span></span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/bootcamp/development/jenkins/#事前準備" class="sidebar-link">事前準備</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/bootcamp/development/jenkins/#jenkins-とは" class="sidebar-link">jenkins とは</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/bootcamp/development/jenkins/#使ってみる" class="sidebar-link">使ってみる</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/bootcamp/development/jenkins/#ワークスペース" class="sidebar-link">ワークスペース</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/bootcamp/development/jenkins/#ビルドトリガー" class="sidebar-link">ビルドトリガー</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/bootcamp/development/jenkins/#秘密情報の利用" class="sidebar-link">秘密情報の利用</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/bootcamp/development/jenkins/#最後に" class="sidebar-link">最後に</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><table><tr><td>このハンズオンでやること</td><td>jenkinsを手元で動かしてプロダクトの理解や使い所を考えます</td></tr> <tr><td>想定時間</td><td>1h</td></tr> <tr><td>前提知識・用語</td><td>docker, 継続的インテグレーション</td></tr></table> <h1 id="jenkins-を触ってみよう"><a href="#jenkins-を触ってみよう" class="header-anchor">#</a> Jenkins を触ってみよう</h1> <h2 id="事前準備"><a href="#事前準備" class="header-anchor">#</a> 事前準備</h2> <p>TODO: dockerでjenkinsの環境を用意する</p> <p>起動後に <a href="http://192.168.20.10:8080/" target="_blank" rel="noopener noreferrer">http://192.168.20.10:8080/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> にアクセスすると初期パスワードの入力画面が開くので、以下の通りにパスワードを調べて入力してください。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">sudo</span> <span class="token function">cat</span> /var/lib/jenkins/secrets/initialAdminPassword
</code></pre></div><p>パスワードを入力するとpluginをインストールするか聞かれるので、「Install suggested plugins」を選んでおいてください。</p> <p>その後「新しいjobを作成」が表示されれば準備完了です。</p> <h2 id="jenkins-とは"><a href="#jenkins-とは" class="header-anchor">#</a> jenkins とは</h2> <p>2011年に発表されたCI(継続的インテグレーション) / CD（継続的デリバリー）ツールの１つで、シェルスクリプトで作成されたタスクをURLへのリクエストや時刻を指定した定期実行、他のタスクからのチェインなど様々なトリガーで実行することができるツールです。</p> <p>CIとは、開発中にコミットやpushの度にテストやデプロイを「継続的に」実施することで、問題の発見を早期に発見する開発手法です。
例えば１ヶ月開発してからデプロイ・テストをするよりも、1日に一回や変更の度にテストを回す方が効率的に問題を発見できます。
当然これは単体テストや自動でデプロイを行う仕組みを作っていることが前提です。</p> <p>CIツールはそのような開発スタイルをサポートするためのツールで、githubのcommitなどをトリガーにしてテストやデプロイを実施して結果を知らせてくれるツールの総称です。</p> <p>最近の主要なCIツールとしては</p> <ul><li>jenkins</li> <li>Circle CI</li> <li>Travis CI</li> <li><a href="http://drone.io" target="_blank" rel="noopener noreferrer">drone.io<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <p>あたりが上げられます。</p> <p>jenkinsの特徴としては、タスクの実行内容をシェルスクリプトで作成するためシンプルで自由度が高く、様々な用途に使用することができます。
（向き不向きはあれどjenkinsがあればほぼなんでもできる）</p> <p>またプラグインで機能を拡張することができる他、masterとslave構成にしてスケールさせることも可能です。</p> <p>欠点としてはタスクのスクリプトはjenkinsが構築されている環境で実行されるため、例えばrubyを実行したければjenkinsが動作しているホストにrubyをインストールする必要があります。これは例えば、プロジェクトによって違うrubyのバージョンを使いたくなったときなどに非常に辛いです。</p> <p>このあたりはCircle CIやdone.ioなどのコンテナ型ツールの方が便利です。ただしjenkinsプラグインの中にはタスクをコンテナで実行するためのプラグインもあるため、やろうと思えばjenkinsをコンテナ対応させることも可能です。</p> <h2 id="使ってみる"><a href="#使ってみる" class="header-anchor">#</a> 使ってみる</h2> <p>早速試しに使ってみましょう。「新しいジョブを作成」をクリックするとジョブの作成画面に入ります。まずは「フリースタイル・プロジェクトのビルド」をクリックしてください。</p> <p><img src="/bootcamp/assets/img/create-job.64f88f43.png" alt="create-job"></p> <p>作成するとジョブの設定画面が開きます。色々設定がありますが、まずは「ビルド」からスクリプトを登録してみましょう。「ビルド手順の追加」から「シェルの実行」を選ぶとスクリプトを登録できます。</p> <p><img src="/bootcamp/assets/img/job-build-script.6ceffc7f.png" alt="job-build-script"></p> <p>「保存」をクリックするとジョブが作成されるので、「ビルド実行」を押して実行してみます。
「ビルド履歴」に<code>#1</code>が増えたでしょうか。<code>#1</code>をクリックして「コンソール出力」をクリックするとビルドの様子を確認できます。</p> <p><img src="/bootcamp/assets/img/build-result.d9a8c5f6.png" alt="build-result"></p> <h2 id="ワークスペース"><a href="#ワークスペース" class="header-anchor">#</a> ワークスペース</h2> <p>上の例ではシェルスクリプトで<code>welcome.txt</code>というファイルを作成しました。このようにビルドの実行で生成されるファイルを「成果物」と呼んだりします。今回は適当なテキストファイルでしたが、ビルドした結果生成されたバイナリファイルであることが多いです。</p> <p>成果物はどこに作られているでしょうか。jenkinsホストで以下のディレクトリを覗くと成果物が生成されているのが分かります。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">cat</span> /var/lib/jenkins/workspace/test-project/welcome.txt
welcome to bootcamp
</code></pre></div><p>ディレクトリ名からも分かる通り、ジョブが実行されるディレクトリを「ワークスペース」と呼び、成果物も基本的にここに作成されます。ワークスペースはジョブ毎に別々に作られるため、他のジョブに影響されず実行することができます。</p> <p>成果物はジョブの実行前に自動で削除するようにも設定できますが、そうでない場合は前回の成果物がそのまま残っているためスクリプトを作る際は注意が必要です。また成果物を残しすぎるとjenkinsホストのディスクを圧迫するため不要な成果物は削除するようにしましょう。</p> <h2 id="ビルドトリガー"><a href="#ビルドトリガー" class="header-anchor">#</a> ビルドトリガー</h2> <p>先ほどはジョブを手動で実行しましたが、他にも様々な方法でビルドを実行することができます。
webhookなどのHTTPリクエストからジョブを実行するトリガーを設定してみましょう。</p> <p>(ちなみに手動実行は、本番環境の更新などビルドの実行タイミングを人が判断したい場合などによく使います。)</p> <p>先にいくつかセキュリティ設定を無効化しておきましょう。
<code>jenkinsトップ＞jenkinsの管理＞グローバルセキュリティの設定</code> から「権限管理」と「CSRF対策」の項目を以下のように変更してください。</p> <p><img src="/bootcamp/assets/img/security.e963cfeb.png" alt="security"></p> <p>画面上部のパンくずリストなどからジョブのトップ画面に移動し、「設定」をクリックして設定画面に移動しましょう。「ビルド・トリガ」からトリガーを設定することができます。「リモートからビルド」を選ぶとHTTPリクエストによるビルドを登録できます。</p> <p><img src="/bootcamp/assets/img/build-trigger.9ac0a1e6.png" alt="build-trigger"></p> <p>認証トークンを設定できるので適当な文字列（本当に使うときはちゃんとランダムな文字列使ってください）設定して保存します。保存後、設定画面に書かれているように<code>URL/buildWithParameters?token=TOKEN</code>にリクエストしてみましょう。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">curl</span> <span class="token string">'http://192.168.20.10:8080/job/test-project/build?token=test-token'</span>
</code></pre></div><p>上記を実行するとジョブが実行されると思います。このように外部システムのイベントをトリガーにしてjenkinsでビルドを実行することができます。</p> <p>リモート実行に限りませんが、ビルドにはパラメータを設定することができます。「General」にある「ビルドをパラメータ化」からパラメータを設定してみてください。</p> <p><img src="/bootcamp/assets/img/build-param.680aae50.png" alt="build-param"></p> <p>設定したパラメータは環境変数として使えます。スクリプトを以下のようにしてみてください。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">pwd</span>
<span class="token builtin class-name">echo</span> <span class="token variable">$param</span> <span class="token operator">&gt;&gt;</span> welcome.txt
</code></pre></div><p>そしてパラメータ付きビルドをリモートから実行します。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">curl</span> -X POST -F <span class="token string">'param=bootcamp'</span> <span class="token string">'http://192.168.20.10:8080/job/test-project/buildWithParameters?token=test-token'</span>
</code></pre></div><p>ビルドの履歴から結果を見ると、<code>echo boocamp</code>というコマンドが実行されているのが分かります。
ちなみにパラメータは手動実行の際にブラウザから指定することもできます。</p> <h2 id="秘密情報の利用"><a href="#秘密情報の利用" class="header-anchor">#</a> 秘密情報の利用</h2> <p>jenkinsではパスワードなど秘密情報を取り扱う機能があります。パスワードをスクリプトに直接書いてしまうと誰でも見えてしまうので、外には表示されない状態で埋め込むことができます。</p> <p>ジョブ設定画面「ビルド環境」にある「秘密テキストや秘密ファイルを利用する」を使います。
秘密情報であるpasswordを埋め込んでみましょう。少し使い方が難しいですが、「変数」に変数名を指定し、<code>Specific credentials</code> を選択して「追加」から秘密情報を追加できます。</p> <p><img src="/bootcamp/assets/img/secret-add.688f68ae.png" alt="secret-add"></p> <p>secretを追加したら設定したIDである<code>secret</code>を選択して保存しましょう。</p> <p><img src="/bootcamp/assets/img/secret-config.a408764a.png" alt="secret-config"></p> <p>これでスクリプトで<code>echo $password</code>などすると設定した秘密情報を利用できます。</p> <h2 id="最後に"><a href="#最後に" class="header-anchor">#</a> 最後に</h2> <p>jenkinsは非常に様々なことができますが、その分使いこなすのが難しいです。さらに環境によってバージョンの違いや入っているプラグインの違いで微妙に使い勝手が違ったり、使い方が分かりにくかったり苦労することもあります。</p> <p>ただしきちんと運用されたjenkinsサーバーを適切に使うと、様々なシステムと連携して自由度の高いビルドを実施できるため開発などの業務を効率化することができます。</p> <p>スクリプトの変更履歴管理がしにくいため、スクリプトをgitに置いてcloneして実行するなども有効です。</p> <div><hr> <span>CC BY-SA Licensed | Copyright (c) 2019, Internet Initiative Japan Inc.</span></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/iij/bootcamp/edit/master/src/development/jenkins/README.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">12/2/2019, 11:26:47 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/bootcamp/assets/js/app.d2f1aa0e.js" defer></script><script src="/bootcamp/assets/js/2.acfdd0a4.js" defer></script><script src="/bootcamp/assets/js/3.8871fbf6.js" defer></script><script src="/bootcamp/assets/js/5.d20398c4.js" defer></script><script src="/bootcamp/assets/js/4.a9d4f0c2.js" defer></script>
  </body>
</html>
