<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>開発環境をDocker Composeで構築 | IIJ Bootcamp</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="Docker Compose を用いて開発環境を構築します。">
    
    <link rel="preload" href="/bootcamp/assets/css/0.styles.095a7d7e.css" as="style"><link rel="preload" href="/bootcamp/assets/js/app.da888871.js" as="script"><link rel="preload" href="/bootcamp/assets/js/2.0d322aa6.js" as="script"><link rel="preload" href="/bootcamp/assets/js/41.7975ab7f.js" as="script"><link rel="preload" href="/bootcamp/assets/js/14.c8974a20.js" as="script"><link rel="preload" href="/bootcamp/assets/js/13.9be8637e.js" as="script"><link rel="prefetch" href="/bootcamp/assets/js/10.dd8644f9.js"><link rel="prefetch" href="/bootcamp/assets/js/11.ce6a2bf0.js"><link rel="prefetch" href="/bootcamp/assets/js/12.d25a1efe.js"><link rel="prefetch" href="/bootcamp/assets/js/15.0b6b2bf6.js"><link rel="prefetch" href="/bootcamp/assets/js/16.e4ade53b.js"><link rel="prefetch" href="/bootcamp/assets/js/17.cb43e59d.js"><link rel="prefetch" href="/bootcamp/assets/js/18.ce9241c0.js"><link rel="prefetch" href="/bootcamp/assets/js/19.5185799d.js"><link rel="prefetch" href="/bootcamp/assets/js/20.27f9c598.js"><link rel="prefetch" href="/bootcamp/assets/js/21.c274a4a1.js"><link rel="prefetch" href="/bootcamp/assets/js/22.cf755e50.js"><link rel="prefetch" href="/bootcamp/assets/js/23.958292cb.js"><link rel="prefetch" href="/bootcamp/assets/js/24.c25183d4.js"><link rel="prefetch" href="/bootcamp/assets/js/25.95aecd73.js"><link rel="prefetch" href="/bootcamp/assets/js/26.aeb9c634.js"><link rel="prefetch" href="/bootcamp/assets/js/27.f22429f1.js"><link rel="prefetch" href="/bootcamp/assets/js/28.cfb3729c.js"><link rel="prefetch" href="/bootcamp/assets/js/29.a77e9435.js"><link rel="prefetch" href="/bootcamp/assets/js/3.4f3ff0ea.js"><link rel="prefetch" href="/bootcamp/assets/js/30.8900b286.js"><link rel="prefetch" href="/bootcamp/assets/js/31.a310dbc0.js"><link rel="prefetch" href="/bootcamp/assets/js/32.faa73779.js"><link rel="prefetch" href="/bootcamp/assets/js/33.4573c574.js"><link rel="prefetch" href="/bootcamp/assets/js/34.66fe8e77.js"><link rel="prefetch" href="/bootcamp/assets/js/35.f7277e8c.js"><link rel="prefetch" href="/bootcamp/assets/js/36.5a0cdf15.js"><link rel="prefetch" href="/bootcamp/assets/js/37.87be7d87.js"><link rel="prefetch" href="/bootcamp/assets/js/38.9b56dbfc.js"><link rel="prefetch" href="/bootcamp/assets/js/39.2dbc9b8f.js"><link rel="prefetch" href="/bootcamp/assets/js/4.43aacb64.js"><link rel="prefetch" href="/bootcamp/assets/js/40.02c70a18.js"><link rel="prefetch" href="/bootcamp/assets/js/42.a0c3de41.js"><link rel="prefetch" href="/bootcamp/assets/js/43.d8893198.js"><link rel="prefetch" href="/bootcamp/assets/js/44.5e7bd4f8.js"><link rel="prefetch" href="/bootcamp/assets/js/45.60543525.js"><link rel="prefetch" href="/bootcamp/assets/js/46.387843f2.js"><link rel="prefetch" href="/bootcamp/assets/js/47.46bf658b.js"><link rel="prefetch" href="/bootcamp/assets/js/48.acbad534.js"><link rel="prefetch" href="/bootcamp/assets/js/49.e4b5002f.js"><link rel="prefetch" href="/bootcamp/assets/js/5.d950eaf0.js"><link rel="prefetch" href="/bootcamp/assets/js/50.f82e0640.js"><link rel="prefetch" href="/bootcamp/assets/js/51.a6028dff.js"><link rel="prefetch" href="/bootcamp/assets/js/52.8a33187a.js"><link rel="prefetch" href="/bootcamp/assets/js/53.12e5254b.js"><link rel="prefetch" href="/bootcamp/assets/js/54.17ab1d3e.js"><link rel="prefetch" href="/bootcamp/assets/js/55.f683cbcb.js"><link rel="prefetch" href="/bootcamp/assets/js/56.22f6bda9.js"><link rel="prefetch" href="/bootcamp/assets/js/57.47e4aee6.js"><link rel="prefetch" href="/bootcamp/assets/js/6.9247dbce.js"><link rel="prefetch" href="/bootcamp/assets/js/7.ac3646d0.js"><link rel="prefetch" href="/bootcamp/assets/js/8.518432a2.js"><link rel="prefetch" href="/bootcamp/assets/js/9.f699ab60.js">
    <link rel="stylesheet" href="/bootcamp/assets/css/0.styles.095a7d7e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/bootcamp/" class="home-link router-link-active"><!----> <span class="site-name">IIJ Bootcamp</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/iij/bootcamp" target="_blank" rel="noopener noreferrer" class="repo-link">
      GitHub
      <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/iij/bootcamp" target="_blank" rel="noopener noreferrer" class="repo-link">
      GitHub
      <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>開発環境をDocker Composeで構築</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/bootcamp/development/docker/docker-compose/#事前準備" class="sidebar-link">事前準備</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bootcamp/development/docker/docker-compose/#windows-macos" class="sidebar-link">Windows, macOS</a></li><li class="sidebar-sub-header"><a href="/bootcamp/development/docker/docker-compose/#linux" class="sidebar-link">Linux</a></li><li class="sidebar-sub-header"><a href="/bootcamp/development/docker/docker-compose/#導入できたら" class="sidebar-link">導入できたら</a></li></ul></li><li><a href="/bootcamp/development/docker/docker-compose/#_1-docker-compose-とは" class="sidebar-link">1. Docker Compose とは</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/bootcamp/development/docker/docker-compose/#_2-docker-compose-入門" class="sidebar-link">2. Docker Compose 入門</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bootcamp/development/docker/docker-compose/#_2-1-dockerfile-の作成" class="sidebar-link">2.1 Dockerfile の作成</a></li><li class="sidebar-sub-header"><a href="/bootcamp/development/docker/docker-compose/#_2-2-docker-compose-yml-の作成と解説" class="sidebar-link">2.2 docker-compose.yml の作成と解説</a></li><li class="sidebar-sub-header"><a href="/bootcamp/development/docker/docker-compose/#_2-3-backendサービスの作成" class="sidebar-link">2.3 backendサービスの作成</a></li><li class="sidebar-sub-header"><a href="/bootcamp/development/docker/docker-compose/#_2-4-docker-compose-コマンド" class="sidebar-link">2.4 docker compose コマンド</a></li></ul></li><li><a href="/bootcamp/development/docker/docker-compose/#_3-docker-のネットワーク" class="sidebar-link">3. Docker のネットワーク</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/bootcamp/development/docker/docker-compose/#_4-まとめ" class="sidebar-link">4. まとめ</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><table><tr><td>このハンズオンでやること</td><td>Docker Compose を用いて開発環境を構築します。</td></tr> <tr><td>想定時間</td><td>1h</td></tr> <tr><td>前提知識・用語</td><td>docker</td></tr></table> <h1 id="page-frontmatter-title"><a href="#page-frontmatter-title" class="header-anchor">#</a> 開発環境をDocker Composeで構築</h1> <h2 id="事前準備"><a href="#事前準備" class="header-anchor">#</a> 事前準備</h2> <ul><li>この講義では <code>docker compose (docker-compose)</code>はコマンドを使います。</li> <li>環境ごとに インストール方法が異なるので、 以下の通り導入しておいてください。</li></ul> <h3 id="windows-macos"><a href="#windows-macos" class="header-anchor">#</a> Windows, macOS</h3> <ul><li><a href="https://iij.github.io/bootcamp/init/hello-bootcamp/" target="_blank" rel="noopener noreferrer">ハンズオン事前準備<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> で Docker Desktop for Windowsや、Docker Desktop for Mac を導入済みであれば、すでにインストールされているはずです。</li></ul> <h3 id="linux"><a href="#linux" class="header-anchor">#</a> Linux</h3> <ul><li>以下の手順に従って、<code>docker compose</code> をインストールしてください。</li> <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/compose/install/" target="_blank" rel="noopener noreferrer">https://matsuand.github.io/docs.docker.jp.onthefly/compose/install/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h3 id="導入できたら"><a href="#導入できたら" class="header-anchor">#</a> 導入できたら</h3> <ul><li>下記コマンドを実際に入力し、コマンドが実行できるか確認してください。</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">docker</span> compose version
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="_1-docker-compose-とは"><a href="#_1-docker-compose-とは" class="header-anchor">#</a> 1. Docker Compose とは</h2> <p>Docker Compose とは、複数のコンテナから構成されるようなアプリケーションの管理をしやすくしたものです。Docker Compose を利用することで、各コンテナの起動・停止が一括して行えたり、後述する1つの設定ファイルに各コンテナの情報を記述するため可視性が高くなり管理もしやすくなります。また、各コンテナ間のネットワークや依存関係も設定ファイルとして管理することが出来る点も利点です。</p> <p>例えば、以下の3つのコンポーネントから構成されるWebサービスをDockerコンテナを用いた場合を想定してみましょう。</p> <ul><li>フロントエンド（Angular）</li> <li>データベースサーバ（MongoDB）</li> <li>バックエンド（Rails）</li></ul> <p>通常、この構成のWeb サービスを起動する際、各コンテナを立ち上げるため、<code>docker run</code> コマンドを3回実行する必要がでてきます。停止する際も同様です。ここで、Docker Compose を用いて管理を行うと、各コンテナの定義をした設定ファイルである「<strong>docker-compose.yml</strong>」に基づいて一括管理することが可能となります。具体的には、上記の各コンテナの起動・停止などは、<code>docker-compose</code> コマンドを1回実行するだけで済みます。また、コンテナの起動順序も適切な順番で起動することが可能となります。特に開発する際やテストなどの際には、サービスの起動停止は複数回繰り返したりすることも考えられるため効率化につながります。</p> <p>本講義では、実際に複数コンテナをDocker Composeを用いて管理を行っていきます。Docker Composeを使ったアプリケーションを実行するまでの一般的な流れは以下の通りです。</p> <ol><li>各コンテナのDockerfile の作成</li> <li>docker-compose.yml の作成</li> <li><code>docker-compose</code> コマンドを使った複数のコンテナの管理</li></ol> <p>そこで本講義でも上記の流れに沿って講義を進めていきます。</p> <h2 id="_2-docker-compose-入門"><a href="#_2-docker-compose-入門" class="header-anchor">#</a> 2. Docker Compose 入門</h2> <p>本章では、実際に<code>docker compose</code> コマンドを使って複数コンテナの立ち上げや停止などをしていただきます。今回題材のサービスは、データベースにMongoDB を利用したGo 言語のWebアプリケーションです。Webアプリケーション自体の作成は本質ではないので、サンプルコードをそのまま利用していただきます。Web アプリケーションの機能は以下の2点です。</p> <ol><li><code>/get</code> で、MongoDB に格納されているデータを一覧表示</li> <li><code>/add</code> で、<code>title</code> と<code>body</code> パラメータを添えてPOST することで、MongoDB にデータを格納する</li></ol> <h3 id="_2-1-dockerfile-の作成"><a href="#_2-1-dockerfile-の作成" class="header-anchor">#</a> 2.1 Dockerfile の作成</h3> <p>この節では、前述したコンテナのDockerfile を作成します。Dockerfile の作成については、前講義「Docker を触ってみよう」で行いましたので、各命令などの詳細な説明は割愛します。Docker Compose を使う際、コンテナの指定方法は、</p> <ol><li><code>docker run</code> と同様にimage を指定して起動する</li> <li>Dockerfile を指定して起動時にbuild する</li></ol> <p>の2通りがあります。また今回の場合、MongoDB のイメージは特にカスタマイズしないため、1の方法で起動します。</p> <p>以下の内容をファイル名「Dockerfile.backend」で作成してください。</p> <div class="language-Dockerfile line-numbers-mode"><pre class="language-dockerfile"><code><span class="token instruction"><span class="token keyword">FROM</span> golang</span>
<span class="token instruction"><span class="token keyword">LABEL</span> maintainer=<span class="token string">&quot;your_email&quot;</span></span>

<span class="token instruction"><span class="token keyword">COPY</span> ./backend/main.go /root/</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /root</span>
<span class="token instruction"><span class="token keyword">RUN</span> go env -w GO111MODULE=auto</span>
<span class="token instruction"><span class="token keyword">RUN</span> go get -v github.com/globalsign/mgo &amp;&amp; go build main.go</span>
<span class="token instruction"><span class="token keyword">ENTRYPOINT</span> [<span class="token string">&quot;./main&quot;</span>]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="_2-2-docker-compose-yml-の作成と解説"><a href="#_2-2-docker-compose-yml-の作成と解説" class="header-anchor">#</a> 2.2 docker-compose.yml の作成と解説</h3> <p>次に、以下の内容をファイル名「docker-compose.yml」で新規作成してください。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">database</span><span class="token punctuation">:</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> iijbootcamp<span class="token punctuation">-</span>database
    <span class="token key atrule">image</span><span class="token punctuation">:</span> mongo
    <span class="token key atrule">expose</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;27017&quot;</span>
  <span class="token key atrule">backend</span><span class="token punctuation">:</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> iijbootcamp<span class="token punctuation">-</span>backend
    <span class="token key atrule">build</span><span class="token punctuation">:</span>
      <span class="token key atrule">context</span><span class="token punctuation">:</span> .
      <span class="token key atrule">dockerfile</span><span class="token punctuation">:</span> Dockerfile.backend
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> database
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;8088:80&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>では、ファイルの各設定について見ていきたいと思います。</p> <ul><li><p><code>version</code> では、docker-compose.yml自体のバージョンを設定します。現在の最新版は、3系です。ここで指定するバージョンによって機能の違いが生じるため、調べる際には気を付けてください。</p></li> <li><p><code>services</code> では、Docker Compose で管理する各サービスを子要素として定義していきます。本設定の子要素になっている<code>database</code> と<code>backend</code> が、それぞれMongoDBとgolangのWebアプリケーション用のサービスです。ここは、好きな名前を設定できます。</p></li></ul> <p>次に、<code>database</code> の子要素について見ていきます。</p> <ul><li><code>container_name</code> は、作成されるコンテナ名を設定しています。この値やサービス名は、別コンテナからアクセスされる際のホスト名としても利用可能となります。そのため後にダウンロードするWebアプリケーションのソースコードでは、MongoDB の接続先として「iijbootcamp-database」を利用しています。</li> <li><code>image</code> では、Docker イメージを指定します。Dockerfile と同様ローカルにDocker イメージが存在しない場合は、DockerHub などからダウンロードしてきます。</li> <li><code>expose</code> では、<strong>ホストには晒さないが、別コンテナには晒すポート</strong>の設定をします。今回は、MongoDB のデフォルトポートの27017を設定しています。</li></ul> <p>最後に、<code>backend</code> の子要素について見ていきます。</p> <ul><li><p><code>build</code> は、独自にDockerfile などを用いてDocker イメージを作成する際に使う設定です。<code>build</code> の子要素に、Dockerfile が格納されているディレクトリを示す<code>context</code> が必須となっています。また、今回のようにDockerfile に「Dockerfile」以外の名前を使っている場合は、<code>dockerfile</code> で対象ファイル名を指定する必要があります。</p></li> <li><p><code>depends_on</code> では、各コンテナの起動順序を設定する項目になっています。今回の場合、backend サービスは、database サービスを必要とするので、こういった設定になっています。ただし、サービスの起動を待ってくれるわけではなく、database が起動しきる前にbackendサービスが起動してしまう場合もあります。<a href="http://docs.docker.jp/compose/startup-order.html" target="_blank" rel="noopener noreferrer">公式<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> にそういったケースの対策が載っているので興味がある方はご覧になってください。</p></li> <li><p><code>ports</code> は、ホストとコンテナのポートをマッピングする設定です。今回の場合、backend サービスは、コンテナ内でポート80で起動しているので、ホストのポート8088へアクセスしたらコンテナ内の80に接続されるように設定しています。ここに記載する値は、文字列を推奨します。なぜならば、YAML の仕様では、<code>XX:YY</code> は、60進数として解釈されてしまうため、意図しない値になる可能性があるためです。</p></li></ul> <p>その他詳しい機能について知りたい方は、<a href="https://docs.docker.com/compose/compose-file/" target="_blank" rel="noopener noreferrer">公式のリファレンス<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>をご参照ください。</p> <h3 id="_2-3-backendサービスの作成"><a href="#_2-3-backendサービスの作成" class="header-anchor">#</a> 2.3 backendサービスの作成</h3> <p>次に、backend のアプリケーションを作成します。しかし前述した通り、ここではコードの解説などは割愛します。Go 言語のコードに興味があったら、ぜひ中身もご覧になってください。アプリケーションのソースコードは、本リポジトリに<a href="/bootcamp/main.go">main.go</a>として同梱しています。<code>Dockerfile.backend</code> と同じ階層に<code>backend</code> ディレクトリを作成して、中に<a href="/bootcamp/main.go">main.go</a>を配置してください。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token builtin class-name">.</span>
├── Dockerfile.backend
├── backend
│   └── main.go
└── docker-compose.yml

<span class="token number">1</span> directory, <span class="token number">3</span> files
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="_2-4-docker-compose-コマンド"><a href="#_2-4-docker-compose-コマンド" class="header-anchor">#</a> 2.4 docker compose コマンド</h3> <p>では、必要なものはすべて揃ったので、「docker-compose.yml」が存在するディレクトリで、以下のコマンドを入力してください。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">docker</span> compose build
$ <span class="token function">docker</span> compose up
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>初回実行時は必要な image の取得や Dockerfile.backend を利用した docker build などが実行されるため、時間がかかります。</p> <p>また、もし プロキシ 環境下で 正常に go get が成功しない場合は 以下のように <code>docker compose build</code> してから試してみてください。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">docker</span> compose build --build-arg <span class="token assign-left variable">https_proxy</span><span class="token operator">=</span>http://<span class="token operator">&lt;</span>proxy<span class="token operator">&gt;</span>:<span class="token operator">&lt;</span>port<span class="token operator">&gt;</span>
$ <span class="token function">docker</span> compose up
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>以下が実際に実行した際の画面です。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>Building backend
Step <span class="token number">1</span>/6 <span class="token builtin class-name">:</span> FROM golang
 ---<span class="token operator">&gt;</span> 901414995ecd
Step <span class="token number">2</span>/6 <span class="token builtin class-name">:</span> LABEL <span class="token assign-left variable">maintainer</span><span class="token operator">=</span><span class="token string">&quot;your_email&quot;</span>
 ---<span class="token operator">&gt;</span> Using cache
 ---<span class="token operator">&gt;</span> af942d8500ac
Step <span class="token number">3</span>/6 <span class="token builtin class-name">:</span> COPY ./backend/main.go /root/
 ---<span class="token operator">&gt;</span> c337913839f2
Step <span class="token number">4</span>/6 <span class="token builtin class-name">:</span> WORKDIR /root
 ---<span class="token operator">&gt;</span> Running <span class="token keyword">in</span> 62a5f25461f4
Removing intermediate container 62a5f25461f4
 ---<span class="token operator">&gt;</span> 487a8ce36447
Step <span class="token number">5</span>/6 <span class="token builtin class-name">:</span> RUN go get -v github.com/globalsign/mgo <span class="token operator">&amp;&amp;</span> go build main.go
 ---<span class="token operator">&gt;</span> Running <span class="token keyword">in</span> 5605bfeb08b9
github.com/globalsign/mgo <span class="token punctuation">(</span>download<span class="token punctuation">)</span>
github.com/globalsign/mgo/internal/json
github.com/globalsign/mgo/internal/scram
github.com/globalsign/mgo/bson
github.com/globalsign/mgo
Removing intermediate container 5605bfeb08b9
 ---<span class="token operator">&gt;</span> fb0e91bd3afc
Step <span class="token number">6</span>/6 <span class="token builtin class-name">:</span> ENTRYPOINT <span class="token punctuation">[</span><span class="token string">&quot;./main&quot;</span><span class="token punctuation">]</span>
 ---<span class="token operator">&gt;</span> Running <span class="token keyword">in</span> bf08974a1e5d
Removing intermediate container bf08974a1e5d
 ---<span class="token operator">&gt;</span> 0dd916739b50
Successfully built 0dd916739b50
Successfully tagged docker-compose_backend:latest
Creating iijbootcamp-database <span class="token punctuation">..</span>. <span class="token keyword">done</span>
Creating iijbootcamp-backend  <span class="token punctuation">..</span>. <span class="token keyword">done</span>
Attaching to iijbootcamp-database, iijbootcamp-backend
iijbootcamp-database <span class="token operator">|</span> <span class="token number">2019</span>-02-15T02:55:28.221+0000 I CONTROL  <span class="token punctuation">[</span>main<span class="token punctuation">]</span> Automatically disabling TLS <span class="token number">1.0</span>, to force-enable TLS <span class="token number">1.0</span> specify --sslDisabledProtocols <span class="token string">'none'</span>
iijbootcamp-database <span class="token operator">|</span> <span class="token number">2019</span>-02-15T02:55:28.229+0000 I CONTROL  <span class="token punctuation">[</span>initandlisten<span class="token punctuation">]</span> MongoDB starting <span class="token builtin class-name">:</span> <span class="token assign-left variable">pid</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token number">27017</span> <span class="token assign-left variable">dbpath</span><span class="token operator">=</span>/data/db <span class="token number">64</span>-bit <span class="token assign-left variable">host</span><span class="token operator">=</span>783519c19d49
iijbootcamp-database <span class="token operator">|</span> <span class="token number">2019</span>-02-15T02:55:28.229+0000 I CONTROL  <span class="token punctuation">[</span>initandlisten<span class="token punctuation">]</span> db version v4.0.0
iijbootcamp-database <span class="token operator">|</span> <span class="token number">2019</span>-02-15T02:55:28.229+0000 I CONTROL  <span class="token punctuation">[</span>initandlisten<span class="token punctuation">]</span> <span class="token function">git</span> version: 3b07af3d4f471ae89e8186d33bbb1d5259597d51
iijbootcamp-database <span class="token operator">|</span> <span class="token number">2019</span>-02-15T02:55:28.229+0000 I CONTROL  <span class="token punctuation">[</span>initandlisten<span class="token punctuation">]</span> OpenSSL version: OpenSSL <span class="token number">1.0</span>.2g  <span class="token number">1</span> Mar <span class="token number">2016</span>
<span class="token punctuation">(</span>省略<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p><code>docker compose up</code> コマンドは、docker-compose.yml ファイルに基づきコンテナを新規作成し、起動するコマンドです。<code>-d</code> オプションを利用することで、デーモンとして起動することも可能です。デーモンで起動している際は、ログが表示されなくなってしまうので、見たい場合は<code>docker compose logs</code> コマンドで閲覧可能です。また、<code>-f</code> オプションを渡すことで、ログを流し続けることができます。</p> <p>別のターミナル環境を開いて、「docker-compose.yml」が存在するディレクトリ で以下のコマンドを入力してください。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">docker</span> compose <span class="token function">ps</span>
        Name                     Command             State          Ports
---------------------------------------------------------------------------------
iijbootcamp-backend    ./main                        Up      <span class="token number">0.0</span>.0.0:8088-<span class="token operator">&gt;</span><span class="token number">80</span>/tcp
iijbootcamp-database   docker-entrypoint.sh mongod   Up      <span class="token number">27017</span>/tcp
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><code>docker compose ps</code> コマンドでは、Docker Compose で管理してる各コンテナの状態を一覧で見ることができます。「State」が「Up」になっていれば立ち上がっている状態です。その他のカラムは<code>docker ps</code> の意味と同様です。</p> <h4 id="webアプリケーションの動作確認方法"><a href="#webアプリケーションの動作確認方法" class="header-anchor">#</a> Webアプリケーションの動作確認方法</h4> <p>では、実際にWebアプリケーションが動作しているか確認するために以下のコマンドを入力してください。</p> <p>ここでは、まずデータを追加し、次に追加されたデータを取り出しています。</p> <p><code>/get</code> にアクセスして、最初に登録したデータが取り出せていれば成功です。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> -X POST -d <span class="token string">'title=iijbootcamp&amp;body=IIJBootCamp is fun!!'</span> http://localhost:8088/add
Successfully added

$ <span class="token function">curl</span> http://localhost:8088/get
<span class="token punctuation">[</span><span class="token punctuation">{</span>ID:ObjectIdHex<span class="token punctuation">(</span><span class="token string">&quot;5c6642fc04b685000117c15b&quot;</span><span class="token punctuation">)</span> Title:iijbootcamp Body:IIJBootCamp is fun<span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>また、<code>docker compose start</code>、<code>docker compose stop</code> で一括してコンテナの起動・停止を行えます。さらに起動中のコンテナの停止と削除を一括して行う場合は、<code>docker compose down</code> が利用できます。では、先ほど起動したコンテナたちを停止してみましょう。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">docker</span> compose down
Stopping iijbootcamp-backend  <span class="token punctuation">..</span>. <span class="token keyword">done</span>
Stopping iijbootcamp-database <span class="token punctuation">..</span>. <span class="token keyword">done</span>
Removing iijbootcamp-backend  <span class="token punctuation">..</span>. <span class="token keyword">done</span>
Removing iijbootcamp-database <span class="token punctuation">..</span>. <span class="token keyword">done</span>
Removing network docker-compose_default
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>上記の実行結果より、各コンテナを停止し、削除していることがわかります。また、後述するネットワークも削除しています。</p> <h2 id="_3-docker-のネットワーク"><a href="#_3-docker-のネットワーク" class="header-anchor">#</a> 3. Docker のネットワーク</h2> <p>前章では、Docker Composeでコンテナ間接続を体験しました。本章では、Docker がどのようにしてネットワークを構築し、ホストとコンテナやコンテナ間を接続しているのかをご紹介します。まずは、以下のコマンドを実行してみてください。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">docker</span> network <span class="token function">ls</span>
NETWORK ID          NAME                     DRIVER              SCOPE
420d7b4e475a        bridge                   bridge              <span class="token builtin class-name">local</span>
24bd91406a30        docker-compose_default   bridge              <span class="token builtin class-name">local</span>
7b99e3f7a971        <span class="token function">host</span>                     <span class="token function">host</span>                <span class="token builtin class-name">local</span>
f70accdb164f        none                     null                <span class="token builtin class-name">local</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><code>docker network</code> コマンドは、Docker ネットワークを管理するためのコマンドです。<code>ls</code> サブコマンドは、Docker が把握しているすべてのネットワーク一覧を表示するコマンドです。
Docker をインストールすると、自動的に以下の名前の3つのネットワークを作成します。</p> <ol><li>bridge</li> <li>none</li> <li>host</li></ol> <p><code>docker run</code> コマンドを実行する際に、<code>--net</code> オプションで、これらの値を設定することができます。デフォルト値では、<code>bridge</code> になっています。Docker がインストールされた今回の環境では、ホストに「<strong>docker0</strong>」というブリッジネットワークが表れます。これが「bridge」に接続されており、Docker はデフォルトでこのネットワークにコンテナを接続します。そのため、ホストからコンテナへの接続やコンテナ間の接続が可能となります。<code>none</code> は、ネットワークの接続を必要としないコンテナを作成する際に利用します。<code>host</code> は、コンテナがホストと同じインタフェースやIPアドレスを持たせたい際に利用します。</p> <p>上記結果の中で、「default」で終わるネットワークは、<code>docker-compose</code> コマンドによって自動的に作成されたネットワークのことです。「default」の前には、プロジェクト名（docker-compose.ymlファイルが存在するディレクトリ名）が利用されます。</p> <p>以下のコマンドを入力してください。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">docker</span> network inspect bridge
<span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        <span class="token string">&quot;Name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;bridge&quot;</span>,
        <span class="token string">&quot;Id&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;420d7b4e475aa6a17e94a33cbda837af886dafd98339176e0acd31252904aed6&quot;</span>,
        <span class="token string">&quot;Created&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;2019-02-21T06:07:03.697181196Z&quot;</span>,
        <span class="token string">&quot;Scope&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;local&quot;</span>,
        <span class="token string">&quot;Driver&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;bridge&quot;</span>,
        <span class="token string">&quot;EnableIPv6&quot;</span><span class="token builtin class-name">:</span> false,
        <span class="token string">&quot;IPAM&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;Driver&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;default&quot;</span>,
            <span class="token string">&quot;Options&quot;</span><span class="token builtin class-name">:</span> null,
            <span class="token string">&quot;Config&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                    <span class="token string">&quot;Subnet&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;172.17.0.0/16&quot;</span>,
                    <span class="token string">&quot;Gateway&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;172.17.0.1&quot;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>,
        <span class="token string">&quot;Internal&quot;</span><span class="token builtin class-name">:</span> false,
        <span class="token string">&quot;Attachable&quot;</span><span class="token builtin class-name">:</span> false,
        <span class="token string">&quot;Ingress&quot;</span><span class="token builtin class-name">:</span> false,
        <span class="token string">&quot;ConfigFrom&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;Network&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>
        <span class="token punctuation">}</span>,
        <span class="token string">&quot;ConfigOnly&quot;</span><span class="token builtin class-name">:</span> false,
        <span class="token string">&quot;Containers&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>,
        <span class="token string">&quot;Options&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;com.docker.network.bridge.default_bridge&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;true&quot;</span>,
            <span class="token string">&quot;com.docker.network.bridge.enable_icc&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;true&quot;</span>,
            <span class="token string">&quot;com.docker.network.bridge.enable_ip_masquerade&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;true&quot;</span>,
            <span class="token string">&quot;com.docker.network.bridge.host_binding_ipv4&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;0.0.0.0&quot;</span>,
            <span class="token string">&quot;com.docker.network.bridge.name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;docker0&quot;</span>,
            <span class="token string">&quot;com.docker.network.driver.mtu&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;1500&quot;</span>
        <span class="token punctuation">}</span>,
        <span class="token string">&quot;Labels&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p><code>inspect</code> サブコマンドでは、引数に取ったネットワークやコンテナの情報を表示できます。本コマンドによって、サブネットやゲートウェイといった情報などが閲覧できます。割愛しますが、<code>docker-compose</code> コマンドによって生成されたbridgeネットワークと各コンテナのIPアドレスを<code>inspect</code> サブコマンドで確認してみると同一ネットワークにいることが確認できると思います。</p> <h2 id="_4-まとめ"><a href="#_4-まとめ" class="header-anchor">#</a> 4. まとめ</h2> <p>本講義では、Docker Compose を紹介し、実際に<code>docker-compose</code> コマンドを使って、複数のサービスを管理していただきました。複数のDocker コンテナを管理する場合、Docker Compose を用いるとDocker単独で利用するよりも効率的に管理することができるためぜひ利用してください。また、OSS の中ではDocker イメージを始め、<code>docker-compose.yml</code> を公開しているものも多いため、それらを使って簡単に検証作業や環境構築などを行うことができます。ぜひ有効活用してみてください。</p> <div><hr> <span>CC BY-SA Licensed | Copyright (c) 2020, Internet Initiative Japan Inc.</span></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/iij/bootcamp/edit/master/src/development/docker/docker-compose/README.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">1/10/2023, 2:55:10 AM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/bootcamp/assets/js/app.da888871.js" defer></script><script src="/bootcamp/assets/js/2.0d322aa6.js" defer></script><script src="/bootcamp/assets/js/41.7975ab7f.js" defer></script><script src="/bootcamp/assets/js/14.c8974a20.js" defer></script><script src="/bootcamp/assets/js/13.9be8637e.js" defer></script>
  </body>
</html>
