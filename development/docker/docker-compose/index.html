<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>開発環境をDocker Composeで構築 | IIJ Bootcamp</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="Docker Compose を用いて開発環境を構築します。">
    
    <link rel="preload" href="/bootcamp/assets/css/0.styles.095a7d7e.css" as="style"><link rel="preload" href="/bootcamp/assets/js/app.25d944b1.js" as="script"><link rel="preload" href="/bootcamp/assets/js/2.88156336.js" as="script"><link rel="preload" href="/bootcamp/assets/js/42.f36d95c3.js" as="script"><link rel="preload" href="/bootcamp/assets/js/15.47505260.js" as="script"><link rel="preload" href="/bootcamp/assets/js/14.a328a235.js" as="script"><link rel="prefetch" href="/bootcamp/assets/js/10.613798f8.js"><link rel="prefetch" href="/bootcamp/assets/js/11.cb441a14.js"><link rel="prefetch" href="/bootcamp/assets/js/12.7a853bb0.js"><link rel="prefetch" href="/bootcamp/assets/js/13.75f9159f.js"><link rel="prefetch" href="/bootcamp/assets/js/16.7d731960.js"><link rel="prefetch" href="/bootcamp/assets/js/17.b514f0b0.js"><link rel="prefetch" href="/bootcamp/assets/js/18.c113cf54.js"><link rel="prefetch" href="/bootcamp/assets/js/19.2f400cdb.js"><link rel="prefetch" href="/bootcamp/assets/js/20.253b0f21.js"><link rel="prefetch" href="/bootcamp/assets/js/21.7c61e2ac.js"><link rel="prefetch" href="/bootcamp/assets/js/22.22429cdd.js"><link rel="prefetch" href="/bootcamp/assets/js/23.9746a0f1.js"><link rel="prefetch" href="/bootcamp/assets/js/24.edb3327f.js"><link rel="prefetch" href="/bootcamp/assets/js/25.4907958a.js"><link rel="prefetch" href="/bootcamp/assets/js/26.44288614.js"><link rel="prefetch" href="/bootcamp/assets/js/27.c48de000.js"><link rel="prefetch" href="/bootcamp/assets/js/28.436f1618.js"><link rel="prefetch" href="/bootcamp/assets/js/29.085cbc33.js"><link rel="prefetch" href="/bootcamp/assets/js/3.2f1563a5.js"><link rel="prefetch" href="/bootcamp/assets/js/30.d3318ad2.js"><link rel="prefetch" href="/bootcamp/assets/js/31.1a673358.js"><link rel="prefetch" href="/bootcamp/assets/js/32.d527dc6c.js"><link rel="prefetch" href="/bootcamp/assets/js/33.ea276f0b.js"><link rel="prefetch" href="/bootcamp/assets/js/34.fe4b9594.js"><link rel="prefetch" href="/bootcamp/assets/js/35.d47203dc.js"><link rel="prefetch" href="/bootcamp/assets/js/36.e693d468.js"><link rel="prefetch" href="/bootcamp/assets/js/37.33712df8.js"><link rel="prefetch" href="/bootcamp/assets/js/38.061175a1.js"><link rel="prefetch" href="/bootcamp/assets/js/39.f14e9447.js"><link rel="prefetch" href="/bootcamp/assets/js/4.5c70c49a.js"><link rel="prefetch" href="/bootcamp/assets/js/40.1726199f.js"><link rel="prefetch" href="/bootcamp/assets/js/41.412376d8.js"><link rel="prefetch" href="/bootcamp/assets/js/43.085edc99.js"><link rel="prefetch" href="/bootcamp/assets/js/44.a0caf7ba.js"><link rel="prefetch" href="/bootcamp/assets/js/45.5817e9d9.js"><link rel="prefetch" href="/bootcamp/assets/js/46.53ed04b2.js"><link rel="prefetch" href="/bootcamp/assets/js/47.127c735a.js"><link rel="prefetch" href="/bootcamp/assets/js/48.407eefe1.js"><link rel="prefetch" href="/bootcamp/assets/js/49.9c27e17c.js"><link rel="prefetch" href="/bootcamp/assets/js/5.784d3083.js"><link rel="prefetch" href="/bootcamp/assets/js/50.ab175504.js"><link rel="prefetch" href="/bootcamp/assets/js/51.b87a1220.js"><link rel="prefetch" href="/bootcamp/assets/js/52.fdcd0da3.js"><link rel="prefetch" href="/bootcamp/assets/js/53.4d768535.js"><link rel="prefetch" href="/bootcamp/assets/js/54.c9b0286d.js"><link rel="prefetch" href="/bootcamp/assets/js/55.d5051a30.js"><link rel="prefetch" href="/bootcamp/assets/js/56.1205fafc.js"><link rel="prefetch" href="/bootcamp/assets/js/57.474dacb1.js"><link rel="prefetch" href="/bootcamp/assets/js/58.a92bad6f.js"><link rel="prefetch" href="/bootcamp/assets/js/6.c867db6e.js"><link rel="prefetch" href="/bootcamp/assets/js/7.f4542d95.js"><link rel="prefetch" href="/bootcamp/assets/js/8.f9a8588b.js"><link rel="prefetch" href="/bootcamp/assets/js/9.54fd6b10.js">
    <link rel="stylesheet" href="/bootcamp/assets/css/0.styles.095a7d7e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/bootcamp/" class="home-link router-link-active"><!----> <span class="site-name">IIJ Bootcamp</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/iij/bootcamp" target="_blank" rel="noopener noreferrer" class="repo-link">
      GitHub
      <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/iij/bootcamp" target="_blank" rel="noopener noreferrer" class="repo-link">
      GitHub
      <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>開発環境をDocker Composeで構築</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/bootcamp/development/docker/docker-compose/#事前準備" class="sidebar-link">事前準備</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bootcamp/development/docker/docker-compose/#windows-macos向け" class="sidebar-link">Windows, macOS向け</a></li><li class="sidebar-sub-header"><a href="/bootcamp/development/docker/docker-compose/#linux向け" class="sidebar-link">Linux向け</a></li></ul></li><li><a href="/bootcamp/development/docker/docker-compose/#docker-compose-概要" class="sidebar-link">Docker Compose 概要</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/bootcamp/development/docker/docker-compose/#docker-compose-演習" class="sidebar-link">Docker Compose 演習</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bootcamp/development/docker/docker-compose/#サンプルアプリケーションの作成" class="sidebar-link">サンプルアプリケーションの作成</a></li><li class="sidebar-sub-header"><a href="/bootcamp/development/docker/docker-compose/#dockerfile-の作成" class="sidebar-link">Dockerfile の作成</a></li><li class="sidebar-sub-header"><a href="/bootcamp/development/docker/docker-compose/#_2-2-docker-compose-yml-の作成と解説" class="sidebar-link">2.2 docker-compose.yml の作成と解説</a></li><li class="sidebar-sub-header"><a href="/bootcamp/development/docker/docker-compose/#_2-4-docker-compose-コマンド" class="sidebar-link">2.4 docker compose コマンド</a></li></ul></li><li><a href="/bootcamp/development/docker/docker-compose/#_3-docker-のネットワーク" class="sidebar-link">3. Docker のネットワーク</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/bootcamp/development/docker/docker-compose/#_4-まとめ" class="sidebar-link">4. まとめ</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><table><tr><td>このハンズオンでやること</td><td>Docker Compose を用いて開発環境を構築します。</td></tr> <tr><td>想定時間</td><td>1h</td></tr> <tr><td>前提知識・用語</td><td>docker</td></tr></table> <h1 id="page-frontmatter-title"><a href="#page-frontmatter-title" class="header-anchor">#</a> 開発環境をDocker Composeで構築</h1> <h2 id="事前準備"><a href="#事前準備" class="header-anchor">#</a> 事前準備</h2> <ul><li>この講義では <code>docker compose (docker-compose)</code>はコマンドを使います。</li> <li>環境ごとに インストール方法が異なるので、 以下の通り導入しておいてください。</li> <li>インストールが完了したら下記コマンドを実際に入力し、コマンドが実行できるか確認してください。</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">docker</span> compose version
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="windows-macos向け"><a href="#windows-macos向け" class="header-anchor">#</a> Windows, macOS向け</h3> <ul><li><a href="https://iij.github.io/bootcamp/init/hello-bootcamp/" target="_blank" rel="noopener noreferrer">ハンズオン事前準備<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> で Docker Desktop for Windowsや、Docker Desktop for Mac を導入済みであれば、すでにインストールされているはずです。</li></ul> <h3 id="linux向け"><a href="#linux向け" class="header-anchor">#</a> Linux向け</h3> <ul><li>以下の手順に従って、<code>docker compose</code> をインストールしてください。</li> <li><a href="https://matsuand.github.io/docs.docker.jp.onthefly/compose/install/" target="_blank" rel="noopener noreferrer">https://matsuand.github.io/docs.docker.jp.onthefly/compose/install/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h2 id="docker-compose-概要"><a href="#docker-compose-概要" class="header-anchor">#</a> Docker Compose 概要</h2> <p>Docker Compose とは、複数のコンテナから構成されるようなアプリケーションの管理をしやすくしたものです。
Docker Compose を利用することで、各コンテナの起動・停止が一括して行えたり、後述する1つの設定ファイルに各コンテナの情報を記述するため可視性が高くなり管理もしやすくなります。
また、各コンテナ間のネットワークや依存関係も設定ファイルとして管理することが出来る点も利点です。</p> <p>例えば、以下の2つのコンポーネントから構成されるWebサービスをDockerコンテナを用いた場合を想定してみましょう。</p> <ul><li>フロントエンド（Flask）</li> <li>バックエンド（Rails）</li></ul> <p>通常、この構成のWeb サービスを起動する際、各コンテナを立ち上げるため、<code>docker run</code> コマンドを2回実行する必要がでてきます。従って停止する際も同様に2回の操作が必要です。</p> <p>しかし、Docker Compose を用いて管理を行うと、各コンテナの定義をした設定ファイルである「<strong>docker-compose.yml</strong>」に基づいて一括管理することが可能となります。具体的には、上記の各コンテナの起動・停止などは、<code>docker compose</code> コマンドを1回実行するだけで済みます。また、コンテナの起動順序も適切な順番で起動することが可能となります。特に開発する際やテストなどの際には、サービスの起動停止は複数回繰り返したりすることも考えられるため効率化につながります。</p> <p>本講義では、実際に複数コンテナをDocker Composeを用いて管理を行っていきます。Docker Composeを使ったアプリケーションを実行するまでの一般的な流れは以下の通りです。</p> <ol><li>各コンテナのDockerfile の作成</li> <li>docker-compose.yml の作成</li> <li><code>docker compose</code> コマンドを使った複数のコンテナの管理</li></ol> <p>そこで本講義でも上記の流れに沿って講義を進めていきます。</p> <h2 id="docker-compose-演習"><a href="#docker-compose-演習" class="header-anchor">#</a> Docker Compose 演習</h2> <p>本章では、実際に<code>docker compose</code> コマンドを使って複数コンテナの立ち上げや停止などをしていただきます。
今回題材のサービスは、Python製のWebAPIフレームワークとしてFlask を利用したWebアプリケーションです。
Webアプリケーション自体の作成は本質ではないので、サンプルコードをそのまま利用していただきます。Web アプリケーションの機能は以下の2点です。</p> <p>それぞれファイルは以下のように配置してください</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token builtin class-name">.</span>
├── app.py
├── docker-compose.yml
├── Dockerfile
└── requirements.txt
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="サンプルアプリケーションの作成"><a href="#サンプルアプリケーションの作成" class="header-anchor">#</a> サンプルアプリケーションの作成</h3> <p>テキストエディタを開き <code>app.py</code> というpythonコードを書きます</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> time

<span class="token keyword">import</span> redis
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
cache <span class="token operator">=</span> redis<span class="token punctuation">.</span>Redis<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">&quot;redis&quot;</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">6379</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">get_hit_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    retries <span class="token operator">=</span> <span class="token number">5</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> cache<span class="token punctuation">.</span>incr<span class="token punctuation">(</span><span class="token string">&quot;hits&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> redis<span class="token punctuation">.</span>exceptions<span class="token punctuation">.</span>ConnectionError <span class="token keyword">as</span> exc<span class="token punctuation">:</span>
            <span class="token keyword">if</span> retries <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token keyword">raise</span> exc
            retries <span class="token operator">-=</span> <span class="token number">1</span>
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    count <span class="token operator">=</span> get_hit_count<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">&quot;Hello IIJBootcamp ! I have been seen {} times.\n&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>続いてアプリケーションの実行に必要なモジュールリストファイル <code>requirements.txt</code> を作ります。</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>flask
redis
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="dockerfile-の作成"><a href="#dockerfile-の作成" class="header-anchor">#</a> Dockerfile の作成</h3> <p>この節では、前述したコンテナのDockerfile を作成します。Dockerfile の作成については、前講義「Docker を触ってみよう」で行いましたので、各命令などの詳細な説明は割愛します。</p> <p>以下の内容をファイル名「Dockerfile」で作成してください。</p> <div class="language-Dockerfile line-numbers-mode"><pre class="language-dockerfile"><code><span class="token comment"># syntax=docker/dockerfile:1</span>
<span class="token instruction"><span class="token keyword">FROM</span> python:3.7-alpine</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /code</span>
<span class="token instruction"><span class="token keyword">ENV</span> FLASK_APP=app.py</span>
<span class="token instruction"><span class="token keyword">ENV</span> FLASK_RUN_HOST=0.0.0.0</span>
<span class="token instruction"><span class="token keyword">RUN</span> apk add --no-cache gcc musl-dev linux-headers</span>
<span class="token instruction"><span class="token keyword">COPY</span> requirements.txt requirements.txt</span>
<span class="token instruction"><span class="token keyword">RUN</span> pip install -r requirements.txt</span>
<span class="token instruction"><span class="token keyword">EXPOSE</span> 5000</span>
<span class="token instruction"><span class="token keyword">COPY</span> . .</span>
<span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">&quot;flask&quot;</span>, <span class="token string">&quot;run&quot;</span>]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="_2-2-docker-compose-yml-の作成と解説"><a href="#_2-2-docker-compose-yml-の作成と解説" class="header-anchor">#</a> 2.2 docker-compose.yml の作成と解説</h3> <p>次に、以下の内容をファイル名「docker-compose.yml」で新規作成してください。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">web</span><span class="token punctuation">:</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> iijbootcamp<span class="token punctuation">-</span>flask
    <span class="token key atrule">build</span><span class="token punctuation">:</span> .
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;8088:5000&quot;</span>
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> iijbootcamp<span class="token punctuation">-</span>backend
    <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">&quot;redis:alpine&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>では、ファイルの各設定について見ていきたいと思います。</p> <ul><li><p><code>version</code> では、docker-compose.yml自体のバージョンを設定します。現在の最新版は、3系です。ここで指定するバージョンによって機能の違いが生じるため、調べる際には気を付けてください。</p></li> <li><p><code>services</code> では、Docker Compose で管理する各サービスを子要素として定義していきます。本設定の子要素になっている<code>web</code> と<code>redis</code> が、それぞれflaskとRedisのWebアプリケーション用のサービスです。ここは、好きな名前を設定できます。</p></li></ul> <p>次に、<code>redis</code> の子要素について見ていきます。</p> <ul><li><code>container_name</code> は、作成されるコンテナ名を設定しています。この値やサービス名は、別コンテナからアクセスされる際のホスト名としても利用可能となります。</li> <li><code>image</code> では、Docker イメージを指定します。Dockerfile と同様ローカルにDocker イメージが存在しない場合は、DockerHub などからダウンロードしてきます。</li></ul> <p>最後に、<code>web</code> の子要素について見ていきます。</p> <ul><li><p><code>build</code> は、独自にDockerfile などを用いてDocker イメージを作成する際に使う設定です。<code>build</code> の子要素に、Dockerfile が格納されているディレクトリを示す<code>context</code> が必須となっています。また、今回のようにDockerfile に「Dockerfile」以外の名前を使っている場合は、<code>dockerfile</code> で対象ファイル名を指定する必要があります。</p></li> <li><p><code>ports</code> は、ホストとコンテナのポートをマッピングする設定です。今回の場合、backend サービスは、コンテナ内でポート80で起動しているので、ホストのポート8088へアクセスしたらコンテナ内の80に接続されるように設定しています。ここに記載する値は、文字列を推奨します。なぜならば、YAML の仕様では、<code>XX:YY</code> は、60進数として解釈されてしまうため、意図しない値になる可能性があるためです。</p></li></ul> <p>その他詳しい機能について知りたい方は、<a href="https://docs.docker.com/compose/compose-file/" target="_blank" rel="noopener noreferrer">公式のリファレンス<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>をご参照ください。</p> <h3 id="_2-4-docker-compose-コマンド"><a href="#_2-4-docker-compose-コマンド" class="header-anchor">#</a> 2.4 docker compose コマンド</h3> <p>では、必要なものはすべて揃ったので、「docker-compose.yml」が存在するディレクトリで、以下のコマンドを入力してください。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">docker</span> compose build
$ <span class="token function">docker</span> compose up
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>初回実行時は必要な image の取得や Dockerfile.backend を利用した docker build などが実行されるため、時間がかかります。</p> <p>また、もし プロキシ 環境下で 正常に go get が成功しない場合は 以下のように <code>docker compose build</code> してから試してみてください。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">docker</span> compose build --build-arg <span class="token assign-left variable">https_proxy</span><span class="token operator">=</span>http://<span class="token operator">&lt;</span>proxy<span class="token operator">&gt;</span>:<span class="token operator">&lt;</span>port<span class="token operator">&gt;</span>
$ <span class="token function">docker</span> compose up
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><code>docker compose up</code> コマンドは、docker-compose.yml ファイルに基づきコンテナを新規作成し、起動するコマンドです。<code>-d</code> オプションを利用することで、デーモンとして起動することも可能です。デーモンで起動している際は、ログが表示されなくなってしまうので、見たい場合は<code>docker compose logs</code> コマンドで閲覧可能です。また、<code>-f</code> オプションを渡すことで、ログを流し続けることができます。</p> <p>別のターミナル環境を開いて、「docker-compose.yml」が存在するディレクトリ で以下のコマンドを入力してください。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">docker</span> compose <span class="token function">ps</span>
NAME                  IMAGE               COMMAND                  SERVICE             CREATED             STATUS              PORTS
iijbootcamp-backend   redis:alpine        <span class="token string">&quot;docker-entrypoint.s…&quot;</span>   redis               <span class="token number">8</span> seconds ago       Up <span class="token number">7</span> seconds        <span class="token number">6379</span>/tcp
iijbootcamp-flask     solution-web        <span class="token string">&quot;flask run&quot;</span>              web                 <span class="token number">8</span> seconds ago       Up <span class="token number">7</span> seconds        <span class="token number">0.0</span>.0.0:8088-<span class="token operator">&gt;</span><span class="token number">5000</span>/tcp, :::8088-<span class="token operator">&gt;</span><span class="token number">5000</span>/tcp
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><code>docker compose ps</code> コマンドでは、Docker Compose で管理してる各コンテナの状態を一覧で見ることができます。「State」が「Up」になっていれば立ち上がっている状態です。その他のカラムは<code>docker ps</code> の意味と同様です。</p> <h4 id="webアプリケーションの動作確認方法"><a href="#webアプリケーションの動作確認方法" class="header-anchor">#</a> Webアプリケーションの動作確認方法</h4> <p>無事に起動できたならば <code>http://localhost:8088</code>にて画面が表示される為、ブラウザでアクセスしてみてください。
内部では表示回数をカウントしているため、リロードなどをする度に数が増える事でしょう。</p> <h2 id="_3-docker-のネットワーク"><a href="#_3-docker-のネットワーク" class="header-anchor">#</a> 3. Docker のネットワーク</h2> <p>前章では、Docker Composeでコンテナ間接続を体験しました。本章では、Docker がどのようにしてネットワークを構築し、ホストとコンテナやコンテナ間を接続しているのかをご紹介します。まずは、以下のコマンドを実行してみてください。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">docker</span> network <span class="token function">ls</span>
NETWORK ID          NAME                     DRIVER              SCOPE
420d7b4e475a        bridge                   bridge              <span class="token builtin class-name">local</span>
24bd91406a30        docker-compose_default   bridge              <span class="token builtin class-name">local</span>
7b99e3f7a971        <span class="token function">host</span>                     <span class="token function">host</span>                <span class="token builtin class-name">local</span>
f70accdb164f        none                     null                <span class="token builtin class-name">local</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><code>docker network</code> コマンドは、Docker ネットワークを管理するためのコマンドです。<code>ls</code> サブコマンドは、Docker が把握しているすべてのネットワーク一覧を表示するコマンドです。
Docker をインストールすると、自動的に以下の名前の3つのネットワークを作成します。</p> <ol><li>bridge</li> <li>none</li> <li>host</li></ol> <p><code>docker run</code> コマンドを実行する際に、<code>--net</code> オプションで、これらの値を設定することができます。デフォルト値では、<code>bridge</code> になっています。Docker がインストールされた今回の環境では、ホストに「<strong>docker0</strong>」というブリッジネットワークが表れます。これが「bridge」に接続されており、Docker はデフォルトでこのネットワークにコンテナを接続します。そのため、ホストからコンテナへの接続やコンテナ間の接続が可能となります。<code>none</code> は、ネットワークの接続を必要としないコンテナを作成する際に利用します。<code>host</code> は、コンテナがホストと同じインタフェースやIPアドレスを持たせたい際に利用します。</p> <p>上記結果の中で、「default」で終わるネットワークは、<code>docker compose</code> コマンドによって自動的に作成されたネットワークのことです。「default」の前には、プロジェクト名（docker-compose.ymlファイルが存在するディレクトリ名）が利用されます。</p> <p>以下のコマンドを入力してください。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">docker</span> network inspect bridge
<span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        <span class="token string">&quot;Name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;bridge&quot;</span>,
        <span class="token string">&quot;Id&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;420d7b4e475aa6a17e94a33cbda837af886dafd98339176e0acd31252904aed6&quot;</span>,
        <span class="token string">&quot;Created&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;2019-02-21T06:07:03.697181196Z&quot;</span>,
        <span class="token string">&quot;Scope&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;local&quot;</span>,
        <span class="token string">&quot;Driver&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;bridge&quot;</span>,
        <span class="token string">&quot;EnableIPv6&quot;</span><span class="token builtin class-name">:</span> false,
        <span class="token string">&quot;IPAM&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;Driver&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;default&quot;</span>,
            <span class="token string">&quot;Options&quot;</span><span class="token builtin class-name">:</span> null,
            <span class="token string">&quot;Config&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                    <span class="token string">&quot;Subnet&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;172.17.0.0/16&quot;</span>,
                    <span class="token string">&quot;Gateway&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;172.17.0.1&quot;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>,
        <span class="token string">&quot;Internal&quot;</span><span class="token builtin class-name">:</span> false,
        <span class="token string">&quot;Attachable&quot;</span><span class="token builtin class-name">:</span> false,
        <span class="token string">&quot;Ingress&quot;</span><span class="token builtin class-name">:</span> false,
        <span class="token string">&quot;ConfigFrom&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;Network&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>
        <span class="token punctuation">}</span>,
        <span class="token string">&quot;ConfigOnly&quot;</span><span class="token builtin class-name">:</span> false,
        <span class="token string">&quot;Containers&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>,
        <span class="token string">&quot;Options&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;com.docker.network.bridge.default_bridge&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;true&quot;</span>,
            <span class="token string">&quot;com.docker.network.bridge.enable_icc&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;true&quot;</span>,
            <span class="token string">&quot;com.docker.network.bridge.enable_ip_masquerade&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;true&quot;</span>,
            <span class="token string">&quot;com.docker.network.bridge.host_binding_ipv4&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;0.0.0.0&quot;</span>,
            <span class="token string">&quot;com.docker.network.bridge.name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;docker0&quot;</span>,
            <span class="token string">&quot;com.docker.network.driver.mtu&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;1500&quot;</span>
        <span class="token punctuation">}</span>,
        <span class="token string">&quot;Labels&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p><code>inspect</code> サブコマンドでは、引数に取ったネットワークやコンテナの情報を表示できます。本コマンドによって、サブネットやゲートウェイといった情報などが閲覧できます。割愛しますが、<code>docker compose</code> コマンドによって生成されたbridgeネットワークと各コンテナのIPアドレスを<code>inspect</code> サブコマンドで確認してみると同一ネットワークにいることが確認できると思います。</p> <h2 id="_4-まとめ"><a href="#_4-まとめ" class="header-anchor">#</a> 4. まとめ</h2> <p>本講義では、Docker Compose を紹介し、実際に<code>docker compose</code> コマンドを使って、複数のサービスを管理していただきました。複数のDocker コンテナを管理する場合、Docker Compose を用いるとDocker単独で利用するよりも効率的に管理することができるためぜひ利用してください。また、OSS の中ではDocker イメージを始め、<code>docker-compose.yml</code> を公開しているものも多いため、それらを使って簡単に検証作業や環境構築などを行うことができます。ぜひ有効活用してみてください。</p> <div><hr> <span>CC BY-SA Licensed | Copyright (c) 2020, Internet Initiative Japan Inc.</span></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/iij/bootcamp/edit/master/src/development/docker/docker-compose/README.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">7/20/2023, 6:08:52 AM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/bootcamp/assets/js/app.25d944b1.js" defer></script><script src="/bootcamp/assets/js/2.88156336.js" defer></script><script src="/bootcamp/assets/js/42.f36d95c3.js" defer></script><script src="/bootcamp/assets/js/15.47505260.js" defer></script><script src="/bootcamp/assets/js/14.a328a235.js" defer></script>
  </body>
</html>
