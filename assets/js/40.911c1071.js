(window.webpackJsonp=window.webpackJsonp||[]).push([[40],{510:function(s,a,t){"use strict";t.r(a);var e=t(10),n=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"_4-ansible-playbook-の作成"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-ansible-playbook-の作成"}},[s._v("#")]),s._v(" 4. Ansible playbook の作成")]),s._v(" "),a("p",[s._v("皆さんはここまでで既にansible を使ってホストの管理を行っていました。\n先ほどの演習で使った"),a("code",[s._v("ansible")]),s._v("コマンドがそれであり、ほかにも様々なモジュールを用いることで\n例えばアプリケーションのインストールなども行うことができます。")]),s._v(" "),a("p",[s._v("しかし、Ansible のアドホックコマンドは単純なオペレーションには便利ですが、\n複雑な構成管理や作業の定型化などには適していません。\nAnsible の真価を発揮するためには、Playbook の使用方法を学習し、一連のターゲットホストに対して複数の複雑なタスクを簡単に反復可能な方法で実行できるようにする必要があります。")]),s._v(" "),a("h3",{attrs:{id:"playbook-について"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#playbook-について"}},[s._v("#")]),s._v(" Playbook について")]),s._v(" "),a("p",[s._v("Playbook（プレイブック）は、管理対象に対してこうなってほしいという構成や手順を記述したファイルです。\nplaybook は先ほど実行していたアドホックコマンドを複数取り込み、複数の task のセットとして利用することができるようになります。")]),s._v(" "),a("p",[s._v("タスクは、特定の作業単位を実行するモジュールのアプリケーションです。\nつまり、Playbook とは、特定の順序で実行される 1 つ以上の task を含むテキストファイルです。")]),s._v(" "),a("p",[s._v("では、これまでアドホックに行っていた ansible ping を行う playbook を作成してみましょう。\nPlaybookはYAMLと呼ばれる書式によって書く必要があります。")]),s._v(" "),a("h2",{attrs:{id:"演習-playbookの作成"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#演習-playbookの作成"}},[s._v("#")]),s._v(" [演習] Playbookの作成")]),s._v(" "),a("ul",[a("li",[s._v("Ansibleのplaybookを作成します。今回は"),a("code",[s._v("playbook.yml")]),s._v("として作成してみます\n"),a("ul",[a("li",[s._v("docker 上で作成する場合は以下の通りvi 等でテキストファイルを作成します")]),s._v(" "),a("li",[s._v("演習環境に沿って実施している人は ansible フォルダがそのままconsoleホストにマウントされているため、ansibleフォルダ配下にファイルを作成しvscodeで編集することが可能です")])])]),s._v(" "),a("li",[s._v("playbook.ymlの作成\n"),a("ul",[a("li",[s._v("以下のように記載します"),a("div",{staticClass:"language-yml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("---")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hosts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" exercise\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tasks")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ping")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])])])])]),s._v(" "),a("li",[s._v("playbookの実行\n"),a("ul",[a("li",[s._v("Playbookの実行には"),a("code",[s._v("ansible-plyabook")]),s._v("というコマンドを使って実行します"),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("ansible-playbook playbooks.yml\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])]),s._v(" "),a("li",[s._v("実行結果"),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("SSH password:\n\nPLAY "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("exercise"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" ***********************************************************************************************************\n\nTASK "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Gathering Facts"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" ****************************************************************************************************\nok: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("host00"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nok: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("host01"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\nTASK "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ping"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" ***************************************************************************************************************\nok: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("host01"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nok: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("host00"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\nPLAY RECAP ****************************************************************************************************************\nhost00                     "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ok")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("changed")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("unreachable")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("failed")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("skipped")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("rescued")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ignored")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nhost01                     "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ok")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("changed")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("unreachable")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("failed")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("skipped")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("rescued")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ignored")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("   ```\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])])])])])]),s._v(" "),a("p",[s._v("上記の通り exercise グループに属している host00, host01, の 2 台に対し、ping モジュールが実行され"),a("code",[s._v("OK")]),s._v("が表示されれば成功です。")]),s._v(" "),a("h3",{attrs:{id:"解説"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解説"}},[s._v("#")]),s._v(" 解説")]),s._v(" "),a("ul",[a("li",[s._v("1 行目: "),a("code",[s._v("---")]),s._v(" "),a("ul",[a("li",[s._v("Playbook の始まりを意味します")]),s._v(" "),a("li",[s._v("YAML における形式の区切りの意味も持つため Playbook を書く際には必ず入れましょう")])])]),s._v(" "),a("li",[s._v("2 行目 "),a("code",[s._v("hosts: exercise")]),s._v(" "),a("ul",[a("li",[s._v("この Playbook（Play）は、Inventory の中の"),a("code",[s._v("exercise")]),s._v("グループに対して実行すると示します")])])]),s._v(" "),a("li",[s._v("4 行目 "),a("code",[s._v("tasks:")]),s._v(" "),a("ul",[a("li",[s._v("この行以下は、この Playbook（Play）で実行される task を定義します")]),s._v(" "),a("li",[s._v("tasks 後の行は、インデント（行頭の空白による字下げ）が入ります\n"),a("ul",[a("li",[s._v("このインデントは、YAML の書式同様、以降の要素が tasks の子要素や孫要素となっていることを意味します")])])])])]),s._v(" "),a("li",[s._v("5 行目 "),a("code",[s._v("ping")]),s._v(" "),a("ul",[a("li",[s._v("ここで"),a("code",[s._v("ping")]),s._v("モジュールを用いて操作する事（task)を宣言します\n"),a("ul",[a("li",[s._v("モジュールによって様々なオプションを追加することがあります")])])])])])]),s._v(" "),a("h2",{attrs:{id:"発展-gather-の停止"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#発展-gather-の停止"}},[s._v("#")]),s._v(" [発展] gather の停止")]),s._v(" "),a("p",[s._v("先ほどの実行結果で "),a("code",[s._v("TASK[ping]")]),s._v(" の前に "),a("code",[s._v("TASK[Gathering Facts]")]),s._v("というものがあったことに気づいたでしょうか。\nAnsible は通常、実行する際に実行対象となるホストから様々な情報の収集を行っています。\nこれらはansible_factsと呼ばれる特殊な変数に格納され、続くtaskで活用したり、収集結果をファイルに出力するなどに活用することができます。")]),s._v(" "),a("p",[s._v("しかし一方でそういった情報を収集する必要が無い場合は、収集の分だけ実行時間が長引くことになってしまいます。\n従って収集する必要がない場合は明示的に情報収集を停止したり、設定ファイルを編集し、デフォルトの動作を切り替えることで収集を停止し、即座に記載したtaskを実行させることができます。")]),s._v(" "),a("p",[s._v("以下のいずれかを実施することで下記の通り直ぐにpingモジュールの実行に移ることができます。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("ansible-playbook playbooks.yml\nSSH password:\n\nPLAY "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("exercise"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" ***********************************************************************************************************\n\nTASK "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ping"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" ***************************************************************************************************************\nok: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("host01"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nok: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("host00"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\nPLAY RECAP ****************************************************************************************************************\nhost00                     "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ok")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("changed")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("unreachable")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("failed")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("skipped")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("rescued")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ignored")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nhost01                     "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ok")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("changed")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("unreachable")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("failed")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("skipped")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("rescued")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ignored")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("h3",{attrs:{id:"playbook単位での停止"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#playbook単位での停止"}},[s._v("#")]),s._v(" playbook単位での停止")]),s._v(" "),a("ul",[a("li",[s._v("playbookに以下を宣言することで停止することができます\n"),a("ul",[a("li",[s._v("記載する場所どこでも構いませんが"),a("code",[s._v("hosts")]),s._v("等のセクションと同じレベル（同じインデントレベル）で宣言する必要があります。")])]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("gather_facts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("false")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])])]),s._v(" "),a("h3",{attrs:{id:"設定ファイルでの停止"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#設定ファイルでの停止"}},[s._v("#")]),s._v(" 設定ファイルでの停止")]),s._v(" "),a("ul",[a("li",[s._v("ansible.cfg に以下の通り記載することでこのplaybookに宣言しなくともgatherを停止することができます\n"),a("ul",[a("li",[s._v("宣言する箇所は"),a("code",[s._v("[defaults]")]),s._v("セクションに宣言してください")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("gathering = explicit\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])])])])}),[],!1,null,null,null);a.default=n.exports}}]);