(window.webpackJsonp=window.webpackJsonp||[]).push([[34],{497:function(s,t,a){s.exports=a.p+"assets/img/nginx_html.ae5a2fc7.png"},565:function(s,t,a){"use strict";a.r(t);var n=a(10),e=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"ssl-tls-を触ってみよう"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ssl-tls-を触ってみよう"}},[s._v("#")]),s._v(" SSL/TLS を触ってみよう")]),s._v(" "),t("h2",{attrs:{id:"事前準備"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#事前準備"}},[s._v("#")]),s._v(" 事前準備")]),s._v(" "),t("p",[s._v("このハンズオンでは、dockerをただの隔離環境として扱っています。")]),s._v(" "),t("p",[s._v("apache/nginx のハンズオンの際のものが残っているのであればそのまま流用できますので、以下の手順はスキップしてください。")]),s._v(" "),t("p",[s._v("以下のように"),t("code",[s._v("docker pull")]),s._v("をしたあと、ハンズオン用のコンテナを立ち上げてログインしてください。")]),s._v(" "),t("div",{staticClass:"language-shell-session line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell-session"}},[t("code",[t("span",{pre:!0,attrs:{class:"token command"}},[t("span",{pre:!0,attrs:{class:"token shell-symbol important"}},[s._v("$")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token bash language-bash"}},[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" pull python:3.8.17-bookworm")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token output"}},[s._v("3.8.17-bookworm: Pulling from library/python\nd52e4f012db1: Pull complete\n7dd206bea61f: Pull complete\n2320f9be4a9c: Pull complete\n6e5565e0ba8d: Pull complete\nd3797e13cc41: Pull complete\n9d8ab9ac5a7d: Pull complete\n43ed38f1d568: Pull complete\n164b4060be55: Pull complete\nDigest: sha256:2ee706fa11ec6907a27f1c5116e9749ad1267336b3b0d53fc35cfba936fae32e\nStatus: Downloaded newer image for python:3.8.17-bookworm\ndocker.io/library/python:3.8.17-bookworm\n")]),t("span",{pre:!0,attrs:{class:"token command"}},[t("span",{pre:!0,attrs:{class:"token shell-symbol important"}},[s._v("$")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token bash language-bash"}},[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" run --rm -itd --name test-debian -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v(":80 -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8082")]),s._v(":82 -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8088")]),s._v(":88 -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8089")]),s._v(":89 -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8443")]),s._v(":443 -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8444")]),s._v(":444 python:3.8.17-bookworm /bin/bash")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token output"}},[s._v("a0da070e286fd52ebb323e5faff9c960014bfcd8eb1e509cb5a12daa9fb9a85e\n")]),t("span",{pre:!0,attrs:{class:"token command"}},[t("span",{pre:!0,attrs:{class:"token shell-symbol important"}},[s._v("$")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token bash language-bash"}},[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" -it test-debian /bin/bash")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token output"}},[s._v("root@a0da070e286f:/#\n")])])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])]),t("p",[s._v("nginxをインストールします。")]),s._v(" "),t("div",{staticClass:"language-shell-session line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell-session"}},[t("code",[t("span",{pre:!0,attrs:{class:"token command"}},[t("span",{pre:!0,attrs:{class:"token info punctuation"}},[t("span",{pre:!0,attrs:{class:"token user"}},[s._v("root@a0da070e286f")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token path"}},[s._v("/")])]),t("span",{pre:!0,attrs:{class:"token shell-symbol important"}},[s._v("#")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token bash language-bash"}},[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt")]),s._v(" update")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token output"}},[s._v("Get:1 http://deb.debian.org/debian bookworm InRelease [151 kB]\nGet:2 http://deb.debian.org/debian bookworm-updates InRelease [52.1 kB]\nGet:3 http://deb.debian.org/debian-security bookworm-security InRelease [48.0 kB]\nGet:4 http://deb.debian.org/debian bookworm/main amd64 Packages [8906 kB]\nGet:5 http://deb.debian.org/debian bookworm-updates/main amd64 Packages [4732 B]\nGet:6 http://deb.debian.org/debian-security bookworm-security/main amd64 Packages [48.0 kB]\nFetched 9210 kB in 3s (3184 kB/s)\nReading package lists... Done\nBuilding dependency tree... Done\nReading state information... Done\n10 packages can be upgraded. Run 'apt list --upgradable' to see them.\n\n")]),t("span",{pre:!0,attrs:{class:"token command"}},[t("span",{pre:!0,attrs:{class:"token info punctuation"}},[t("span",{pre:!0,attrs:{class:"token user"}},[s._v("root@a0da070e286f")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token path"}},[s._v("/")])]),t("span",{pre:!0,attrs:{class:"token shell-symbol important"}},[s._v("#")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token bash language-bash"}},[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y apache2 apache2-dev nginx neovim")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token output"}},[s._v("Reading package lists... Done\nBuilding dependency tree... Done\nReading state information... Done\nThe following additional packages will be installed:\n  apache2-bin apache2-data apache2-utils autopoint bsdextrautils debhelper dh-autoreconf dh-strip-nondeterminism dwz gettext gettext-base groff-base intltool-debian iproute2\n  libapr1-dev libaprutil1-dbd-sqlite3 libaprutil1-dev libaprutil1-ldap libarchive-cpio-perl libarchive-zip-perl libatm1 libbpf1 libcap2-bin libdebhelper-perl\n  libfile-stripnondeterminism-perl libgpm2 libldap-dev libldap2-dev liblua5.3-0 libmail-sendmail-perl libmnl0 libpam-cap libpipeline1 libsctp-dev libsctp1 libsodium23\n\n~~~略~~~\n\nSetting up libapr1-dev (1.7.2-3) ...\nSetting up libaprutil1-dev (1.6.3-1) ...\nSetting up debhelper (13.11.4) ...\nSetting up apache2-dev (2.4.57-2) ...\nProcessing triggers for libc-bin (2.36-9) ...\nProcessing triggers for hicolor-icon-theme (0.17-2) ...\nroot@a0da070e286f:/#\n")])])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br")])]),t("p",[s._v("以下のコマンドでバージョンが表示されれば成功です。")]),s._v(" "),t("div",{staticClass:"language-shell-session line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell-session"}},[t("code",[t("span",{pre:!0,attrs:{class:"token command"}},[t("span",{pre:!0,attrs:{class:"token info punctuation"}},[t("span",{pre:!0,attrs:{class:"token user"}},[s._v("root@a0da070e286f")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token path"}},[s._v("/")])]),t("span",{pre:!0,attrs:{class:"token shell-symbol important"}},[s._v("#")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token bash language-bash"}},[s._v("nginx -v")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token output"}},[s._v("nginx version: nginx/1.22.1\n")])])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h3",{attrs:{id:"nginx-の初期設定"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#nginx-の初期設定"}},[s._v("#")]),s._v(" nginx の初期設定")]),s._v(" "),t("p",[s._v("nginxのサイトは88 portでリクエストを受け付けるようにします。")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("root@a0da070e286f:/"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# echo 'Hello Bootcamp!!' > /var/www/html/index.html")]),s._v("\nroot@a0da070e286f:/"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# nvim /etc/nginx/sites-enabled/default")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("listen")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("88")]),s._v(" default_server")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 80 => 88 に変更")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("listen")]),s._v(" [::]:88 default_server")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 80 => 88 に変更")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("root")]),s._v(" /var/www/html")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("index")]),s._v(" index.html index.htm index.nginx-debian.html")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server_name")]),s._v(" _")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" /")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token directive"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("try_files")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$uri")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$uri")]),s._v("/ =404")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])]),t("p",[s._v("変更したらnginxを起動しましょう。")]),s._v(" "),t("div",{staticClass:"language-shell-session line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell-session"}},[t("code",[t("span",{pre:!0,attrs:{class:"token command"}},[t("span",{pre:!0,attrs:{class:"token info punctuation"}},[t("span",{pre:!0,attrs:{class:"token user"}},[s._v("root@a0da070e286f")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token path"}},[s._v("/")])]),t("span",{pre:!0,attrs:{class:"token shell-symbol important"}},[s._v("#")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token bash language-bash"}},[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" nginx start")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token output"}},[s._v("[ ok ] Starting nginx: nginx.\n")])])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[t("a",{attrs:{href:"http://localhost:8088",target:"_blank",rel:"noopener noreferrer"}},[s._v("localhost:8088"),t("OutboundLink")],1),s._v(" にアクセスしてみてください。"),t("code",[s._v("Hello Bootcamp!!")]),s._v("のHTMLが見えていれば成功です。")]),s._v(" "),t("p",[t("img",{attrs:{src:a(497),alt:"nginx_html"}})]),s._v(" "),t("p",[s._v("アクセスログも確認してみましょう。")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("root@a0da070e286f:/"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# tail /var/log/nginx/access.log")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("ここまでが事前作業となります。間に合わなければ、座学の間で準備してください。")]),s._v(" "),t("h2",{attrs:{id:"ssl-tls-とは"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ssl-tls-とは"}},[s._v("#")]),s._v(" SSL/TLS とは")]),s._v(" "),t("p",[s._v("例えば、HTTP は基本的に平文でデータをやりとりします。")]),s._v(" "),t("p",[s._v("ということは、途中でパケットキャプチャをすると、やり取りの内容を読み取ることができます。")]),s._v(" "),t("p",[s._v("もしそこにパスワード情報など見られてはいけない情報が含まれていたら...怖いですね。")]),s._v(" "),t("p",[s._v("そこで、SSL/TLS (Secure Socket Layer/Transport Layer Securityの技術)を用いて通信路の暗号化を行うHTTP over SSL いわゆるHTTPS を重要な情報のやりとりを行う際には用いるのが一般的となっています。")]),s._v(" "),t("p",[s._v("SSL/TLSは通信路の暗号化として汎用性のあるものとなっており、HTTPに限らず様々なプロトコルでの暗号化に用いられています。")]),s._v(" "),t("ul",[t("li",[s._v("ファイル転送: FTP -> FTPS")]),s._v(" "),t("li",[s._v("メール: SMTP -> SMTPS, POP3 -> POP3S, IMAP -> IMAPS")])]),s._v(" "),t("p",[s._v("プロトコルとまではなっていなくても、mysqlなどでもレプリケーションの経路を暗号化するために用いられていたりもします。")]),s._v(" "),t("p",[s._v("では、そのSSL/TLS の概要と歴史について、はIPAの資料がよくまとまっているため、そちらの2章1節を読むのがよいでしょう。\nざっくりというと、公開鍵暗号を用いて共通鍵を共有し、その共通鍵を用いて以後の経路の暗号化を行う、というものになります。")]),s._v(" "),t("p",[t("a",{attrs:{href:"https://www.ipa.go.jp/security/crypto/guideline/ssl_crypt_config.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("TLS 暗号設定ガイドライン"),t("OutboundLink")],1)]),s._v(" "),t("p",[s._v("この講義では、主にHTTPSをメインに触っていこうと思います。\nまた、以下ではSSL/TLSの総称としてTLSということにします。")]),s._v(" "),t("h2",{attrs:{id:"証明書-とは"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#証明書-とは"}},[s._v("#")]),s._v(" 証明書 とは")]),s._v(" "),t("p",[s._v("TLSは公開鍵暗号と共通鍵暗号の組み合わせという話をしました。\nこの公開鍵暗号の部分を担う重要なパーツとして証明書があります。")]),s._v(" "),t("p",[s._v("証明書には、以下の役割があります。")]),s._v(" "),t("ul",[t("li",[s._v("公開鍵暗号の公開鍵情報の共有手段")]),s._v(" "),t("li",[s._v("通信相手が確かにアクセスしようとしたドメインのサーバであることの確認手段")])]),s._v(" "),t("p",[s._v("後者について、どのように確認が行えるのでしょうか？")]),s._v(" "),t("p",[s._v("試しに"),t("a",{attrs:{href:"https://www.iij.ad.jp",target:"_blank",rel:"noopener noreferrer"}},[s._v("IIJの公式サイト"),t("OutboundLink")],1),s._v("の証明書を覗いてみましょう。")]),s._v(" "),t("p",[s._v("ブラウザでHTTPSなサイトを開くと、アドレスバーの横に鍵のマークが出ているかと思います。\nそこから、証明書の情報を見ることができます。")]),s._v(" "),t("p",[s._v("まずは、本体の証明書を見てみましょう。\n見るところは色々ありますが、この辺りを注意してみましょう。\nブラウザによって表記が異なる場合がありますので、いくつか名称は並べて書きます")]),s._v(" "),t("ul",[t("li",[s._v("共通名、一般名、Common Name(CN)\n"),t("ul",[t("li",[s._v("基本的にはサイトのドメイン")]),s._v(" "),t("li",[s._v("昔は、ここのドメインをもって確認をしても良いことになっていましたが、現在では禁止されています(RFC9110)\n"),t("ul",[t("li",[s._v("参考: "),t("a",{attrs:{href:"https://eng-blog.iij.ad.jp/archives/14820",target:"_blank",rel:"noopener noreferrer"}},[s._v("エンジニアブログ"),t("OutboundLink")],1)])])])])]),s._v(" "),t("li",[s._v("組織、Organization(O)\n"),t("ul",[t("li",[s._v("この証明書を用いたサイトの管理組織")])])]),s._v(" "),t("li",[s._v("有効期間\n"),t("ul",[t("li",[s._v("この証明書の有効期間")]),s._v(" "),t("li",[s._v("昔は5年などもありましたが、2024年現在では13か月が最長となっています。90日まで短縮する議論もあるようです。")])])]),s._v(" "),t("li",[s._v("主体者代替名、サブジェクトの代替名、サブジェクトの別名、Subject Alternative Names(SANs)\n"),t("ul",[t("li",[s._v("いくつか項目があるが、このうち重要なのはDNS名。この証明書が有効であるサイトを示しています。")]),s._v(" "),t("li",[s._v("複数存在しうる")]),s._v(" "),t("li",[s._v("現在では、証明書が管理するサイトを示す唯一の項目となります。")])])]),s._v(" "),t("li",[s._v("公開鍵\n"),t("ul",[t("li",[s._v("この証明書が提供する公開鍵。これを用いて共通鍵の共有を行います。")])])])]),s._v(" "),t("p",[s._v("ここまで見たところで、証明書に添付された公開鍵を用いて暗号化通信を始めてよいのでしょうか？\nまだ、単に私はこのサイトの管理者だぞ！と自称しているに過ぎません。\n信用して暗号化した経路でクレジットカードの情報を送ったのに、送った相手は偽サイトを運用する悪人だった、\nとなったら目も当てられません。\n確かにこのサイトの管理者だと信じるには、信頼できる第三者の担保が欲しいですね。")]),s._v(" "),t("p",[s._v("ここで登場するのが、認証局(Certification Authority: CA)です。")]),s._v(" "),t("p",[s._v("証明書に戻ると、発行者(発行元、Issuer)と証明書の署名という項目があるのがわかります。\n具体的な検証手段は割愛しますが、この署名を検証することで、確かに証明書が発行者に認められたものであることがわかります。")]),s._v(" "),t("p",[s._v("では、その発行者は信頼できるのでしょうか？\n証明書の情報を見ると、階層構造のようになっている部分があり、本体の証明書の上に発行者の証明書が表示されているかと思います。\n発行者の証明書もまた同じような構造をしており、有効期間や組織などの情報はもちろん、またその上位の発行者と署名があります。\nこうして証明書のチェインがつながっていった結果、最終的にRootCA の証明書に行きつきます。")]),s._v(" "),t("p",[s._v("ブラウザのユーザは、少なくともそのブラウザは信用して使っているのだと思います。\nブラウザは、そのブラウザを含めて世界的に信用している認証局の証明書を、リストとして保持しています。\nその認証局がRootCAと呼ばれているものです。\n証明書のチェインがつながって、RootCAのものまで辿れれば、それは信頼できる認証局が証明したものとして信用できる、と判断できるようになります。")]),s._v(" "),t("p",[s._v("このような証明書のチェインを通じて公開鍵の正当性を担保するための枠組みを公開鍵基盤(Public Key Infrastrcture:PKI)と呼びます。")]),s._v(" "),t("p",[s._v("余談ですが、政府がRootとして正当性を担保する、政府認証基盤(Government PKI:GPKI)というものもあります。\n例えばマイナンバーカードの証明書は公的個人認証サービス(JPKI)というものが発行していますが、JPKIの正当性はGPKIと相互認証する形で担保していたりします。")]),s._v(" "),t("h2",{attrs:{id:"実際に手を動かしてみる"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#実際に手を動かしてみる"}},[s._v("#")]),s._v(" 実際に手を動かしてみる")]),s._v(" "),t("h3",{attrs:{id:"証明書と秘密鍵を作ってみる-check1"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#証明書と秘密鍵を作ってみる-check1"}},[s._v("#")]),s._v(" 証明書と秘密鍵を作ってみる (check1)")]),s._v(" "),t("p",[s._v("通常、証明書は以下の手順で入手します。")]),s._v(" "),t("ol",[t("li",[s._v("秘密鍵を生成する")]),s._v(" "),t("li",[s._v("秘密鍵からCSR (Certificate Signing Request) を生成する")]),s._v(" "),t("li",[s._v("CSR を証明局に提出し、審査を受け、証明局の持つ秘密鍵で署名された証明書を発行してもらう")])]),s._v(" "),t("p",[s._v("ここでは、３を簡略化して1 で生成した鍵で署名する、自己署名証明書(いわゆるオレオレ証明書)を作ります。\nこのdocker image に既にインストールされている、openssl ツールで一通りの操作を行うことができます。")]),s._v(" "),t("h4",{attrs:{id:"_1-秘密鍵を生成する"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-秘密鍵を生成する"}},[s._v("#")]),s._v(" 1. 秘密鍵を生成する")]),s._v(" "),t("p",[s._v("ここではRSA の2048 bit の秘密鍵を生成します。")]),s._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[s._v("TIP")]),s._v(" "),t("p",[s._v("サブコマンドであるgenrsa はRSA 暗号の秘密鍵を生成するものとなります。")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("root@a0da070e286f:/"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mkdir /etc/nginx/ssl")]),s._v("\nroot@a0da070e286f:/"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# openssl genrsa 2048 > /etc/nginx/ssl/private.key")]),s._v("\nGenerating RSA private key, "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2048")]),s._v(" bit long modulus "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" primes"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("+++++\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".+++++\ne is "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("65537")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("0x010001"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("h4",{attrs:{id:"_2-秘密鍵からcsr-certificate-signing-request-を生成する"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-秘密鍵からcsr-certificate-signing-request-を生成する"}},[s._v("#")]),s._v(" 2. 秘密鍵からCSR (Certificate Signing Request) を生成する")]),s._v(" "),t("p",[s._v("1 で作った秘密鍵から、CSR を生成します。")]),s._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[s._v("TIP")]),s._v(" "),t("p",[s._v("サブコマンドであるreq はCSR を扱うためのものとなります。")])]),s._v(" "),t("p",[s._v("証明書で表示する情報をここで入力することになります。\n実際に発行する際は、正当性を担保したい対象であるCommon Name は特に間違わないようにしましょう。")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("root@a0da070e286f:/"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# openssl req -new -sha256 -key /etc/nginx/ssl/private.key -out /etc/nginx/ssl/server.csr")]),s._v("\nYou are about to be asked to enter information that will be incorporated\ninto your certificate request.\nWhat you are about to enter is what is called a Distinguished Name or a DN.\nThere are quite a few fields but you can leave some blank\nFor some fields there will be a default value,\nIf you enter "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'.'")]),s._v(", the field will be left blank.\n-----\nCountry Name "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" letter code"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("AU"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(":JP\nState or Province Name "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("full name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Some-State"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(":Tokyo\nLocality Name "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("eg, city"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(":Chiyoda\nOrganization Name "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("eg, company"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Internet Widgits Pty Ltd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(":IIJ\nOrganizational Unit Name "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("eg, section"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(":TU\nCommon Name "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("e.g. server FQDN or YOUR name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(":localhost\nEmail Address "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(":\n\nPlease enter the following "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'extra'")]),s._v(" attributes\nto be sent with your certificate request\nA challenge password "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(":\nAn optional company name "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(":\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br")])]),t("h4",{attrs:{id:"_3-署名された証明書を発行する"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-署名された証明書を発行する"}},[s._v("#")]),s._v(" 3. 署名された証明書を発行する")]),s._v(" "),t("p",[s._v("1 で作った秘密鍵、2 で作ったCSR から証明書を発行します。")]),s._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[s._v("TIP")]),s._v(" "),t("p",[s._v("サブコマンドであるx509 は、証明書の標準規格を指しています。\n-req でinput がCSR であることを示し、signkey に1 で作った秘密鍵を指定することでこれで署名します。")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("root@a0da070e286f:/"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# openssl x509 -req -in /etc/nginx/ssl/server.csr -out /etc/nginx/ssl/server.crt -signkey /etc/nginx/ssl/private.key -days 365")]),s._v("\nCertificate request self-signature ok\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("subject")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("C "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" JP, ST "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Tokyo, L "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Chiyoda, O "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" IIJ, OU "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" TU, CN "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" localhost\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("出来上がったら、証明書の中を覗いてみましょう。text オプションでテキスト出力をすることができます。")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("root@a0da070e286f:/"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# openssl x509 -in /etc/nginx/ssl/server.crt -text")]),s._v("\nCertificate:\n    Data:\n        Version: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("0x0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        Serial Number:\n            "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("45")]),s._v(":ef:45:48:8c:89:e0:e5:38:74:f7:fc:21:32:35:eb:2b:bc:10:6b\n        Signature Algorithm: sha256WithRSAEncryption\n        Issuer: C "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" JP, ST "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Tokyo, L "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Chiyoda, O "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" IIJ, OU "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" TU, CN "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" localhost\n        Validity\n            Not Before: Aug  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(":29:36 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v(" GMT\n            Not After "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Aug  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(":29:36 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2023")]),s._v(" GMT\n        Subject: C "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" JP, ST "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Tokyo, L "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Chiyoda, O "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" IIJ, OU "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" TU, CN "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" localhost\n        Subject Public Key Info:\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".省略"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("."),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])]),t("p",[s._v("実際に発行されたものを確認する際は、期間(Not BeforeとNot After)とSubject (CN が正しいか)に特に注意しましょう。")]),s._v(" "),t("p",[s._v("秘密鍵と証明書のペアが正しいかを確認するには、RSA のものならmodulus を比較するのが簡単です。")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("root@a0da070e286f:/"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# openssl rsa -in /etc/nginx/ssl/private.key -modulus -noout")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Modulus")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("FB1908BE2B1567D1B8B7EE99DF3480CE2EDF57EC73ADD08AE2FA37A833321C84CF49D6D3F8011419BDAF8882B6E610C097D7016D173A14B7343E8D1381B8CF7FCD14CAA5717594B6F5CD586BF13EB90D2673E03B73EB25463333BD8D4384477C7910E87C8CEB2E71C83E59DD3BAC61E9B19DB97545AA9DB96DC995B01B2F96FA62CD8C777C0DA3A0377F71E0F6251CE7511964F2B4604D7F88472759C0178ECA1C7B21F9D9198166F28097A6EDF76925247119B7BEBDA73DD387607BD6320444E0242E127108C234B7F0D6CD6EB7E496747BDE7249E606BA44024E1FCC61E9ADBBE1BDABE51B342AF7DA5801AE36393E11EFFFAE60047EA7FE1E8E9A12FFF57B\n\nroot@a0da070e286f:/"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# openssl x509 -in /etc/nginx/ssl/server.crt -modulus -noout")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Modulus")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("FB1908BE2B1567D1B8B7EE99DF3480CE2EDF57EC73ADD08AE2FA37A833321C84CF49D6D3F8011419BDAF8882B6E610C097D7016D173A14B7343E8D1381B8CF7FCD14CAA5717594B6F5CD586BF13EB90D2673E03B73EB25463333BD8D4384477C7910E87C8CEB2E71C83E59DD3BAC61E9B19DB97545AA9DB96DC995B01B2F96FA62CD8C777C0DA3A0377F71E0F6251CE7511964F2B4604D7F88472759C0178ECA1C7B21F9D9198166F28097A6EDF76925247119B7BEBDA73DD387607BD6320444E0242E127108C234B7F0D6CD6EB7E496747BDE7249E606BA44024E1FCC61E9ADBBE1BDABE51B342AF7DA5801AE36393E11EFFFAE60047EA7FE1E8E9A12FFF57B\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("h3",{attrs:{id:"https-の設定-check2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#https-の設定-check2"}},[s._v("#")]),s._v(" https の設定(check2)")]),s._v(" "),t("p",[s._v("事前作業で作ったhttp で受けていたサイトをhttps でも受けられるようにしてみます。")]),s._v(" "),t("p",[t("code",[s._v("/etc/nginx/sites-enabled/default")]),s._v(" の一番下に以下を追記していきます。")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("server "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        listen "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")]),s._v(" default_server"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        listen "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("::"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(":443 default_server"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        ssl on"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        ssl_certificate /etc/nginx/ssl/server.crt"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        ssl_certificate_key /etc/nginx/ssl/private.key"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        root /var/www/html"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        index index.html index.htm index.nginx-debian.html"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        server_name _"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        location / "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                try_files "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$uri")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$uri")]),s._v("/ "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("404")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br")])]),t("p",[s._v("追記したら、nginx をリスタートしましょう。")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("root@dea1ac0e1edb:/"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# service nginx restart")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" ok "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Restarting nginx: nginx.\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("443 は8443 にポートフォワードの設定が入っているため、8443 ポートにアクセスしてみましょう。\nhttps での通信となるため、URL の先頭がhttp ではなくhttps となっています。")]),s._v(" "),t("p",[t("a",{attrs:{href:"https://localhost:8443/",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://localhost:8443/"),t("OutboundLink")],1)]),s._v(" "),t("p",[s._v("今回は自己署名証明書であるため、ほとんどのブラウザは正当な証明書ではないと判断し、注意喚起の画面が表示されます。\n危険性を承知で閲覧すると、"),t("code",[s._v("Hello Bootcamp!!")]),s._v("の表示が確認できるかと思います。")]),s._v(" "),t("p",[s._v("また、ブラウザ上で暗号化に使っている証明書の内容が確認できるので、確認もしてみましょう。")]),s._v(" "),t("h3",{attrs:{id:"詳細な暗号設定"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#詳細な暗号設定"}},[s._v("#")]),s._v(" 詳細な暗号設定")]),s._v(" "),t("p",[s._v("TLSの設定としては、主に、プロトコルのバージョン、暗号スイート、証明書、に何を使うかが大事になります。")]),s._v(" "),t("h4",{attrs:{id:"protocol-を設定してみる-check3"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#protocol-を設定してみる-check3"}},[s._v("#")]),s._v(" protocol を設定してみる(check3)")]),s._v(" "),t("p",[s._v("プロトコルについては、既に1.1 までは2021に禁止扱いになっていたりします。")]),s._v(" "),t("p",[s._v("nginx だと、"),t("code",[s._v("ssl_protocols")]),s._v("で設定します。")]),s._v(" "),t("p",[s._v("まずは、デフォルトの状態で接続を確認してみましょう。TLSv1.2で接続できています。")]),s._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[s._v("TIP")]),s._v(" "),t("p",[s._v("nginx上ではデフォルトで後述設定の通りTLSv1, 1.1 が有効に見えますが、接続できないようです。\nそのため、ここでは差異が見えるようわざとTLSv1.2 で試してみています。")])]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("root@34cfcf7b6f05:/"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl -vvv -k --tls-max 1.2 https://localhost:443")]),s._v("\n*   Trying "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:443"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n* Connected to localhost "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" port "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#0)")]),s._v("\n* ALPN: offers h2,http/1.1\n* TLSv1.2 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("OUT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", TLS handshake, Client hello "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(":\n* TLSv1.2 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("IN"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", TLS handshake, Server hello "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(":\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("中略"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" GET / HTTP/1.1\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" Host: localhost\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" User-Agent: curl/7.88.1\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" Accept: */*\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" HTTP/1.1 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v(" OK\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" Server: nginx/1.22.1\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" Date: Thu, 01 Aug "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2024")]),s._v(" 01:58:28 GMT\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" Content-Type: text/html\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" Content-Length: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" Last-Modified: Mon, "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("29")]),s._v(" Jul "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2024")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":13:24 GMT\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" Connection: keep-alive\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" ETag: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"66a82214-11"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" Accept-Ranges: bytes\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("\nHello Bootcamp"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("\n* Connection "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#0 to host localhost left intact")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br")])]),t("p",[s._v("では、/etc/nginx/nginx.conf に設定があるので、書き換えてみましょう。\n書き換えたら再起動して反映させます。")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("root@34cfcf7b6f05:/"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# nvim /etc/nginx/nginx.conf")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("前後省略"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# SSL Settings")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##")]),s._v("\n\n        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Dropping SSLv3, ref: POODLE  <= ここからTLSv1 TLSv1.1 TLSv1.2 を消してみる")]),s._v("\n        ssl_prefer_server_ciphers on"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Logging Settings")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("前後省略"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nroot@34cfcf7b6f05:/"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# service nginx restart")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])]),t("p",[s._v("設定してみたら、接続できなくなることを確認してみましょう。")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("root@34cfcf7b6f05:/"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl -vvv -k --tls-max 1.2 https://localhost:443")]),s._v("\n*   Trying "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:443"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n* Connected to localhost "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" port "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#0)")]),s._v("\n* ALPN: offers h2,http/1.1\n* TLSv1.2 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("OUT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", TLS handshake, Client hello "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(":\n* TLSv1.2 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("IN"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", TLS alert, protocol version "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("582")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(":\n* OpenSSL/3.0.9: error:0A00042E:SSL routines::tlsv1 alert protocol version\n* Closing connection "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\ncurl: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("35")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" OpenSSL/3.0.9: error:0A00042E:SSL routines::tlsv1 alert protocol version\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("h4",{attrs:{id:"暗号スイートを設定してみる-check4"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#暗号スイートを設定してみる-check4"}},[s._v("#")]),s._v(" 暗号スイートを設定してみる(check4)")]),s._v(" "),t("p",[s._v("暗号スイートは、")]),s._v(" "),t("ul",[t("li",[s._v("鍵交換方式")]),s._v(" "),t("li",[s._v("署名方式")]),s._v(" "),t("li",[s._v("暗号化方式")]),s._v(" "),t("li",[s._v("ハッシュ関数")])]),s._v(" "),t("p",[s._v("の組で構成されます。TLS1.3からは、ここから鍵交換方式、署名方式が外されて暗号化方式、ハッシュ関数で構成されます。(鍵交換や署名の部分がプロトコルに最初から組み込まれるようになったため、指定する必要がなくなりました)")]),s._v(" "),t("p",[s._v("openssl コマンドで、扱える暗号スイートの一覧を見ることが出来るので、見てみましょう。")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("root@34cfcf7b6f05:/"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# openssl ciphers -v")]),s._v("\nTLS_AES_256_GCM_SHA384         TLSv1.3 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Kx")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("any      "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Au")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("any   "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Enc")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("AESGCM"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("256")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("            "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Mac")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("AEAD\nTLS_CHACHA20_POLY1305_SHA256   TLSv1.3 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Kx")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("any      "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Au")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("any   "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Enc")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("CHACHA20/POLY1305"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("256")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Mac")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("AEAD\nTLS_AES_128_GCM_SHA256         TLSv1.3 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Kx")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("any      "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Au")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("any   "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Enc")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("AESGCM"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("128")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("            "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Mac")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("AEAD\nECDHE-ECDSA-AES256-GCM-SHA384  TLSv1.2 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Kx")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ECDH     "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Au")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ECDSA "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Enc")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("AESGCM"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("256")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("            "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Mac")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("AEAD\nECDHE-RSA-AES256-GCM-SHA384    TLSv1.2 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Kx")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ECDH     "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Au")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("RSA   "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Enc")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("AESGCM"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("256")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("            "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Mac")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("AEAD\nDHE-RSA-AES256-GCM-SHA384      TLSv1.2 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Kx")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("DH       "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Au")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("RSA   "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Enc")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("AESGCM"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("256")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("            "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Mac")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("AEAD\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("以下略"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("p",[s._v("一番上のものは、TLS1.3 のものなので、暗号化がAES256のGCMモード、ハッシュ関数がSHA384\n4番目のものは、TLS1.2 のものなので、鍵交換がECDHE、署名がECDSA、暗号化がAES256のGCMモード、ハッシュ関数がSHA384\nといった感じになります。")]),s._v(" "),t("p",[s._v("注意する点として、この表記はOpenSSL流のものですが、世の中にはIANAが定めた表記も存在しています。\n技術文書で出てきたものが見当たらないな、と思ったら別表記のものかもしれません。")]),s._v(" "),t("p",[s._v("参考")]),s._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"https://testssl.sh/openssl-iana.mapping.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("testssl.sh が出してるマッピング"),t("OutboundLink")],1)]),s._v(" "),t("li",[t("a",{attrs:{href:"https://ciphersuite.info/",target:"_blank",rel:"noopener noreferrer"}},[s._v("変換してくれるサイト"),t("OutboundLink")],1)])]),s._v(" "),t("p",[s._v("nginxでは、"),t("code",[s._v("ssl_ciphers")]),s._v("を用いて設定します。")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("root@34cfcf7b6f05:/"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# nvim /etc/nginx/nginx.conf")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("前後省略"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# SSL Settings")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##")]),s._v("\n\n        ssl_protocols TLSv1.2 TLSv1.3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Dropping SSLv3, ref: POODLE  <= TLSv1.2 を元に戻す")]),s._v("\n        ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-CHACHA20-POLY1305"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ↑↑↑ この行を追加")]),s._v("\n        ssl_prefer_server_ciphers on"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Logging Settings")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("前後省略"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nroot@34cfcf7b6f05:/"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# service nginx restart")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br")])]),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[s._v("TIP")]),s._v(" "),t("p",[s._v('ssl_ciphers の設定部分は、openssl ciphers の引数に食わせることで、この設定で使えるcipher の一覧を表示させることができます。\n今回は列挙した形ですが、!EXP のようにブラックリストな書き方もできるため、よくわからなくなったらこれで実際に設定されるものを確認するとよいでしょう。\nopenssl ciphers -v "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-CHACHA20-POLY1305"')])]),s._v(" "),t("p",[t("code",[s._v("openssl ciphers")]),s._v("の一覧から適当なものを選んで接続してみて、nginx.confで設定したものは接続でき、設定しなかったものは接続できないことを確認してください。")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("root@34cfcf7b6f05:/"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl -vvv -k --tls-max 1.2 --ciphers ECDHE-RSA-AES128-GCM-SHA256 https://localhost:443")]),s._v("\n*   Trying "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:443"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n* Connected to localhost "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" port "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#0)")]),s._v("\n* ALPN: offers h2,http/1.1\n* Cipher selection: ECDHE-RSA-AES128-GCM-SHA256\n* TLSv1.2 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("OUT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", TLS handshake, Client hello "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(":\n* TLSv1.2 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("IN"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", TLS handshake, Server hello "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(":\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("中略"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nHello Bootcamp"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("\n\nroot@34cfcf7b6f05:/"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# curl -vvv -k --tls-max 1.2 --ciphers AES256-SHA256 https://localhost:443")]),s._v("\n*   Trying "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:443"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n* Connected to localhost "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" port "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#0)")]),s._v("\n* ALPN: offers h2,http/1.1\n* Cipher selection: AES256-SHA256\n* TLSv1.2 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("OUT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", TLS handshake, Client hello "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(":\n* TLSv1.2 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("IN"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", TLS alert, handshake failure "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("552")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(":\n* OpenSSL/3.0.9: error:0A000410:SSL routines::sslv3 alert handshake failure\n* Closing connection "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\ncurl: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("35")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" OpenSSL/3.0.9: error:0A000410:SSL routines::sslv3 alert handshake failure\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br")])]),t("h4",{attrs:{id:"証明書について-check5"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#証明書について-check5"}},[s._v("#")]),s._v(" 証明書について(check5)")]),s._v(" "),t("p",[s._v("証明書については、発行形式は証明局側がよしなにするので、こちらで主に気にすべきは秘密鍵の方です。\n鍵長長ければ長いほどセキュリティ強度は高まりますが、復号するために余計にリソースを消費することになるため、\nそこはトレードオフとなります。")]),s._v(" "),t("p",[s._v("ECDSAは暗号の特性上、短い鍵長でも高いセキュリティ強度を保つことができます。\nRSAであれば2048bit、ECDSAであれば256bit のものを使うのがよいでしょう。")]),s._v(" "),t("p",[s._v("ここでは、試しにECDSAの秘密鍵を用いて証明書を作って使用してみます。\nopenssl コマンドで、ECDSAの秘密鍵も生成可能です。")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("root@a0da070e286f:/"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# openssl ecparam -genkey -name prime256v1 > /etc/nginx/ssl/ecdsa.key")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("生成した鍵を見てみると、形式がRSAのものと異なり、短くなっていることが見て取れるかと思います。\nここから先の手順は、RSAの時と同様です。出力も同様なので省略します。")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("root@34cfcf7b6f05:/"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# openssl req -new -sha256 -key /etc/nginx/ssl/ecdsa.key -out /etc/nginx/ssl/ecdsa.csr")]),s._v("\nroot@34cfcf7b6f05:/"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# openssl x509 -req -in /etc/nginx/ssl/ecdsa.csr -out /etc/nginx/ssl/ecdsa.crt -signkey /etc/nginx/ssl/ecdsa.key -days 365")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("出来上がったものを見てみると、Public Key Info が変わっています。")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("root@34cfcf7b6f05:/"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# openssl x509 -in /etc/nginx/ssl/ecdsa.crt -text")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("中略"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  Subject Public Key Info:\n    Public Key Algorithm: id-ecPublicKey\n      Public-Key: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("256")]),s._v(" bit"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n      pub:\n        04:6b:b0:f6:cc:b5:8d:6a:b9:93:f2:1d:50:ec:4e:\n        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("59")]),s._v(":82:39:70:33:61:f3:b4:3b:13:42:39:1d:68:27:\n        5a:27:3d:0a:df:14:78:3d:aa:fb:ec:f5:a8:8b:87:\n        3b:bc:cc:f7:47:b3:84:db:85:a5:e5:2e:9c:03:44:\n        8f:37:65:2e:e4\n      ASN1 OID: prime256v1\n      NIST CURVE: P-256\nSignature Algorithm: ecdsa-with-SHA256\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])]),t("p",[s._v("後は、nginx の参照を変更し、この証明書を使ってhttpsを提供してみましょう。")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("root@34cfcf7b6f05:/"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# nvim /etc/nginx/sites-enabled/default")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("中略"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\nserver "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        listen "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")]),s._v(" default_server"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        listen "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("::"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(":443 default_server"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        ssl on"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        ssl_certificate /etc/nginx/ssl/ecdsa.crt"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# <= ここを書き換え")]),s._v("\n        ssl_certificate_key /etc/nginx/ssl/ecdsa.key"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# <= ここを書き換え")]),s._v("\n\n        root /var/www/html"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        index index.html index.htm index.nginx-debian.html"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("後略"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nroot@34cfcf7b6f05:/"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# service nginx restart")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br")])]),t("p",[s._v("ECDSAの鍵を用いたものでも問題なく接続できるかと思います。")]),s._v(" "),t("p",[s._v("パフォーマンスの観点からはECDSAの方が有利ですが、中にはECDSAに対応していないサービスもあります。\n利用してみたい場合も証明書を使用するサービスで使えるかどうか確認してから発行するようにしましょう。")]),s._v(" "),t("h4",{attrs:{id:"安全とされている設定"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安全とされている設定"}},[s._v("#")]),s._v(" 安全とされている設定")]),s._v(" "),t("p",[s._v("日本における暗号設定のセキュリティ上の最低ラインは先の暗号設定ガイドラインの3.1に記載されています。\n\n"),t("a",{attrs:{href:"https://www.ipa.go.jp/security/crypto/guideline/ssl_crypt_config.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("TLS 暗号設定ガイドライン"),t("OutboundLink")],1)]),s._v(" "),t("p",[s._v("表14がわかりやすいでしょう。ビットセキュリティについては、2.6の表11がわかりやすいです。")]),s._v(" "),t("p",[s._v("mozilla の推奨暗号スイートも参考になります。")]),s._v(" "),t("p",[t("a",{attrs:{href:"https://wiki.mozilla.org/Security/Server_Side_TLS",target:"_blank",rel:"noopener noreferrer"}},[s._v("mozilla Server Side TLS"),t("OutboundLink")],1)]),s._v(" "),t("p",[s._v("今回のcipher設定についてはmozilla のintermediate のものを利用しています。\n"),t("a",{attrs:{href:"https://ssl-config.mozilla.org/",target:"_blank",rel:"noopener noreferrer"}},[s._v("こちら"),t("OutboundLink")],1),s._v("で対応する設定を出力してくれるのも便利です。")])])}),[],!1,null,null,null);t.default=e.exports}}]);