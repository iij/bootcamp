(window.webpackJsonp=window.webpackJsonp||[]).push([[9],{255:function(t,s,e){t.exports=e.p+"assets/img/fork-repo.e0dbd328.jpg"},276:function(t,s,e){t.exports=e.p+"assets/img/drone_first_test.31192e41.png"},277:function(t,s,e){t.exports=e.p+"assets/img/drone_steps.6a94640c.png"},278:function(t,s,e){t.exports=e.p+"assets/img/drone_test_failed.3ffdd2f3.png"},279:function(t,s,e){t.exports=e.p+"assets/img/drone_pull_request_button.39571d74.png"},280:function(t,s,e){t.exports=e.p+"assets/img/drone_pull_request_result.6e4f0582.png"},281:function(t,s,e){t.exports=e.p+"assets/img/drone_branch_protection.6e9707f7.png"},282:function(t,s,e){t.exports=e.p+"assets/img/drone_reject_merge.260c0651.png"},283:function(t,s,e){t.exports=e.p+"assets/img/drone_textlint_error.9c7cad75.png"},442:function(t,s,e){"use strict";e.r(s);var a=e(10),n=Object(a.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"drone-でciテスト・デプロイを回す"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#drone-でciテスト・デプロイを回す"}},[t._v("#")]),t._v(" drone でCIテスト・デプロイを回す")]),t._v(" "),s("h2",{attrs:{id:"_0-この講義について"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_0-この講義について"}},[t._v("#")]),t._v(" 0. この講義について")]),t._v(" "),s("h3",{attrs:{id:"_0-1-この講義の目的"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_0-1-この講義の目的"}},[t._v("#")]),t._v(" 0.1 この講義の目的")]),t._v(" "),s("p",[t._v("継続的インテグレーション(Continuous Integration)、継続的デリバリ(Continuous Delivery)について理解する。\ndrone を利用したCI/CDを体験し、自分のプロジェクトにCI/CDを自ら導入できるようにする。")]),t._v(" "),s("h3",{attrs:{id:"_0-2-ハンズオンの対象者"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_0-2-ハンズオンの対象者"}},[t._v("#")]),t._v(" 0.2 ハンズオンの対象者")]),t._v(" "),s("p",[t._v("これからプログラムを書く、またはテキストファイルによる設定ファイル、マニュアル、仕様書などを記述する可能性のある技術者を対象としています。")]),t._v(" "),s("p",[t._v("講義にあたって事前に以下の要件を満たすようにしてください。")]),t._v(" "),s("ul",[s("li",[t._v("YAMLの読み書きができること\n"),s("ul",[s("li",[t._v("知らない場合は"),s("a",{attrs:{href:"https://www.codeproject.com/Articles/1214409/Learn-YAML-in-five-minutes",target:"_blank",rel:"noopener noreferrer"}},[t._v("Learn YAML in five minutes!"),s("OutboundLink")],1),t._v("をご覧ください。")])])]),t._v(" "),s("li",[t._v("「Gitの使い方＋GitHubを使った開発手法」を受講しておくこと\n"),s("ul",[s("li",[t._v("この講義の中では Git の操作に加え GitHub 上での操作も必要になります。アカウントがない場合は事前に用意してください。")])])])]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("チェックポイント1 🏁")]),t._v(" "),s("p",[t._v("Gitの使い方＋GitHubを使った開発手法を受講しましたか？"),s("br"),t._v("\ngit clone, checkout, add, commit, push などを利用します。")])]),t._v(" "),s("h3",{attrs:{id:"_0-3-下準備"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_0-3-下準備"}},[t._v("#")]),t._v(" 0.3 下準備")]),t._v(" "),s("ul",[s("li",[t._v("Gitを利用できる環境を準備してください。")]),t._v(" "),s("li",[t._v("お好みのテキストエディタを準備してください。\n"),s("ul",[s("li",[t._v("この講義では"),s("a",{attrs:{href:"https://azure.microsoft.com/ja-jp/products/visual-studio-code/",target:"_blank",rel:"noopener noreferrer"}},[t._v("VSCode"),s("OutboundLink")],1),t._v("を推奨します。\n"),s("a",{attrs:{href:"https://atom.io/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Atom"),s("OutboundLink")],1),t._v("や"),s("a",{attrs:{href:"https://www.sublimetext.com/3",target:"_blank",rel:"noopener noreferrer"}},[t._v("Sublime Text"),s("OutboundLink")],1),t._v("、"),s("a",{attrs:{href:"https://notepad-plus-plus.org/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Nodepad++"),s("OutboundLink")],1),t._v("を使ってもかまいません。Vimに慣れている人はVimを使ってもよいです。\nメモ帳、サクラエディタ、TeraPadは非推奨です。")])])])]),t._v(" "),s("h3",{attrs:{id:"_0-4-この資料のお約束"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_0-4-この資料のお約束"}},[t._v("#")]),t._v(" 0.4. この資料のお約束")]),t._v(" "),s("p",[t._v("💻 は自分で操作する箇所を示しています。")]),t._v(" "),s("p",[t._v("<ほげほげ> で囲まれている部分は自分の設定値で置き換えてください。たとえば")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("git clone <リモートリポジトリのアドレス>\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[t._v("と記載されている箇所は")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("git clone git@github.com:iij/bootcamp.git\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[t._v("というように置き換えてください。")]),t._v(" "),s("h2",{attrs:{id:"_1-継続的インテグレーション、継続的デリバリとは"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-継続的インテグレーション、継続的デリバリとは"}},[t._v("#")]),t._v(" 1. 継続的インテグレーション、継続的デリバリとは")]),t._v(" "),s("p",[t._v("継続的インテグレーション(Continuous Integration、以下CI)とは、\nアプリケーションのリリースサイクルにおいてビルドやテストなどを自動化し、\n継続的に実行することで品質改善や納期短縮を実現するための方法です。")]),t._v(" "),s("p",[t._v("もしかしたら自分のプロジェクトがそうかもれませんが、プログラミングは意外と手作業の多い分野でした。\nしかしながら手作業でビルド、テストをしていると不具合が含まれていても発覚するのが遅くなり、手戻りが大きくなってしまいます。\nそこでビルドやテストを自動化し、コードがpushされたらすぐに実行することで早期に不具合を見つけようというのがCIです。\nまた世の中にはビルドが難しいプロダクトというのも多数存在しますので、自動化されているということは開発メンバーを追加するのも楽になります。")]),t._v(" "),s("p",[t._v("継続的デリバリ(Continuous Delivery、以下CD)とはCIをさらに進めてユーザーに製品を届けるまでのリリースプロセス全体を自動化し、\n"),s("strong",[t._v("継続的に顧客に価値を届ける")]),t._v("ことを目的とした手法です。")]),t._v(" "),s("p",[t._v("CI/CDを導入した場合、コードをコミットするとビルドが走り、ユニットテストを通して、コードがテスト環境にデプロイされます。その後結合テスト、\nシステムテストを行い、必要であれば承認後、本番環境にデプロイされます。")]),t._v(" "),s("h2",{attrs:{id:"_2-droneとは"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-droneとは"}},[t._v("#")]),t._v(" 2. droneとは")]),t._v(" "),s("p",[s("a",{attrs:{href:"https://drone.io/",target:"_blank",rel:"noopener noreferrer"}},[t._v("drone"),s("OutboundLink")],1),t._v(" とはdockerをベースとしたCI/CDのためのプラットフォームです。\nIIJ社内ではdrone v1.0を提供しています。")]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),s("p",[t._v("社内のプライベートな環境で使えるdroneが用意されていることがあります。\n講師の指示がある場合はそちらの環境を利用しましょう。")])]),t._v(" "),s("ul",[s("li",[t._v("サイト: "),s("a",{attrs:{href:"https://cloud.drone.io/",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://cloud.drone.io/"),s("OutboundLink")],1)]),t._v(" "),s("li",[t._v("ドキュメント: "),s("a",{attrs:{href:"https://docs.drone.io/",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://docs.drone.io/"),s("OutboundLink")],1)])]),t._v(" "),s("p",[t._v("GitHubと連携して簡単に設定を行うことができ、設定もyamlに記載するシンプルなもので、dockerベースのため環境構築も簡単に行うことができます。")]),t._v(" "),s("h3",{attrs:{id:"_2-1-とりあえず初めてみる"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-とりあえず初めてみる"}},[t._v("#")]),t._v(" 2.1. とりあえず初めてみる")]),t._v(" "),s("h4",{attrs:{id:"_2-1-1-droneの設定を有効化する"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-1-droneの設定を有効化する"}},[t._v("#")]),t._v(" 2.1.1. droneの設定を有効化する")]),t._v(" "),s("p",[t._v("このハンズオンのためにCI/CDを行うためのサンプルリポジトリを "),s("a",{attrs:{href:"https://github.com/iij/drone-exercise",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/iij/drone-exercise"),s("OutboundLink")],1),t._v(" に用意しています。")]),t._v(" "),s("p",[t._v("💻 GitHub上で操作し、作業用リポジトリを作成してください。")]),t._v(" "),s("p",[s("img",{attrs:{src:e(255),alt:"droneで最初のテスト"}})]),t._v(" "),s("p",[t._v("上記リポジトリを開いて「Use this template」を押してください。"),s("br"),t._v("\nリポジトリ名は「"),s("code",[t._v("drone-exercise-<user名>")]),t._v("」にしましょう。"),s("br"),t._v("\nほかの設定値はデフォルトで良いです。")]),t._v(" "),s("p",[t._v("ここで作成したリポジトリに対して操作をしていきます。")]),t._v(" "),s("div",{staticClass:"custom-block warning"},[s("p",{staticClass:"custom-block-title"},[t._v("WARNING")]),t._v(" "),s("p",[t._v("Use this template が表示されていない場合は正しくログインできているか確認してください。"),s("br"),t._v("\n講師から repository を作成する organization が指示されていれば、それに従ってください。")])]),t._v(" "),s("p",[t._v("droneはGitHub上のコミットやpushといったイベントが発生するとそれに応じて自動的に処理が走るようになっています。\nこれはWebhookというしくみを用いて実現されていますが、droneを使う前にこの設定が必要です。")]),t._v(" "),s("p",[t._v("💻 droneにリポジトリを登録する。")]),t._v(" "),s("div",{staticClass:"custom-block warning"},[s("p",{staticClass:"custom-block-title"},[t._v("WARNING")]),t._v(" "),s("p",[s("a",{attrs:{href:"https://cloud.drone.io/",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://cloud.drone.io/"),s("OutboundLink")],1),t._v(" では 新規のユーザー登録を行っていません。"),s("br"),t._v("\nそのため、以下の手順を実施するためには "),s("a",{attrs:{href:"http://drone.io",target:"_blank",rel:"noopener noreferrer"}},[t._v("drone.io"),s("OutboundLink")],1),t._v(" の 構築が必要です。"),s("br"),t._v("\n講師は接続先を案内してください。")])]),t._v(" "),s("p",[s("a",{attrs:{href:"http://xn--drone-f83dqcwesos420avc3aymzhv8g.io",target:"_blank",rel:"noopener noreferrer"}},[t._v("講師に案内されたdrone.io"),s("OutboundLink")],1),t._v(" にログインしてください。")]),t._v(" "),s("p",[t._v("初回のログインでは OAuth の連携の許可が必要になるかもしれません。")]),t._v(" "),s("p",[t._v("Repositories の リストから「自分のアカウント名/"),s("code",[t._v("drone-exercise-<user名>")]),t._v("」を探してリポジトリ名をクリックし詳細ページを開きましょう。")]),t._v(" "),s("p",[t._v("見つからない場合は「SYNC」ボタンを押してから探してください。")]),t._v(" "),s("p",[t._v("「SETTINGS」タブから「ACTIVATE REPOSITORY」をクリックすると自動で設定が行われ、設定画面が表示されます。")]),t._v(" "),s("p",[t._v("これでdroneを利用する準備が整いました。")]),t._v(" "),s("h4",{attrs:{id:"_2-1-2-droneでテストを実行する"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-2-droneでテストを実行する"}},[t._v("#")]),t._v(" 2.1.2. droneでテストを実行する")]),t._v(" "),s("p",[t._v("💻 作成した作業用リポジトリ(自分のアカウント名/"),s("code",[t._v("drone-exercise-<user名>")]),t._v(")をローカルにgit cloneしてください。")]),t._v(" "),s("p",[t._v("このリポジトリにはすでにdroneの設定ファイルが置かれています。\n適当に"),s("code",[t._v("README.md")]),t._v("を編集してコミット、pushしてみましょう。")]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),s("p",[t._v("おさらいです。 編集したあとは git add でステージング したのち commit && push となります。")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v('date >> README.md\ngit add README.md\ngit commit -m "update README.md"\ngit push origin master\n')])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br")])])]),t._v(" "),s("p",[t._v("GitHub に push してしばらくすると drone で テストが実行されます。")]),t._v(" "),s("p",[t._v("先程開いた droneの「自分のアカウント名/"),s("code",[t._v("drone-exercise-<user名>")]),t._v("」の 詳細ページから「ACTIVITY FEED」タブを開くとテストの実行ログが表示されます。")]),t._v(" "),s("p",[t._v("クリックして 実行ログを読むとどのようにテストが実行されているかが分かります。")]),t._v(" "),s("p",[t._v("このリポジトリにはRubyで書かれたプログラムと、Ruby用のテストフレームワークである"),s("a",{attrs:{href:"https://rspec.info/",target:"_blank",rel:"noopener noreferrer"}},[t._v("RSpec"),s("OutboundLink")],1),t._v("で\n書かれたテストが置かれています。")]),t._v(" "),s("p",[s("img",{attrs:{src:e(276),alt:"droneで最初のテスト"}})]),t._v(" "),s("p",[t._v("図を見ると、 clone と test の step からなるとわかります。")]),t._v(" "),s("p",[t._v("それぞれクリックすると各 step の詳細が表示されます。")]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("チェックポイント2 🏁")]),t._v(" "),s("p",[t._v("「test」ではどういうメッセージが出力されたでしょうか？")])]),t._v(" "),s("h4",{attrs:{id:"_2-1-3-webhookの設定確認"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-3-webhookの設定確認"}},[t._v("#")]),t._v(" 2.1.3 Webhookの設定確認")]),t._v(" "),s("p",[t._v("drone と GitHub の連携には Webhook を利用しています。")]),t._v(" "),s("p",[t._v("デフォルトでは"),s("code",[t._v("pr")]),t._v("と"),s("code",[t._v("push")]),t._v("の2つが登録されています。")]),t._v(" "),s("p",[s("code",[t._v("pr")]),t._v("を指定すると、Pull Requestをオープンしたとき、または既存のPRへpushしたときにテストが実行されます。\n"),s("code",[t._v("push")]),t._v(" を指定すると、"),s("code",[t._v("git push")]),t._v(" したときにテストが実行されます。")]),t._v(" "),s("p",[t._v("この設定は 「Settings」->「Hooks」->「Webhooks」-> droneのエントリ -> Edit で確認でき、")]),t._v(" "),s("p",[t._v("設定画面最下部の「Recent Deliveries」では実際に発行されたWebhookを確認 & 再送信できます。")]),t._v(" "),s("h2",{attrs:{id:"_3-droneの基本的な設定"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-droneの基本的な設定"}},[t._v("#")]),t._v(" 3. droneの基本的な設定")]),t._v(" "),s("p",[t._v("drone設定の基本は、どういった環境で、どのようなコマンドを実行するかということを記述することです。")]),t._v(" "),s("p",[t._v("設定はKubernetesライクな書き方になっていますので、Kubernetesの知識があれば読みやすいです。")]),t._v(" "),s("p",[t._v("droneはバージョンによって設定ファイルの書き方が異なりますので、\n既存のプロジェクトを編集するときは気を付けてください。")]),t._v(" "),s("p",[t._v("droneの設定はデフォルトでリポジトリの一番上の階層に"),s("code",[t._v(".drone.yml")]),t._v("という名前で置きます。")]),t._v(" "),s("p",[t._v("2.1.2 でcloneしたリポジトリの"),s("code",[t._v(".drone.yml")]),t._v("を見てみましょう。")]),t._v(" "),s("div",{staticClass:"language-yaml line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" pipeline\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" default\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("steps")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" test\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ruby"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("2.6.2\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("commands")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" bundle install\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" rspec\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br")])]),s("p",[t._v("各項目について解説していきます。")]),t._v(" "),s("h3",{attrs:{id:"_3-1-pipeline"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-pipeline"}},[t._v("#")]),t._v(" 3.1. Pipeline")]),t._v(" "),s("div",{staticClass:"language-yaml line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" pipeline\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" default\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br")])]),s("p",[t._v("一連のテスト実行の流れを"),s("code",[t._v("Pipeline")]),t._v("と呼びます。")]),t._v(" "),s("p",[t._v("まずyamlの先頭で"),s("code",[t._v("kind: pipeline")]),t._v("と記載し、この下に書かれる設定値がPipelineのものであることを宣言します。\nただIIJの環境では"),s("code",[t._v("Pipeline")]),t._v("以外の設定は利用できませんのでこの"),s("code",[t._v("kind")]),t._v("と"),s("code",[t._v("name")]),t._v("は固定になります。")]),t._v(" "),s("p",[s("code",[t._v("Pipeline")]),t._v("は複数の"),s("code",[t._v("Step")]),t._v("で構成されます。")]),t._v(" "),s("h3",{attrs:{id:"_3-2-steps"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-steps"}},[t._v("#")]),t._v(" 3.2. Steps")]),t._v(" "),s("p",[t._v("ひとつのPipelineで複数のテスト("),s("code",[t._v("Step")]),t._v(")を実行できます。")]),t._v(" "),s("p",[t._v("各"),s("code",[t._v("Step")]),t._v("は別々のdockerコンテナで実行され、各テストは独立した環境でテストできます。")]),t._v(" "),s("p",[t._v("UI上では各"),s("code",[t._v("Step")]),t._v("ごとに結果が分けて表示され、"),s("code",[t._v("name")]),t._v("で名前を付けることができ、これはUI上に表示されます。")]),t._v(" "),s("p",[s("img",{attrs:{src:e(277),alt:"Stepの表示"}})]),t._v(" "),s("p",[s("code",[t._v("image")]),t._v(" はテストに利用するdockerイメージを指定します。")]),t._v(" "),s("p",[s("code",[t._v("image: ruby")]),t._v(" と指定した場合はDocker Hubの"),s("a",{attrs:{href:"https://hub.docker.com/_/ruby",target:"_blank",rel:"noopener noreferrer"}},[t._v("Ruby Official Image"),s("OutboundLink")],1),t._v("が利用されます。\n素性のわからないイメージを利用することはやめましょう。")]),t._v(" "),s("p",[t._v("また、"),s("code",[t._v("image: ruby:3.1.2")]),t._v(" のようにタグを指定して、特定のバージョンを利用できるイメージもありますが意図せず更新される場合があります。")]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),s("p",[t._v("プライベートなDockerイメージ置き場を自分で作成することもできます。")])]),t._v(" "),s("p",[s("code",[t._v("commands")]),t._v(" にはコンテナ内で実行するコマンドを記述します。")]),t._v(" "),s("p",[s("code",[t._v("bundle install")]),t._v(" ではテスト実行に必要なライブラリをインストールしていて、"),s("code",[t._v("rspec")]),t._v("でテストを実行しています。")]),t._v(" "),s("p",[t._v("各テストが成功したかどうかは各コマンドのExit Codeを見ていて、Code 0以外ではテストは中断され失敗となります。\nテストが失敗すると以下のような表示になります。")]),t._v(" "),s("p",[s("img",{attrs:{src:e(278),alt:"テスト失敗時の表示"}})]),t._v(" "),s("h2",{attrs:{id:"_4-pull-requestと組み合わせる"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-pull-requestと組み合わせる"}},[t._v("#")]),t._v(" 4. Pull Requestと組み合わせる")]),t._v(" "),s("p",[t._v("droneを設定した状態でPull Requestを作成するとどうなるでしょうか。")]),t._v(" "),s("p",[t._v("💻 意図的にテストが失敗するようにコードを修正し、Pull Requestを作成してみましょう。")]),t._v(" "),s("ol",[s("li",[t._v("まず、別の branch へ checkout します")])]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("git checkout -b feature/text-error\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("ol",{attrs:{start:"2"}},[s("li",[t._v("実装である"),s("code",[t._v("hello_world.rb")]),t._v("を以下のように書き換えてみます。")])]),t._v(" "),s("div",{staticClass:"language-diff line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-diff"}},[s("code",[s("span",{pre:!0,attrs:{class:"token unchanged"}},[s("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[t._v(" ")]),s("span",{pre:!0,attrs:{class:"token line"}},[t._v(" def world\n")])]),s("span",{pre:!0,attrs:{class:"token deleted-sign deleted"}},[s("span",{pre:!0,attrs:{class:"token prefix deleted"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token line"}},[t._v("    'Hello World'\n")])]),s("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[s("span",{pre:!0,attrs:{class:"token prefix inserted"}},[t._v("+")]),s("span",{pre:!0,attrs:{class:"token line"}},[t._v("    'Goodby World'\n")])]),s("span",{pre:!0,attrs:{class:"token unchanged"}},[s("span",{pre:!0,attrs:{class:"token prefix unchanged"}},[t._v(" ")]),s("span",{pre:!0,attrs:{class:"token line"}},[t._v(" end\n")])])])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br")])]),s("ol",{attrs:{start:"3"}},[s("li",[t._v("編集した内容を commit し push します。")])]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v('git add hello_world.rb\ngit commit -m "goodby"\ngit push origin feature/text-error\n')])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br")])]),s("p",[t._v("💻 GitHub を開いてPull Requestを作成しましょう。")]),t._v(" "),s("p",[t._v("別のbranch に push した内容を develop branch などへ取り込んでもらうためのリクエストを Pull Request(PR) と呼びます。")]),t._v(" "),s("p",[s("img",{attrs:{src:e(279),alt:"Pull Requestを作成しましょう"}})]),t._v(" "),s("p",[t._v("もし、作業リポジトリを fork して作成した場合 PR の送り先が fork 元 repository になっています。")]),t._v(" "),s("p",[t._v("その時は 自分のrepository に PR を送るように base repository (左側) の 表記を見直してください。")]),t._v(" "),s("p",[t._v("無事PRを作成できた場合 PRのページへ遷移します。")]),t._v(" "),s("p",[t._v("ページ下部にdroneのテスト結果が表示されています。")]),t._v(" "),s("p",[t._v("一目でテストが失敗していることがわかるでしょう。")]),t._v(" "),s("p",[s("img",{attrs:{src:e(280),alt:"Pull Requestに表示されたdroneの結果"}})]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("チェックポイント3 🏁")]),t._v(" "),s("p",[t._v("Pull Request は作成できましたか？"),s("br"),t._v(" "),s("a",{attrs:{href:"http://drone.io",target:"_blank",rel:"noopener noreferrer"}},[t._v("drone.io"),s("OutboundLink")],1),t._v(" は動作しましたか?"),s("br"),t._v("\nテストが失敗しましたか？")])]),t._v(" "),s("h3",{attrs:{id:"_4-1-テストが失敗したらマージできないようにしたい"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-テストが失敗したらマージできないようにしたい"}},[t._v("#")]),t._v(" 4.1. テストが失敗したらマージできないようにしたい")]),t._v(" "),s("p",[t._v("さて、 先程のPRではテストに失敗してしまいました。")]),t._v(" "),s("p",[t._v("この状態でもMergeボタンを押すことは可能ですが、普通は押されたくないはずです。\nこの挙動はGitHubの設定画面から変更できます。")]),t._v(" "),s("p",[t._v("💻 テストが通ったときだけマージできるように設定する")]),t._v(" "),s("ol",[s("li",[t._v("「Settings」->「Branches」->「Branch protection rules」->「Add rule」を押し、")]),t._v(" "),s("li",[t._v("「Branch name pattern」に「master」と記入し、")]),t._v(" "),s("li",[t._v("「Include administrators」にチェックを入れます。")]),t._v(" "),s("li",[t._v("「Require status checks to pass before merging」にチェックを入れて")]),t._v(" "),s("li",[t._v("「Status checks found in the last week for this repository」に出ている\n「continuous-integration/drone/pr」と\n「continuous-integration/drone/push」にチェックを入れます。")]),t._v(" "),s("li",[t._v("「Create」します。")])]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),s("p",[t._v("もし、continuous-integration/drone/pr が見つからない場合"),s("br"),t._v("\n先ほど作成したPRによる drone のテストがうまく動いていないかもしれません。"),s("br"),t._v("\nfork した場合は PR の作成先を確認する必要があります。"),s("br"),t._v("\nPR の作成先が間違っているかもしれません。見直してください。")])]),t._v(" "),s("p",[s("img",{attrs:{src:e(281),alt:"Branch protection rules"}})]),t._v(" "),s("p",[t._v("先程作成したPull Requestのページに戻るとマージボタンが押せなくなっています。")]),t._v(" "),s("p",[s("img",{attrs:{src:e(282),alt:"マージできない状態"}})]),t._v(" "),s("p",[t._v("これは複数人で開発するときには便利な機能です。")]),t._v(" "),s("p",[t._v("このあとmasterブランチを利用しますのでBranch protection rulesは削除しておきましょう。")]),t._v(" "),s("p",[t._v("💻 Branch protection rules の一覧ページで"),s("code",[t._v("master")]),t._v("と名前がついたルールの"),s("code",[t._v("delete")]),t._v("ボタンを押す")]),t._v(" "),s("p",[t._v("💻 この後項目のためにmasterブランチに戻っておきましょう。")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("$ git checkout master\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("チェックポイント4 🏁")]),t._v(" "),s("p",[t._v("マージボタンが押せなくなったのはなぜですか？")])]),t._v(" "),s("h2",{attrs:{id:"_5-さまざまなプラグイン"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-さまざまなプラグイン"}},[t._v("#")]),t._v(" 5. さまざまなプラグイン")]),t._v(" "),s("p",[s("a",{attrs:{href:"http://plugins.drone.io/",target:"_blank",rel:"noopener noreferrer"}},[t._v("droneには様々なプラグインが用意されています。"),s("OutboundLink")],1)]),t._v(" "),s("p",[t._v("主に外部と連携する機能が用意されています。\n後述する利用のしかたからも分かるとおり plugin は 単なる docker コンテナであるため、自分で開発することもできます。")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("Plugins are just Docker containers which means you can write plugins in any programming language that runs inside a container. You can even create plugins using simple bash scripting.\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("blockquote",[s("p",[s("a",{attrs:{href:"https://docs.drone.io/plugins/overview/",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://docs.drone.io/plugins/overview/"),s("OutboundLink")],1),t._v(" より引用")])]),t._v(" "),s("h3",{attrs:{id:"_5-1-キャッシュプラグイン"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-キャッシュプラグイン"}},[t._v("#")]),t._v(" 5.1. キャッシュプラグイン")]),t._v(" "),s("div",{staticClass:"custom-block warning"},[s("p",{staticClass:"custom-block-title"},[t._v("WARNING")]),t._v(" "),s("p",[t._v("この項目はS3互換のオブジェクトストレージが必要です。\n講師は接続先を案内してください。")])]),t._v(" "),s("p",[t._v("これまでの例ではテストを実行するときに必要なライブラリを"),s("code",[t._v("bundle install")]),t._v("で事前にダウンロードしてから実行していました。\nしかし毎回ダウンロードしていたのではテスト実行に時間がかかりますし、ネットワークの無駄です。")]),t._v(" "),s("p",[s("a",{attrs:{href:"http://plugins.drone.io/drone-plugins/drone-s3-cache/",target:"_blank",rel:"noopener noreferrer"}},[t._v("s3-cache"),s("OutboundLink")],1),t._v("プラグインを使うと特定のディレクトリを\n"),s("a",{attrs:{href:"https://aws.amazon.com/jp/s3/",target:"_blank",rel:"noopener noreferrer"}},[t._v("S3"),s("OutboundLink")],1),t._v("に保存し、テストのたびに復元してくれる機能を提供します。")]),t._v(" "),s("h4",{attrs:{id:"_5-1-1-ライブラリの保存場所を変更する"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-1-ライブラリの保存場所を変更する"}},[t._v("#")]),t._v(" 5.1.1. ライブラリの保存場所を変更する")]),t._v(" "),s("p",[t._v("パッケージマネージャーによってはリポジトリの中ではなく、システムの特別な場所に配置するものがあります。\ns3-cacheプラグインはリポジトリ内にあるファイルしかキャッシュできません。")]),t._v(" "),s("p",[t._v("nodejsのパッケージマネージャーであるnpmはデフォルトでリポジトリ直下にライブラリを配置しますが、\nRubyのパッケージマネージャーであるbundlerはシステム領域にライブラリを保存するため、\nそのままではキャッシュさせることができません。\nほとんどの場合、パッケージマネージャーのオプションで保存場所を変更できますので、\nRubyを例に設定してみましょう。")]),t._v(" "),s("p",[t._v("Rubyのパッケージマネージャーであるbundlerは"),s("code",[t._v("--path")]),t._v("オプションで保存場所を指定できます。")]),t._v(" "),s("p",[s("code",[t._v("drone.yaml")]),t._v(" で 実行している "),s("code",[t._v("bundle install")]),t._v(" にオプションを渡し 一般的によく使われる"),s("code",[t._v("vendor/bundle")]),t._v("に保存するように変更してください。")]),t._v(" "),s("p",[t._v("💻 パッケージの保存先を変更する")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("  - name: test\n    image: ruby:2.6.2\n    commands:\n      - bundle install --path vendor/bundle\n      - bundle exec rspec\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br")])]),s("h4",{attrs:{id:"_5-1-2-ライブラリをキャッシュさせてみる"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-2-ライブラリをキャッシュさせてみる"}},[t._v("#")]),t._v(" 5.1.2. ライブラリをキャッシュさせてみる")]),t._v(" "),s("p",[t._v("さっそくキャッシュさせてみましょう。")]),t._v(" "),s("p",[t._v("このプラグインはキャッシュしたデータを戻す"),s("code",[t._v("restore")]),t._v("と、キャッシュを行う"),s("code",[t._v("rebuild")]),t._v("の機能があります。")]),t._v(" "),s("p",[s("code",[t._v(".drone.yml")]),t._v("を編集してキャッシュを組み込んでみましょう。\n"),s("code",[t._v("rebuild")]),t._v("ステップで"),s("code",[t._v("vendor/bundle")]),t._v("ディレクトリをキャッシュし、\n"),s("code",[t._v("restore")]),t._v("ステップでキャッシュされたものを戻します。")]),t._v(" "),s("p",[s("code",[t._v("test")]),t._v("Stepの前後に、"),s("code",[t._v("restore")]),t._v("と"),s("code",[t._v("rebuild")]),t._v("を追加します。")]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),s("p",[t._v("以下の設定は各環境で用意された接続先へ値を変更してください。")]),t._v(" "),s("p",[t._v("<変数名>で書かれた場所を適切な値で置き換えてください。")])]),t._v(" "),s("p",[t._v("💻 パッケージをキャッシュするように変更する")]),t._v(" "),s("div",{staticClass:"language-yaml line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("steps")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" restore\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" plugins/s3"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("cache\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("settings")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("pull")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("endpoint")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" <ENDPOINT"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("access_key")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" <ACCESS_KEY"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("secret_key")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" <SECRET_KEY"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("restore")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" test\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ruby"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("2.6.2\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("commands")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" bundle install "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("path vendor/bundle\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" bundle exec rspec\n\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" rebuild\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" plugins/s3"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("cache\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("settings")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("pull")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("endpoint")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" <ENDPOINT"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("access_key")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" <ACCESS_KEY"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("secret_key")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" <SECRET_KEY"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("rebuild")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("mount")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" vendor/bundle\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br"),s("span",{staticClass:"line-number"},[t._v("23")]),s("br"),s("span",{staticClass:"line-number"},[t._v("24")]),s("br"),s("span",{staticClass:"line-number"},[t._v("25")]),s("br"),s("span",{staticClass:"line-number"},[t._v("26")]),s("br")])]),s("p",[t._v("💻 コミットして実行してみましょう。")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v('git add .drone.yml\ngit commit -m "Cache導入"\ngit push origin master\n')])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br")])]),s("p",[t._v("droneのUI上で最新の実行ログを開いて見ましょう。\n"),s("code",[t._v("restore")]),t._v("と"),s("code",[t._v("rebuild")]),t._v("のステップが増えていることを確認してください。")]),t._v(" "),s("p",[t._v("1回目はキャッシュされてないので何も起きませんが、2回目からはキャッシュが使われるので実行が早くなります。\n1回目の実行時間を確認してから、以下のように2回目のテストを実行してみてください。")]),t._v(" "),s("p",[s("code",[t._v("--allow-empty")]),t._v(" はファイルを変更していなくてもコミットを作ることができるオプションです。")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v('git commit --allow-empty -m "Cacheの効果を確認する"\ngit push origin master\n')])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br")])]),s("div",{staticClass:"custom-block warning"},[s("p",{staticClass:"custom-block-title"},[t._v("WARNING")]),t._v(" "),s("p",[t._v("このキャッシュを利用する操作は drone で完結しない処理です。"),s("br"),t._v("\nもしオブジェクトストレージ側にトラブルがあれば 処理が長時間に及ぶ可能性があります。")]),t._v(" "),s("p",[t._v("また、drone 上の ジョブの同時実行数には限りがある場合があります。"),s("br"),t._v("\n処理が長時間に渡る場合は drone 上のジョブ実行結果の確認画面から キャンセルができます")])]),t._v(" "),s("p",[t._v("💻 テスト実行が早くなっていることを確認しましょう。")]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("チェックポイント5 🏁")]),t._v(" "),s("p",[t._v("テストが速くなったのはなぜですか？")])]),t._v(" "),s("h2",{attrs:{id:"_6-さまざまな応用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_6-さまざまな応用"}},[t._v("#")]),t._v(" 6. さまざまな応用")]),t._v(" "),s("h3",{attrs:{id:"_6-1-text-lintを使った日本語チェックの例"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_6-1-text-lintを使った日本語チェックの例"}},[t._v("#")]),t._v(" 6.1. Text Lintを使った日本語チェックの例")]),t._v(" "),s("p",[t._v("droneはプログラムにしか使えないものでしょうか。そうではありません。\ndroneは何でも動かすことができますから、テストをすることだけが仕事ではありません。")]),t._v(" "),s("p",[t._v("ここでは自然言語のチェックを行う "),s("a",{attrs:{href:"https://textlint.github.io/",target:"_blank",rel:"noopener noreferrer"}},[t._v("textlint"),s("OutboundLink")],1),t._v(" を使った例を紹介します。")]),t._v(" "),s("p",[t._v("💻 stepsに以下の項目を追加してみましょう。")]),t._v(" "),s("div",{staticClass:"language-yaml line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[t._v("  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" textlint\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" node\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("commands")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" npm install textlint\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" npm install textlint"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("rule"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("preset"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("ja"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("technical"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("writing\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" $(npm bin)/textlint "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("format pretty"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("error "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("preset ja"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("technical"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("writing README.md\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br")])]),s("p",[t._v("textlintはnodejsで動作しますので、イメージにnodeを指定します。\ntextlintはフレームワークのみでこれ単体で動かすことはできません。どういったものをチェックするかというルールは別に定義しなければいけません。\nここでは日本語の技術文書を書くうえで必要ないくつかのルールをまとめた\n"),s("a",{attrs:{href:"https://github.com/textlint-ja/textlint-rule-preset-ja-technical-writing",target:"_blank",rel:"noopener noreferrer"}},[t._v("textlint-rule-preset-ja-technical-writing"),s("OutboundLink")],1),t._v("\nを利用します。試しに "),s("code",[t._v("README.md")]),t._v("をチェックしてみましょう。")]),t._v(" "),s("p",[t._v("💻 README.mdをTextlintでチェックする。")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v('git add .drone.yml\ngit commit -m "textlintによるチェック"\ngit push origin master\n')])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br")])]),s("p",[s("img",{attrs:{src:e(283),alt:"textlintのエラー"}})]),t._v(" "),s("p",[t._v("このようにチェックする対象はプログラムに限りませんので、マニュアルなどのドキュメントのチェックなどにも活用できます。")]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("チェックポイント6 🏁")]),t._v(" "),s("p",[t._v("droneが利用できる事例としてふさわしいものはどれですか？")])]),t._v(" "),s("h3",{attrs:{id:"_6-2-services"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-services"}},[t._v("#")]),t._v(" 6.2 Services")]),t._v(" "),s("p",[t._v("単純なスクリプトやライブラリのテストはこれだけでも十分にdroneでテストできます。")]),t._v(" "),s("p",[t._v("ではデータベース使ったテストはできるでしょうか。")]),t._v(" "),s("p",[t._v("データベースのテストをするならデータベースのプロセスが上がっている必要があります。"),s("br"),t._v("\nでも1つのコンテナでアプリケーションと一緒にデータベースも一緒に立ち上げたくないですよね。")]),t._v(" "),s("p",[t._v("そのために"),s("code",[t._v("Service")]),t._v("というしくみがあります。"),s("br"),t._v("\n同時に複数のコンテナを立ち上げて待機させておき、テスト中利用できます。")]),t._v(" "),s("p",[t._v("サンプルとしてRuby on Rails＋MySQLで構成されたアプリケーションを用意しました。")]),t._v(" "),s("p",[t._v("💻 "),s("a",{attrs:{href:"https://github.com/iij/drone-exercise-rails",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/iij/drone-exercise-rails"),s("OutboundLink")],1),t._v(" から 作業用リポジトリを作成し、git cloneしてください。")]),t._v(" "),s("p",[s("img",{attrs:{src:e(255),alt:"rails テスト"}})]),t._v(" "),s("p",[t._v("上記リポジトリを開いて「Use this template」を押してください。")]),t._v(" "),s("p",[t._v("リポジトリ名は「"),s("code",[t._v("drone-exercise-rails-<user名>")]),t._v("」にしましょう。"),s("br"),t._v("\nほかの設定値はデフォルトで良いです。")]),t._v(" "),s("p",[t._v("ここで作成したリポジトリに対して操作をしていきます。")]),t._v(" "),s("p",[t._v("Ruby on RailsはWebアプリケーションを作るためのRuby製フレームワークです。\nデータの保存にMySQLなどのデータベースを利用できます。")]),t._v(" "),s("p",[t._v("標準的なWebアプリケーションではデータベースなどの外部サービスにデータを保存し、それを読み取って加工して表示するという動作が多く、\nテストするときもデータベースが動いている必要があります。")]),t._v(" "),s("p",[t._v("上記リポジトリにはテストを行うだけの "),s("code",[t._v(".drone.yml")]),t._v(" が含まれています。")]),t._v(" "),s("div",{staticClass:"language-yaml line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" pipeline\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" default\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("steps")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" test\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ruby"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("2.6.2\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("environment")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("RAILS_ENV")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" test\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("commands")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" bundle "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 実行に必要なライブラリをインストールする")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" bundle exec rails db"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("reset "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# テスト用のデータベース、テーブルを作成する")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" bundle exec rails test "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# テストを実行する")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br")])]),s("p",[t._v("💻 まずはこの状態でテストを実行し、結果を見てみましょう。")]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),s("p",[t._v("新しいrepository への drone の 有効のしかた"),s("br"),t._v("\n内容の変更を伴わないcommit をする方法を思い出してください。")])]),t._v(" "),s("p",[t._v("ちなみにテストは "),s("code",[t._v("test/models/user_test.rb")]),t._v(" に書いてあります。")]),t._v(" "),s("p",[t._v("この状態ではデータベースが動いていないのでテストが成功しません。")]),t._v(" "),s("p",[t._v("テストしている間横で何か動かしておきたいという場合には "),s("code",[t._v("Service")]),t._v(" を使います。\n今回はMySQLを使いますが、"),s("a",{attrs:{href:"https://hub.docker.com/_/mysql",target:"_blank",rel:"noopener noreferrer"}},[t._v("MySQLは公式でdockerイメージが提供されています"),s("OutboundLink")],1),t._v("のでこれを利用します。")]),t._v(" "),s("p",[t._v("💻 以下の項目を"),s("code",[t._v(".drone.yml")]),t._v("に追加してください。")]),t._v(" "),s("p",[t._v("kind, name, steps と同じ高さでよいです(services の左側にスペースはいりません)")]),t._v(" "),s("div",{staticClass:"language-yaml line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("services")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" db\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" mysql"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("8.0.16\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("command")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"--default-authentication-plugin=mysql_native_password"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# MySQL8.0のデフォルト認証方式にRailsが対応していないため変更")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("environment")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("MYSQL_ALLOW_EMPTY_PASSWORD")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'yes'")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# テスト用にパスワードなしで接続できるようにする")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br")])]),s("p",[s("code",[t._v("name")]),t._v(" で名前をつけて "),s("code",[t._v("image")]),t._v(" で使用するdockerイメージを指定します。")]),t._v(" "),s("p",[t._v("Railsではデータベースの設定を"),s("code",[t._v("config/database.yml")]),t._v("から読み込みます。"),s("br"),t._v("\ndroneで設定したデータベースへ接続するための設定値を見てみましょう。")]),t._v(" "),s("div",{staticClass:"language-yaml line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("test")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("<<")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token important"}},[t._v("*default")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("host")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" db\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("port")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3306")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("socket")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token null important"}},[t._v("null")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("database")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" drone"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("exercise"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("rails_test\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br")])]),s("p",[t._v("このファイルで接続先MySQLサーバのホストを指定しているのですが、"),s("br"),t._v("\nここでは"),s("code",[t._v(".drone.yml")]),t._v("で指定した"),s("code",[t._v("db")]),t._v("がホスト名になっていて、この名前で接続できます。")]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("チェックポイント7 🏁")]),t._v(" "),s("p",[t._v("テスト実行中にデータベースはどこで実行されているでしょうか？")])]),t._v(" "),s("h2",{attrs:{id:"_8-参考情報"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_8-参考情報"}},[t._v("#")]),t._v(" 8. 参考情報")]),t._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"https://docs.drone.io/",target:"_blank",rel:"noopener noreferrer"}},[t._v("drone Documentation"),s("OutboundLink")],1)])]),t._v(" "),s("h2",{attrs:{id:"続き"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#続き"}},[t._v("#")]),t._v(" 続き")]),t._v(" "),s("ul",[s("li",[s("RouterLink",{attrs:{to:"/cicd_infra/github_actions/"}},[t._v("GitHub Actions でCIテスト・デプロイを回す")])],1)])])}),[],!1,null,null,null);s.default=n.exports}}]);