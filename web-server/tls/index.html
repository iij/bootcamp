<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>SSL/TLS を触ってみよう | IIJ Bootcamp</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="IIJ で実施している新人向けのハンズオン資料集です。">
    
    <link rel="preload" href="/bootcamp/assets/css/0.styles.095a7d7e.css" as="style"><link rel="preload" href="/bootcamp/assets/js/app.182a799b.js" as="script"><link rel="preload" href="/bootcamp/assets/js/2.cc24643c.js" as="script"><link rel="preload" href="/bootcamp/assets/js/35.ea310dd2.js" as="script"><link rel="prefetch" href="/bootcamp/assets/js/10.24909ac4.js"><link rel="prefetch" href="/bootcamp/assets/js/11.45815948.js"><link rel="prefetch" href="/bootcamp/assets/js/12.6000edc4.js"><link rel="prefetch" href="/bootcamp/assets/js/13.8e089884.js"><link rel="prefetch" href="/bootcamp/assets/js/14.5c7db3ea.js"><link rel="prefetch" href="/bootcamp/assets/js/15.21379b8a.js"><link rel="prefetch" href="/bootcamp/assets/js/16.f16535c4.js"><link rel="prefetch" href="/bootcamp/assets/js/17.c25b7430.js"><link rel="prefetch" href="/bootcamp/assets/js/18.600b01a3.js"><link rel="prefetch" href="/bootcamp/assets/js/19.d59d18f2.js"><link rel="prefetch" href="/bootcamp/assets/js/20.4958becc.js"><link rel="prefetch" href="/bootcamp/assets/js/21.df6e33f3.js"><link rel="prefetch" href="/bootcamp/assets/js/22.1705671f.js"><link rel="prefetch" href="/bootcamp/assets/js/23.f2eba3ad.js"><link rel="prefetch" href="/bootcamp/assets/js/24.3c95f29a.js"><link rel="prefetch" href="/bootcamp/assets/js/25.ee802348.js"><link rel="prefetch" href="/bootcamp/assets/js/26.bc3d4b25.js"><link rel="prefetch" href="/bootcamp/assets/js/27.42c48edb.js"><link rel="prefetch" href="/bootcamp/assets/js/28.ed6e4418.js"><link rel="prefetch" href="/bootcamp/assets/js/29.209ec00f.js"><link rel="prefetch" href="/bootcamp/assets/js/3.bc38c705.js"><link rel="prefetch" href="/bootcamp/assets/js/30.0326dc96.js"><link rel="prefetch" href="/bootcamp/assets/js/31.77b44c4f.js"><link rel="prefetch" href="/bootcamp/assets/js/32.8bc98dc3.js"><link rel="prefetch" href="/bootcamp/assets/js/33.f6b42d3e.js"><link rel="prefetch" href="/bootcamp/assets/js/34.9073302f.js"><link rel="prefetch" href="/bootcamp/assets/js/36.c6085808.js"><link rel="prefetch" href="/bootcamp/assets/js/37.105294d7.js"><link rel="prefetch" href="/bootcamp/assets/js/38.b8b5d348.js"><link rel="prefetch" href="/bootcamp/assets/js/39.ed7e8f15.js"><link rel="prefetch" href="/bootcamp/assets/js/4.d1b170a8.js"><link rel="prefetch" href="/bootcamp/assets/js/40.39300df8.js"><link rel="prefetch" href="/bootcamp/assets/js/41.e54c7aa8.js"><link rel="prefetch" href="/bootcamp/assets/js/42.4c246281.js"><link rel="prefetch" href="/bootcamp/assets/js/43.7f2c6b18.js"><link rel="prefetch" href="/bootcamp/assets/js/44.6a73700b.js"><link rel="prefetch" href="/bootcamp/assets/js/45.89d9c61e.js"><link rel="prefetch" href="/bootcamp/assets/js/46.eeb58a07.js"><link rel="prefetch" href="/bootcamp/assets/js/47.e9b6c23e.js"><link rel="prefetch" href="/bootcamp/assets/js/48.35af9522.js"><link rel="prefetch" href="/bootcamp/assets/js/49.2ffa5aed.js"><link rel="prefetch" href="/bootcamp/assets/js/5.977f9e29.js"><link rel="prefetch" href="/bootcamp/assets/js/50.74a208c1.js"><link rel="prefetch" href="/bootcamp/assets/js/51.0657317e.js"><link rel="prefetch" href="/bootcamp/assets/js/52.009782b7.js"><link rel="prefetch" href="/bootcamp/assets/js/53.b2ca34c6.js"><link rel="prefetch" href="/bootcamp/assets/js/54.d60c895d.js"><link rel="prefetch" href="/bootcamp/assets/js/55.e66b3ed7.js"><link rel="prefetch" href="/bootcamp/assets/js/56.9690094e.js"><link rel="prefetch" href="/bootcamp/assets/js/57.f1473f10.js"><link rel="prefetch" href="/bootcamp/assets/js/58.3f97022b.js"><link rel="prefetch" href="/bootcamp/assets/js/59.87504e20.js"><link rel="prefetch" href="/bootcamp/assets/js/6.0f137a1d.js"><link rel="prefetch" href="/bootcamp/assets/js/60.6b0e67cd.js"><link rel="prefetch" href="/bootcamp/assets/js/61.effffc82.js"><link rel="prefetch" href="/bootcamp/assets/js/62.4d285748.js"><link rel="prefetch" href="/bootcamp/assets/js/63.9015f190.js"><link rel="prefetch" href="/bootcamp/assets/js/64.29a2c5c5.js"><link rel="prefetch" href="/bootcamp/assets/js/65.744dfc07.js"><link rel="prefetch" href="/bootcamp/assets/js/66.70e76370.js"><link rel="prefetch" href="/bootcamp/assets/js/7.d1b93d70.js"><link rel="prefetch" href="/bootcamp/assets/js/8.35b08962.js"><link rel="prefetch" href="/bootcamp/assets/js/9.b731b51a.js">
    <link rel="stylesheet" href="/bootcamp/assets/css/0.styles.095a7d7e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/bootcamp/" class="home-link router-link-active"><!----> <span class="site-name">IIJ Bootcamp</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/iij/bootcamp" target="_blank" rel="noopener noreferrer" class="repo-link">
      GitHub
      <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/iij/bootcamp" target="_blank" rel="noopener noreferrer" class="repo-link">
      GitHub
      <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>SSL/TLS を触ってみよう</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/bootcamp/web-server/tls/#事前準備" class="sidebar-link">事前準備</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bootcamp/web-server/tls/#nginx-の初期設定" class="sidebar-link">nginx の初期設定</a></li></ul></li><li><a href="/bootcamp/web-server/tls/#ssl-tls-とは-座学" class="sidebar-link">SSL/TLS とは(座学)</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/bootcamp/web-server/tls/#証明書-とは-座学" class="sidebar-link">証明書 とは(座学)</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/bootcamp/web-server/tls/#実際に手を動かしてみる" class="sidebar-link">実際に手を動かしてみる</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bootcamp/web-server/tls/#証明書と秘密鍵を作ってみる-check1" class="sidebar-link">証明書と秘密鍵を作ってみる (check1)</a></li><li class="sidebar-sub-header"><a href="/bootcamp/web-server/tls/#https-の設定-check2" class="sidebar-link">https の設定(check2)</a></li><li class="sidebar-sub-header"><a href="/bootcamp/web-server/tls/#証明書-の有効期限-座学" class="sidebar-link">証明書 の有効期限(座学)</a></li><li class="sidebar-sub-header"><a href="/bootcamp/web-server/tls/#詳細な暗号設定" class="sidebar-link">詳細な暗号設定</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="ssl-tls-を触ってみよう"><a href="#ssl-tls-を触ってみよう" class="header-anchor">#</a> SSL/TLS を触ってみよう</h1> <h2 id="事前準備"><a href="#事前準備" class="header-anchor">#</a> 事前準備</h2> <p>このハンズオンでは、dockerをただの隔離環境として扱っています。</p> <p>apache/nginx のハンズオンの際のものが残っているのであればそのまま流用できますので、以下の手順はスキップしてください。</p> <p>以下のように<code>docker pull</code>をしたあと、ハンズオン用のコンテナを立ち上げてログインしてください。</p> <div class="language-shell-session line-numbers-mode"><pre class="language-shell-session"><code><span class="token command"><span class="token shell-symbol important">$</span> <span class="token bash language-bash"><span class="token function">docker</span> pull python:3.8.17-bookworm</span></span>
<span class="token output">3.8.17-bookworm: Pulling from library/python
d52e4f012db1: Pull complete
7dd206bea61f: Pull complete
2320f9be4a9c: Pull complete
6e5565e0ba8d: Pull complete
d3797e13cc41: Pull complete
9d8ab9ac5a7d: Pull complete
43ed38f1d568: Pull complete
164b4060be55: Pull complete
Digest: sha256:2ee706fa11ec6907a27f1c5116e9749ad1267336b3b0d53fc35cfba936fae32e
Status: Downloaded newer image for python:3.8.17-bookworm
docker.io/library/python:3.8.17-bookworm
</span><span class="token command"><span class="token shell-symbol important">$</span> <span class="token bash language-bash"><span class="token function">docker</span> run <span class="token parameter variable">--rm</span> <span class="token parameter variable">-itd</span> <span class="token parameter variable">--name</span> test-debian <span class="token parameter variable">-p</span> <span class="token number">8080</span>:80 <span class="token parameter variable">-p</span> <span class="token number">8082</span>:82 <span class="token parameter variable">-p</span> <span class="token number">8088</span>:88 <span class="token parameter variable">-p</span> <span class="token number">8089</span>:89 <span class="token parameter variable">-p</span> <span class="token number">8443</span>:443 <span class="token parameter variable">-p</span> <span class="token number">8444</span>:444 python:3.8.17-bookworm /bin/bash</span></span>
<span class="token output">a0da070e286fd52ebb323e5faff9c960014bfcd8eb1e509cb5a12daa9fb9a85e
</span><span class="token command"><span class="token shell-symbol important">$</span> <span class="token bash language-bash"><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> test-debian /bin/bash</span></span>
<span class="token output">root@a0da070e286f:/#
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>nginxをインストールします。</p> <div class="language-shell-session line-numbers-mode"><pre class="language-shell-session"><code><span class="token command"><span class="token info punctuation"><span class="token user">root@a0da070e286f</span><span class="token punctuation">:</span><span class="token path">/</span></span><span class="token shell-symbol important">#</span> <span class="token bash language-bash"><span class="token function">apt</span> update</span></span>
<span class="token output">Get:1 http://deb.debian.org/debian bookworm InRelease [151 kB]
Get:2 http://deb.debian.org/debian bookworm-updates InRelease [52.1 kB]
Get:3 http://deb.debian.org/debian-security bookworm-security InRelease [48.0 kB]
Get:4 http://deb.debian.org/debian bookworm/main amd64 Packages [8906 kB]
Get:5 http://deb.debian.org/debian bookworm-updates/main amd64 Packages [4732 B]
Get:6 http://deb.debian.org/debian-security bookworm-security/main amd64 Packages [48.0 kB]
Fetched 9210 kB in 3s (3184 kB/s)
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
10 packages can be upgraded. Run 'apt list --upgradable' to see them.

</span><span class="token command"><span class="token info punctuation"><span class="token user">root@a0da070e286f</span><span class="token punctuation">:</span><span class="token path">/</span></span><span class="token shell-symbol important">#</span> <span class="token bash language-bash"><span class="token function">apt</span> <span class="token function">install</span> <span class="token parameter variable">-y</span> apache2 apache2-dev nginx neovim</span></span>
<span class="token output">Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
The following additional packages will be installed:
  apache2-bin apache2-data apache2-utils autopoint bsdextrautils debhelper dh-autoreconf dh-strip-nondeterminism dwz gettext gettext-base groff-base intltool-debian iproute2
  libapr1-dev libaprutil1-dbd-sqlite3 libaprutil1-dev libaprutil1-ldap libarchive-cpio-perl libarchive-zip-perl libatm1 libbpf1 libcap2-bin libdebhelper-perl
  libfile-stripnondeterminism-perl libgpm2 libldap-dev libldap2-dev liblua5.3-0 libmail-sendmail-perl libmnl0 libpam-cap libpipeline1 libsctp-dev libsctp1 libsodium23

~~~略~~~

Setting up libapr1-dev (1.7.2-3) ...
Setting up libaprutil1-dev (1.6.3-1) ...
Setting up debhelper (13.11.4) ...
Setting up apache2-dev (2.4.57-2) ...
Processing triggers for libc-bin (2.36-9) ...
Processing triggers for hicolor-icon-theme (0.17-2) ...
root@a0da070e286f:/#
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>以下のコマンドでバージョンが表示されれば成功です。</p> <div class="language-shell-session line-numbers-mode"><pre class="language-shell-session"><code><span class="token command"><span class="token info punctuation"><span class="token user">root@a0da070e286f</span><span class="token punctuation">:</span><span class="token path">/</span></span><span class="token shell-symbol important">#</span> <span class="token bash language-bash">nginx <span class="token parameter variable">-v</span></span></span>
<span class="token output">nginx version: nginx/1.22.1
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="nginx-の初期設定"><a href="#nginx-の初期設定" class="header-anchor">#</a> nginx の初期設定</h3> <p>nginxのサイトは88 portでリクエストを受け付けるようにします。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@a0da070e286f:/<span class="token comment"># echo 'Hello Bootcamp!!' &gt; /var/www/html/index.html</span>
root@a0da070e286f:/<span class="token comment"># vim /etc/nginx/sites-enabled/default</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-nginx line-numbers-mode"><pre class="language-nginx"><code><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">listen</span> <span class="token number">88</span> default_server</span><span class="token punctuation">;</span>      <span class="token comment"># 80 =&gt; 88 に変更</span>
        <span class="token directive"><span class="token keyword">listen</span> [::]:88 default_server</span><span class="token punctuation">;</span> <span class="token comment"># 80 =&gt; 88 に変更</span>

        <span class="token directive"><span class="token keyword">root</span> /var/www/html</span><span class="token punctuation">;</span>

        <span class="token directive"><span class="token keyword">index</span> index.html index.htm index.nginx-debian.html</span><span class="token punctuation">;</span>

        <span class="token directive"><span class="token keyword">server_name</span> _</span><span class="token punctuation">;</span>

        <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
                <span class="token directive"><span class="token keyword">try_files</span> <span class="token variable">$uri</span> <span class="token variable">$uri</span>/ =404</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>変更したらnginxを起動しましょう。</p> <div class="language-shell-session line-numbers-mode"><pre class="language-shell-session"><code><span class="token command"><span class="token info punctuation"><span class="token user">root@a0da070e286f</span><span class="token punctuation">:</span><span class="token path">/</span></span><span class="token shell-symbol important">#</span> <span class="token bash language-bash"><span class="token function">service</span> nginx start</span></span>
<span class="token output">[ ok ] Starting nginx: nginx.
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><a href="http://localhost:8088" target="_blank" rel="noopener noreferrer">localhost:8088<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> にアクセスしてみてください。<code>Hello Bootcamp!!</code>のHTMLが見えていれば成功です。</p> <p><img src="/bootcamp/assets/img/nginx_html.ae5a2fc7.png" alt="nginx_html"></p> <p>アクセスログも確認してみましょう。</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>root@a0da070e286f:/<span class="token comment"># tail /var/log/nginx/access.log</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>ここまでが事前作業となります。間に合わなければ、座学の間で準備してください。</p> <h2 id="ssl-tls-とは-座学"><a href="#ssl-tls-とは-座学" class="header-anchor">#</a> SSL/TLS とは(座学)</h2> <p>例えば、HTTP は基本的に平文でデータをやりとりします。</p> <p>ということは、途中でパケットキャプチャをすると、やり取りの内容を読み取ることができます。</p> <p>もしそこにパスワード情報など見られてはいけない情報が含まれていたら...怖いですね。</p> <p>そこで、SSL/TLS (Secure Socket Layer/Transport Layer Securityの技術)を用いて通信路の暗号化を行うHTTP over SSL いわゆるHTTPS を重要な情報のやりとりを行う際には用いるのが一般的となっています。</p> <p>SSL/TLSは通信路の暗号化として汎用性のあるものとなっており、HTTPに限らず様々なプロトコルでの暗号化に用いられています。</p> <ul><li>ファイル転送: FTP -&gt; FTPS</li> <li>メール: SMTP -&gt; SMTPS, POP3 -&gt; POP3S, IMAP -&gt; IMAPS</li></ul> <p>プロトコルとまではなっていなくても、mysqlなどでもレプリケーションの経路を暗号化するために用いられていたりもします。</p> <p>では、そのSSL/TLS の概要と歴史について、はIPAの資料がよくまとまっているため、そちらの2章1節を読むのがよいでしょう。
ざっくりというと、公開鍵暗号を用いて共通鍵を共有し、その共通鍵を用いて以後の経路の暗号化を行う、というものになります。</p> <p><a href="https://www.ipa.go.jp/security/crypto/guideline/ssl_crypt_config.html" target="_blank" rel="noopener noreferrer">TLS 暗号設定ガイドライン<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>この講義では、主にHTTPSをメインに触っていこうと思います。
また、以下ではSSL/TLSの総称としてTLSということにします。</p> <h2 id="証明書-とは-座学"><a href="#証明書-とは-座学" class="header-anchor">#</a> 証明書 とは(座学)</h2> <p>TLSは公開鍵暗号と共通鍵暗号の組み合わせという話をしました。
この公開鍵暗号の部分を担う重要なパーツとして証明書があります。</p> <p>証明書には、以下の役割があります。</p> <ul><li>公開鍵暗号の公開鍵情報の共有手段</li> <li>通信相手が確かにアクセスしようとしたドメインのサーバであることの確認手段</li></ul> <p>後者について、どのように確認が行えるのでしょうか？</p> <p>試しに<a href="https://www.iij.ad.jp" target="_blank" rel="noopener noreferrer">IIJの公式サイト<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>の証明書を覗いてみましょう。</p> <p>ブラウザでHTTPSなサイトを開くと、アドレスバーの横に鍵のマークが出ているかと思います。
そこから、証明書の情報を見ることができます。</p> <p>まずは、本体の証明書を見てみましょう。
見るところは色々ありますが、この辺りを注意してみましょう。
ブラウザによって表記が異なる場合がありますので、いくつか名称は並べて書きます</p> <ul><li>共通名、一般名、Common Name(CN)
<ul><li>基本的にはサイトのドメイン</li> <li>昔は、ここのドメインをもって確認をしても良いことになっていましたが、現在では禁止されています(RFC9110)
<ul><li>参考: <a href="https://eng-blog.iij.ad.jp/archives/14820" target="_blank" rel="noopener noreferrer">エンジニアブログ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li></ul></li> <li>組織、Organization(O)
<ul><li>この証明書を用いたサイトの管理組織</li></ul></li> <li>有効期間
<ul><li>この証明書の有効期間</li> <li>昔は5年ものなどもありましたが、2025年現在では約13か月(398日)が最長とされています。詳しくは後述</li></ul></li> <li>主体者代替名、サブジェクトの代替名、サブジェクトの別名、Subject Alternative Names(SANs)
<ul><li>いくつか項目がありますが、このうち重要なのはDNS名。この証明書が有効であるサイトを示しています。</li> <li>複数存在しうる</li> <li>現在では、証明書が管理するサイトを示す唯一の項目となります。</li></ul></li> <li>公開鍵
<ul><li>この証明書が提供する公開鍵。これを用いて共通鍵の共有を行います。</li></ul></li></ul> <p>ここまで確認したところで、証明書に添付された公開鍵を用いて暗号化通信を始めてよいのでしょうか？
ここまでで確認したことは、単に私はこのサイトの管理者だぞ！と自称しているに過ぎません。
信用して暗号化した経路でクレジットカードの情報を送ったのに、実は送った相手は偽サイトを運用する悪人だった、
となったら目も当てられません。
確かにこのサイトの管理者だと信じるには、信頼できる第三者の担保が欲しいですね。</p> <p>ここで登場するのが、認証局(Certification Authority: CA)です。</p> <p>証明書に戻ると、発行者(発行元、Issuer)と証明書の署名という項目があるのがわかります。
具体的な検証手段は割愛しますが、この署名を検証することで、確かに証明書が発行者に認められたものであることがわかります。</p> <p>では、その発行者は信頼できるのでしょうか？
証明書の情報を見ると、階層構造のようになっている部分があり、本体の証明書の上に発行者の証明書が表示されているかと思います。
発行者の証明書もまた同じような構造をしており、有効期間や組織などの情報はもちろん、またその上位の発行者と署名があります。
こうして証明書のチェインがつながっていった結果、最終的にRootCA の証明書に行きつきます。</p> <p>ブラウザのユーザは、少なくともそのブラウザは信用して使っているのだと思います。
ブラウザは、そのブラウザを含めて世界的に信用している認証局の証明書を、リストとして保持しています。
その認証局がRootCAと呼ばれているものです。
証明書のチェインがつながって、RootCAのものまで辿れれば、それは信頼できる認証局が証明したものとして信用できる、と判断できるようになります。</p> <p>このような証明書のチェインを通じて公開鍵の正当性を担保するための枠組みを公開鍵基盤(Public Key Infrastrcture:PKI)と呼びます。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>政府がRootとして正当性を担保する、政府認証基盤(Government PKI:GPKI)というものもあります。
例えばマイナンバーカードの証明書は公的個人認証サービス(JPKI)というものが発行していますが、JPKIの正当性はGPKIと相互認証する形で担保していたりします。</p></div> <h2 id="実際に手を動かしてみる"><a href="#実際に手を動かしてみる" class="header-anchor">#</a> 実際に手を動かしてみる</h2> <p>まずは、証明書を作ってみて、nginxでhttpsの通信が出来るようにしてみましょう。</p> <h3 id="証明書と秘密鍵を作ってみる-check1"><a href="#証明書と秘密鍵を作ってみる-check1" class="header-anchor">#</a> 証明書と秘密鍵を作ってみる (check1)</h3> <p>通常、証明書は以下の手順で入手します。</p> <ol><li>秘密鍵を生成する</li> <li>秘密鍵からCSR (Certificate Signing Request) を生成する</li> <li>CSR を証明局に提出し、審査を受け、証明局の持つ秘密鍵で署名された証明書を発行してもらう</li></ol> <p>秘密鍵を用いると、暗号化した通信を復号することが出来ます。
そのため、絶対に外部に漏らしてはいけません。例え証明局であっても例外ではありません。
証明書の発行には公開鍵があれば十分なため、秘密鍵から生成した公開鍵と、
その他発行に必要な情報を盛り込んだCSRを用いて証明書を発行します。</p> <p>ここでは、３を簡略化して1 で生成した鍵で署名する、自己署名証明書(いわゆるオレオレ証明書)を作ります。
このdocker image に既にインストールされている、openssl ツールで一通りの操作を行うことができます。</p> <h4 id="_1-秘密鍵を生成する"><a href="#_1-秘密鍵を生成する" class="header-anchor">#</a> 1. 秘密鍵を生成する</h4> <p>ここではRSA の2048 bit の秘密鍵を生成します。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>サブコマンドであるgenrsa はRSA 暗号の秘密鍵を生成するものとなります。</p></div> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>root@a0da070e286f:/<span class="token comment"># mkdir /etc/nginx/ssl</span>
root@a0da070e286f:/<span class="token comment"># openssl genrsa 2048 &gt; /etc/nginx/ssl/private.key</span>
Generating RSA private key, <span class="token number">2048</span> bit long modulus <span class="token punctuation">(</span><span class="token number">2</span> primes<span class="token punctuation">)</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>+++++
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.+++++
e is <span class="token number">65537</span> <span class="token punctuation">(</span>0x010001<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="_2-秘密鍵からcsr-certificate-signing-request-を生成する"><a href="#_2-秘密鍵からcsr-certificate-signing-request-を生成する" class="header-anchor">#</a> 2. 秘密鍵からCSR (Certificate Signing Request) を生成する</h4> <p>1 で作った秘密鍵から、CSR を生成します。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>サブコマンドであるreq はCSR を扱うためのものとなります。</p></div> <p>証明書で表示する情報をここで入力することになります。
実際に発行する際は、正当性を担保したい対象であるCommon Name は特に間違わないようにしましょう。</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>root@a0da070e286f:/<span class="token comment"># openssl req -new -sha256 -key /etc/nginx/ssl/private.key -out /etc/nginx/ssl/server.csr</span>
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter <span class="token string">'.'</span>, the field will be left blank.
-----
Country Name <span class="token punctuation">(</span><span class="token number">2</span> letter code<span class="token punctuation">)</span> <span class="token punctuation">[</span>AU<span class="token punctuation">]</span>:JP
State or Province Name <span class="token punctuation">(</span>full name<span class="token punctuation">)</span> <span class="token punctuation">[</span>Some-State<span class="token punctuation">]</span>:Tokyo
Locality Name <span class="token punctuation">(</span>eg, city<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>:Chiyoda
Organization Name <span class="token punctuation">(</span>eg, company<span class="token punctuation">)</span> <span class="token punctuation">[</span>Internet Widgits Pty Ltd<span class="token punctuation">]</span>:IIJ
Organizational Unit Name <span class="token punctuation">(</span>eg, section<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>: Test
Common Name <span class="token punctuation">(</span>e.g. server FQDN or YOUR name<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>:localhost
Email Address <span class="token punctuation">[</span><span class="token punctuation">]</span>:

Please enter the following <span class="token string">'extra'</span> attributes
to be sent with your certificate request
A challenge password <span class="token punctuation">[</span><span class="token punctuation">]</span>:
An optional company name <span class="token punctuation">[</span><span class="token punctuation">]</span>:
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h4 id="_3-署名された証明書を発行する"><a href="#_3-署名された証明書を発行する" class="header-anchor">#</a> 3. 署名された証明書を発行する</h4> <p>1 で作った秘密鍵、2 で作ったCSR から証明書を発行します。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>サブコマンドであるx509 は、証明書の標準規格を指しています。
-req でinput がCSR であることを示し、signkey に1 で作った秘密鍵を指定することでこれで署名します。</p></div> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>root@a0da070e286f:/<span class="token comment"># openssl x509 -req -in /etc/nginx/ssl/server.csr -out /etc/nginx/ssl/server.crt -signkey /etc/nginx/ssl/private.key -days 365</span>
Certificate request self-signature ok
<span class="token assign-left variable">subject</span><span class="token operator">=</span>C <span class="token operator">=</span> JP, ST <span class="token operator">=</span> Tokyo, L <span class="token operator">=</span> Chiyoda, O <span class="token operator">=</span> IIJ, OU <span class="token operator">=</span> Test, CN <span class="token operator">=</span> localhost
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>出来上がったら、証明書の中を覗いてみましょう。text オプションでテキスト出力をすることができます。</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>root@a0da070e286f:/<span class="token comment"># openssl x509 -in /etc/nginx/ssl/server.crt -text</span>
Certificate:
    Data:
        Version: <span class="token number">1</span> <span class="token punctuation">(</span>0x0<span class="token punctuation">)</span>
        Serial Number:
            <span class="token number">45</span>:ef:45:48:8c:89:e0:e5:38:74:f7:fc:21:32:35:eb:2b:bc:10:6b
        Signature Algorithm: sha256WithRSAEncryption
        Issuer: C <span class="token operator">=</span> JP, ST <span class="token operator">=</span> Tokyo, L <span class="token operator">=</span> Chiyoda, O <span class="token operator">=</span> IIJ, OU <span class="token operator">=</span> Test, CN <span class="token operator">=</span> localhost
        Validity
            Not Before: Aug  <span class="token number">1</span> <span class="token number">16</span>:29:36 <span class="token number">2022</span> GMT
            Not After <span class="token builtin class-name">:</span> Aug  <span class="token number">1</span> <span class="token number">16</span>:29:36 <span class="token number">2023</span> GMT
        Subject: C <span class="token operator">=</span> JP, ST <span class="token operator">=</span> Tokyo, L <span class="token operator">=</span> Chiyoda, O <span class="token operator">=</span> IIJ, OU <span class="token operator">=</span> Test, CN <span class="token operator">=</span> localhost
        Subject Public Key Info:
<span class="token punctuation">(</span><span class="token punctuation">..</span>.省略<span class="token punctuation">..</span>.<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>実際に発行されたものを確認する際は、期間(Not BeforeとNot After)とSubject (CN が正しいか)に特に注意しましょう。</p> <p>秘密鍵と証明書のペアが正しいかを確認するには、RSA のものならmodulus を比較するのが簡単です。</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>root@a0da070e286f:/<span class="token comment"># openssl rsa -in /etc/nginx/ssl/private.key -modulus -noout</span>
<span class="token assign-left variable">Modulus</span><span class="token operator">=</span>FB1908BE2B1567D1B8B7EE99DF3480CE2EDF57EC73ADD08AE2FA37A833321C84CF49D6D3F8011419BDAF8882B6E610C097D7016D173A14B7343E8D1381B8CF7FCD14CAA5717594B6F5CD586BF13EB90D2673E03B73EB25463333BD8D4384477C7910E87C8CEB2E71C83E59DD3BAC61E9B19DB97545AA9DB96DC995B01B2F96FA62CD8C777C0DA3A0377F71E0F6251CE7511964F2B4604D7F88472759C0178ECA1C7B21F9D9198166F28097A6EDF76925247119B7BEBDA73DD387607BD6320444E0242E127108C234B7F0D6CD6EB7E496747BDE7249E606BA44024E1FCC61E9ADBBE1BDABE51B342AF7DA5801AE36393E11EFFFAE60047EA7FE1E8E9A12FFF57B

root@a0da070e286f:/<span class="token comment"># openssl x509 -in /etc/nginx/ssl/server.crt -modulus -noout</span>
<span class="token assign-left variable">Modulus</span><span class="token operator">=</span>FB1908BE2B1567D1B8B7EE99DF3480CE2EDF57EC73ADD08AE2FA37A833321C84CF49D6D3F8011419BDAF8882B6E610C097D7016D173A14B7343E8D1381B8CF7FCD14CAA5717594B6F5CD586BF13EB90D2673E03B73EB25463333BD8D4384477C7910E87C8CEB2E71C83E59DD3BAC61E9B19DB97545AA9DB96DC995B01B2F96FA62CD8C777C0DA3A0377F71E0F6251CE7511964F2B4604D7F88472759C0178ECA1C7B21F9D9198166F28097A6EDF76925247119B7BEBDA73DD387607BD6320444E0242E127108C234B7F0D6CD6EB7E496747BDE7249E606BA44024E1FCC61E9ADBBE1BDABE51B342AF7DA5801AE36393E11EFFFAE60047EA7FE1E8E9A12FFF57B
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="https-の設定-check2"><a href="#https-の設定-check2" class="header-anchor">#</a> https の設定(check2)</h3> <p>事前作業で作ったhttp で受けていたサイトをhttps でも受けられるようにしてみます。</p> <p><code>/etc/nginx/sites-enabled/default</code> の一番下に以下を丸ごと追記していきます。</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>server <span class="token punctuation">{</span>
        listen <span class="token number">443</span> default_server<span class="token punctuation">;</span>
        listen <span class="token punctuation">[</span>::<span class="token punctuation">]</span>:443 default_server<span class="token punctuation">;</span>

        ssl on<span class="token punctuation">;</span>
        ssl_certificate /etc/nginx/ssl/server.crt<span class="token punctuation">;</span>
        ssl_certificate_key /etc/nginx/ssl/private.key<span class="token punctuation">;</span>

        root /var/www/html<span class="token punctuation">;</span>

        index index.html index.htm index.nginx-debian.html<span class="token punctuation">;</span>

        server_name _<span class="token punctuation">;</span>

        location / <span class="token punctuation">{</span>
                try_files <span class="token variable">$uri</span> <span class="token variable">$uri</span>/ <span class="token operator">=</span><span class="token number">404</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>追記したら、nginx をリスタートしましょう。</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>root@dea1ac0e1edb:/<span class="token comment"># service nginx restart</span>
<span class="token punctuation">[</span> ok <span class="token punctuation">]</span> Restarting nginx: nginx.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>確認をしてみましょう。
今回は、https での通信となるため、URLの先頭がhttpではなくhttpsとなっています。
https のデフォルトは443ポートのため、ポート指定の部分は省略可能です。</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>root@dea1ac0e1edb:/<span class="token comment"># curl https://localhost:443/</span>
curl: <span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span> SSL certificate problem: self-signed certificate
More details here: https://curl.se/docs/sslcerts.html

<span class="token function">curl</span> failed to verify the legitimacy of the server and therefore could not
establish a secure connection to it. To learn <span class="token function">more</span> about this situation and
how to fix it, please visit the web page mentioned above.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>今回は自己署名証明書であるため、curl は正規の証明書ではないとして検証エラーとなります。
無視してコンテンツを取得するには、--insecure(-k) オプションを使います。</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>root@dea1ac0e1edb:/<span class="token comment"># curl -k https://localhost:443/</span>
Hello Bootcamp<span class="token operator">!</span><span class="token operator">!</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>渡される証明書を見てみたい場合は、openssl のs_client サブコマンドを用いるとよいでしょう。
ここでは、繋がったらCtrl+C で抜けます。</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>root@dea1ac0e1edb:/<span class="token comment"># openssl s_client -connect localhost:443</span>
CONNECTED<span class="token punctuation">(</span>00000003<span class="token punctuation">)</span>
Can't use SSL_get_servername
<span class="token assign-left variable">depth</span><span class="token operator">=</span><span class="token number">0</span> C <span class="token operator">=</span> JP, ST <span class="token operator">=</span> Tokyo, L <span class="token operator">=</span> Chiyoda, O <span class="token operator">=</span> IIJ, OU <span class="token operator">=</span> Test, CN <span class="token operator">=</span> localhost
verify error:num<span class="token operator">=</span><span class="token number">18</span>:self-signed certificate
verify return:1
<span class="token assign-left variable">depth</span><span class="token operator">=</span><span class="token number">0</span> C <span class="token operator">=</span> JP, ST <span class="token operator">=</span> Tokyo, L <span class="token operator">=</span> Chiyoda, O <span class="token operator">=</span> IIJ, OU <span class="token operator">=</span> Test, CN <span class="token operator">=</span> localhost
verify return:1
---
Certificate chain
 <span class="token number">0</span> s:C <span class="token operator">=</span> JP, ST <span class="token operator">=</span> Tokyo, L <span class="token operator">=</span> Chiyoda, O <span class="token operator">=</span> IIJ, OU <span class="token operator">=</span> Test, CN <span class="token operator">=</span> localhost
   i:C <span class="token operator">=</span> JP, ST <span class="token operator">=</span> Tokyo, L <span class="token operator">=</span> Chiyoda, O <span class="token operator">=</span> IIJ, OU <span class="token operator">=</span> Test, CN <span class="token operator">=</span> localhost
   a:PKEY: rsaEncryption, <span class="token number">2048</span> <span class="token punctuation">(</span>bit<span class="token punctuation">)</span><span class="token punctuation">;</span> sigalg: RSA-SHA256
   v:NotBefore: Aug  <span class="token number">3</span> <span class="token number">16</span>:41:31 <span class="token number">2025</span> GMT<span class="token punctuation">;</span> NotAfter: Aug  <span class="token number">3</span> <span class="token number">16</span>:41:31 <span class="token number">2026</span> GMT
---
Server certificate
-----BEGIN CERTIFICATE-----
MIIDQzCCAisCFCeXemGW/mzBWsHN4rmA9eHstX27MA0GCSqGSIb3DQEBCwUAMF4x

<span class="token punctuation">(</span>中略<span class="token punctuation">)</span>

G9hAF0OGhQagV6jcIgjGYk0iIITzss6fujD+eSAwDfp685F84jsayUVdkBnCqVMy
1c1kiqV+wv2XaWHvm2pl/zX94ReoGv4<span class="token operator">=</span>
-----END CERTIFICATE-----
<span class="token assign-left variable">subject</span><span class="token operator">=</span>C <span class="token operator">=</span> JP, ST <span class="token operator">=</span> Tokyo, L <span class="token operator">=</span> Chiyoda, O <span class="token operator">=</span> IIJ, OU <span class="token operator">=</span> Test, CN <span class="token operator">=</span> localhost
<span class="token assign-left variable">issuer</span><span class="token operator">=</span>C <span class="token operator">=</span> JP, ST <span class="token operator">=</span> Tokyo, L <span class="token operator">=</span> Chiyoda, O <span class="token operator">=</span> IIJ, OU <span class="token operator">=</span> Test, CN <span class="token operator">=</span> localhost
---
No client certificate CA names sent
Peer signing digest: SHA256
Peer signature type: RSA-PSS
Server Temp Key: X25519, <span class="token number">253</span> bits
---
SSL handshake has <span class="token builtin class-name">read</span> <span class="token number">1395</span> bytes and written <span class="token number">377</span> bytes
Verification error: self-signed certificate
---
New, TLSv1.3, Cipher is TLS_AES_256_GCM_SHA384
Server public key is <span class="token number">2048</span> bit
Secure Renegotiation IS NOT supported
Compression: NONE
Expansion: NONE
No ALPN negotiated
Early data was not sent
Verify <span class="token builtin class-name">return</span> code: <span class="token number">18</span> <span class="token punctuation">(</span>self-signed certificate<span class="token punctuation">)</span>
---

<span class="token punctuation">(</span>中略<span class="token punctuation">)</span>

    Start Time: <span class="token number">1754239905</span>
    Timeout   <span class="token builtin class-name">:</span> <span class="token number">7200</span> <span class="token punctuation">(</span>sec<span class="token punctuation">)</span>
    Verify <span class="token builtin class-name">return</span> code: <span class="token number">18</span> <span class="token punctuation">(</span>self-signed certificate<span class="token punctuation">)</span>
    Extended master secret: no
    Max Early Data: <span class="token number">0</span>
---
<span class="token builtin class-name">read</span> R BLOCK

<span class="token punctuation">(</span>Ctrl+C を入力して抜ける<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br></div></div><p>openssl s_client は、TLSのhandshakeを行って暗号化した経路を用いるtelnetのようなものです。
ここではCtrl+Cで抜けましたが、続けてHTTPのリクエストを送るとHTTPSの通信となります。</p> <p>ブラウザで確認する場合は、443 は8443 にポートフォワードの設定が入っているため、8443 ポートにアクセスしてみましょう。</p> <p><a href="https://localhost:8443/" target="_blank" rel="noopener noreferrer">https://localhost:8443/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>今回は自己署名証明書であるため、ほとんどのブラウザは正当な証明書ではないと判断し、注意喚起の画面が表示されます。
危険性を承知で閲覧すると、<code>Hello Bootcamp!!</code>の表示が確認できるかと思います。</p> <p>また、ブラウザ上で暗号化に使っている証明書の内容が確認できるので、確認もしてみましょう。</p> <h3 id="証明書-の有効期限-座学"><a href="#証明書-の有効期限-座学" class="header-anchor">#</a> 証明書 の有効期限(座学)</h3> <p>証明書に関する業界標準については主に<a href="https://cabforum.org/" target="_blank" rel="noopener noreferrer">CA/Bフォーラム<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>で議論されます。
証明書を発行する証明局(CA)はもちろん、利用者側として暗号化通信の信頼性に責任を持つブラウザベンダ(B)などが
<a href="https://cabforum.org/about/membership/members/" target="_blank" rel="noopener noreferrer">メンバー<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>となっています。
昨今は、Web以外でも証明書は活用されているため、それらのアプリやOSのベンダもConsumerとして参加しています。</p> <p>CA/Bフォーラムで長らく話題になっていたのが、証明書の最長有効期限の短縮です。
秘密鍵の漏えい対策、仕様変更のサイクルの高速化、などが理由とされています。
最初は特に制限なしだったところから、5年、39か月、825日と段々と縮んでいき、
2020/9より397日まで短縮されていました。
そして、2025/4/11、新たな短縮スケジュールがCA/Bフォーラムで可決されました。</p> <p>当面の有効期限は以下の通りです。</p> <ul><li>2026/3/14 までは、これまで通り397日</li> <li>2027/3/14 までは、200日
<ul><li>6か月 + 1か月の半分 + 1日</li></ul></li> <li>2029/3/14 までは、100日
<ul><li>3か月 + 1か月の1/4 + 1日</li></ul></li> <li>2029/3/15 以降は、47日
<ul><li>1か月 + 1か月の半分 + 1日</li></ul></li></ul> <p>ここまで短くなると、手動で更新し続けることは困難となります。
各証明局側も自動化の対応が進んでいくと思われるので、
それに合わせて自動化していく必要が出てくるでしょう。</p> <h3 id="詳細な暗号設定"><a href="#詳細な暗号設定" class="header-anchor">#</a> 詳細な暗号設定</h3> <p>TLSの設定としては、主に、プロトコルのバージョン、暗号スイート、証明書、に何を使うかが大事になります。</p> <h4 id="protocol-を設定してみる-check3"><a href="#protocol-を設定してみる-check3" class="header-anchor">#</a> protocol を設定してみる(check3)</h4> <p>プロトコルについては、既にTLSv1.1 までは2021に禁止扱いになっていたりします。</p> <p>nginx だと、<code>ssl_protocols</code>で設定します。</p> <p>まずは、デフォルトの状態で接続を確認してみましょう。TLSv1.2で接続できています。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>nginx上ではデフォルトで後述設定の通りTLSv1, 1.1 が有効に見えますが、接続できないようです。
そのため、ここでは差異が見えるようわざとTLSv1.2 で試してみています。</p></div> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>root@34cfcf7b6f05:/<span class="token comment"># curl -vvv -k --tls-max 1.2 https://localhost:443</span>
*   Trying <span class="token number">127.0</span>.0.1:443<span class="token punctuation">..</span>.
* Connected to localhost <span class="token punctuation">(</span><span class="token number">127.0</span>.0.1<span class="token punctuation">)</span> port <span class="token number">443</span> <span class="token punctuation">(</span><span class="token comment">#0)</span>
* ALPN: offers h2,http/1.1
* TLSv1.2 <span class="token punctuation">(</span>OUT<span class="token punctuation">)</span>, TLS handshake, Client hello <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>:
* TLSv1.2 <span class="token punctuation">(</span>IN<span class="token punctuation">)</span>, TLS handshake, Server hello <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>:
<span class="token punctuation">(</span>中略<span class="token punctuation">)</span>
<span class="token operator">&gt;</span> GET / HTTP/1.1
<span class="token operator">&gt;</span> Host: localhost
<span class="token operator">&gt;</span> User-Agent: curl/7.88.1
<span class="token operator">&gt;</span> Accept: */*
<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span> HTTP/1.1 <span class="token number">200</span> OK
<span class="token operator">&lt;</span> Server: nginx/1.22.1
<span class="token operator">&lt;</span> Date: Thu, 01 Aug <span class="token number">2024</span> 01:58:28 GMT
<span class="token operator">&lt;</span> Content-Type: text/html
<span class="token operator">&lt;</span> Content-Length: <span class="token number">17</span>
<span class="token operator">&lt;</span> Last-Modified: Mon, <span class="token number">29</span> Jul <span class="token number">2024</span> <span class="token number">23</span>:13:24 GMT
<span class="token operator">&lt;</span> Connection: keep-alive
<span class="token operator">&lt;</span> ETag: <span class="token string">&quot;66a82214-11&quot;</span>
<span class="token operator">&lt;</span> Accept-Ranges: bytes
<span class="token operator">&lt;</span>
Hello Bootcamp<span class="token operator">!</span><span class="token operator">!</span>
* Connection <span class="token comment">#0 to host localhost left intact</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>では、/etc/nginx/nginx.conf に設定があるので、書き換えてみましょう。
書き換えたら再起動して反映させます。</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>root@34cfcf7b6f05:/<span class="token comment"># vim /etc/nginx/nginx.conf</span>
<span class="token punctuation">(</span>前後省略<span class="token punctuation">)</span>
        <span class="token comment">##</span>
        <span class="token comment"># SSL Settings</span>
        <span class="token comment">##</span>

        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3<span class="token punctuation">;</span> <span class="token comment"># Dropping SSLv3, ref: POODLE  &lt;= ここからTLSv1 TLSv1.1 TLSv1.2 を消してみる</span>
        ssl_prefer_server_ciphers on<span class="token punctuation">;</span>

        <span class="token comment">##</span>
        <span class="token comment"># Logging Settings</span>
        <span class="token comment">##</span>
<span class="token punctuation">(</span>前後省略<span class="token punctuation">)</span>
root@34cfcf7b6f05:/<span class="token comment"># service nginx restart</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>設定してみたら、接続できなくなることを確認してみましょう。</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>root@34cfcf7b6f05:/<span class="token comment"># curl -vvv -k --tls-max 1.2 https://localhost:443</span>
*   Trying <span class="token number">127.0</span>.0.1:443<span class="token punctuation">..</span>.
* Connected to localhost <span class="token punctuation">(</span><span class="token number">127.0</span>.0.1<span class="token punctuation">)</span> port <span class="token number">443</span> <span class="token punctuation">(</span><span class="token comment">#0)</span>
* ALPN: offers h2,http/1.1
* TLSv1.2 <span class="token punctuation">(</span>OUT<span class="token punctuation">)</span>, TLS handshake, Client hello <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>:
* TLSv1.2 <span class="token punctuation">(</span>IN<span class="token punctuation">)</span>, TLS alert, protocol version <span class="token punctuation">(</span><span class="token number">582</span><span class="token punctuation">)</span>:
* OpenSSL/3.0.9: error:0A00042E:SSL routines::tlsv1 alert protocol version
* Closing connection <span class="token number">0</span>
curl: <span class="token punctuation">(</span><span class="token number">35</span><span class="token punctuation">)</span> OpenSSL/3.0.9: error:0A00042E:SSL routines::tlsv1 alert protocol version

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="暗号スイートを設定してみる-check4"><a href="#暗号スイートを設定してみる-check4" class="header-anchor">#</a> 暗号スイートを設定してみる(check4)</h4> <p>暗号スイートは、</p> <ul><li>鍵交換方式</li> <li>署名方式</li> <li>暗号化方式</li> <li>ハッシュ関数</li></ul> <p>の組で構成されます。TLS1.3からは、ここから鍵交換方式、署名方式が外されて暗号化方式、ハッシュ関数で構成されます。
(鍵交換や署名の部分がプロトコルに最初から組み込まれるようになったため、指定する必要がなくなりました)</p> <p>openssl コマンドで、扱える暗号スイートの一覧を見ることが出来るので、見てみましょう。</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>root@34cfcf7b6f05:/<span class="token comment"># openssl ciphers -v</span>
TLS_AES_256_GCM_SHA384         TLSv1.3 <span class="token assign-left variable">Kx</span><span class="token operator">=</span>any      <span class="token assign-left variable">Au</span><span class="token operator">=</span>any   <span class="token assign-left variable">Enc</span><span class="token operator">=</span>AESGCM<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span>            <span class="token assign-left variable">Mac</span><span class="token operator">=</span>AEAD
TLS_CHACHA20_POLY1305_SHA256   TLSv1.3 <span class="token assign-left variable">Kx</span><span class="token operator">=</span>any      <span class="token assign-left variable">Au</span><span class="token operator">=</span>any   <span class="token assign-left variable">Enc</span><span class="token operator">=</span>CHACHA20/POLY1305<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token assign-left variable">Mac</span><span class="token operator">=</span>AEAD
TLS_AES_128_GCM_SHA256         TLSv1.3 <span class="token assign-left variable">Kx</span><span class="token operator">=</span>any      <span class="token assign-left variable">Au</span><span class="token operator">=</span>any   <span class="token assign-left variable">Enc</span><span class="token operator">=</span>AESGCM<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span>            <span class="token assign-left variable">Mac</span><span class="token operator">=</span>AEAD
ECDHE-ECDSA-AES256-GCM-SHA384  TLSv1.2 <span class="token assign-left variable">Kx</span><span class="token operator">=</span>ECDH     <span class="token assign-left variable">Au</span><span class="token operator">=</span>ECDSA <span class="token assign-left variable">Enc</span><span class="token operator">=</span>AESGCM<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span>            <span class="token assign-left variable">Mac</span><span class="token operator">=</span>AEAD
ECDHE-RSA-AES256-GCM-SHA384    TLSv1.2 <span class="token assign-left variable">Kx</span><span class="token operator">=</span>ECDH     <span class="token assign-left variable">Au</span><span class="token operator">=</span>RSA   <span class="token assign-left variable">Enc</span><span class="token operator">=</span>AESGCM<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span>            <span class="token assign-left variable">Mac</span><span class="token operator">=</span>AEAD
DHE-RSA-AES256-GCM-SHA384      TLSv1.2 <span class="token assign-left variable">Kx</span><span class="token operator">=</span>DH       <span class="token assign-left variable">Au</span><span class="token operator">=</span>RSA   <span class="token assign-left variable">Enc</span><span class="token operator">=</span>AESGCM<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span>            <span class="token assign-left variable">Mac</span><span class="token operator">=</span>AEAD
<span class="token punctuation">(</span>以下略<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>一番上のものは、TLS1.3 のものなので、暗号化がAES256のGCMモード、ハッシュ関数がSHA384
4番目のものは、TLS1.2 のものなので、鍵交換がECDHE、署名がECDSA、暗号化がAES256のGCMモード、ハッシュ関数がSHA384
といった感じになります。</p> <p>注意する点として、この表記はOpenSSL流のものですが、世の中にはIANAが定めた表記も存在しています。
技術文書で出てきたものが見当たらないな、と思ったら別表記のものかもしれません。</p> <p>参考</p> <ul><li><a href="https://testssl.sh/openssl-iana.mapping.html" target="_blank" rel="noopener noreferrer">testssl.sh が出してるマッピング<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://ciphersuite.info/" target="_blank" rel="noopener noreferrer">変換してくれるサイト<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>nginxでは、<code>ssl_ciphers</code>を用いて設定します。</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>root@34cfcf7b6f05:/<span class="token comment"># vim /etc/nginx/nginx.conf</span>
<span class="token punctuation">(</span>前後省略<span class="token punctuation">)</span>
        <span class="token comment">##</span>
        <span class="token comment"># SSL Settings</span>
        <span class="token comment">##</span>

        ssl_protocols TLSv1.2 TLSv1.3<span class="token punctuation">;</span> <span class="token comment"># Dropping SSLv3, ref: POODLE  &lt;= TLSv1.2 を元に戻す</span>
        ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-CHACHA20-POLY1305<span class="token punctuation">;</span>
        <span class="token comment"># ↑↑↑ この行を追加</span>
        ssl_prefer_server_ciphers on<span class="token punctuation">;</span>

        <span class="token comment">##</span>
        <span class="token comment"># Logging Settings</span>
        <span class="token comment">##</span>
<span class="token punctuation">(</span>前後省略<span class="token punctuation">)</span>
root@34cfcf7b6f05:/<span class="token comment"># service nginx restart</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>ssl_ciphers の設定部分は、openssl ciphers の引数に渡すことで、この設定で使えるcipher の一覧を表示させることができます。
今回は列挙した形ですが、!EXP のようにブラックリスト的な書き方もできるため、よくわからなくなったらこのように実際に設定されるものを確認するとよいでしょう。
openssl ciphers -v &quot;ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-CHACHA20-POLY1305&quot;</p></div> <p><code>openssl ciphers</code>の一覧から適当なものを選んで接続してみて、nginx.confで設定したものは接続でき、設定しなかったものは接続できないことを確認してください。</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>root@34cfcf7b6f05:/<span class="token comment"># curl -vvv -k --tls-max 1.2 --ciphers ECDHE-RSA-AES128-GCM-SHA256 https://localhost:443</span>
*   Trying <span class="token number">127.0</span>.0.1:443<span class="token punctuation">..</span>.
* Connected to localhost <span class="token punctuation">(</span><span class="token number">127.0</span>.0.1<span class="token punctuation">)</span> port <span class="token number">443</span> <span class="token punctuation">(</span><span class="token comment">#0)</span>
* ALPN: offers h2,http/1.1
* Cipher selection: ECDHE-RSA-AES128-GCM-SHA256
* TLSv1.2 <span class="token punctuation">(</span>OUT<span class="token punctuation">)</span>, TLS handshake, Client hello <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>:
* TLSv1.2 <span class="token punctuation">(</span>IN<span class="token punctuation">)</span>, TLS handshake, Server hello <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>:
<span class="token punctuation">(</span>中略<span class="token punctuation">)</span>
Hello Bootcamp<span class="token operator">!</span><span class="token operator">!</span>

root@34cfcf7b6f05:/<span class="token comment"># curl -vvv -k --tls-max 1.2 --ciphers AES256-SHA256 https://localhost:443</span>
*   Trying <span class="token number">127.0</span>.0.1:443<span class="token punctuation">..</span>.
* Connected to localhost <span class="token punctuation">(</span><span class="token number">127.0</span>.0.1<span class="token punctuation">)</span> port <span class="token number">443</span> <span class="token punctuation">(</span><span class="token comment">#0)</span>
* ALPN: offers h2,http/1.1
* Cipher selection: AES256-SHA256
* TLSv1.2 <span class="token punctuation">(</span>OUT<span class="token punctuation">)</span>, TLS handshake, Client hello <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>:
* TLSv1.2 <span class="token punctuation">(</span>IN<span class="token punctuation">)</span>, TLS alert, handshake failure <span class="token punctuation">(</span><span class="token number">552</span><span class="token punctuation">)</span>:
* OpenSSL/3.0.9: error:0A000410:SSL routines::sslv3 alert handshake failure
* Closing connection <span class="token number">0</span>
curl: <span class="token punctuation">(</span><span class="token number">35</span><span class="token punctuation">)</span> OpenSSL/3.0.9: error:0A000410:SSL routines::sslv3 alert handshake failure

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h4 id="証明書について-check5"><a href="#証明書について-check5" class="header-anchor">#</a> 証明書について(check5)</h4> <p>証明書については、発行形式は証明局側がよしなにするので、こちらで主に気にすべきは秘密鍵の方です。
鍵長長ければ長いほどセキュリティ強度は高まりますが、復号するために余計にリソースを消費することになるため、
そこはトレードオフとなります。</p> <p>ECDSAは暗号の特性上、短い鍵長でも高いセキュリティ強度を保つことができます。
RSAであれば2048bit、ECDSAであれば256bit のものを使うのがよいでしょう。</p> <p>ここでは、試しにECDSAの秘密鍵を用いて証明書を作って使用してみます。
openssl コマンドで、ECDSAの秘密鍵も生成可能です。</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>root@a0da070e286f:/<span class="token comment"># openssl ecparam -genkey -name prime256v1 &gt; /etc/nginx/ssl/ecdsa.key</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>生成した鍵を見てみると、形式がRSAのものと異なり、短くなっていることが見て取れるかと思います。
ここから先の手順は、RSAの時と同様です。出力も同様なので省略します。</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>root@34cfcf7b6f05:/<span class="token comment"># openssl req -new -sha256 -key /etc/nginx/ssl/ecdsa.key -out /etc/nginx/ssl/ecdsa.csr</span>
root@34cfcf7b6f05:/<span class="token comment"># openssl x509 -req -in /etc/nginx/ssl/ecdsa.csr -out /etc/nginx/ssl/ecdsa.crt -signkey /etc/nginx/ssl/ecdsa.key -days 365</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>出来上がったものを見てみると、Public Key Info が変わっています。</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>root@34cfcf7b6f05:/<span class="token comment"># openssl x509 -in /etc/nginx/ssl/ecdsa.crt -text</span>
<span class="token punctuation">(</span>中略<span class="token punctuation">)</span>
  Subject Public Key Info:
    Public Key Algorithm: id-ecPublicKey
      Public-Key: <span class="token punctuation">(</span><span class="token number">256</span> bit<span class="token punctuation">)</span>
      pub:
        04:6b:b0:f6:cc:b5:8d:6a:b9:93:f2:1d:50:ec:4e:
        <span class="token number">59</span>:82:39:70:33:61:f3:b4:3b:13:42:39:1d:68:27:
        5a:27:3d:0a:df:14:78:3d:aa:fb:ec:f5:a8:8b:87:
        3b:bc:cc:f7:47:b3:84:db:85:a5:e5:2e:9c:03:44:
        8f:37:65:2e:e4
      ASN1 OID: prime256v1
      NIST CURVE: P-256
Signature Algorithm: ecdsa-with-SHA256
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>後は、nginx の参照を変更し、この証明書を使ってhttpsを提供してみましょう。</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>root@34cfcf7b6f05:/<span class="token comment"># vim /etc/nginx/sites-enabled/default</span>
<span class="token punctuation">(</span>中略<span class="token punctuation">)</span>

server <span class="token punctuation">{</span>
        listen <span class="token number">443</span> default_server<span class="token punctuation">;</span>
        listen <span class="token punctuation">[</span>::<span class="token punctuation">]</span>:443 default_server<span class="token punctuation">;</span>

        ssl on<span class="token punctuation">;</span>
        ssl_certificate /etc/nginx/ssl/ecdsa.crt<span class="token punctuation">;</span>           <span class="token comment"># &lt;= ここを書き換え</span>
        ssl_certificate_key /etc/nginx/ssl/ecdsa.key<span class="token punctuation">;</span>       <span class="token comment"># &lt;= ここを書き換え</span>

        root /var/www/html<span class="token punctuation">;</span>

        index index.html index.htm index.nginx-debian.html<span class="token punctuation">;</span>
<span class="token punctuation">(</span>後略<span class="token punctuation">)</span>
root@34cfcf7b6f05:/<span class="token comment"># service nginx restart</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>ECDSAの鍵を用いたものでも問題なく接続できるかと思います。</p> <p>パフォーマンスの観点からはECDSAの方が有利ですが、中にはECDSAに対応していないサービスもあります。
利用してみたい場合も証明書を使用するサービスで使えるかどうか確認してから発行するようにしましょう。</p> <h4 id="安全とされている設定-座学"><a href="#安全とされている設定-座学" class="header-anchor">#</a> 安全とされている設定(座学)</h4> <p>日本における暗号設定のセキュリティ上の最低ラインは先の暗号設定ガイドラインの3.1に記載されています。</p> <p><a href="https://www.ipa.go.jp/security/crypto/guideline/ssl_crypt_config.html" target="_blank" rel="noopener noreferrer">TLS 暗号設定ガイドライン<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>表14がわかりやすいでしょう。ビットセキュリティについては、2.6の表11がわかりやすいです。</p> <p>mozilla の推奨暗号スイートも参考になります。</p> <p><a href="https://wiki.mozilla.org/Security/Server_Side_TLS" target="_blank" rel="noopener noreferrer">mozilla Server Side TLS<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>今回のcipher設定についてはmozilla のintermediate のものを利用しています。
<a href="https://ssl-config.mozilla.org/" target="_blank" rel="noopener noreferrer">こちら<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>で対応する設定を出力してくれるのも便利です。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/iij/bootcamp/edit/master/src/web-server/tls/README.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">8/4/2025, 12:57:25 AM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/bootcamp/assets/js/app.182a799b.js" defer></script><script src="/bootcamp/assets/js/2.cc24643c.js" defer></script><script src="/bootcamp/assets/js/35.ea310dd2.js" defer></script>
  </body>
</html>
