<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>動的アプリのホスティング | IIJ Bootcamp</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="rubyやgoとnginx/apacheを組み合わせて動的アプリのホスティングに挑戦します">
    
    <link rel="preload" href="/bootcamp/assets/css/0.styles.095a7d7e.css" as="style"><link rel="preload" href="/bootcamp/assets/js/app.f493d58f.js" as="script"><link rel="preload" href="/bootcamp/assets/js/2.faacc272.js" as="script"><link rel="preload" href="/bootcamp/assets/js/24.620eaf66.js" as="script"><link rel="preload" href="/bootcamp/assets/js/14.58971041.js" as="script"><link rel="preload" href="/bootcamp/assets/js/13.c36dceeb.js" as="script"><link rel="prefetch" href="/bootcamp/assets/js/10.30b1f461.js"><link rel="prefetch" href="/bootcamp/assets/js/11.efbfb6eb.js"><link rel="prefetch" href="/bootcamp/assets/js/12.5c11c9a3.js"><link rel="prefetch" href="/bootcamp/assets/js/15.6cc15209.js"><link rel="prefetch" href="/bootcamp/assets/js/16.28d246bf.js"><link rel="prefetch" href="/bootcamp/assets/js/17.f55869aa.js"><link rel="prefetch" href="/bootcamp/assets/js/18.a3bd1bc5.js"><link rel="prefetch" href="/bootcamp/assets/js/19.e9155a35.js"><link rel="prefetch" href="/bootcamp/assets/js/20.e165743b.js"><link rel="prefetch" href="/bootcamp/assets/js/21.6ef03cf0.js"><link rel="prefetch" href="/bootcamp/assets/js/22.20a9c4c1.js"><link rel="prefetch" href="/bootcamp/assets/js/23.4e82ac36.js"><link rel="prefetch" href="/bootcamp/assets/js/25.a096e705.js"><link rel="prefetch" href="/bootcamp/assets/js/26.98a2b961.js"><link rel="prefetch" href="/bootcamp/assets/js/27.ad7f20df.js"><link rel="prefetch" href="/bootcamp/assets/js/28.b65ba8b2.js"><link rel="prefetch" href="/bootcamp/assets/js/29.97dcc9cd.js"><link rel="prefetch" href="/bootcamp/assets/js/3.e29c363c.js"><link rel="prefetch" href="/bootcamp/assets/js/30.1f3b275f.js"><link rel="prefetch" href="/bootcamp/assets/js/31.7d645bc2.js"><link rel="prefetch" href="/bootcamp/assets/js/32.7212207e.js"><link rel="prefetch" href="/bootcamp/assets/js/33.14be957d.js"><link rel="prefetch" href="/bootcamp/assets/js/34.38bb9de3.js"><link rel="prefetch" href="/bootcamp/assets/js/35.e8fb5a6c.js"><link rel="prefetch" href="/bootcamp/assets/js/36.21fbaf09.js"><link rel="prefetch" href="/bootcamp/assets/js/37.dd712a7f.js"><link rel="prefetch" href="/bootcamp/assets/js/38.384e58b9.js"><link rel="prefetch" href="/bootcamp/assets/js/39.fc350ddc.js"><link rel="prefetch" href="/bootcamp/assets/js/4.9530a1b4.js"><link rel="prefetch" href="/bootcamp/assets/js/40.92054734.js"><link rel="prefetch" href="/bootcamp/assets/js/41.bc1d4761.js"><link rel="prefetch" href="/bootcamp/assets/js/42.476343f8.js"><link rel="prefetch" href="/bootcamp/assets/js/43.2f81d708.js"><link rel="prefetch" href="/bootcamp/assets/js/44.ba189b47.js"><link rel="prefetch" href="/bootcamp/assets/js/45.b17cd5f2.js"><link rel="prefetch" href="/bootcamp/assets/js/46.d8eacb93.js"><link rel="prefetch" href="/bootcamp/assets/js/47.b8dd01c7.js"><link rel="prefetch" href="/bootcamp/assets/js/48.51a92fcd.js"><link rel="prefetch" href="/bootcamp/assets/js/49.2a642805.js"><link rel="prefetch" href="/bootcamp/assets/js/5.e0f49538.js"><link rel="prefetch" href="/bootcamp/assets/js/50.5ed0952c.js"><link rel="prefetch" href="/bootcamp/assets/js/51.9ae72886.js"><link rel="prefetch" href="/bootcamp/assets/js/52.048ab376.js"><link rel="prefetch" href="/bootcamp/assets/js/53.9a76f598.js"><link rel="prefetch" href="/bootcamp/assets/js/54.7242db1a.js"><link rel="prefetch" href="/bootcamp/assets/js/55.6db8fafa.js"><link rel="prefetch" href="/bootcamp/assets/js/56.a1ab7292.js"><link rel="prefetch" href="/bootcamp/assets/js/57.94744a28.js"><link rel="prefetch" href="/bootcamp/assets/js/6.f3a8e697.js"><link rel="prefetch" href="/bootcamp/assets/js/7.f33abdc4.js"><link rel="prefetch" href="/bootcamp/assets/js/8.739a4a70.js"><link rel="prefetch" href="/bootcamp/assets/js/9.ccb16338.js">
    <link rel="stylesheet" href="/bootcamp/assets/css/0.styles.095a7d7e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/bootcamp/" class="home-link router-link-active"><!----> <span class="site-name">IIJ Bootcamp</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/iij/bootcamp" target="_blank" rel="noopener noreferrer" class="repo-link">
      GitHub
      <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/iij/bootcamp" target="_blank" rel="noopener noreferrer" class="repo-link">
      GitHub
      <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>動的アプリのホスティング</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/bootcamp/web-server/hosting/#事前準備" class="sidebar-link">事前準備</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/bootcamp/web-server/hosting/#前置き" class="sidebar-link">前置き</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/bootcamp/web-server/hosting/#go-nginx" class="sidebar-link">go + nginx</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bootcamp/web-server/hosting/#echo-serverの起動" class="sidebar-link">echo-serverの起動</a></li><li class="sidebar-sub-header"><a href="/bootcamp/web-server/hosting/#nginxと連携させる" class="sidebar-link">nginxと連携させる</a></li></ul></li><li><a href="/bootcamp/web-server/hosting/#ruby-apache" class="sidebar-link">ruby + apache</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bootcamp/web-server/hosting/#前書き" class="sidebar-link">前書き</a></li><li class="sidebar-sub-header"><a href="/bootcamp/web-server/hosting/#動かしてみる" class="sidebar-link">動かしてみる</a></li></ul></li><li><a href="/bootcamp/web-server/hosting/#追加" class="sidebar-link">追加</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><table><tr><td>このハンズオンでやること</td><td>rubyやgoとnginx/apacheを組み合わせて動的アプリのホスティングに挑戦します</td></tr> <tr><td>想定時間</td><td>1h</td></tr> <tr><td>前提知識・用語</td><td>ruby go apache nginx</td></tr></table> <h1 id="page-frontmatter-title"><a href="#page-frontmatter-title" class="header-anchor">#</a> 動的アプリのホスティング</h1> <h2 id="事前準備"><a href="#事前準備" class="header-anchor">#</a> 事前準備</h2> <ul><li>dockerのインストール</li></ul> <h2 id="前置き"><a href="#前置き" class="header-anchor">#</a> 前置き</h2> <p>現在では様々な言語、フレームワークを使ってWebサーバーアプリケーションの構築を行います。</p> <ul><li>ruby
<ul><li>rails</li></ul></li> <li>python
<ul><li>Django</li></ul></li> <li>go</li> <li>java</li> <li>PHP</li></ul> <p>上はほんの一例ですが、どの言語で作っても「HTTPリクエストを受け取って何らかのレスポンスを返す」というHTTPサーバーとしての機能を持っていることには変わりありません。</p> <p>しかし実際の本番環境においては、通常これらのアプリケーションがユーザーからのリクエストを直接受けることはしません。必ずApacheやNginxなど専用のWebサーバーを中継してリクエストを処理します。</p> <p>なぜこんな二度手間のようなことをするかというと理由は色々ありますが、大雑把に以下のようなものです。</p> <ul><li>各言語で実装されたHTTPサーバーの機能が貧弱</li> <li>TLSの終端などをアプリケーション側に実装したくない
<ul><li>証明書の管理などをアプリケーションでやらないといけない</li></ul></li> <li>HTTPサーバーとして信頼性の高いものを使いたい
<ul><li>脆弱性対策などが一通り行われている</li> <li>不具合が少ない
<ul><li>HTTPサーバーとしての機能に特化している</li> <li>世界中で多く使われているため修正が活発</li></ul></li></ul></li></ul> <p>このハンズオンではフロントとしてApacheまたはNginxを利用し、裏側のRailsやGo製アプリケーションと連携するような構成を手元で作ってみたいと思います。</p> <h2 id="go-nginx"><a href="#go-nginx" class="header-anchor">#</a> go + nginx</h2> <h3 id="echo-serverの起動"><a href="#echo-serverの起動" class="header-anchor">#</a> echo-serverの起動</h3> <p>まずは比較的シンプルな例としてGo言語で作られたアプリケーションとNginxを連携させてみましょう。なぜシンプルなのかはあとでお話しします。</p> <p>以下のコマンドでハンズオン用のdockerコンテナにログインしてください。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">docker</span> run -p <span class="token number">8080</span>:8080 -p <span class="token number">80</span>:80 -it --rm regunorf/bootcamp-go-nginx /bin/bash
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>このコンテナの中にはgo言語で書かれたリクエストを返すだけのシンプルなechoサーバーと、nginxがインストールされています。ソースコードとDockerfileは <a href="https://github.com/ryoya-fujimoto/go-echo-server" target="_blank" rel="noopener noreferrer">ここ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> にあります。</p> <p>dockerにログインしたら試しにecho-serverを起動してみましょう。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@4dd714ba5f7b:/<span class="token comment"># echo-server --bind 0.0.0.0:8080</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>8080 portで動き始めるので、別のターミナルを開いてcurlを叩くかブラウザからアクセスしてみましょう。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> -H <span class="token string">'Content-Type:application/json'</span> -H <span class="token string">'Accept-Encoding:gzip,deflate'</span> -d <span class="token string">&quot;{&quot;</span>bootcamp<span class="token string">&quot;:&quot;</span><span class="token boolean">true</span><span class="token string">&quot;}&quot;</span> localhost:8080
User-Agent: curl/7.54.0
Accept: */*
Content-Type: application/json
Accept-Encoding: gzip,deflate
Content-Length: <span class="token number">15</span>

<span class="token punctuation">{</span>bootcamp:true<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>送信したリクエストのheaderとbodyが出力されます。ブラウザでアクセスするとどのようなヘッダーが送信されているか面白いので試してみてください。</p> <h3 id="nginxと連携させる"><a href="#nginxと連携させる" class="header-anchor">#</a> nginxと連携させる</h3> <p>echo-serverを立ち上げて外からアクセスできるようにはできましたが、echo-serverにはTLSの終端機能もHTMLなどの静的ファイル配信機能もありません。頑張って実装してもいいですが、ここではnginxにその辺りをやってもらいましょう。
(TLSは今回やりませんが・・・)</p> <p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgkAAABRCAYAAABYIDVLAAADznpUWHRteEdyYXBoTW9kZWwAAE1Ux7KrOBD9Gle9t7ALEBizJNpgMNmEzS1MNjkbvn7E+E7VLJDU6aj70K0DYKtPkpfxAUOqJsqTPI4OgDtgGIag1BEhjxhqIdgB0MS+oNQJ4JgPzdA/a4bx67ssyynqg+WUN19TkMb1r01ptrwsgwMmECcEmv4oQZjXYzNkB8BAWazHuIQ7VMNVNeHiwg9FflD8h/gLj3TblrETv+75uKMA8gTOO9D9ZinyAWPhucyLvYJrHBbNHsJmfVNBjUDCS0+AJJETiu+JmUES9Pn/YHZlPAbpN9k73x5NlxlhLUdR6TXzMWlfnznuh7ypv24oClHRr2Fc2/irjeI5D+NdC/gDYKM8SPuggi75L6Xe8XEUi+nGPpX1qs78Dz3jX5A6qH5BNEjdEf2CfJ6+HBLDwms4usnmLeJoW8Pxq3rAGCSr7brXCckyGu/RMfZQeg7kU5jbuzFJGf+ex0lEtHpEtQn0Q9LCIJ7Q/ZbyKkvTKpa3OHkItHsIycUv62VKPq7+QGj7QrWp9LY6ka9uLzabEZYbC0++DsLEs6leBRzB08tnXWmbxj/Le7IXkq798OGEH45mH7mQeTARUzVyqUXkYoM0C5ymqxrfc6svt51RSlma+FKk5+IQEyw5jist4v3V7Aa6undRZ09WBKMAG8jDh2tL3PLuVIJm9epoFOXeVvlVyUnrY9MLmCAqrOeUcg42u1U/O2FXPbIAeWhb6sHs5u3BKcwdwiH2dcanN07a/njXc13uUFCIA+8pF9m5xe0my6KI3vzx7NqfB54TDBvChhRogkWlpmwZumlss7BEijXCJ7UBQrcBWEY57ihlubWbr0p1RgEQnZ2wH5H0HK/OrLYLiXrvCzIqKpsBNme9l5spYWoNBiE7U4GljFVokxEbi8e7+l43nRizCA+vScQDZOQG+PdotbJ4X1mde/AMFIwjRk8qLVrK49uFSNYsSzFLuUguz6BTs709YuKzKHAnh0Uc4He1kUrSGyurPpcFrD/Pd7NQhf6NdW+eXC1UqGWCoPbbYclM4cbz2JnTbDtnYyV8z7qsfCkU8fhKzTbEz2fgkDm51OmbznRSZLVrviUpuvpG2DmNTU/seeJ11X2FiIotV+JjLK5gif5g65ni64xFb7iUXMwbkSbiUzqHm4vsjQJZlJnq8QxIWrygmWi8H+I1TSxtWPXZUs8jR9WbjBglRisK32NeRQVDYK86wB3MFda6ceFQCQOYLztpdQeFrI3x9ewGyS0F2wS1F7B3F/KCYwr3/yb137GF8u+LCPh/ALXeLTEAABp/SURBVHhe7Z0J2E3V98eXX1GSFCUpMmSWqSRNpPEhUkoqCmWWKU0yvCVFk7GRDGmQJJShyFCZCpU5pYhEZQgVpfyez/7/j99133vfe+97z3vuOfuu9TwevO85++z9Xeus/d1rrb1PrsOHDx+WBGXz5s3y5ZdfyqZNm6REiRJSvXp1KV68eIKt6OVBRCBXrlxB7Lb2OQEEsuESEmhdL7UJAfUHNmkz8lhyJUISli9fLv369ZPVq1dLtWrVpG7dujJ//nz54osvpEqVKtK/f3/zcxV7EcAp6CSi+rUXAR1ZIgioP0gEreBdi37jJgkjRoyQsWPHyvvvvy9FihTJNNpt27ZJgwYNpF27dtK+ffvgoaE9jgsBdQpxwRTYi1S/gVVdSjqu9pIS2D17aNwkAYJAFGHMmDExO9eyZUupVauWdOjQIea1ekHwEFCnEDydJdJj1W8iaOm1ai9220BcJAFyQHRg2bJlcaNBymHcuHFStWrVuO/RC4OBgDqFYOgpu71U/WYXufS8T+3Fbr3HRRKuu+46GTVqVMQUQzR4tm7dKh07dpRp06bZjWAajk6dgt1KV/3arV+3R6f24jai/movJklgF0OdOnXMLoZEpVixYrJ48WI566yzEr1Vr/cxAuoUfKwcF7qm+nUBxDRqQu3FbmXHJAlTp041dQhTpkxJGInrr79e7rrrLmnUqFHC9+oN/kVAnYJ/deNGz1S/bqCYPm2ovdit65gkYejQoWa7W7du3RJGIpl7E36Y3uAZAuoUPIM6JQ9S/aYE9sA+VO0lsKqLq+MxSUIykQQiCG3atJGGDRvG1Rm9KBgIqFMIhp6y20vVb3aRS8/71F7s1ntMkvDDDz/IpZdeKtQmJCrUIixdulTOPPPMRG/V632MgDoFHyvHha6pfl0AMY2aUHuxW9kxSQLDJxLw0ksvSdGiReNGA1LRpUsXIRKhYhcC6hTs0mf4aFS/duvX7dGpvbiNqL/ai4sk8I2GVq1amaOX45Vzzz1X3nzzTalcuXK8t+h1AUFAnUJAFJXNbqp+swlcmt6m9mK34uMiCUDw4osvypIlS8yxzLGkRYsWctlll5l6BBX7EFCnYJ9OQ0ek+rVbv26PTu3FbUT91V7cJIFuv/DCCybtwLcbIp19QIqBg5dIMyhB8Jei3eyNOgU30fRfW6pf/+nEzz1Se/GzdpLvW0Ikgcd99dVX0rdvX1mxYoXUqFFD/vrrL8mdO7f5/3nnnScDBgzQFEPyevF1C+oUfK2epDun+k0awrRqQO3FbnUnTBIcODh2GWLAgUkcvQxh0F0MdhuLMzp1CnbrWfVrt37dHp3ai9uI+qu9bJMEnTD8pUgve6NOwUu0vX+W6td7zIP8RLWXIGsvdt+VJMTGSK8IQ0Cdgt0mofq1W79ujy4I9sKpwf/8848ce+yxbg/f+vaUJFivYvcHGASn4P6o06dF1W/66NqNkQbBXubMmWO28W/ZssWNIadVG4YkZGRkHM7IyPB84DyzX79+nj9XH5gcAkFwCsmNML3vVv2mt/4THX0Q7EVJQqJa/d/1GknIPnZpe2cQnELaKseFgat+XQAxjZpIhb1s375dunbtKvPnz5eqVavKoEGDpHr16gb1SZMmycMPPyx79uyRW265RZ588kn59NNP5fbbbzdfJR4/frwULlzYbOc///zzTRriiSeeMP9ntx7XsUsvb968mbT47rvvyrBhw2T58uXSuHFjGTFihJx00kkSrT8cQEhbtWrVktdee02KFSsmzZo1k+bNm5u2+dnMmTPl9ddfl88++0x69uwpX3/9tVxzzTUyePBgKVSokPkK8/fffy8//vijSZfQTy9FSYKXaFvyrFQ4BUugC8QwVL+BUJNvOum1vVBfwKR78skny/333y8fffSRDBw4UHbv3i3suuO0XybyMmXKGCLRp08fKVKkiFx11VVyww03SOvWrc0E/O+//8q8efNk5MiRcu+99xqiwL2QhJYtW0r//v2PwvjXX3+V0047TSZOnCinnHKKuefOO++U7t27R+3PqlWrzMGCZcuWlfvuu0/WrFlj/nz44Yem7csvv9z8adeunenjPffcIzfddJMhNnv37pWPP/7YkIzevXsb4vDAAw+Y670UJQleom3Js7x2CpbAFphhqH4DoypfdNRre2EVTwSA1XWJEiUE0sAE+/zzz8uyZctk4cKFZnJFSDPwkcLixYsbkrB//37Jly+fWb0TZWAivuCC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" alt="go-nginx"></p> <p>まずはecho-serverの起動方法を変更します。今は外からecho-serverに直接アクセスできてしまいますが、それでは都合が悪いためサーバー内部からしかアクセスできないようにします。</p> <p>ついでにecho-server起動中も他の作業ができるようにバックグラウンドで実行させておきましょう。echo-serverが起動しているかどうかは<code>ps</code>コマンドなどで確認できます。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ echo-server --bind <span class="token number">127.0</span>.0.1:8080 <span class="token operator">&amp;</span>

<span class="token comment"># 起動できているか確認</span>
$ <span class="token function">ps</span> -aux <span class="token operator">|</span> <span class="token function">grep</span> echo-server
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>バックグラウンドで起動している他に、先ほどのecho-server起動と何が違うでしょうか。試しに先ほどと同じようにブラウザや手元のマシンからcurlなどでアクセスみてもecho-serverにアクセスできません。</p> <p>しかしecho-serverを起動したdockerの中で<code>localhost:8080</code>にアクセスするとレスポンスが返ってきます。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 手元のwindowsマシンでcurlやブラウザを開くとアクセスできない</span>
$ <span class="token function">curl</span> localhost:8080
curl: <span class="token punctuation">(</span><span class="token number">52</span><span class="token punctuation">)</span> Empty reply from server

<span class="token comment"># dockerの中からはアクセスできる</span>
root@4dd714ba5f7b:/<span class="token comment"># curl localhost:8080</span>
<span class="token number">127.0</span>.0.1:40468 <span class="token operator">|</span> GET / <span class="token operator">|</span> time: <span class="token number">2019</span>-07-21 02:02:09.250992846 +0000 UTC
User-Agent: curl/7.58.0
Accept: */*


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>最初の例では<code>bind</code>オプションに<code>0.0.0.0:8080</code>を指定していました。<code>0.0.0.0</code>はざっくり言うと「全てのアドレス」と言う意味で、この場合は「全てのアドレスからのリクエストを受け付ける」と言う設定になります。</p> <p>反対に2回目の<code>127.0.0.1:8080</code>は<code>127.0.0.1 = localhost</code>からのリクエストからしか受け付けないため、上のような挙動になっています。</p> <p>ではこの<code>localhost</code>で公開されているecho-serverに、nginxを通してアクセスできるようにしてみましょう。
nginxの設定ファイルは<code>/etc/nginx/nginx.conf</code>にありますが、設定を見やすくするため<code>/etc/nginx/conf.d/</code>の下に新しく設定ファイルを作っていきます。</p> <p><code>/etc/nginx/conf.d/bootcamp.conf</code>というファイルを以下のように作成してください。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server {
    listen       80 default_server;
    server_name  _;

    root /var/www/html;
    location / {
        try_files $uri $uri/ =404;
    }
    location /echo-server {
        proxy_pass http://127.0.0.1:8080;
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>次にdefaultで作られている設定を削除しておきます（上の内容をこちらに追記しても構いません）。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">rm</span> /etc/nginx/sites-enabled/default
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>nginxを起動します</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ nginx
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>ブラウザなどから<code>localhost</code>にアクセスしてみてください。するとnginxのwelcomeページが表示されるはずです。そして<code>localhost/echo-server</code>というパスにアクセスするとecho-serverからリクエストが返ってきます。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> -H <span class="token string">'Content-Type:application/json'</span> -d <span class="token string">&quot;{&quot;</span>bootcamp<span class="token string">&quot;:&quot;</span><span class="token boolean">true</span><span class="token string">&quot;}&quot;</span> localhost/echo-server
Connection: close
Content-Length: <span class="token number">15</span>
User-Agent: curl/7.54.0
Accept: */*
Content-Type: application/json
Accept-Encoding: gzip,deflate

<span class="token punctuation">{</span>bootcamp:true<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>無事にgoアプリ＋nginxな構成を作ることができました。今回はecho-serverとの連携に<code>localhost</code>を使いましたが、unixドメインソケットを介して連携することもよく行われます。</p> <h2 id="ruby-apache"><a href="#ruby-apache" class="header-anchor">#</a> ruby + apache</h2> <h3 id="前書き"><a href="#前書き" class="header-anchor">#</a> 前書き</h3> <p>Go言語やNode.jsで作られたアプリケーションは、大抵の場合複数のリクエストを並行して捌くことが可能です。これはGoの場合はgoroutine、Node.jsは非同期IOという形で並行処理をデフォルトで扱えるような設計になっているためです。</p> <p>そのため上の例ではnginxからのリクエストを単にそれぞれのアプリケーションに投げつければ、複数のユーザーからアクセスが同時にあっても問題はありませんでした。</p> <p>それに対してjavaやruby、pythonなどで作られたアプリケーションは通常１度に１つの処理しか行えないため、「マルチプロセス」や「マルチスレッド」という形で並行処理を実現します。そのためプロセスやスレッドを管理するためのソフトウェアが追加で必要になります。</p> <p><img src="/bootcamp/assets/img/ruby-nginx.eb55bb1c.png" alt="go-nginx"></p> <p>このようなソフトウェアの例としては以下のようなものがあります</p> <ul><li>ruby
<ul><li>puma</li> <li>unicorn</li> <li>passenger</li></ul></li> <li>java
<ul><li>tomcat</li></ul></li> <li>python
<ul><li>uWSGI?</li></ul></li></ul> <p>pumaやunicornはアプリケーション側に組み込んで並行処理機能を追加するもの、passengerやtomcatはwebサーバー側(Apache)に組み込んでアプリケーションを動かすもの、といったようにツールによって動かし方は様々です。</p> <h3 id="動かしてみる"><a href="#動かしてみる" class="header-anchor">#</a> 動かしてみる</h3> <p>ここではrubyのアプリケーションをwebサーバーと連携させてみましょう。最近だとpumaやunicornが使われることが多いですが、その場合は先ほどのGoの例と同じようにpumaやunicornをwebアプリとして起動させて、リバースプロキシで連携させます。</p> <p>同じことをしてもつまらないので、passengerを使ってモジュール組み込みな例を動かしてみましょう。このようにモジュールとして動作させる場合はnginxよりもApacheの方が便利です。</p> <p>先ほどと同じようにdockerで練習用のコンテナを起動します。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">docker</span> run -p <span class="token number">80</span>:80 --rm -it regunorf/bootcamp-passenger /bin/bash
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>ソースコードは <a href="https://github.com/ryoya-fujimoto/ruby-echo-server" target="_blank" rel="noopener noreferrer">ここ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> にあります。アプリケーションは<code>/app</code>ディレクトリにあります。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@f8fb220a22d0:/app<span class="token comment"># ls -l</span>
total <span class="token number">20</span>
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">66</span> Jul <span class="token number">21</span> 05:15 Dockerfile
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">45</span> Jul <span class="token number">21</span> 04:59 Gemfile
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">325</span> Jul <span class="token number">21</span> 05:00 Gemfile.lock
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">64</span> Jul <span class="token number">21</span> 04:57 README.md
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">319</span> Jul <span class="token number">21</span> 05:12 app.rb
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>コンテナには既にrubyの環境が作られているので、<code>ruby main.rb</code>するとアプリケーションが起動します。</p> <p>ではpassengerの環境を作っていきましょう。まずはgemコマンドでpassengerをインストールします。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@f8fb220a22d0:/app<span class="token comment"># gem install passenger</span>
Fetching passenger-6.0.2.gem
Building native extensions. This could take a while<span class="token punctuation">..</span>.
Successfully installed passenger-6.0.2
<span class="token number">1</span> gem installed
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>そしてapache用のモジュール（プラグイン）をビルドするコマンドを実行します。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@f8fb220a22d0:/app<span class="token comment"># passenger-install-apache2-module</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>TUIが起動するので、今回はrubyだけを選択してエンターを押します。
すると足りてないライブラリが表示されるので、言われるがままインストールしましょう。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">apt-get</span> <span class="token function">install</span> -y apache2-dev libapr1-dev libaprutil1-dev
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>もう一度実行するとモジュールのビルドが始まります（結構かかる）。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@f8fb220a22d0:/app<span class="token comment"># passenger-install-apache2-module</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>成功すると<code>Please edit your Apache configuration file, and add these lines:</code>というメッセージが表示されます。そこに書いてある内容をapacheの設定ファイルに追記せよとのこと。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>LoadModule passenger_module /usr/local/bundle/gems/passenger-6.0.2/buildout/apache2/mod_passenger.so
&lt;IfModule mod_passenger.c&gt;
    PassengerRoot /usr/local/bundle/gems/passenger-6.0.2
    PassengerDefaultRuby /usr/local/bin/ruby
&lt;/IfModule&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>一旦enterを押して抜けましょう。apacheの設定ファイルに以下の内容を追加します。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@0111e4e14e6d:/app<span class="token comment"># vi /etc/apache2/conf-enabled/bootcamp.conf</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>LoadModule passenger_module /usr/local/bundle/gems/passenger-6.0.2/buildout/apache2/mod_passenger.so
&lt;IfModule mod_passenger.c&gt;
    PassengerRoot /usr/local/bundle/gems/passenger-6.0.2
    PassengerDefaultRuby /usr/local/bin/ruby
&lt;/IfModule&gt;

&lt;VirtualHost *:80&gt;
  ServerName bootcamp
  DocumentRoot &quot;/app/public&quot;
  RackEnv production
&lt;/VirtualHost&gt;

&lt;Directory /app/public&gt;
  Options FollowSymlinks Includes
  AllowOverride All
  AddType text/html .html

  Require all granted
&lt;/Directory&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>apacheを起動します。ServerNameについて警告が出ますがひとまず問題ありません。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@0111e4e14e6d:/app<span class="token comment"># apachectl restart</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>無事起動できたらホストのブラウザなどからアクセスしてみましょう。sinatraアプリが動いていれば成功です。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> -H <span class="token string">'Content-Type:application/json'</span> -d <span class="token string">&quot;{&quot;</span>bootcamp<span class="token string">&quot;:&quot;</span><span class="token boolean">true</span><span class="token string">&quot;}&quot;</span> localhost
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>１つ目の例と違うのは、sinatraアプリケーションが単体で起動してlocalhostなどをlistenしているのではなく、apacheの一部として起動している点です。この場合はechoアプリケーションを再起動するためにはApacheごと再起動しなければいけません。</p> <h2 id="追加"><a href="#追加" class="header-anchor">#</a> 追加</h2> <ul><li>apacheが起動している状態で<code>/app</code>以下の<code>app.rb</code>を変更してみましょう。</li> <li>pumaまたはunicornを使ってapacheまたはnginxとrubyアプリケーションを連携させてみましょう。</li></ul> <div><hr> <span>CC BY-SA Licensed | Copyright (c) 2019, Internet Initiative Japan Inc.</span></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/iij/bootcamp/edit/master/src/web-server/hosting/README.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">8/26/2022, 1:12:09 AM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/bootcamp/assets/js/app.f493d58f.js" defer></script><script src="/bootcamp/assets/js/2.faacc272.js" defer></script><script src="/bootcamp/assets/js/24.620eaf66.js" defer></script><script src="/bootcamp/assets/js/14.58971041.js" defer></script><script src="/bootcamp/assets/js/13.c36dceeb.js" defer></script>
  </body>
</html>
