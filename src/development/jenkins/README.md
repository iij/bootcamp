---
footer: CC BY-SA Licensed | Copyright (c) 2019, Internet Initiative Japan Inc.
description: jenkinsを手元で動かしてプロダクトの理解や使い所を考えます
time: 1h
prior_knowledge: docker, 継続的インテグレーション
---

<header-table/>

# Jenkins を触ってみよう

## 事前準備

TODO: dockerでjenkinsの環境を用意する

起動後に [http://192.168.20.10:8080/](http://192.168.20.10:8080/) にアクセスすると初期パスワードの入力画面が開くので、以下の通りにパスワードを調べて入力してください。

```bash
sudo cat /var/lib/jenkins/secrets/initialAdminPassword
```

パスワードを入力するとpluginをインストールするか聞かれるので、「Install suggested plugins」を選んでおいてください。

その後「新しいjobを作成」が表示されれば準備完了です。

## jenkins とは

2011年に発表されたCI(継続的インテグレーション) / CD（継続的デリバリー）ツールの１つで、シェルスクリプトで作成されたタスクをURLへのリクエストや時刻を指定した定期実行、他のタスクからのチェインなど様々なトリガーで実行することができるツールです。

CIとは、開発中にコミットやpushの度にテストやデプロイを「継続的に」実施することで、問題の発見を早期に発見する開発手法です。
例えば１ヶ月開発してからデプロイ・テストをするよりも、1日に一回や変更の度にテストを回す方が効率的に問題を発見できます。
当然これは単体テストや自動でデプロイを行う仕組みを作っていることが前提です。

CIツールはそのような開発スタイルをサポートするためのツールで、githubのcommitなどをトリガーにしてテストやデプロイを実施して結果を知らせてくれるツールの総称です。

最近の主要なCIツールとしては

- jenkins
- Circle CI
- Travis CI
- drone.io

あたりが上げられます。

jenkinsの特徴としては、タスクの実行内容をシェルスクリプトで作成するためシンプルで自由度が高く、様々な用途に使用することができます。
（向き不向きはあれどjenkinsがあればほぼなんでもできる）

またプラグインで機能を拡張することができる他、masterとslave構成にしてスケールさせることも可能です。

欠点としてはタスクのスクリプトはjenkinsが構築されている環境で実行されるため、例えばrubyを実行したければjenkinsが動作しているホストにrubyをインストールする必要があります。これは例えば、プロジェクトによって違うrubyのバージョンを使いたくなったときなどに非常に辛いです。

このあたりはCircle CIやdone.ioなどのコンテナ型ツールの方が便利です。ただしjenkinsプラグインの中にはタスクをコンテナで実行するためのプラグインもあるため、やろうと思えばjenkinsをコンテナ対応させることも可能です。

## 使ってみる

早速試しに使ってみましょう。「新しいジョブを作成」をクリックするとジョブの作成画面に入ります。まずは「フリースタイル・プロジェクトのビルド」をクリックしてください。

![create-job](./images/create-job.png)

作成するとジョブの設定画面が開きます。色々設定がありますが、まずは「ビルド」からスクリプトを登録してみましょう。「ビルド手順の追加」から「シェルの実行」を選ぶとスクリプトを登録できます。

![job-build-script](./images/job-build-script.png)

「保存」をクリックするとジョブが作成されるので、「ビルド実行」を押して実行してみます。
「ビルド履歴」に`#1`が増えたでしょうか。`#1`をクリックして「コンソール出力」をクリックするとビルドの様子を確認できます。

![build-result](./images/build-result.png)

## ワークスペース

上の例ではシェルスクリプトで`welcome.txt`というファイルを作成しました。このようにビルドの実行で生成されるファイルを「成果物」と呼んだりします。今回は適当なテキストファイルでしたが、ビルドした結果生成されたバイナリファイルであることが多いです。

成果物はどこに作られているでしょうか。jenkinsホストで以下のディレクトリを覗くと成果物が生成されているのが分かります。

```bash
$ cat /var/lib/jenkins/workspace/test-project/welcome.txt
welcome to bootcamp
```

ディレクトリ名からも分かる通り、ジョブが実行されるディレクトリを「ワークスペース」と呼び、成果物も基本的にここに作成されます。ワークスペースはジョブ毎に別々に作られるため、他のジョブに影響されず実行することができます。

成果物はジョブの実行前に自動で削除するようにも設定できますが、そうでない場合は前回の成果物がそのまま残っているためスクリプトを作る際は注意が必要です。また成果物を残しすぎるとjenkinsホストのディスクを圧迫するため不要な成果物は削除するようにしましょう。

## ビルドトリガー

先ほどはジョブを手動で実行しましたが、他にも様々な方法でビルドを実行することができます。
webhookなどのHTTPリクエストからジョブを実行するトリガーを設定してみましょう。

(ちなみに手動実行は、本番環境の更新などビルドの実行タイミングを人が判断したい場合などによく使います。)

先にいくつかセキュリティ設定を無効化しておきましょう。
`jenkinsトップ＞jenkinsの管理＞グローバルセキュリティの設定` から「権限管理」と「CSRF対策」の項目を以下のように変更してください。

![security](./images/security.png)

画面上部のパンくずリストなどからジョブのトップ画面に移動し、「設定」をクリックして設定画面に移動しましょう。「ビルド・トリガ」からトリガーを設定することができます。「リモートからビルド」を選ぶとHTTPリクエストによるビルドを登録できます。

![build-trigger](./images/build-trigger.png)

認証トークンを設定できるので適当な文字列（本当に使うときはちゃんとランダムな文字列使ってください）設定して保存します。保存後、設定画面に書かれているように`URL/buildWithParameters?token=TOKEN`にリクエストしてみましょう。

```bash
curl 'http://192.168.20.10:8080/job/test-project/build?token=test-token'
```

上記を実行するとジョブが実行されると思います。このように外部システムのイベントをトリガーにしてjenkinsでビルドを実行することができます。

リモート実行に限りませんが、ビルドにはパラメータを設定することができます。「General」にある「ビルドをパラメータ化」からパラメータを設定してみてください。

![build-param](./images/build-param.png)

設定したパラメータは環境変数として使えます。スクリプトを以下のようにしてみてください。

```bash
pwd
echo $param >> welcome.txt
```

そしてパラメータ付きビルドをリモートから実行します。

```bash
curl -X POST -F 'param=bootcamp' 'http://192.168.20.10:8080/job/test-project/buildWithParameters?token=test-token'
```

ビルドの履歴から結果を見ると、`echo boocamp`というコマンドが実行されているのが分かります。
ちなみにパラメータは手動実行の際にブラウザから指定することもできます。

## 秘密情報の利用

jenkinsではパスワードなど秘密情報を取り扱う機能があります。パスワードをスクリプトに直接書いてしまうと誰でも見えてしまうので、外には表示されない状態で埋め込むことができます。

ジョブ設定画面「ビルド環境」にある「秘密テキストや秘密ファイルを利用する」を使います。
秘密情報であるpasswordを埋め込んでみましょう。少し使い方が難しいですが、「変数」に変数名を指定し、`Specific credentials` を選択して「追加」から秘密情報を追加できます。

![secret-add](./images/secret-add.png)

secretを追加したら設定したIDである`secret`を選択して保存しましょう。

![secret-config](./images/secret-config.png)

これでスクリプトで`echo $password`などすると設定した秘密情報を利用できます。

## 最後に

jenkinsは非常に様々なことができますが、その分使いこなすのが難しいです。さらに環境によってバージョンの違いや入っているプラグインの違いで微妙に使い勝手が違ったり、使い方が分かりにくかったり苦労することもあります。

ただしきちんと運用されたjenkinsサーバーを適切に使うと、様々なシステムと連携して自由度の高いビルドを実施できるため開発などの業務を効率化することができます。

スクリプトの変更履歴管理がしにくいため、スクリプトをgitに置いてcloneして実行するなども有効です。

<credit-footer/>
